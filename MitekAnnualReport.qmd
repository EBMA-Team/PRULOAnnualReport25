---
title: "Usage and Outcomes of DePuy-Mitek Hardware for Shoulder Surgery"
author: "Corey Scholes"
type: "website"
number-sections: true
number-depth: 3
date: "2025-Apr-11"
date-modified: "2025-Oct-10"
bibliography: MitekReport references.bib
format: 
  html:
    df-print: paged
    toc: true
    toc-depth: 1
    toc-location: left
    link-external-icon: true
    link-external-newwindow: true
    smooth-scroll: true
    fig_caption: yes
  pdf:
    toc: true
    colorlinks: true
    fig_caption: yes
  docx: 
    toc: true
    fig-align: center
    fig_caption: yes
editor: visual
execute:
  echo: false
  warning: false
  message: false
---

# Preamble

**Author:** Corey Scholes, EBM Analytics

**Sponsors:** Assoc Prof Kevin Eng and Prof Richard Page, Geelong Orthopaedics; Mitek, JnJ MedTech

**EBMAReference**: RC_MitekReporting_KE006May24

**Version:** 1.0

# Introduction

The surgeons from Geelong Orthopaedics participating in the Patient Registry of Upper Limb Pathology Outcomes (PRULO) specialise in joint replacement, sports injuries, upper limb and hand surgery, and trauma. The PRULO registry collates and stores patient outcomes collected routinely as part of the standard clinical pathway for upper limb pathology treatment.

The registry comprises three patient cohorts: rotator cuff pathology, glenohumeral instability, and general shoulder pathologies. Outcomes data collected by the registry include objective joint function, patient reported outcomes (pain, satisfaction, quality of life), radiological findings, surgical treatment and rates of revision surgery or complications.

Mitek Products are used across all three cohorts. This report summarises the outcomes of the Mitek product list used within the PRULO registry for the past year.

The dataset is derived from the PRULO registry snapshot and live database tables. A [protocol](https://academic.oup.com/jsprm/article/2023/4/snad014/7317733) has been previously prepared for the registry @scholes2023.

The outline of this report has been derived from the [EuroSpine Registry](https://drive.google.com/file/d/1ahcwmg50p87BR0AgJQXb740z2g7LUj-J/view?usp=sharing "Link to report example") report supplied as an example by Bruce Robie (Mitek, JnJ MedTech) (Sep 2023) and via summary of meeting minutes provided by Tracey Mealey in email correspondence (26-Jun-2023).

# Glossary

To clarify terms used throughout the report, a glossary is presented below.

::: {#tbl-glossary}
+--------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Term                     | Definition                                                                                                                                                                                                                                                                           |
+==========================+======================================================================================================================================================================================================================================================================================+
| Case Failure             | Patient presents in a state such that                                                                                                                                                                                                                                                |
|                          |                                                                                                                                                                                                                                                                                      |
|                          | i\) a repaired construct is deemed to be absent healing, or has reinjured subsequent to the index procedure                                                                                                                                                                          |
|                          |                                                                                                                                                                                                                                                                                      |
|                          | ii\) the shoulder presents in a state such that removal of hardware or procedure revision (single or multi-stage) is recommended                                                                                                                                                     |
+--------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Reoperation              | A theatre procedure subsequent to the index surgery that does not involve removal, replacement or modification of the construct.                                                                                                                                                     |
+--------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Case                     | A definitive reconstruction procedure performed on a patient, excluding a reoperation, but including revision procedures.                                                                                                                                                            |
+--------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Revision Else            | A repeat definitive procedure performed on a case where the previous definitive procedure has been performed by another surgeon                                                                                                                                                      |
+--------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Revision Own             | A repeat definitive procedure performed on a case where the previous definitive procedure has been performed by the same contributing surgeon                                                                                                                                        |
+--------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| QuickDASH                | Short form of the Disabilities of the Arm, Hand and Shoulder questionnaire. The questions are directed toward pain and disability associated with upper limb activities. A diminishing score over time reflects improved function.                                                   |
+--------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| WORCNorm                 | Western Ontario Rotator Cuff Index is a questionnaire specific to rotator cuff pathology and is scored as the sum of a series of 10mm visual analogue scales. A normalised score is calculated to convert the sum to a percentage score of normal (100%).                            |
+--------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| WORC Physical Question 3 | Question 3 of the Physical subscale of the WORC asks "How much weakness do you experience in your shoulder?" and is a                                                                                                                                                                |
+--------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| WOSINorm                 | Western Ontario Rotator Cuff Index is a questionnaire specific to glenohumeral instability and associated pathology and is scored as the sum of a series of 10mm visual analogue scales. A normalised score is calculated to convert the sum to a percentage score of normal (100%). |
+--------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

Glossary of terms used in report
:::

# Data Preparation

The steps below outline the process for preparing registry data for analysis.

## Load libraries

Load up required packages in advance.

```{r}
#| label: Load packages

 if(!require("pacman")) install.packages("pacman")
pacman::p_load(
  "binom",
  "knitr",
  "cardx",
  "quarto",
  "pROC",
  "reshape",
  "future",
  "furrr",
  "memoise",
  "gargle",
  "googledrive",
  "googlesheets4",
  "openxlsx2",
  "readr",
  "purrr",
  "tidyverse",
  "tidymodels",
  "tidytext",
  "stopwords",
  "tictoc",
  "lubridate",
  "forcats",
  "gt",
  "consort",
  "gtsummary",
  "flextable",
  "survival",
  "ggplot2",
  "ggdist",
  "ggsurvfit",
  "ggfortify",
  "mice",
  "marginaleffects",
  "patchwork",
  "naniar",
  "quantreg",
  "broom",
  "broom.helpers",
  "labelled",
  "epoxy",
  "broom.mixed",
  "lme4",
  "janitor",
  "progressr",
  "DT",
  install = TRUE,
  update = FALSE
)

```

## Authorisations

Pre-authorise access to registry datasets.

```{r}
#| label: Authorisations
#| echo: false

options(
  gargle_oauth_cache = ".secrets",
  gargle_oauth_email = TRUE
)

drive_auth(cache = ".secrets", email = TRUE)

```

## Functions for Processing

Include a series of functions to call later in the file for processing data imports.

```{r}
#| label: Snapshot-folder
#| echo: false

base_folder_id1 <- "1og1hWKEXFcy8v8pLSzA_Ii767bbCe_EK"




```

```{r}
#| label: Retrieve-snapshot-func


get_specific_snapshot <- function(folder_name, base_folder_id = base_folder_id1) {
  tryCatch({
    # Check if the folder exists in the base directory
    folder <- googledrive::drive_ls(as_id(base_folder_id), pattern = paste0("^", folder_name, "$"))
    
    if(nrow(folder) == 0) {
      stop(paste("Folder", folder_name, "not found"))
    }
    
    # Find the snapshot file in the specified folder
    snapshot_file <- googledrive::drive_ls(
      folder$id, 
      pattern = "Registry data snapshot\\.xlsx$"
    )
    
    if(nrow(snapshot_file) == 0) {
      stop("No snapshot file found in specified folder")
    }
    
    # Return both pieces of information as a list
    return(list(
      snapshot = snapshot_file,
      folder_name = folder$name
    ))
    
  }, error = function(e) {
    stop(paste("Error finding specified snapshot:", e$message))
  })
}

```

```{r}
# Function to generate multiple dataframe pairs from a configuration list
Generate_selectrep <- function(config_list, ProductTable, SnapshotComb4, 
                               ComplicInfection, ComplicLigament_Tendon, 
                               ComplicStiffness, ComplicLoosening, ComplicHardware, 
                               ComplicInstability, ComplicNeurological, ComplicFracture,
                               ComplicThrombosis, ComplicEffusion, ComplicPain, 
                               ComplicOther, ComplicIntraop, ComplicReop, ComplicTable3, 
                               ...) {
  
  result_list <- list()
  
  for(i in seq_along(config_list)) {
    config <- config_list[[i]]
    df_name <- names(config_list)[i]
    
    # Prepare PROM arguments if specified
    prom_args <- list()
    if (!is.null(config$proms)) {
      dots <- list(...)
      for (prom_name in config$proms) {
        if (prom_name %in% names(dots)) {
          prom_args[[prom_name]] <- dots[[prom_name]]
        }
      }
    }
    
    # Create the dataframe pair with subsets and PROMs
    df_results <- do.call(create_dataframe_pair, c(
      list(
        df_name = df_name,
        category = config$category,
        search_terms = config$search_terms,
        pattern = config$pattern,
        subsets = config$subsets,
        proms = config$proms,
        ProductTable = ProductTable,
        SnapshotComb4 = SnapshotComb4,
        ComplicInfection = ComplicInfection,
        ComplicLigament_Tendon = ComplicLigament_Tendon,
        ComplicStiffness = ComplicStiffness,
        ComplicLoosening = ComplicLoosening,
        ComplicHardware = ComplicHardware,
        ComplicInstability = ComplicInstability,
        ComplicNeurological = ComplicNeurological,
        ComplicFracture = ComplicFracture,
        ComplicThrombosis = ComplicThrombosis,
        ComplicEffusion = ComplicEffusion,
        ComplicPain = ComplicPain,
        ComplicOther = ComplicOther,
        ComplicIntraop = ComplicIntraop,
        ComplicReop = ComplicReop,
        ComplicTable3 = ComplicTable3
      ),
      prom_args
    ))
    
    # Store main dataframes
    result_list[[paste0("RefCode", i)]] <- df_results$RefCode
    result_list[[paste0("SelectRep", i)]] <- df_results$SelectRep
    
    # Store PROMs
    if (!is.null(config$proms)) {
      for (prom_name in config$proms) {
        if (prom_name %in% names(df_results)) {
          result_list[[paste0("SelectRep", i, prom_name)]] <- df_results[[prom_name]]
        }
      }
    }
    
    # Store subsets with appropriate naming
    if (!is.null(config$subsets)) {
      for (subset_name in names(config$subsets)) {
        # Main subset
        if (subset_name %in% names(df_results)) {
          result_list[[paste0("SelectRep", i, subset_name)]] <- df_results[[subset_name]]
        }
        
        # PROM subsets
        if (!is.null(config$proms)) {
          for (prom_name in config$proms) {
            prom_subset_name <- paste0(subset_name, prom_name)
            if (prom_subset_name %in% names(df_results)) {
              result_list[[paste0("SelectRep", i, prom_subset_name)]] <- df_results[[prom_subset_name]]
            }
          }
        }
      }
    }
  }
  
  return(result_list)
}
```



## Import Inputs

Data was imported from the PRULO registry. Configuration tables were also loaded, including the product table to describe the products of interest and list identifiers to match to surgical records. The table was modified to include a material column (PEEK or BR) and product identifiers.

```{r}
#| label: Specify-sources
#| echo: false

SheetIDs <- list(
  DbPRULO = "https://docs.google.com/spreadsheets/d/1zyFuf0Wmij13ELTYNmdi_BprF8hU4QSCPsNZ0EYRXzo/edit",
  ProductTable = "https://docs.google.com/spreadsheets/d/1MvT00sc8FzH5SXEi-yzEgW1H1ao3AOoakKqpg7UkxW4/edit",
  RefIgnore =   "https://docs.google.com/spreadsheets/d/1MvT00sc8FzH5SXEi-yzEgW1H1ao3AOoakKqpg7UkxW4/edit",
  PROMsMaster = "https://docs.google.com/spreadsheets/d/1zyFuf0Wmij13ELTYNmdi_BprF8hU4QSCPsNZ0EYRXzo/edit",
  TargetTerms = "https://docs.google.com/spreadsheets/d/1ESVvSKAv8ma11kri9pby6OEU9Gk5Z3UnF6XwjXBTcTg/edit",
  AuditResults = "https://docs.google.com/spreadsheets/d/1e7431oSrK9tItiSZb4wCWPI7nqGqawH8pNgnqgHPNkU/edit",
  AuditReport = "https://docs.google.com/spreadsheets/d/1ESVvSKAv8ma11kri9pby6OEU9Gk5Z3UnF6XwjXBTcTg/edit"
  
)

```

```{r}
#| label: Read-live-tables

# Authenticate for sheets using the same token
gs4_auth(token = drive_token())

ComplicTable <- googlesheets4::read_sheet(
  ss = SheetIDs$DbPRULO,
  sheet = "Complications",
  range = "A1:H",
  col_names = TRUE,
  col_types = "TcccDccD"
  )

PatientTable <- googlesheets4::range_read(
  ss = SheetIDs$DbPRULO,
  sheet = "Patient",
  col_names = c(
  "PatientCreationDate",
  "PatientID",
  "LastName",
  "FirstName",
  "AlternateID",
  "DateOfBirth",
  "Sex",
  "RegistryStatus",
  "RegistryStatusNotes",
  "DateRegistryStatus",
  "NotificationMethod",
  "NoTreatmentRecords",
  "Email",
  "Phone",
  "Postcode",
  "PatientRegistrationStatus",
  "DatePatientRegistration",
  "TrueNoTreatmentRecords"
),
range = "A6:R",
col_types = "DccccDcccTciccccTi"
)

ProductTable <- googlesheets4::range_read(
  ss = SheetIDs$ProductTable,
  sheet = "Mitek",
  range = "F1:J",
  col_names = TRUE,
  col_types = "ncccc"
  ) |> dplyr::mutate( # For each row in ProductTable,
# create a new column 'Material' based on the 'Description' column.
# The 'case_when' function is used to create the 'Material' column. It checks for specific patterns
#          in the 'Description' column and assigns them corresponding material names.
# 'str_detect' is used to check if a string contains a pattern. If the 'Description' column contains "BR",
#          it assigns "Bioresorbable" to 'Material', and if it contains "PEEK", it assigns "PEEK".
# Note that this code assumes that 'Description' column has no missing values or errors in order to perform
#          the pattern checks.
    Material = case_when(
      stringr::str_detect(Description,"BR") ~ "Bioresorbable",
      stringr::str_detect(Description,"PEEK") ~ "PEEK",
      .default = NA_character_
    )
  )

# Read RefIgnore from the specified URL and sheet. It reads only a range of 'A1:A' from the sheet 'RefIgnore'.
# Since only one column is being read, it automatically infers that all entries are of type 'character'.
RefIgnore <- googlesheets4::range_read(
ss = SheetIDs$RefIgnore,
sheet = "RefIgnore",
range = "A1:A",
col_names = TRUE,
col_types = "c"
)

# Read PROMsMaster from the specified URL and sheet. It reads a range of 'D1:H' from the sheet 'PROMS Master list'.

PROMsMaster <- googlesheets4::range_read(
  ss = SheetIDs$PROMsMaster,
  sheet = "PROMS Master list",
  range = "D1:H",
  col_names = TRUE,
  col_types = "Dcicc") |> dplyr::select(-`External Reference`)



# read in existing Procedure Terms

TargetTerms2 <- googlesheets4::range_read(
  ss= SheetIDs$TargetTerms,
  sheet = "Procedures",
  range = "A1:C",
  col_names = TRUE,
  trim_ws = TRUE
) 
```

```{r}
#| label: Import-snapshot

# Authenticate for sheets using the same token
gs4_auth(token = drive_token())

# To get a snapshot from a specific folder (e.g., "20230415")
specific_snapshot <- get_specific_snapshot("20250331")


```


```{r}
temp_file1 <- tempfile(fileext = ".xlsx")
drive_download(
  file = specific_snapshot$snapshot$id,
  path = temp_file1,
  overwrite = TRUE
)

SnapshotDate <- lubridate::ymd("20250331")

# Correction to reset back to excel origin
DaysDiff <- as.numeric(as.duration(interval(ymd("1899-12-30"), ymd("1970-01-01"))),"days")

SnapshotGen <- openxlsx2::read_xlsx(
  temp_file1,
  sheet = "ShoulderGeneral",
  colNames = TRUE,
  detectDates = TRUE
  ) |> dplyr::mutate(
    Cohort = "General",
    across(starts_with("IC"),as.character),
    Followup = as.numeric(as.duration(interval(DateTreatment, SnapshotDate)),"days"),
    DurationStatusChange = if_else(
      !is.na(DateStatusChange),
      as.numeric(as.duration(interval(DateTreatment, DateStatusChange)),"days"),
      NA,
    ),
    EligibleAtx3months = if_else(
      Followup >= 56 & (is.na(DurationStatusChange) | DurationStatusChange > 105),
      "Yes",
      NA_character_
    )
  )

SnapshotRC <- openxlsx2::read_xlsx(
  temp_file1,
  sheet = "RotatorCuff",
  colNames = TRUE,
  detectDates = TRUE
  ) |> dplyr::mutate(
    Cohort = "Rotator Cuff",
    across(starts_with("IC"),as.character)
  )

SnapshotGHI <- openxlsx2::read_xlsx(
  temp_file1,
  sheet = "GlenohumeralInstability",
  colNames = TRUE,
  detectDates = TRUE
  ) |> dplyr::mutate(
    Cohort = "Glenohumeral Instability",
    across(starts_with("IC"),as.character)
  )


STROBEInput <- openxlsx2::read_xlsx(
  temp_file1,
  sheet = "Strobe_Input",
  colNames = TRUE,
  detectDates = TRUE
  )
```

Dataframes were combined into one for further analysis.

## Combine and filter for 3 month follow up

The dataset was filtered to only include records with a minimum of 3 months follow up at the time of analysis.

```{r}
## Slice inputs for columns and rows
#| label: Slice-stack-1
#| code-summary: "line up input frames"
#| warning: false



# Combine SnapshotRC, SnapshotGH, and SnapshotGen into a single table.
# Remove 'ExternalStudyTag', 'Email', and 'Phone' columns.
SnapshotComb <- SnapshotRC |> dplyr::select(-(c(ExternalStudyTag,Email,Phone))) |>
  bind_rows(dplyr::select(SnapshotGHI, -(c(ExternalStudyTag,Email,Phone)))) |>  # Continue to combine tables by removing the specified columns. This time, combining 'SnapshotGen'.
  bind_rows(dplyr::select(SnapshotGen, -(c(ExternalStudyTag,Email,Phone,Followup,DurationStatusChange)))) |> 
  mutate(  # Create a new column 'PatientID' based on the TreatmentID column, using 'str_split_i' function with a pattern of '.'. This means splitting the string at the first occurrence of '.', and capturing the first part (using `1` argument).
        PatientID = str_split_i(TreatmentID,"\\.",1)
      ) |> relocate( # Move 'PatientID' column before 'TreatmentID' column.
    PatientID, .before = TreatmentID
  ) |> mutate(  # Create a new column 'CombID' by pasting 'PatientID' and 'AffectedSide' columns.
    CombID = paste0(PatientID,AffectedSide)
  ) |> relocate(   # Move 'CombID' column after 'TreatmentID' column.
    CombID, .after = TreatmentID
  ) |> relocate( # Move 'Cohort' column to the desired position in the table.
    Cohort, .before = EligibleAtPreop
  ) |> mutate(
  DurationTotal = as.numeric(as.duration(interval(ymd(DateTreatment), SnapshotDate)),"days")
  ) |> filter(
    EligibleAtx3months == "Yes"
  )

```

## Prepare dataset for procedure

Procedure data was combined from all cohorts. New columns were created based on conditional statements, cases were filtered where procedure data was unavailable (non-surgical, missing intraoperative data). Procedure data was further processed to standardise labels, categorised by structure (Rotator Cuff, Labrum, Capsule and Ligament) and adjunct procedures reorganised to account for variation across surgical indication.

```{r}
#| label: snapshot-comb1

SnapshotComb1  <- SnapshotComb |> 
  # Use 'case_when' function to create CuffRepair2 column
  mutate(
    CuffRepair2 = case_when(
      CuffRepair == "Yes" ~ "Rotator Cuff Repair",  
      .default = NA_character_
    ),
    # Use 'str_detect' and 'str_to_lower' functions to create TreatmentGlenoid2 column
    TreatmentGlenoid2 = case_when(
      str_detect(str_to_lower(TreatmentGlenoid), "internal fixation") ~ "Glenoid internal fixation",
      !is.na(TreatmentGlenoid) & (TreatmentGlenoid != "None" | TreatmentGlenoid != "Internal fixation") ~ TreatmentGlenoid,
      .default = NA_character_
    ),
    # Use 'case_when' function to create AdjunctProcedures2 column
    AdjunctProcedures2 = case_when(
      !is.na(AdjunctProcedures) & AdjunctProcedures != "None performed" ~ AdjunctProcedures,
      .default = NA_character_
    )
  ) |> 
  # Use 'unite' function to concatenate the new columns into a single column called Procedures2
  unite(
    "Procedures2", 
    all_of(c(
      "CuffRepair2",
      "TreatmentGlenoid2",
      "TreatmentHumeralHead",
      "SoftTissueProcedure",
      "AdjunctProcedures2",
      "ProceduresOfInterest"
    )),
    sep = "; ", 
    remove = FALSE, 
    na.rm = TRUE
  ) |> 
  # Use 'relocate' function to move the Procedures2 column to the end of the dataframe
  relocate(
    Procedures2, 
    .after = last_col()
  ) |> dplyr::select(
    -CuffRepair
  )
```

```{r}
# This code chunk filters the 'SnapshotComb1b' dataframe to include only rows where the Procedures2 column has a length greater than 0 (i.e., non-empty)
#
# The goal of this filter operation is to remove any rows that do not have any procedures listed, as these may be unnecessary or irrelevant for further analysis
#
SnapshotCombProc <- SnapshotComb1  |> 
  # Use the 'filter' function from dplyr to apply a filter condition to the dataframe
  filter( 
    str_length(Procedures2)  > 0
  )
```

```{r}
#| label: process-procedures


# This code chunk uses the `unnest_regex` function from the tidytext package to expand and transform the Procedures2 column in the SnapshotCombProc dataframe
# The goal of this operation is likely to extract individual procedures from a comma-separated or semicolon-separated string, and create new rows for each procedure
# The input pattern specifies how to split the Procedures2 column into separate procedures

ProcedureMaster   <- tidytext::unnest_regex( 
  # Select specific columns from SnapshotCombProc dataframe
  SnapshotCombProc  |> dplyr::select(
    TreatmentID, 
    CombID, 
    DateTreatment, 
    AffectedSide, 
    TreatmentStatus, 
    TreatmentStatusNotes,
    Procedures2
   ),
  
  # Specify the output column name and the input column name
  output = Procedures3, 
  input = Procedures2,

  # Regular expression pattern to split the Procedures2 column into separate procedures
  pattern = "\\; |\\, |\\band\\b |\\+", 

  # Convert all procedure names to lowercase for consistency
  to_lower = TRUE,
  
  # Do not drop any rows during the transformation
  drop = FALSE
)
```

```{r}
#| label: target-procedures
# This code chunk selects and transforms the ProcedureMaster dataframe to create a new TargetTerms dataframe
# The goal of this operation is to identify unique target procedures (Procedures3) for each treatment UID, and store them in a Google Sheet

TargetTermsNew    <- ProcedureMaster |> 
  # Select only TreatmentID and Procedures3 columns
  dplyr::select(
    TreatmentID,
    Procedures3
  )   |> 
  # Remove duplicate rows while keeping all other columns (TreatmentID) using distinct()
  distinct(
    Procedures3, 
    .keep_all = TRUE
  )   |> 
  # Arrange the procedures in alphabetical order within each treatment UID
  arrange(
    Procedures3
  )   |> 
  # Use str_squish() to remove extra whitespace from procedure names
  mutate(
    Procedures3  = str_squish(Procedures3)
  )

# Commented out code: This is a call to the googlesheets4 package to write the TargetTerms dataframe to a Google Sheets spreadsheet

#googlesheets4::range_write(
#  ss = "https://docs.google.com/spreadsheets/d/1ESVvSKAv8ma11kri9pby6OEU9Gk5Z3UnF6XwjXBTcTg/edit", 
#  data = TargetTerms |> dplyr::select(TreatmentID, Procedures3), 
#  sheet = "Procedures", 
#  range = paste0("A1:", "B", nrow(TargetTerms) + 1),
#  col_names = TRUE
#)
```

```{r}
#| label: Procedure-master

# Create a new dataset by joining ProcedureMaster with TargetTerms2 on Procedures3
ProcedureMaster1 <- ProcedureMaster |> left_join(
  TargetTerms2 |> dplyr::select(-TreatmentID),
  by = "Procedures3",
  relationship = "many-to-many"
  ) |> 
  
  # Filter out rows with NA values in ReplaceProcedure and rows where ReplaceProcedure is "none"
  filter(!is.na(ReplaceProcedure), !(ReplaceProcedure == "none")) |> 
  
  # Group the data by TreatmentID
  group_by(TreatmentID) |> 
  
  # Remove duplicates while keeping all columns (including non-unique ones)
  distinct(ReplaceProcedure, .keep_all = TRUE) |> 
  
  # Filter out rows where ReplaceProcedure contains certain strings
  filter(str_detect(ReplaceProcedure, "slap|bankart|augment*", negate = TRUE)) |> 
  
  # Create a new column called Entry and order the data by this column
  mutate(Entry = str_order(ReplaceProcedure)) |> 
  
  # Arrange the data in descending order of Entry within each group
  arrange(desc(Entry), .by_group = TRUE) |> 
  ungroup()


# Create a new dataset by joining ProcedureMaster with TargetTerms2 on Procedures3
ProcedureMaster1a <- ProcedureMaster |> 
  left_join(
    TargetTerms2 |> dplyr::select(-TreatmentID),
    by = "Procedures3",
    relationship = "many-to-many"
  ) |> 
  
  # Filter out rows with NA values in ReplaceProcedure and rows where ReplaceProcedure is "none"
  filter(!is.na(ReplaceProcedure), !(ReplaceProcedure == "none")) |> 
  
  # Group the data by TreatmentID
  group_by(TreatmentID) |> 
  
  # Remove duplicates while keeping all columns (including non-unique ones)
  distinct(ReplaceProcedure, .keep_all = TRUE) |> 
  
  # Create a new column called Entry and order the data by this column
  mutate(Entry = str_order(str_sort(ReplaceProcedure))) |> 
  
  # Arrange the data in descending order of Entry within each group
  arrange(desc(Entry), .by_group = TRUE) |> 
  ungroup()
  

```

```{r}
#| label: fig-ProcedureCount
#| fig-cap: "Summary of procedure terms included in registry output"

# Create a new dataset by grouping ProcedureMaster1 by ReplaceProcedure and counting the occurrences
FigProcCount  <- ProcedureMaster1  |> 
  
   # Count the occurrences of each unique value in ReplaceProcedure, sort the results by count in ascending order (default), and create a new dataset
  count(ReplaceProcedure, sort = TRUE)  |> 
  
   # Filter out procedures with only one occurrence
  filter(n > 1)  |> 
  
   # Create a new column called ReplaceProcedure and reorder it based on the count of each procedure
  mutate(ReplaceProcedure = reorder(ReplaceProcedure, n))  |> 
  
   # Create a bar plot using ggplot2, where x-axis is the count (n) and y-axis is the reorder(replaceprocedure) variable
  ggplot(aes(n, ReplaceProcedure)) + 
  
   # Add a geom_col() layer to create the bar plot
  geom_col() + 
  
   # Remove the axis label for the y-axis using labs()
  labs(y = NULL)
  
  # Print the plot using knit_print from knitr package
knitr::knit_print(FigProcCount)
```

```{r}
#| label: update-procedures


ProcedureMaster2 <- left_join(
  # Filter SnapshotComb1 to only include rows with SurgicalTreatment == "Surgical"
  SnapshotComb1 |> filter(SurgicalTreatment == "Surgical") |> dplyr::select(
    TreatmentID, CuffRepair2, AdjunctProcedures2, SoftTissueProcedure, RepairAugmentation, ProceduresOfInterest), # Select specific columns from the filtered data frame
  summarise(ProcedureMaster1a,    # Summarize ProcedureMaster1a by TreatmentID and collapse unique ReplaceProcedure values into a single string separated by ";"
             .by = "TreatmentID", 
             Procedure4 = str_c(str_unique(ReplaceProcedure), collapse = "; ")
  ), 
  by = "TreatmentID",
  relationship = "one-to-one" # Specify the join relationship as one-to-one
) |> mutate(
  RepairAugmentation2 = case_when(   # Update RepairAugmentation column based on conditions in Procedure4 column
    (!(is.na(RepairAugmentation)) | RepairAugmentation == "Other") & !str_detect(Procedure4, "augment*") ~ RepairAugmentation,
    (is.na(RepairAugmentation) | RepairAugmentation == "Other") & str_detect(Procedure4, "augment*") ~ str_extract(Procedure4, "rotator cuff repair augmentation\\s+([^;]+)"),
    (!(is.na(RepairAugmentation)) | RepairAugmentation != "Other") & str_detect(Procedure4, "augment*") ~ str_c(RepairAugmentation, str_extract(Procedure4, "rotator cuff repair augmentation\\s+([^;]+)"), sep = "; ")
  )
) |> mutate(
  RepairAugmentation3 = case_when(
    str_detect(RepairAugmentation2,"rotator cuff repair augmentation - biceps") ~ str_replace(RepairAugmentation2,"rotator cuff repair augmentation - biceps", "Autograft"),
        str_detect(RepairAugmentation2,"rotator cuff repair augmentation - superior capsular reconstruction") ~ str_replace(RepairAugmentation2,"rotator cuff repair augmentation - superior capsular reconstruction", "Superior Capsular"),
    str_detect(Procedure4,"advancement") ~ str_c(RepairAugmentation2,"advancement",sep = "; "),
    .default = RepairAugmentation2
    )
  ) |> mutate(
    RepairAugmentationClean = case_when(
      str_detect(RepairAugmentation3,"Superior Capsular; Superior Capsular") ~ str_replace(RepairAugmentation3,"Superior Capsular; Superior Capsular","Superior Capsular"),
      RepairAugmentation3 == "Nil" ~ "None",
      .default = RepairAugmentation3
      )
    ) |> mutate(
      CuffRepair = case_when(
        !is.na(RepairAugmentationClean) & RepairAugmentationClean != "None" & str_detect(Procedure4,"rotator cuff repair") ~ "Augmented Cuff Repair",
        (is.na(RepairAugmentationClean) | RepairAugmentationClean == "None") & str_detect(Procedure4,"rotator cuff repair") ~ "Cuff Repair",
        str_detect(Procedure4,"remplissage") ~ "Remplissage",
        !is.na(Procedure4) & str_detect(Procedure4, "(rotator cuff repair)|remplissage", negate = TRUE) ~ "None",
        .default = NA_character_
      ),
      LongHeadBiceps = case_when(
        str_detect(Procedure4,"biceps tenodesis") ~ "Tenodesis",
        str_detect(Procedure4,"biceps transfer") ~ "Transfer",
        str_detect(Procedure4, "tenotomy") ~ "Tenotomy",
        str_detect(Procedure4, "long-head") ~ "Unknown",
        !is.na(Procedure4) & str_detect(Procedure4, "(biceps)(tenotomy|transfer|tenodesis)", negate = TRUE) ~ "None",
        .default = NA_character_
      ),
      Labrum = case_when(
        str_detect(Procedure4,"labrum repair") ~ "Labrum Repair",
        str_detect(Procedure4,"labrum debridement") ~ "Debridement",
        str_detect(Procedure4, "capsulolabral") ~ "Capsulolabral Repair",
        !is.na(Procedure4) & str_detect(Procedure4, "((labrum repair)|debridement)|capsulolabral", negate = TRUE) ~ "None",
        .default = NA_character_
      ),
            LabrumRepair = case_when(
        str_detect(Procedure4,"bankart") ~ "Bankart",
        str_detect(Procedure4,"slap") ~ "SLAP",
        str_detect(Procedure4,"labrum repair") & str_detect(Procedure4, "bankart|slap", negate = FALSE) ~ "Other",
        !is.na(Procedure4) & str_detect(Procedure4, "((labrum repair)|debridement)|capsulolabral", negate = TRUE) ~ "None",
        .default = NA_character_
      ),
      CapsuleLigament = case_when(
        str_detect(Procedure4,"shift") ~ "Capsular Shift",
        str_detect(Procedure4,"(ligament|avulsion) repair") ~ "Repair",
        str_detect(Procedure4,"ligament (debulk|release|debridement)") ~ "Ligament Release",
        str_detect(Procedure4, "capsulotomy") ~ "Capsulotomy",
        str_detect(Procedure4, "capsular reconstruction") | str_detect(RepairAugmentationClean, "Capsular") ~ "Capsular Reconstruction",
        str_detect(Procedure4, "other soft tissue") ~ "Other",
        !is.na(Procedure4) & str_detect(Procedure4, "shift|capsulotomy|release|soft((ligament|avulsion)(repair))", negate = TRUE) & str_detect(RepairAugmentationClean, "Capsular", negate = TRUE) ~ "None",
        .default = NA_character_
      ),
      Glenoid = case_when(
        str_detect(Procedure4,"glenoplasty") ~ "Glenoplasty",
        str_detect(Procedure4,"bristow") ~ "Bristow",
        str_detect(Procedure4,"fixation") & str_detect(Procedure4,"humeral fracture", negate = TRUE) ~ "Fracture fixation",
        str_detect(Procedure4,"latarjet") ~ "Latarjet",
        !is.na(Procedure4) & (str_detect(Procedure4, "glenoplasty|fixation|latarjet|bristow", negate = TRUE) | str_detect(Procedure4,"humeral fracture")) ~ "None",
        .default = NA_character_
      )
      )
```

```{r}
#| label: adjunct-procedures

# Filter out adjunct procedures from proceduremaster and then left_join into proceduremaster2

ProcedureAdjunct <- ProcedureMaster1 |> dplyr::select(-Entry) |> filter(
  str_detect(
    ReplaceProcedure,
    "repair|remplissage|biceps|labrum|capsul*|ligament|soft|gleno*|fixation|latarjet|bristow",
    negate = TRUE)
) |> group_by(
  TreatmentID
) |> distinct(
  ReplaceProcedure,
  .keep_all = TRUE
) |> mutate(
  Entry = str_order(
  ReplaceProcedure
) 
) |> arrange(
  desc(ReplaceProcedure),
  .by_group = TRUE
) |> ungroup()

```

```{r}
#| label: adjunct-proedures-2

# Continue processing to extract out adjunct procedures and reinject back into procedures dataframe
ProcedureMaster3 <- left_join(
  ProcedureMaster2,
  summarise(
  ProcedureAdjunct,
  .by = "TreatmentID",
  AdjunctProcedure = str_c(str_unique(ReplaceProcedure), collapse = "; ")
),
by = "TreatmentID"
) |> mutate(
  AdjunctProcedure2 = stringr::str_to_title(case_when(
   if_any(CuffRepair:Glenoid,~!is.na(.)) & is.na(AdjunctProcedure) ~ "None", 
    if_all(CuffRepair:Glenoid,~is.na(.)) ~ NA_character_,
    .default = AdjunctProcedure
  )
)
) |> mutate(
  across(
    c(
      CuffRepair,
      LongHeadBiceps,
      Labrum,
      CapsuleLigament
      ),
      ~ifelse(. == "None", NA, .))
  ) |> unite(
    "ProcedureTotal",
    c(CuffRepair, LongHeadBiceps, Labrum, CapsuleLigament),
    na.rm = TRUE,
    sep = "; ",
    remove = FALSE
    ) |> mutate(
      ProcedureTotal = ifelse(ProcedureTotal == "", "None", ProcedureTotal)
  ) |> dplyr::select(
  -(c(
    AdjunctProcedure,
    RepairAugmentation,
    RepairAugmentation2,
    RepairAugmentation3
  )
  )
) |> rename(
  AdjunctProcedure = "AdjunctProcedure2",
  RepairAugmentation = "RepairAugmentationClean"
) |> relocate(
  RepairAugmentation,
  .after = CuffRepair
) |> mutate( # switch back to "None" labeling for tables in each report
  across(
    c(
      CuffRepair,
      LongHeadBiceps,
      Labrum,
      CapsuleLigament
      ),
      ~ifelse(is.na(.), "None", .))
  )
```

```{r}
#| label: update-snapshot

# Marry into SnapshotComb to continue processing from one dataframe
#Adjust for labrum procedures

SnapshotComb1a <- left_join(
  SnapshotComb1 |> dplyr::select(
    -(c(
      AdjunctProcedures,
      RepairAugmentation,
      TreatmentGlenoid,
      TreatmentHumeralHead
    ))
    ),
    ProcedureMaster3 |> dplyr::select(
      TreatmentID,
      ProcedureTotal:AdjunctProcedure
    ),
    by = "TreatmentID",
    relationship = "one-to-one"
  ) |> separate_wider_delim(
  cols = LabralTearPosition,
  delim = " - ",
  names = c("TearStart","TearEnd")
) |> mutate(
  TearStart = as.numeric(TearStart),
  TearEnd = as.numeric(TearEnd),
  LabrumPath2 = case_when(
    is.na(TearStart) | is.na(TearEnd) ~ NA_character_,
    (!is.na(TearStart) & !is.na(TearEnd)) & (between(TearStart,1,6) & between(TearEnd,3.9,10)) ~ "Bankart",
    (!is.na(TearStart) & !is.na(TearEnd)) & (between(TearStart,6.1,11.9) & between(TearEnd,6.1,11.9)) ~ "Posterior",
    (!is.na(TearStart) & !is.na(TearEnd)) & (between(TearStart,9.9,12.9) | between(TearStart,0.9,2.1)) & (between(TearEnd,9.9,12.9) | between(TearEnd,0.9,2.1)) ~ "SLAP",
    .default = "Other"
  )
) |> mutate(
  LabrumRepair2 = case_when(
    str_detect(Labrum,"Repair") & LabrumPath2 == "Bankart" ~ "Bankart",
    str_detect(Labrum,"Repair") & LabrumPath2 == "SLAP" ~ "SLAP",
    str_detect(Labrum,"Repair") & LabrumPath2 == "Other" ~ "Other",
    str_detect(Labrum,"Repair") & LabrumPath2 == "SLAP" ~ "SLAP",
    str_detect(Labrum,"Repair") & LabrumPath2 == "Posterior" ~ "Posterior",
    !is.na(LabrumPath2) & (is.na(Labrum)|Labrum == "None") ~ "Not Repaired",
    .default = LabrumRepair
    )
  ) |> relocate(
  c(TearStart,TearEnd,LabrumPath2), .after = "Procedures2"
)   |> relocate(
  c(LabrumRepair2), .after = "LabrumRepair"
) |> dplyr::select(
  -LabrumRepair
) |> rename(
  LabrumRepair = "LabrumRepair2"
)
```

## Adjust dataset for time to event

To account for variations in follow up, time to event was calculated between date of surgery and change of record status. Treatment record end was defined as any change in state such that the treatment would be considered no longer active, has not achieved its clinical purpose or is no longer relevant. For example, in the case of soft tissue repair, if the target tissue represents with a retear, or the construct presents in a state such that hardware removal or replacement is recommended, then the treatment record status is set to inactive and a new treatment record is created to capture the subsequent treatment. The treatments with inactive statuses were extracted to a shared file for review. The subsequent treatment was manually labelled to create the *Subsequent Treatment* variable.

Additional numeric variables were calculated from inputs collected within the registry (e.g. Symptom Duration).

```{r}
#| label: Survival-prep-1
# create endate and survival time

#Calculate status
SnapshotComb2 <- SnapshotComb1a |> mutate(
  Status = case_when(
    TreatmentStatus == "Failed"~ 1,
    .default = 0),
  EndDate = case_when(
    !is.na(DateStatusChange) ~ DateStatusChange,
    .default = coalesce(DateStatusChange, SnapshotDate)
  ),
  Duration = as.numeric(as.duration(interval(ymd(DateTreatment), ymd(EndDate))),"weeks"),
        WaitTime = as.numeric(as.duration(interval(ymd(DateInitialExamination), ymd(DateTreatment))),"weeks"),
 CuffTearSizeML = as.numeric(CuffTearSizeML),
 CuffTearSizeAP = as.numeric(CuffTearSizeAP),
 SymptomDuration = as.numeric(as.duration(interval(ymd(DateOfInjury_Preop), ymd(DateTreatment))),"weeks"),
 SymptomDurationCat = case_when(
  is.na(SymptomDuration) ~ NA_character_,
  SymptomDuration <= 26 ~ "<=0.5",
  SymptomDuration > 26 ~ ">0.5"
) 
 )

SnapshotCombFail <- SnapshotComb2 |> dplyr::filter(
  TreatmentStatus == "Failed",
  SurgicalTreatment == "Surgical"
)

# |> dplyr::mutate(
#   factor(levels = c("<=0.5", ">0.5"), exclude = NULL)
```

```{r}
#| label: write-failures
#| eval: false
#| include: false

# Authenticate for sheets using the same token
gs4_auth(token = drive_token())




with_gs4_quiet(googlesheets4::range_write(
  ss = SheetIDs$AuditResults,
  data = SnapshotCombFail |> dplyr::select(
    TreatmentID,
    CombID,
    DateTreatment,
    Cohort,
    TreatmentStatus,
    TreatmentStatusNotes,
    DateStatusChange
    ) |> dplyr::arrange(
     desc(DateTreatment)
    ),
  sheet = "Failures",
  range = "A1:G",
  col_names = TRUE
)
)
```

Read in results of manual review of failure cases and categorise subsequent treatments.

```{r}
#| label: identify-subsequent

SnapshotSubseq <- SnapshotComb2 |> dplyr::filter(
  CombID %in% SnapshotCombFail$CombID
) |> dplyr::select(
  TreatmentID,
  CombID,
  DateTreatment,
  TreatmentStatus,
  TreatmentStatusNotes,
  DateStatusChange,
  SurgicalTreatment
) |> dplyr::group_by(
  CombID
) |> arrange(
  CombID,
  DateTreatment,
  by_group = FALSE
)


```

```{r}
#| label: retrieve-revisions
#| eval: true

# Authenticate for sheets using the same token
gs4_auth(token = drive_token())

SnapshotRevision <- googlesheets4::range_read(
  ss = SheetIDs$AuditResults,
  sheet = "Failures",
  range = "A1:H",
  col_types = "ccDcccDc"
)

SnapshotComb2a <- left_join(
  SnapshotComb2,
  SnapshotRevision |> dplyr::select(
    TreatmentID,
    SubsequentTx
  ),
  by = "TreatmentID"
) |> mutate(
  SubsequentTx2 = case_when(
    is.na(SubsequentTx) ~ "Not Applicable",
    str_detect(SubsequentTx,"ROH") ~ str_replace_all(SubsequentTx,"ROH","Removal of Hardware"),
    str_detect(SubsequentTx,"Non-op") ~ "Nonoperative Management",
    .default = stringr::str_to_title(SubsequentTx)
  ),
    ReoperationProcedure2 = case_when(
      is.na(ReoperationProcedure) & (SubsequentTx2 == "Nonoperative Management" | SubsequentTx2 == "Not Applicable")  ~ "No",
      is.na(ReoperationProcedure) & !(SubsequentTx2 == "Nonoperative Management" | SubsequentTx2 == "Not Applicable") ~ "Yes",
      ReoperationProcedure == "No" & !(SubsequentTx2 == "Nonoperative Management" | SubsequentTx2 == "Not Applicable") ~ "Yes",
      .default = ReoperationProcedure
    )
)

SnapshotCombCheck <- SnapshotComb2a |> dplyr::select(
  TreatmentID,
  Cohort,
  TreatmentStatus,
  TreatmentStatusNotes,
  ReoperationProcedure2,
  SubsequentTx
)

```



## Prepare product groups of interest

Tables were rearranged and the dataset was filtered against an ignore list created from the product configuration table. Regular expressions were used to match products of interest to intraoperative hardware information and to sum the instances of implantation for each product of interest.

```{r}
#| label: product-usage-1

#Extract cases with Mitek and remove ignore list

ProductUsage1 <- SnapshotComb2a |> dplyr::select(TreatmentID,ImplantCodes) |> filter(grepl("10886",ImplantCodes))

# Trim whitespace
ProductUsage1$ImplantCodes <- trimws(ProductUsage1$ImplantCodes)

#Pivot long so each Product code is on its own row

# Link back to ProductTable and bring back model description and count models rather than SKUs
ProductUsage2 <- separate_longer_delim(
    ProductUsage1,
    cols = ImplantCodes,
    ", ") |>
  left_join(
    dplyr::select(
      ProductTable,
      Reference,
      Description),
join_by("ImplantCodes"=="Reference")
    ) |>  dplyr::mutate(
    CustomUID = stringr::str_remove_all(paste0(Description,"_",TreatmentID,sep=""),"\\([^\\)]+\\)")
  ) |> filter(
  !(ImplantCodes %in% RefIgnore$ImplantIgnore)
  )
```


 Identify the problematic codes that are not linking back to the ProductTable correctly

```{r}
#| label: product-tracking-write
#| eval: false
#| include: false

# Authenticate for sheets using the same token
gs4_auth(token = drive_token())

# Do the write operation silently
if (nrow(ProductUsage2 |> filter(is.na(Description)) |> arrange(ImplantCodes)) < 1) {
  invisible(
    googlesheets4::range_write(
      ss = SheetIDs$AuditReport,
          data = ProductUsage2 |> filter(is.na(Description)) |> arrange(ImplantCodes),
          sheet = "ImplantTracking",
          range = "A1:D",
          col_names = TRUE
    )
  )
}

```

```{r}
#| label: product-tracking-display

{if_else(nrow(ProductUsage2 |> filter(is.na(Description)) |> arrange(ImplantCodes)) < 1,
        "There are no cases to flag for discrepancies.", 
        "Discrepancies identified have been added to external table."  # Empty string when data exists
)
}
```


```{r}
#| label: product-usage-summary

ProductUsage3 <- ProductUsage2 |> distinct(CustomUID, .keep_all = TRUE) |> filter(grepl("10886",ImplantCodes)) |>
  rowwise() |>
   mutate( #Swap around paste0 of TreatmentID and Description so that str_count doesnt overlap for customUIDs with other UIDs
    CustomUID = str_remove_all(paste0(Description,"_",TreatmentID,sep=""),"\\([^\\)]+\\)")
  ) |>
  rowwise() |>
  mutate(
  ProductCount = sum(str_count(ProductUsage2$CustomUID, CustomUID))
  ) |>
  arrange(TreatmentID,desc(ProductCount), by_group = TRUE) |>
  mutate(
  UsageDesc = str_remove_all(paste0(ProductCount," x ",Description,sep=""),"\\([^\\)]+\\)")
  ) |>
  group_by(TreatmentID) |>
  top_n(4, ProductCount) |>
  arrange(TreatmentID, desc(ProductCount)) |>
  mutate(ProductNum = paste0("Product", row_number())) |> ungroup() |>
  pivot_wider(
    id_cols = TreatmentID,
    names_from = ProductNum,
    values_from = UsageDesc
  )

```

```{r}
#| label: update-snapshot-procedure

# Count unique substrings row-wise
SnapshotComb3 <- left_join(
  SnapshotComb2a,
  dplyr::select(
    ProductUsage3,
    TreatmentID,
    Product1,
    Product2,
    Product3,
    Product4), 
  by = "TreatmentID"
  )

```

## Adjust patient demographics for presentation

Recode Sex for report presentation.

```{r}
#| label: update-snapshot-sex


SnapshotComb4 <- SnapshotComb3 |> mutate(
  Sex2 = case_when(
    Sex == "F" ~ "Female",
    Sex == "M" ~ "Male",
    .default = NA_character_
  )
) |> dplyr::select(-Sex) |> rename(
  Sex = "Sex2"
)
```

## Prepare patient-reported outcomes

The PRULO registry uses the QuickDASH [@gummesson2006] for all cases, Western Ontario Rotator Cuff Index (WORC) [@kirkley2003] for records placed into the Rotator Cuff cohort and the Western Ontario Shoulder Instability Index (WOSI) [@kirkley1998] for records placed in the Glenohumeral Instability cohort to monitor patient-reported outcomes before and after surgery at defined time intervals. The metrics utilised for each questionnaire in this report are the total score (QuickDaSH) and the normalised total score (WORC and WOSI). A single question from the WORC was also presented (Question 3 of the Physical subscale) that asks "How much weakness do you experience in your shoulder?" to observe potential patterns relevant specifically to cuff repair. PROMs entries were restricted to cases where the treatment record was "eligible" for the time point. Tables were reshaped and variables refactored, with delta variables generated (difference to baseline at each followup) to enable plotting and table generation.

```{r}
#| label: proms-prep
#| code-summary: "Prepare for PROMs analysis"
#| warning: false

#Add delta columns Pre-3months; Pre-6months; Pre-12months

SnapshotPROM <- SnapshotComb4 |>
  rename_with( ~sub("_TotalScore_","",.), contains("TotalScore")) |>
  rename_with( ~sub("WOSI_Norm_","WOSINorm",.), contains("WOSI_Norm")) |>
  rename_with( ~sub("WORC_Norm_","WORCNorm",.), contains("WORC_Norm")) |>
  rename_with( ~sub("PhysicalQ3_","PhysicalQ3",.), contains("PhysicalQ3")) |>
  rename_with( ~sub("EligibleAt|EligibleAtx", "Eligible",.), starts_with("EligibleAt")) |>
  mutate(
  across(matches("QDASH|WORC|WOSI"),as.numeric)
  ) |>
  dplyr::select(
    !c(
    RegistryStatus:DateOfBirth, 
    DominantSide, 
    Weight,
    Height,
    DateBMI,
    EligibleIntraop,
    RecordNumberInIntraop,
    tidyselect::ends_with("24months")
    )
    ) |>
  relocate((all_of(c("QDASHPreop",
                        "QDASH3months",
                        "QDASH6months",
                        "QDASH12months",
                        "EligiblePreop",
                        "Eligible3months",
                        "Eligible6months",
                        "Eligible12months"))), .after = last_col(),
           ) |>
mutate(
  Eligible3months = case_when(
    Eligible3months != "Yes" ~ NA_character_,
    .default = Eligible3months
  ),
  DeltaQPreop = NA,
  DeltaQ3months = case_when(
    (EligiblePreop == "Yes" & !is.na(QDASHPreop)) & (Eligible3months == "Yes" & !is.na(QDASH3months)) ~ QDASHPreop - QDASH3months,
    .default = NA
  ),
   DeltaQ6months = case_when(
    (EligiblePreop == "Yes" & !is.na(QDASHPreop)) & (Eligible6months == "Yes" & !is.na(QDASH6months)) ~ QDASHPreop - QDASH6months,
    .default = NA
  ),
   DeltaQ12months = case_when(
    (EligiblePreop == "Yes" & !is.na(QDASHPreop)) & (Eligible12months == "Yes" & !is.na(QDASH12months)) ~ QDASHPreop - QDASH12months,
    .default = NA
  ),
  WORCDeltaPreop = NA,
  WORCDelta6months = case_when(
    (EligiblePreop == "Yes" & !is.na(WORCNormPreop)) & (Eligible6months == "Yes" & !is.na(WORCNorm6months)) ~ WORCNorm6months - WORCNormPreop,
    .default = NA
  ),
   WORCDelta12months = case_when(
    (EligiblePreop == "Yes" & !is.na(WORCNormPreop)) & (Eligible12months == "Yes" & !is.na(WORCNorm12months)) ~ WORCNorm12months - WORCNormPreop,
    .default = NA
  ),
  WOSIDeltaPreop = NA,
  WOSIDelta3months = case_when(
    (EligiblePreop == "Yes" & !is.na(WOSINormPreop)) & (Eligible3months == "Yes" & !is.na(WOSINorm3months)) ~ WOSINormPreop - WOSINorm3months - WOSINormPreop,
    .default = NA
  ),
  WOSIDelta6months = case_when(
    (EligiblePreop == "Yes" & !is.na(WOSINormPreop)) & (Eligible6months == "Yes" & !is.na(WOSINorm6months)) ~ WOSINorm6months - WOSINormPreop,
    .default = NA
  ),
   WOSIDelta12months = case_when(
    (EligiblePreop == "Yes" & !is.na(WOSINormPreop)) & (Eligible12months == "Yes" & !is.na(WOSINorm12months)) ~ WOSINorm12months - WOSINormPreop,
    .default = NA
  ),
  )

```

```{r}
#| label: proms-pivot-check
#| eval: false
# Check the lengths of columns specified in varying



QDASH_cols <- grep("QDASH", colnames(SnapshotPROM), value = TRUE)
DeltaQ_cols <- grep("DeltaQ", colnames(SnapshotPROM), value = TRUE)
WORC_cols  <- grep("WORCNorm|WORCPhysicalQ3|WORCDelta", colnames(SnapshotPROM), value = TRUE)
WOSI_cols  <- grep("WOSINorm|WOSIDelta", colnames(SnapshotPROM), value = TRUE)
Eligible_cols <- grep("Eligible", colnames(SnapshotPROM), value = TRUE)

lengths_QDASH <- sapply(QDASH_cols, function(col) length(unique(SnapshotPROM$TreatmentID)))
lengths_DeltaQ <- sapply(DeltaQ_cols, function(col) length(unique(SnapshotPROM$TreatmentID)))
lengths_WORC <- sapply(WORC_cols, function(col) length(unique(SnapshotPROM$TreatmentID)))
lengths_WOSI <- sapply(WOSI_cols, function(col) length(unique(SnapshotPROM$TreatmentID)))

lengths_Eligible <- sapply(Eligible_cols, function(col) length(unique(SnapshotPROM$TreatmentID)))

```

```{r}
#| label: PROM-prep-DASHWOSI

SnapshotPROM1 <- SnapshotPROM |>
  pivot_longer(
    cols = c(
      starts_with("QDASH"),
      starts_with("DeltaQ"),
      starts_with("WOSINorm"),
      starts_with("WOSIDelta"),
      starts_with("Eligible")
    ),
    names_to = c(".value", "Timepoint"),
    names_pattern = "(.+)(Preop|3m|6m|12m)",
    values_to = c("QDASH", "QDASHDelta", "WOSINorm", "WOSIDelta", "Eligible")
  ) |>
  mutate(Timepoint = forcats::fct(
    Timepoint, 
    levels = c("Preop", "3m", "6m", "12m"))
    ) |> filter(!is.na(Eligible)) |> rename(
      QDASHDelta = "DeltaQ"
    )

```

```{r}
#| label: PROM-prep-WORC

SnapshotPROM2 <- SnapshotPROM |>
  pivot_longer(
    cols = c(
      starts_with("WORCNorm"),
      starts_with("WORCDelta"),
      starts_with("WORCPhysicalQ3"),
      starts_with("Eligible")
    ),
    names_to = c(".value", "Timepoint"),
    names_pattern = "(.+)(Preop|6m|12m)",
    values_to = c("WORCNorm","WORCDelta","WOSIPhysicalQ3", "Eligible")
  ) |>
  mutate(Timepoint = forcats::fct(
    Timepoint, 
    levels = c("Preop", "6m", "12m"))
    ) |> filter(!is.na(Eligible))

```


## Prepare adverse events

Adverse events were monitored by near real-time chart review and surgical bookings. Events were added to the registry using an electronic form and linked to the treatment records. The data import was assessed for data entry validity, differences between date of event, date of reoperation and surgery date of the index treatment were calculated to assess date validity. Additional data preparation and cleaning was performed, which included filtering and standardizing key identifiers across multiple datasets. Missing values were identified to ensure data consistency. The adverse events were attached to the treatment data with filters applied to constrain to pertinent records and time periods. Time-based metrics were calculated and classification was performed based on the event descriptions using regular expressions. Finally, it conducted data quality checks, identifying potential discrepancies and duplicate entries. After the data transformation, the revised dataset was exported to an external file for review. The code then generated multiple subset datasets, each focusing on a specific type of complication and isolating the earliest occurrence for each unique treatment. This was used for retrieval for each product report.


```{r}
#| label:  complications-intraop
# Slice out intraoperative complications (explants)
# 
# 
IntraopComp <- SnapshotComb4 |> dplyr::select(
  TreatmentID,
  CombID,
  DateTreatment,
  SurgicalTreatment,
  TreatmentStatus,
  ICCount:ICIntervention
) |> filter(
  !is.na(ICCount)
) |> mutate(
  ICNature2 = if_else(
    stringr::str_detect(ICNature,"explant"),
    "Hardware explantation",
    ICNature
  )
)

```



```{r}
#| label:  Complications-postop
# Join sufficient columns to complictable to perform calculations


# Add filter to align complications table with snapshot with CurrentDate
ComplicTable1 <- ComplicTable |> dplyr::filter(
    `Date of Occurrence` < SnapshotDate
    ) |>
  mutate(
    TreatmentID = trimws(`Treatment ID`)
  )

#Tidy up TreatmentID in both tables
# Remove leading and trailing whitespaces

SnapshotComb2a$TreatmentID <- trimws(SnapshotComb2a$TreatmentID)
# Check data types
#str(ComplicTable1$TreatmentID)
#str(SnapshotComb2$TreatmentID)

#str(SnapshotComb2$DateTreatment)

# Check for NAs in ComplicTable1
na_in_ComplicTable1 <- sum(is.na(ComplicTable1$TreatmentID))


# Check for NAs in SnapshotMerge2
na_in_SnapshotComb2a <- sum(is.na(SnapshotComb2a$TreatmentID))

```



```{epoxy}
#| eval: false

There are {nrow(SnapshotComb2a |> filter(is.na(TreatmentID)))} cases with missing TreatmentID in the dataset and {nrow(ComplicTable1 |> filter(is.na(TreatmentID)))} missing in the complications table.

```

<!--# Clean up live tables for complications. Assess date validity and correct data entry. -->

```{r}
#| label: clean-complications

mismatched_rows <- ComplicTable1[!(ComplicTable1$TreatmentID %in% SnapshotComb2$TreatmentID), ]

# Remove non-matching rows from ComplicTable2
ComplicTable2 <- ComplicTable1 |>
  filter(!(TreatmentID %in% mismatched_rows$TreatmentID))
```

```{r}
#| label: recode-complications

# Join in key data from Snapshot table to calculate additional columns
ComplicTable3 <- left_join(
  ComplicTable2,
  SnapshotComb2a |> dplyr::select(
  TreatmentID,
  DateStatusChange,
  DateTreatment,
  ICCount:ICIntervention
  ),
  by = "TreatmentID"
) |> 
  filter(
    !is.na(DateTreatment) & `Complication Occurrence` != "No"
  ) |>
  mutate(
    DateOccurFix = ymd(`Date of Occurrence`),
  ) |>
mutate(
  EventDelay = as.numeric(as.duration(interval(ymd(DateTreatment), ymd(DateOccurFix))),"weeks"), # Mitek would like this in years - may need to change over once intiial review is complete
  ReopDelay_Surgery = as.numeric(difftime(`Reoperation Procedure Date`,DateTreatment,units = "weeks")),
  ReopDelay_Occur = as.numeric(difftime(`Reoperation Procedure Date`,DateOccurFix,units = "weeks")),
DateCheck = case_when(
  `Date of Occurrence` < DateTreatment ~ "Check",
  .default = "OK"
),
  Infection = case_when(
    stringr::str_detect(stringr::str_to_lower(`Complication Nature`),"washout|infect|antibiotic*|vac.*dress*|culture") ~ "Yes", #added "culture" as term for Infection
    .default = "No",
  ),
  Ligament_Tendon = case_when(
    stringr::str_detect(stringr::str_to_lower(`Complication Nature`),"fail|recurrent|rupture|retear|.*torn|weak|weakness|tear") ~ "Yes", #removed enthesopathy, as those kind of connective tissue pathologies will make it difficult to distinguish from retears in this framework - pushed to Other. 
    .default = "No"
    ),
  Stiffness = case_when(
    stringr::str_detect(stringr::str_to_lower(`Complication Nature`),"capsulitis|frozen|stiff*|release|arthrofib*") ~ "Yes", #removed "carpal tunnel release" as a term for "Stiffness" as it was previously overlapping with other types of releases
    .default = "No"
    ),
  Loosening = case_when(
   stringr::str_detect(stringr::str_to_lower(`Complication Nature`),"regraft*|loos(?!e\\sbodies)|pullout") ~ "Yes",
    .default = "No"
    ),
  Hardware = case_when(
   stringr::str_detect(stringr::str_to_lower(`Complication Nature`),"remov*|irritat*|explant*|broke*|annoy*|device|replac*") ~ "Yes", 
   .default = "No"
  ),
  Instability = case_when(stringr::str_detect(stringr::str_to_lower(`Complication Nature`),"instab*|sublux*|disloc*") ~ "Yes",
    .default = "No"
  ),
  Neurological = case_when(
    stringr::str_detect(stringr::str_to_lower(`Complication Nature`),"palsy|radiculopathy|carpal\\s+tunnel") ~ "Yes", #added carpal tunnel compression or release as a potential neurological condition
    .default = "No"
  ),
  Fracture = case_when(
    stringr::str_detect(stringr::str_to_lower(`Complication Nature`),"fract*") ~ "Yes",
    .default = "No"
  ),
  Wound = case_when(
    stringr::str_detect(stringr::str_to_lower(`Complication Nature`),"wound|necro*") ~ "Yes",
    .default = "No"
  ),
  Thrombosis = case_when(
    stringr::str_detect(stringr::str_to_lower(`Complication Nature`),"dvt|embo*|\\bpe\\b|occlus*") ~ "Yes",
    .default = "No"
  ),
  Effusion = case_when(
    stringr::str_detect(stringr::str_to_lower(`Complication Nature`),"swell*|edema|oedema|effus*|swollen") ~ "Yes",
    .default = "No"
  ),
  Pain = case_when(
    stringr::str_detect(stringr::str_to_lower(`Complication Nature`),"pain|complex|crps") ~ "Yes", #previously had word boundary - but got excluded when hard up against ";" so removed word boundaries
    .default = "No"
  )
) |>
  rowwise() |>
  mutate(
    Other = case_when(
      any(str_detect(c_across(Infection:Pain),"Yes")) ~ "No",
      .default = "Yes"
    ),
    PainIsol = case_when(
      any(str_detect(c_across(Infection:Effusion),"Yes")) | Other == "Yes" ~ "No",
      all(str_detect(c_across(Infection:Effusion),"No")) & Other == "No" & Pain == "Yes" ~ "Yes",
      .default = NA_character_
    )
  )
```

```{r}
#| label: review-complications

ComplicFailCheck <- ComplicTable3 |> filter(
  !is.na(DateStatusChange)
) |> mutate(
  StatusDiff = ymd(DateStatusChange) - ymd(`Date of Occurrence`)
) |> relocate(
  StatusDiff,
  .after = DateStatusChange
) |> group_by(
  TreatmentID
) |> slice_max(
  `Date of Occurrence`
)

```

```{r}
#| label: Write-complications
#| eval: true
#| include: false

# Authenticate for sheets using the same token
gs4_auth(token = drive_token())

with_gs4_quiet(googlesheets4::range_write(
  ss = SheetIDs$AuditResults,
  data = ComplicTable3,
  sheet = "ComplicTable",
  range = "A1:AO",
  col_names = TRUE
)
)
```

Split out into arrays to bounce against for each Product report

```{r}

ComplicInfection <- ComplicTable3 |> dplyr::group_by(TreatmentID) |> filter(Infection == "Yes") |> slice_min(DateOccurFix, n = 1) |> ungroup()
ComplicLigament_Tendon <- ComplicTable3 |> group_by(TreatmentID) |> filter(Ligament_Tendon == "Yes") |> slice_min(DateOccurFix, n = 1) |> ungroup()
ComplicStiffness <- ComplicTable3 |> group_by(TreatmentID) |> filter(Stiffness == "Yes") |> slice_min(DateOccurFix, n = 1) |> ungroup()
ComplicLoosening <- ComplicTable3 |> group_by(TreatmentID) |> filter(Loosening == "Yes") |> slice_min(DateOccurFix, n = 1) |> ungroup()
ComplicHardware <- ComplicTable3 |> group_by(TreatmentID) |> filter(Hardware == "Yes" & Loosening == "No") |> slice_min(DateOccurFix, n = 1) |> ungroup()
ComplicInstability <- ComplicTable3 |> group_by(TreatmentID) |> filter(Instability == "Yes") |> slice_min(DateOccurFix, n = 1) |> ungroup()
ComplicNeurological <- ComplicTable3 |> group_by(TreatmentID) |> filter(Neurological == "Yes") |> slice_min(DateOccurFix, n = 1) |> ungroup()
ComplicFracture <- ComplicTable3 |> group_by(TreatmentID) |> filter(Fracture == "Yes") |> slice_min(DateOccurFix, n = 1) |> ungroup()
ComplicThrombosis <- ComplicTable3 |> group_by(TreatmentID) |> filter(Thrombosis == "Yes") |> slice_min(DateOccurFix, n = 1) |> ungroup()
ComplicEffusion <- ComplicTable3 |> group_by(TreatmentID) |> filter(Effusion == "Yes") |> slice_min(DateOccurFix, n = 1) |> ungroup()
ComplicPain <- ComplicTable3 |> group_by(TreatmentID) |> filter(PainIsol == "Yes") |> slice_min(DateOccurFix, n = 1) |> ungroup()
ComplicOther <- ComplicTable3 |> group_by(TreatmentID) |> filter(Other == "Yes") |> slice_min(DateOccurFix, n = 1) |> ungroup()
ComplicReop <- ComplicTable3 |> group_by(TreatmentID) |> filter(`Reoperation Procedure` == "Yes") |> slice_min(DateOccurFix, n = 1) |> ungroup()


```

<!--# Review intraoperative complications manually for mechanism -->

Intraoperative complications were reviewed manually for mechanism.

```{r}
#| label: Complication-discrepancies
#| eval: true
#| include: false

# Authenticate for sheets using the same token
gs4_auth(token = drive_token())

ComplicDiscrep <- ComplicTable3 |> filter(
  DateCheck == "Check"|
    is.na(`Complication Nature`)|
    (`Reoperation Procedure` == "Yes" & `Complication Occurrence` == "No")
)

#Identify duplicate entries
ComplicDiscrep2 <- ComplicTable3 |>
  group_by(TreatmentID, DateOccurFix) |>
  filter(n() > 1)

# Identify the problematic codes that are not linking back to the ProductTable correctly

with_gs4_quiet(googlesheets4::range_write(
  ss = SheetIDs$AuditResults,
  data = bind_rows(ComplicDiscrep,ComplicDiscrep2) |> arrange(TreatmentID),
  sheet = "ComplicDiscrepancy",
  range = "A1:AO",
  col_names = TRUE
)
)


```

```{r}
#| label: Complications-missing
#| eval: true
#| include: false


# Authenticate for sheets using the same token
gs4_auth(token = drive_token())

# Comment out after first use
 # range_write(ComplicTable4,
 #             ss = "https://docs.google.com/spreadsheets/d/1e7431oSrK9tItiSZb4wCWPI7nqGqawH8pNgnqgHPNkU/edit",
 #             sheet = "ComplicDiscrepancy2",
 #             range = "A1:AC")

 with_gs4_quiet(range_write(SnapshotComb2a |>
               filter(SurgicalTreatment == "Surgical" & is.na(ComplicationOccurrence)) |>
               dplyr::select(TreatmentID,DateTreatment),
             ss = SheetIDs$AuditResults,
             sheet = "ComplicMissing",
            range = "A1:C")
 )
```


# PRULO Summary

The diagram below summarises recruitment and categorisation of patients into the PRULO registry.

```{r}
#| label: strobe-prep
#| code-summary: "CONSORT|STROBE"

# Inclusion
# - Surgical treatment
# - With hardware of interest
# After "induction"
# - Patient withdraws consent
# - Treatment fails before analysis date
# - Not eligible for 12m followup
# 

STROBEFlow <- STROBEInput |> dplyr::filter(
  !is.na(TreatmentID)
) |> dplyr::left_join(
  SnapshotComb1 |> dplyr::select(
    TreatmentID,
    CombID,
    DateInitialExamination,
    EligibleAtPreop,
    EligibleAtx3months,
    EligibleAtx12months
  ),
  by = "TreatmentID"
) |> dplyr::mutate(
  DurationTotal = as.numeric(as.duration(interval(ymd(DateTreatment), ymd(SnapshotDate))),"days"),
  exclusion1 = case_when(
    is.na(SurgicalTreatment) ~ "Not a surgical treatment",
    SurgicalTreatment == "Surgical" ~ NA_character_,
    .default = "Not a surgical treatment"
  ),
  exclusion2 = case_when(
    is.na(exclusion1) & stringr::str_detect(RegistryStatus,"Opt-out") ~ "Patient Opt-Out",
    is.na(exclusion1) & stringr::str_detect(ImplantCodes,"10886") ~ NA_character_,
    #is.na(exclusion1) & Surgeon != "RP" ~ "Other Surgeon",
    is.na(exclusion1) & stringr::str_detect(ImplantCodes,"10886*", negate = TRUE) ~ "No hardware of interest"
  ),
  followup = if_else(
    is.na(exclusion1) & is.na(exclusion2),
    TreatmentID,
    NA_character_
  ),
  lost_followup = case_when(
    is.na(exclusion1) & is.na(exclusion2) & TreatmentStatus == "Failed" & (ymd(DateStatusChange) < ymd(SnapshotDate)) ~ "Repair failure",
    is.na(exclusion1) & is.na(exclusion2) & TreatmentStatus == "No further followup" & (ymd(DateStatusChange) < ymd(SnapshotDate)) ~ "Patient Opt-out",
    is.na(exclusion1) & is.na(exclusion2) & TreatmentStatus == "Ongoing" & is.na(EligibleAtx3months) ~ "Not eligible for followup"
  ),
  mitt = if_else(
    !is.na(followup) & is.na(lost_followup),
    TreatmentID,
    NA_character_
)
) |> dplyr::rename(
  trialno = "TreatmentID",
  arm3 = "RegistryCohortName"
)


```

```{r}
#| label: fig-strobe
#| fig-cap: "Flowchart of extraction and followup of sample from the Registry"

STROBEPlot <- consort::consort_plot(
  data = STROBEFlow,
  orders = c(
    trialno = "Population",
    exclusion1 = "Excluded",
    trialno = "Received Surgery",
    exclusion2 = "Excluded from Sample",
    followup = "Study Sample at Baseline",
    arm3 = "Diagnostic Group",
    lost_followup = "Unavailable 3m",
    mitt = "Final Analysis"),
side_box = c(
  "exclusion1", 
  "exclusion2",
  "lost_followup"
  ),
allocation = "arm3",
cex = 0.7
)

knitr::knit_print(STROBEPlot)
```

```{r}
#| label: tbl-diagnosis
#| tbl-cap: "Summary of diagnoses using ICD-10 coding for primary presentation"

DiagnosisData <- SnapshotComb4 |> dplyr::filter(
  TreatmentID %in% STROBEFlow$followup
) |> mutate(
    ICD10 = stringr::str_extract(DiagnosisPrimary,"^[A-Za-z]+[0-9.]+")
  )

TableData <- DiagnosisData |> group_by(
           Cohort
           ) |> count(
             ICD10, 
             sort = TRUE
             ) |> slice_head(n = 5) 

knitr::kable(TableData)


```

The table below summarises patient diagnoses in the PRULO registry. The primary pathology for a given presentation was derived from clinical notes and labelled with an ICD-10 (international) code. Each code was included in a configuration file to link to a registry cohort.

```{r}
#| label: tbl-surgical
#| tbl-cap: "Summary of PRULO surgical cases by cohort"

TableRepB <-
  SnapshotComb4 |> mutate(
    SurgeonA = case_when(
    Surgeon == "KE" ~ "A",
    Surgeon == "RP" ~ "B",
    Surgeon == "GB" ~ "C",
    .default = NA_character_
  )) |>
  filter(SurgicalTreatment == "Surgical" &
          !grepl("Pending",TreatmentStatus)) |>
  dplyr::select(
    AgeAtInitialExam, 
    Sex,
    Cohort,
    IndexSide,
    BilateralStatus,
    SymptomDuration,
    SymptomDurationCat,
    #SurgeonA,
    TreatmentStatus,
    RegistryStatus
    ) |>
    tbl_summary(
      by = "Cohort",
      label = list(
        #SurgeonA ~ "Surgeon",
        AgeAtInitialExam ~ "Age at Initial Consultation (Years)",
        Sex = "Male",
        BilateralStatus ~ "Bilateral Presentation",
        IndexSide ~ "Dominant Side",
        TreatmentStatus ~ "Treatment Record Active",
        RegistryStatus ~ "Patient Record Active",
        SymptomDuration ~ "Symptom Duration (Weeks)",
        SymptomDurationCat ~ "Symptom Duration Category"
      ),
      type = list(
        Sex ~ "dichotomous",
        TreatmentStatus ~ "dichotomous"
      ),
      value = list(
        Sex = "Male",
        IndexSide = "Dominant",
        TreatmentStatus = "Ongoing",
        RegistryStatus = "Open"
      ),
      statistic = list(
        all_categorical() ~ "{p} ({n})"
        ),
      missing = "no"
    ) |> add_stat_label(
    location = "column"
  ) |> add_overall() |> modify_table_styling(
      columns = label,
      rows = label == "Symptom Duration Category",
      footnote = "Dichotomised below or equal to 0.5 years or greater than 0.5 years"
  ) |> modify_table_styling(
      columns = label,
      rows = label == "Treatment Record Active",
      footnote = "Treatment record remains active - no change to follow up"
  ) |> modify_table_styling(
      columns = label,
      rows = label == "Patient Record Active",
      footnote = "Patient record remains open - no change to consent or mortality status"
  ) 

gtsummary::as_flex_table(TableRepB) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.15,
  align = "center",
  opts_word = list(
    split = TRUE
    )
  )

```

<!--# Removed SymptomDurationCat - turning it into a factor was problematic when constructing the summary table with gtsummary-->

The overall registry enrolment is summarised in @tbl-surgical, describing how the population is summarised into cohorts.

# Product Report 1 - Healix Advance PEEK with Dynacord

## Sample Selection

The sample of patients with the relevant product group were identified and data were retrieved for analysis by matching registry records to the relevant stock keeping units (SKUs) for the product group of interest. Usage statistics for the product group were added, and adverse events data were attached. Patient-reported data were retrieved and the dataset was manipulated to include relevant details for procedures of interest.

```{r}
#| label: Reference-Code-Rep1

RefCode1 <- ProductTable |> filter(
  Category == "Anchor + Suture" &
  stringr::str_detect(stringr::str_to_lower(Description),"advance") &
  stringr::str_detect(stringr::str_to_lower(Description),"peek") &
  stringr::str_detect(stringr::str_to_lower(Description),"dynacord") &
  stringr::str_detect(stringr::str_to_lower(Description),"healix")  
)

```

```{r}
#| label:  Slice-stack-Rep1


Pattern1 <- "(healix advance peek dynacord)"

SelectRep1 <- SnapshotComb4 |> 
  filter(
    str_detect(ImplantCodes,paste(RefCode1$Reference,collapse = "|"))
  ) |> mutate(
    Product1Check = stringr::str_detect(stringr::str_to_lower(Product1),Pattern1),
    Product2Check = stringr::str_detect(stringr::str_to_lower(Product2),Pattern1),
    Product3Check = stringr::str_detect(stringr::str_to_lower(Product3),Pattern1),
    Product4Check = stringr::str_detect(stringr::str_to_lower(Product4),Pattern1)
  ) |> mutate(
    Product1Count = case_when(
      Product1Check == TRUE ~ stringr::str_extract(Product1,"\\d"),
      .default = NA
    ),
    Product2Count = case_when(
      Product2Check == TRUE ~ stringr::str_extract(Product2,"\\d"),
      .default = NA
    ),
    Product3Count = case_when(
      Product3Check == TRUE ~ stringr::str_extract(Product3,"\\d"),
      .default = NA
    ),
    Product4Count = case_when(
      Product4Check == TRUE ~ stringr::str_extract(Product4,"\\d"),
      .default = NA
      )
    ) |> mutate(
      across(Product1Count:Product4Count,~as.numeric(.))
    ) |> rowwise() |> mutate(
    ProductCount =  sum(across(Product1Count:Product4Count), na.rm = TRUE)
      ) |> mutate(
        ProductCountFct = forcats::fct(
            as.character(ProductCount),
            levels = c("1","2","3","4","5")
          )
        ) |> mutate(
  Infection = TreatmentID %in% ComplicInfection$TreatmentID,
  Ligament_Tendon = TreatmentID %in% ComplicLigament_Tendon$TreatmentID,
  Stiffness = TreatmentID %in% ComplicStiffness$TreatmentID,
  Loosening = TreatmentID %in% ComplicLoosening$TreatmentID,
  Hardware = TreatmentID %in% ComplicHardware$TreatmentID,
  Instability = TreatmentID %in% ComplicInstability$TreatmentID,
  Neurological = TreatmentID %in% ComplicNeurological$TreatmentID,
  Fracture = TreatmentID %in% ComplicFracture$TreatmentID,
  Thrombosis = TreatmentID %in% ComplicThrombosis$TreatmentID,
  Effusion = TreatmentID %in% ComplicEffusion$TreatmentID,
  Pain = TreatmentID %in% ComplicPain$TreatmentID,
  Other = TreatmentID %in% ComplicOther$TreatmentID,

  Reop = TreatmentID %in% ComplicReop$TreatmentID
) |> left_join(
  ComplicTable3 |> 
    group_by(TreatmentID) |>
    slice_max(
      ymd(`Reoperation Procedure Date`), 
      n = 1, 
      na_rm = TRUE,
      with_ties = FALSE
      ) |> ungroup() |> dplyr::select(
    TreatmentID,
    ReopDelay_Occur,
    ReopDelay_Surgery,
    EventDelay
  ),
  by = "TreatmentID"
)
```

```{r}
# validate slicemax

SliceCheck <- ComplicTable3 |> 
    group_by(TreatmentID) |>
    slice_max(
      ymd(`Reoperation Procedure Date`), 
      n = 1, 
      na_rm = TRUE,
      with_ties = FALSE
      ) |> dplyr::select(
    TreatmentID,
    `Complication ID`,
    ReopDelay_Occur,
    ReopDelay_Surgery,
    EventDelay,
    Timestamp
  ) |> ungroup() 
```

```{r}
#| label: Select-PROMs-Rep1

SelectRep1PROM1 <- SnapshotPROM1 |>
  filter(
    str_detect(ImplantCodes,paste(RefCode1$Reference,collapse = "|"))
  )

SelectRep1PROM2 <- SnapshotPROM2 |>
  filter(
    str_detect(ImplantCodes,paste(RefCode1$Reference,collapse = "|"))
  )

```

```{r}
#| label: Select-Procedure-Rep1

SelectRep1RC <- SelectRep1 |> filter(str_detect(CuffRepair,"Repair"))
#SelectRep1RCno <- SelectRep1 |> filter(str_detect(CuffRepair,"Repair",negate = TRUE) | is.na(CuffRepair))

SelectRep1RCPROM1 <- SelectRep1PROM1 |> filter(str_detect(CuffRepair,"Repair"))
SelectRep1RCPROM2 <- SelectRep1PROM2 |> filter(str_detect(CuffRepair,"Repair"))

SelectRep1BT <- SelectRep1 |> filter(str_detect(LongHeadBiceps,"Tenodesis"))
SelectRep1BTPROM1<- SelectRep1PROM1 |> filter(str_detect(LongHeadBiceps,"Tenodesis"))
SelectRep1BTPROM2<- SelectRep1PROM2 |> filter(str_detect(LongHeadBiceps,"Tenodesis"))
```

## Overview

Usage of the Product within the patient group is summarised below.

<!--# Insert date range into epoxy block -->

```{epoxy}
#| label:  Overview-Rep1

{
  if(nrow(SelectRep1) == 1) {
    epoxy::epoxy("There is {nrow(SelectRep1)} case involving the anchor of interest.")
  } else {
    procedures <- unique(SelectRep1$ProcedureTotal)
    procedures <- procedures[procedures != "None" & procedures != "Unknown" & procedures != ""]
    procedures <- procedures[!grepl("^(Tenodesis|Tenotomy)$", procedures)]
    
    procedures_string <- if(length(procedures) > 1) {
  result1 <- paste(procedures[-length(procedures)], collapse = "] [")
  paste0(result1, "], and [", procedures[length(procedures)])
    } else {
      procedures
    }
    
    epoxy::epoxy("There are {nrow(SelectRep1)} cases involving the anchor of interest. Surgeries were performed between {format(min(SelectRep1$DateTreatment),'%Y-%b-%d')} and {format(max(SelectRep1$DateTreatment),'%Y-%b-%d')}. The procedures included [{procedures_string}].")
  }
}
{ifelse(nrow(SelectRep1RC) == 1,
        epoxy::epoxy("There is {nrow(SelectRep1RC)} case involving the anchor of interest and a rotator cuff repair."),
        epoxy::epoxy("There are {nrow(SelectRep1RC)} cases involving the anchor of interest and a rotator cuff repair. Surgeries were performed between {format(min(SelectRep1RC$DateTreatment),'%Y-%b-%d')} to {format(max(SelectRep1RC$DateTreatment),'%Y-%b-%d')}.")
)} 
{ifelse(nrow(SelectRep1BT) == 1,
        epoxy::epoxy("There is {nrow(SelectRep1BT)} case involving the anchor of interest and a biceps tenodesis."),
        epoxy::epoxy("There are {nrow(SelectRep1BT)} cases involving the anchor of interest and a biceps tenodesis. Surgeries were performed between {format(min(SelectRep1BT$DateTreatment),'%Y-%b-%d')} to {format(max(SelectRep1BT$DateTreatment),'%Y-%b-%d')}.")
)}




```

## Procedure Report - Rotator Cuff Repair

### Patient Characteristics

Patient demographic, pathology, and treatment characteristics for this cohort receiving the Product are summarised below.

```{r}
#| label: tbl-rep1RC1pat
#| tbl-cap: "Summary of PRULO Report 1 (Rotator Cuff) Case - Patient Characteristics"

#Dont insert chunk names into table chunks - quarto bug makes it wig out when there is a named chunk for some reason

TableRep1RC1 <- SelectRep1RC |> mutate(
    SurgeonA = case_when(
      Surgeon == "KE" ~ "A",
      Surgeon == "RP" ~ "B",
      Surgeon == "GB" ~ "C",
      .default = NA_character_
  )) |>
  dplyr::select(
    AgeAtInitialExam,
    Sex,
    Cohort,
    IndexSide,
    BilateralStatus,
    SymptomDuration,
    SymptomDurationCat,
    #SurgeonA,
    LongHeadBiceps,
    TreatmentStatus,
    RegistryStatus
    ) |>
    tbl_summary(
      by = LongHeadBiceps,
      label = list(
        #SurgeonA ~ "Surgeon",
        AgeAtInitialExam ~ "Age at Initial Consultation (Years)",
        Sex = "Male",
        BilateralStatus ~ "Bilateral Presentation",
        IndexSide ~ "Dominant Side",
        SymptomDuration ~ "Symptom Duration (Weeks)",
        SymptomDurationCat ~ "Symptom Duration Category",
        TreatmentStatus ~ "Treatment Record Active",
        RegistryStatus ~ "Patient Record Active"
      ),
      type = list(
        AgeAtInitialExam ~ "continuous",
        SymptomDuration ~ "continuous",
        Sex ~ "dichotomous",
        TreatmentStatus ~ "dichotomous",
        RegistryStatus ~ "dichotomous"
      ),
      value = list(
        Sex = "Male",
        IndexSide = "Dominant",
        TreatmentStatus = "Ongoing",
        RegistryStatus = "Open"
      ),
      statistic = list(
        all_categorical() ~ "{p} ({n})"
        ),
      missing = "no"
    ) |> add_stat_label(
    location = "column"
  ) |> add_overall() |> modify_table_styling(
      columns = label,
      rows = label == "Symptom Duration Category",
      footnote = "Dichotomised below or equal to 0.5 years or greater than 0.5 years"
  ) |> modify_table_styling(
      columns = label,
      rows = label == "Treatment Record Active",
      footnote = "Treatment record remains active - no change to follow up"
  ) |> modify_table_styling(
      columns = label,
      rows = label == "Patient Record Active",
      footnote = "Patient record remains open - no change to consent or mortality status"
  )

gtsummary::as_flex_table(TableRep1RC1) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)

```

### Surgical Details

Surgical findings and management strategies are summarised below.

```{r}
#| eval: false

CuffStatus1 <- SelectRep1RC |> filter(is.na(CuffStatus))
```

<!--# There are a couple of cases that do not seem to fit the cuff status field properly. There is one GHI case that has the repair details (1399.1), but not cuff status inserted. The other is a general case that is a retorn RCR that probably needs to be moved across cohorts (193.2). -->

```{r}
#| label: tbl-rep1RC1Surg
#| tbl-cap: "Summary of PRULO Report 1 (Rotator Cuff) Cases Pathology and Surgical Details"

TableRep1RC2 <-
  SelectRep1RC |>
  dplyr::select(
    CuffStatus,
    TreatmentType,
    ProductCountFct, #This has a code block it depends on to derive this count within the dataframe - ensure its copied|amended into each report as required
    CuffRepair:AdjunctProcedure) |>
  tbl_summary(
      by = LongHeadBiceps,
      label = list(
        ProductCountFct ~ "Product Count",
        CuffStatus ~ "Cuff Status",
        TreatmentType ~ "Treatment Type",
        CuffRepair ~ "Cuff Repair",
        RepairAugmentation ~ "Repair Augmentation",
        LabrumRepair ~ "Labrum Repair",
        CapsuleLigament ~ "Capsule | Ligament",
        AdjunctProcedure ~ "Adjunct Procedure"
      ),
      statistic = list(
        all_categorical() ~ "{p} ({n})"
        ),
      missing = "no"
    ) |> add_overall() |> modify_table_styling(
      columns = label,
      rows = label == "Other",
      footnote = "Biceps tendon integration; Biceps tendon transfer; Tendon advancement"
    ) 

gtsummary::as_flex_table(TableRep1RC2) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.15,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)

  
```

### Treatment Survival

```{epoxy}
#| label:  Duration-Rep1-Proc1

The mean follow up duration is {round(SelectRep1RC |> ungroup() |> summarise(mean = mean(Duration))/52,1)} years, with a standard deviation of {round(SelectRep1RC |> ungroup() |> summarise(sd = sd(Duration))/52,2)} years.

```

Failure or revision events as identified in the registry for this cohort are summarised below. Individual failure data can be accessed in [Attachment 1](https://docs.google.com/spreadsheets/d/1ESVvSKAv8ma11kri9pby6OEU9Gk5Z3UnF6XwjXBTcTg/edit#gid=0).

```{r}
#| label: tbl-rep1RC3
#| tbl-cap: "Summary of PRULO Report 1 (Rotator Cuff) Procedure Survival"

TableRep1RC3 <- tbl_survfit(
  survfit2(Surv(Duration, Status) ~ 1, 
           data = SelectRep1RC),
  times = c(1,26,52,104),
  label_header = "**{time} Weeks**",
  label = "Procedure Survival",
  statistic = "{estimate} ({conf.low} - {conf.high})"
) |> gtsummary::modify_footnote_header(
    footnote = "% survival with 95% confidence intervals",
    columns = all_stat_cols(),
  ) |> gtsummary::modify_footnote_header(
    footnote = "% survival with 95% confidence intervals",
    columns = all_stat_cols(),
  )

gtsummary::as_flex_table(TableRep1RC3) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "left",
  opts_word = list(
    split = TRUE
    )
)

```

```{r}
#| label:  Failure-Rep-Rep1A-Proc1

#Previous surgery(ies) at the same site Anatomical Location 
#Anchor 1 Anchor 2 Anchor 3 Anchor 4

FailuresRep1RC <-
  SelectRep1RC |> mutate(
    TreatmentStatusDesc = stringr::str_to_sentence(TreatmentStatusNotes)
  ) |>
      filter(TreatmentStatus == "Failed") |> 
  dplyr::select(
    TreatmentID,
    AgeAtInitialExam, 
    Sex,
    TreatmentType,
    Duration,
    TreatmentStatusDesc,
    ReoperationProcedure2,
    SubsequentTx2,
    Product1,
    Product2,
    Product3,
    Product4,
    QDASH_TotalScore_Preop,
    QDASH_TotalScore_3months,
    QDASH_TotalScore_6months) |> mutate(
      Group = "CuffRepair"
    )

```



```{r}
#| label:  Failure-Report-Rep1A-write
#| eval: false
#| include: false

# Authenticate for sheets using the same token
gs4_auth(token = drive_token())

# Do the write operation silently
if (nrow(FailuresRep1RC) > 0) {
  invisible(
    googlesheets4::range_write(
 ss = SheetIDs$AuditReport,
 data = FailuresRep1RC |> arrange(TreatmentID),
 sheet = "Failures1",
 range = "A1:P",
 col_names = TRUE
    )
  )
}


```


```{r}
#| label:  Failure-Report-Rep1A-display

if (nrow(FailuresRep1RC) == 0) {
  epoxy::epoxy_html("There are no failures to report.")
} else {
  epoxy::epoxy_html('Failures were written to <a href="{{SheetIDs$AuditReport}}"Attachment 1/a> for further review')
}


```


### Adverse Events

Complications and adverse events are summarised below. Individual reoperation data can be accessed in [Attachment 1](https://docs.google.com/spreadsheets/d/1ESVvSKAv8ma11kri9pby6OEU9Gk5Z3UnF6XwjXBTcTg/edit#gid=0).

```{r}
#| label:  Complication-Other-Rep1

SelectRep1Other <- SelectRep1 |> filter(
  Other == TRUE
) |> dplyr::select(
  TreatmentID,
  DateTreatment,
  Cohort
)
```



```{r}
#| label: tbl-intraop-complications-1A
#| tbl-cap: "Summary of PRULO Report 1 (Rotator Cuff) Cases - Intraoperative Events"

# Check if any complications exist in filtered data
has_complications <- SelectRep1RC |> 
  filter(TreatmentID %in% IntraopComp$TreatmentID) |> 
  nrow() > 0

# Conditionally generate content
if (!has_complications) {
  # If no complications, return the text message
  epoxy("No intraoperative complications observed.")
} else {
  # Calculate incidence and confidence intervals
  total_cases <- nrow(SelectRep1RC)
  complication_cases <- SelectRep1RC |> 
    filter(TreatmentID %in% IntraopComp$TreatmentID) |> 
    nrow()
  
  # Calculate proportion and 95% CI using Wilson method
  prop_result <- binom::binom.confint(complication_cases, total_cases, 
                                      methods = "wilson")
  incidence_pct <- round(prop_result$mean * 100, 1)
  ci_lower <- round(prop_result$lower * 100, 1)
  ci_upper <- round(prop_result$upper * 100, 1)
  
  # Generate summary sentence
  summary_text <- glue::glue(
    "Intraoperative events occurred in {complication_cases} of {total_cases} cases ({incidence_pct}%, 95% CI: {ci_lower}%-{ci_upper}%)."
  )
  
  # Print summary sentence
  cat(summary_text, "\n\n")
  
  # Generate and return the table
  IntraopComp |> 
    filter(TreatmentID %in% SelectRep1RC$TreatmentID) |> 
    rename(
      Description = "ICNature2",
      Intervention = "ICIntervention",
      PostopManagement = "ICPostopManagement"
    ) |> 
    select(
      TreatmentID,
      Description,
      Intervention,
      PostopManagement
    ) |> 
    gt::gt()
}

```




```{r}
#| label: tbl-Rep1RC4
#| tbl-cap: "Summary of PRULO Report 1 (Rotator Cuff) Cases - Postoperative Events."

# Now create the summary table
TableRep1RC4 <- SelectRep1RC |>
  dplyr::select(
    Infection,
    Ligament_Tendon,
    Effusion,
    Pain,
    Hardware,
    Loosening,
    Instability,
    Stiffness,
    Neurological,
    Thrombosis,
    Other,
    Reop,
    SubsequentTx2, #Inserted to address C028
    ReopDelay_Surgery) |>
  tbl_summary(
    label = list(
      Ligament_Tendon ~ "Ligament|Tendon (Retear)",
      ReopDelay_Surgery ~ "Reoperation Delay (Weeks)",
      
      Reop ~ "Reoperation",
      SubsequentTx2 ~ "Subsequent Treatment"
      ),
    type = list(
      ReopDelay_Surgery ~ "continuous"
    ),
    statistic = list(
      all_categorical() ~ "{p} ({n})",
      all_continuous() ~ "{mean} ({sd})"
    ),
    missing = "no",) |> add_ci(
      statistic = list(
        all_categorical() ~ "{conf.low} - {conf.high}",
        all_continuous() ~ "{conf.low} - {conf.high}"
        
      )
    ) |> modify_table_styling(
      columns = label,
      rows = label == "Other",
      footnote = "Myocardial Infarction"
    ) |> modify_table_styling (
      columns = label,
      rows = label == "Subsequent Treatment",
      footnote = "Management undertaken for procedures that have suffered tissue failure or required hardware removal or replacement"
    ) |> modify_table_styling(
      columns = label,
      rows = label == "Reoperation",
      footnote = "A theatre procedure subsequent to the index surgery that does not involve removal, replacement or modification of the construct."
    ) |> modify_table_styling(
      columns = label,
      rows = label == "Reoperation Delay (Weeks)",
      footnote = "Time between index procedure and reoperation"
    ) 

gtsummary::as_flex_table(TableRep1RC4) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
  split = TRUE
  )
)

```

```{r}
#| label:  Reoperations-Rep1A-Proc1

#echo: false
#warning: false

#Previous surgery(ies) at the same site Anatomical Location 
#Anchor 1 Anchor 2 Anchor 3 Anchor 4

##Flip this around so that multiple reoperations are retained


SelectRep1RCReop <- ComplicTable3 |> filter(
  TreatmentID %in% SelectRep1RC$TreatmentID,
  `Reoperation Procedure` == "Yes"
  ) |> group_by(TreatmentID) |> slice_min(
    ReopDelay_Surgery,
    n = 1
    ) |> ungroup() |> left_join(
    SelectRep1 |> dplyr::select(
    TreatmentID,
    AgeAtInitialExam,
    Sex,
    TreatmentType,
    Product1,
    Product2,
    Product3,
    Product4,
    QDASH_TotalScore_Preop,
    QDASH_TotalScore_3months,
    QDASH_TotalScore_6months
      ),
    by = "TreatmentID",
    relationship = "one-to-one"
    ) |>
  mutate(
     QDASH_TotalScore_Preop = as.numeric(QDASH_TotalScore_Preop),
     QDASH_TotalScore_3months = as.numeric(QDASH_TotalScore_3months),
     QDASH_TotalScore_6months =as.numeric(QDASH_TotalScore_6months)
  ) |> dplyr::select(
    TreatmentID,
    AgeAtInitialExam,
    Sex,
    TreatmentType,
    `Complication Nature`,

    EventDelay,
    Product1,
    Product2,
    Product3,
    Product4,
    QDASH_TotalScore_Preop,
    QDASH_TotalScore_3months,
    QDASH_TotalScore_6months
    ) |> mutate(
      Procedure = "Cuff Repair"
      ) |> arrange(
    TreatmentID
    )

```



```{r}
#| label:  Reoperations-Report-Rep1A-Proc1
#| eval: false
#| include: false

# Authenticate for sheets using the same token
gs4_auth(token = drive_token())

# Do the write operation silently
if (nrow(SelectRep1RCReop) > 0) {
  invisible(
    googlesheets4::range_write(
 ss = SheetIDs$AuditReport,
 data = SelectRep1RCReop,
 sheet = "Reoperations1",
 range = "A1:P",
 col_names = TRUE
    )
  )
}


```


```{r}
#| label:  Reoperations-Report-Rep1A-Proc1-display

if (nrow(SelectRep1RCReop) == 0) {
  epoxy::epoxy_html("There are no reoperations to report.")
} else {
  epoxy::epoxy_html('Reoperations were written to <a href="{{SheetIDs$AuditReport}}"Attachment 1/a> for further review')
}


```

### Patient-Reported Outcomes

Complete case analysis of QDASH, WORC Index Normalised, and WORC Physical Question 3 (How much weakness do you experience in your shoulder?) is summarised below.

```{r}
#| label: fig-PROMs-Rep1
#| fig-cap: "Complete case analysis of QDASH(Top), WORC Normalised (Middle) and WORC Physical Question 3 (Bottom)."
#| fig-cap-location: bottom

Rep1RCPROM1 <- ggplot(data = SelectRep1RCPROM1, mapping = aes(Timepoint,QDASH)) + 
geom_boxplot()

Rep1RCPROM2 <- ggplot(data = SelectRep1RCPROM2, mapping = aes(Timepoint,WORCNorm)) + 
geom_boxplot()

Rep1RCPROM3 <- ggplot(data = SelectRep1RCPROM2, mapping = aes(Timepoint,WORCPhysicalQ3)) + 
geom_boxplot()

Rep1RCPROM1 / Rep1RCPROM2 / Rep1RCPROM3

```

```{r}
#| label: tbl-PROMs-Rep1
#| tbl-cap: "Summary of PRULO Report 1 (Rotator Cuff) Cases - QuickDASH"


TableRep1RC5 <- SelectRep1RCPROM1 |>
dplyr::select(
  QDASH,
  QDASHDelta,
  Timepoint) |>
tbl_summary(by = "Timepoint",
            missing = "no",
            type = list(
              QDASH ~ "continuous",
              QDASHDelta ~ "continuous"
            ),
            statistic = all_continuous() ~ "{median} ({p25} - {p75})"
            ) 


gtsummary::as_flex_table(TableRep1RC5) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
  split = TRUE
  )
)



```

```{r}
#| label: tbl-PROMs-Rep1Worc
#| tbl-cap: "Summary of PRULO Report 1 (Rotator Cuff) Cases - Western Ontario Rotator Cuff Index"


TableRep1RC6 <- SelectRep1RCPROM2 |>
dplyr::select(WORCNorm,
              WORCPhysicalQ3,
              WORCDelta,
              Timepoint) |>
tbl_summary(by = "Timepoint",
            missing = "no",
            type = list(
              WORCNorm ~ "continuous",
              WORCPhysicalQ3 ~ "continuous",
              WORCDelta ~ "continuous"
            ),
            statistic = all_continuous() ~ "{median} ({p25} - {p75})")  

gtsummary::as_flex_table(TableRep1RC6) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
  split = TRUE
  )
)

```

## Procedure Report - Biceps Tenodesis

### Patient Characteristics

Patient demographic, pathology, and treatment characteristics for this cohort receiving the Product are summarised below.

```{r}
#| label: tbl-rept1bt1
#| tbl-cap: "Summary of PRULO Report 1 (Biceps Tenodesis) Case - Patient Characteristics"

TableRep1BT1 <-
  SelectRep1BT |> mutate(
    SurgeonA = case_when(
      Surgeon == "KE" ~ "A",
      Surgeon == "RP" ~ "B",
      Surgeon == "GB" ~ "C",
      .default = NA_character_
  )) |>
  dplyr::select(
    AgeAtInitialExam,
    Sex,
    Cohort,
    IndexSide,
    BilateralStatus,
    SymptomDuration,
    SymptomDurationCat,
    ##SurgeonA,
    LongHeadBiceps,
    TreatmentStatus,
    RegistryStatus
    ) |>
    tbl_summary(
      by = LongHeadBiceps,
      label = list(
        #SurgeonA ~ "Surgeon",
        AgeAtInitialExam ~ "Age at Initial Consultation (Years)",
        Sex = "Male",
        BilateralStatus ~ "Bilateral Presentation",
        IndexSide ~ "Dominant Side",
        SymptomDuration ~ "Symptom Duration (Weeks)",
        SymptomDurationCat ~ "Symptom Duration Category",
        TreatmentStatus ~ "Treatment Record Active",
        RegistryStatus ~ "Patient Record Active"
      ),
      type = list(
        AgeAtInitialExam ~ "continuous",
        SymptomDuration ~ "continuous",
        Sex ~ "dichotomous",
        TreatmentStatus ~ "dichotomous",
        RegistryStatus ~ "dichotomous"
      ),
      value = list(
        Sex = "Male",
        IndexSide = "Dominant",
        TreatmentStatus = "Ongoing",
        RegistryStatus = "Open"
      ),
      statistic = list(
        all_categorical() ~ "{p} ({n})"
        ),
      missing = "no"
    )|> add_stat_label(
    location = "column"
  ) |> modify_table_styling(
      columns = label,
      rows = label == "Symptom Duration Category",
      footnote = "Dichotomised below or equal to 0.5 years or greater than 0.5 years"
  ) |> modify_table_styling(
      columns = label,
      rows = label == "Treatment Record Active",
      footnote = "Treatment record remains active - no change to follow up"
  ) |> modify_table_styling(
      columns = label,
      rows = label == "Patient Record Active",
      footnote = "Patient record remains open - no change to consent or mortality status"
  )

gtsummary::as_flex_table(TableRep1BT1) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)

```

### Surgical Details

Surgical findings and management strategies are summarised below.

```{r}
#| label: tbl-rept1bt2
#| tbl-cap: "Summary of PRULO Report 1 (Biceps Tenodesis) Cases Pathology and Surgical Details"

TableRep1BT2 <-
  SelectRep1BT |>
  dplyr::select(
    CuffStatus,
    TreatmentType,
    ProductCountFct, #This has a code block it depends on to derive this count within the dataframe - ensure its copied|amended into each report as required
    CuffRepair:AdjunctProcedure,
    TreatmentType) |>
  tbl_summary(
    label = list(
        ProductCountFct ~ "Product Count",
        CuffStatus ~ "Cuff Status",
        TreatmentType ~ "Treatment Type",
        CuffRepair ~ "Cuff Repair",
        RepairAugmentation ~ "Repair Augmentation",
        LabrumRepair ~ "Labrum Repair",
        CapsuleLigament ~ "Capsule | Ligament",
        AdjunctProcedure ~ "Adjunct Procedure",
        LongHeadBiceps ~ "Long Head Biceps Procedures"
      ),
    #by = "LongHeadBiceps",
    missing = "no") |> modify_table_styling(
      columns = label,
      rows = label == "Other",
      footnote = "Biceps tendon integration; Biceps tendon transfer; Tendon advancement"
    ) 

gtsummary::as_flex_table(TableRep1BT2) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)
  
```

### Treatment Survival

```{epoxy}
#| label: Duration-Rep1B

The mean follow up duration is {round(SelectRep1BT |> ungroup() |> summarise(mean = mean(Duration))/52,1)} years, with a standard deviation of {round(SelectRep1BT |> ungroup() |> summarise(sd = sd(Duration))/52,2)} years.
```

Failure or revision events as identified in the registry for this cohort are summarised below.

Individual failure data can be accessed in [Attachment 1](https://docs.google.com/spreadsheets/d/1ESVvSKAv8ma11kri9pby6OEU9Gk5Z3UnF6XwjXBTcTg/edit#gid=0)

<!--# Is the same link still relevant or does it need to be updated for cohorts/reports? -->


```{r}
#| label: tbl-rept1bt3
#| tbl-cap: "Summary of PRULO Report 1 (Biceps Tenodesis) procedure survival ("

TableRep1BT3 <- tbl_survfit(
  survfit2(Surv(Duration, Status) ~ 1, 
           data = SelectRep1BT),
  times = c(1,26,52,104),
  label_header = "**{time} Weeks**",
  label = "Procedure Survival",
  statistic = "{estimate} ({conf.low} - {conf.high})"
) |> gtsummary::modify_footnote_header(
    footnote = "% survival with 95% confidence intervals",
    columns = all_stat_cols(),
  )

gtsummary::as_flex_table(TableRep1BT3) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)

```

```{r}
#| label: failure-Rep1B

#Previous surgery(ies) at the same site Anatomical Location 
#Anchor 1 Anchor 2 Anchor 3 Anchor 4

FailuresRep1BT <-
  SelectRep1BT |> mutate(
    TreatmentStatusDesc = stringr::str_to_sentence(TreatmentStatusNotes)
  ) |>
      filter(TreatmentStatus == "Failed") |> 
  dplyr::select(
    TreatmentID,
    AgeAtInitialExam, 
    Sex,
    TreatmentType,
    Duration,
    TreatmentStatusDesc,
    ReoperationProcedure2,
    SubsequentTx2,
    Product1,
    Product2,
    Product3,
    Product4,
    QDASH_TotalScore_Preop,
    QDASH_TotalScore_3months,
    QDASH_TotalScore_6months) |> mutate(
      Procedure = "Biceps Tenodesis"
    )

```



```{r}
#| label:  Failure-Report-Rep1B-Proc2
#| eval: false
#| include: false

# Authenticate for sheets using the same token
gs4_auth(token = drive_token())

# Do the write operation silently
if (nrow(FailuresRep1BT) > 0) {
  invisible(
    googlesheets4::sheet_append(
      ss = SheetIDs$AuditReport,
      data = FailuresRep1BT,
      sheet = "Failures1"
    )
  )
}


```

```{r}
#| label:  Failure-Report-Rep1B-write
#| eval: false
#| include: false

# Authenticate for sheets using the same token
gs4_auth(token = drive_token())

# Do the write operation silently
if (nrow(FailuresRep1BT) > 0) {
  invisible(
    googlesheets4::sheet_append(
 ss = SheetIDs$AuditReport,
 data = FailuresRep1BT |> arrange(TreatmentID),
 sheet = "Failures1"
    )
  )
}


```


```{r}
#| label:  Failure-Report-Rep1B-display

if (nrow(FailuresRep1BT) == 0) {
  epoxy::epoxy_html("There are no failures to report.")
} else {
  epoxy::epoxy_html('Failures were written to <a href="{{SheetIDs$AuditReport}}"Attachment 1/a> for further review')
}


```



<!--# # This is fun, the range needs to be at the bottom of the RC failures and go to the end of the range of the new dataframe (BT failures). The +1 represents the conversion between R dataframe and the googlesheets table.  -->

### Adverse Events

Complications and adverse events are summarised below. Individual reoperation data can be accessed in [Attachment 1](https://docs.google.com/spreadsheets/d/1ESVvSKAv8ma11kri9pby6OEU9Gk5Z3UnF6XwjXBTcTg/edit#gid=0).

```{r}
#| label: tbl-intraop-complications-1B
#| tbl-cap: "Summary of PRULO Report 1 (Biceps Tenodesis) Cases - Intraoperative Events"

# Check if any complications exist in filtered data
has_complications <- SelectRep1BT |> 
  filter(TreatmentID %in% IntraopComp$TreatmentID) |> 
  nrow() > 0

# Conditionally generate content
if (!has_complications) {
  # If no complications, return the text message
  epoxy("No intraoperative complications observed.")
} else {
  # Calculate incidence and confidence intervals
  total_cases <- nrow(SelectRep1BT)
  complication_cases <- SelectRep1BT |> 
    filter(TreatmentID %in% IntraopComp$TreatmentID) |> 
    nrow()
  
  # Calculate proportion and 95% CI using Wilson method
  prop_result <- binom::binom.confint(complication_cases, total_cases, 
                                      methods = "wilson")
  incidence_pct <- round(prop_result$mean * 100, 1)
  ci_lower <- round(prop_result$lower * 100, 1)
  ci_upper <- round(prop_result$upper * 100, 1)
  
  # Generate summary sentence
  summary_text <- glue::glue(
    "Intraoperative events occurred in {complication_cases} of {total_cases} cases ({incidence_pct}%, 95% CI: {ci_lower}%-{ci_upper}%)."
  )
  
  # Print summary sentence
  cat(summary_text, "\n\n")
  
  # Generate and return the table
  IntraopComp |> 
    filter(TreatmentID %in% SelectRep1BT$TreatmentID) |> 
    rename(
      Description = "ICNature2",
      Intervention = "ICIntervention",
      PostopManagement = "ICPostopManagement"
    ) |> 
    select(
      TreatmentID,
      Description,
      Intervention,
      PostopManagement
    ) |> 
    gt::gt()
}

```

```{r}
#| label: tbl-rept1bt4
#| tbl-cap: "Summary of PRULO Report 1 (Biceps Tenodesis) Cases - Postoperative Events"

# Now create the summary table
TableRep1BT4 <- SelectRep1BT |>
  dplyr::select(
    Infection,
    Ligament_Tendon,
    Effusion,
    Pain,
    Hardware,
    Loosening,
    Instability,
    Stiffness,
    Neurological,
    Thrombosis,
    Other,
    Reop,
    SubsequentTx2 #Inserted to address C028
    #ReopDelay_Surgery
    ) |>
  tbl_summary(
    label = list(
      Ligament_Tendon ~ "Ligament|Tendon (Retear)",
      #ReopDelay_Surgery ~ "Reoperation Delay (Weeks)",
      
      Reop ~ "Reoperation",
      SubsequentTx2 ~ "Subsequent Treatment"
      ),
    # type = list(
    #   ReopDelay_Surgery ~ "continuous"
    # ),
    statistic = list(
      all_categorical() ~ "{p} ({n})"
      #all_continuous() ~ "{mean} ({sd})"
    ),
    missing = "no",) |> add_ci(
      statistic = list(
        all_categorical() ~ "{conf.low} - {conf.high}"
        #all_continuous() ~ "{conf.low} - {conf.high}"
        
      )
    ) |> modify_table_styling (
      columns = label,
      rows = label == "Subsequent Treatment",
      footnote = "Management undertaken for procedures that have suffered tissue failure or required hardware removal or replacement"
    ) |> modify_table_styling(
      columns = label,
      rows = label == "Reoperation",
      footnote = "A theatre procedure subsequent to the index surgery that does not involve removal, replacement or modification of the construct."
    ) 

gtsummary::as_flex_table(TableRep1BT4) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)

```

```{r}
#| label: Reoperations-Report-Rep1B



#Previous surgery(ies) at the same site Anatomical Location 
#Anchor 1 Anchor 2 Anchor 3 Anchor 4

##Flip this around so that multiple reoperations are retained


SelectRep1BTReop <- ComplicTable3 |> filter(
  TreatmentID %in% SelectRep1BT$TreatmentID,
  `Reoperation Procedure` == "Yes"
  ) |> group_by(TreatmentID) |> slice_min(
    ReopDelay_Surgery,
    n = 1
    ) |> ungroup() |> left_join(
      SelectRep1 |> dplyr::select(
    TreatmentID,
    AgeAtInitialExam,
    Sex,
    TreatmentType,
    Product1,
    Product2,
    Product3,
    Product4,
    QDASH_TotalScore_Preop,
    QDASH_TotalScore_3months,
    QDASH_TotalScore_6months
      ),
    by = "TreatmentID",
    relationship = "one-to-one"
    ) |>
  mutate(
     QDASH_TotalScore_Preop = as.numeric(QDASH_TotalScore_Preop),
     QDASH_TotalScore_3months = as.numeric(QDASH_TotalScore_3months),
     QDASH_TotalScore_6months =as.numeric(QDASH_TotalScore_6months)
  ) |> dplyr::select(
    TreatmentID,
    AgeAtInitialExam,
    Sex,
    TreatmentType,
    `Complication Nature`,

    EventDelay,
    Product1,
    Product2,
    Product3,
    Product4,
    QDASH_TotalScore_Preop,
    QDASH_TotalScore_3months,
    QDASH_TotalScore_6months
  ) |> mutate(
      Procedure = "Biceps Tenodesis"
    ) |> arrange(
    TreatmentID
    )

```



```{r}
#| label:  Reoperations-Report-Rep1B-write


# Authenticate for sheets using the same token
gs4_auth(token = drive_token())

# Do the write operation silently
if (nrow(SelectRep1BTReop) > 0) {
  invisible(
    googlesheets4::sheet_append(
 ss = SheetIDs$AuditReport,
 data = SelectRep1BTReop,
 sheet = "Reoperations1"
    )
  )
}


```


```{r}
#| label:  Reoperations-Report-Rep1B-display

if (nrow(SelectRep1BTReop) == 0) {
  epoxy::epoxy_html("There are no reoperations to report.")
} else {
  epoxy::epoxy_html('Reoperations were written to <a href="{{SheetIDs$AuditReport}}">Attachment 1</a> for further review')
}


```

### Patient-Reported Outcomes

Complete case analysis of QDASH, WORC Normalised, and WORC Physical Q3 is summarised below.

```{r}
#| label: fig-PROMsrep1BT
#| fig-cap: "Complete case analysis of QDASH(Top), WORC Normalised (Middle) and WORC Physical Question 3 (Bottom)."


Rep1BTPROM1 <- ggplot(data = SelectRep1BTPROM1, mapping = aes(Timepoint,QDASH)) + 
geom_boxplot()

Rep1BTPROM2 <- ggplot(data = SelectRep1BTPROM2, mapping = aes(Timepoint,WORCNorm)) + 
geom_boxplot()

Rep1BTPROM3 <- ggplot(data = SelectRep1BTPROM2, mapping = aes(Timepoint,WORCPhysicalQ3)) + 
geom_boxplot()

Rep1BTPROM1 / Rep1BTPROM2 / Rep1BTPROM3

```

```{r}
#| label: tbl-PROMsrep1BT1
#| tbl-cap: "Summary of PRULO Report 1 (Biceps Tenodesis) Cases - QuickDASH."


TableRep1BT5 <- SelectRep1BTPROM1 |>
dplyr::select(
  QDASH,
  QDASHDelta,
  Timepoint) |>
tbl_summary(by = "Timepoint",
            missing = "no",
            type = list(
              QDASH ~ "continuous",
              QDASHDelta ~ "continuous"
            ),
            statistic = all_continuous() ~ "{median} ({p25} - {p75})"
            ) 

gtsummary::as_flex_table(TableRep1BT5) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)

```

```{r}
#| label: tbl-PROMsrep1BT2
#| tbl-cap: "Summary of PRULO Report 1 (Biceps Tenodesis) Cases - Western Ontario Rotator Cuff Index"

TableRep1BT6 <- SelectRep1BTPROM2 |>
dplyr::select(
  WORCNorm,
  WORCPhysicalQ3,
  #WORCDelta, #Insufficient data points
  Timepoint) |>
tbl_summary(by = "Timepoint",
            missing = "no",
            type = list(
              WORCNorm ~ "continuous",
              WORCPhysicalQ3 ~ "continuous"
            ),
            statistic = all_continuous() ~ "{median} ({p25} - {p75})"
            )

gtsummary::as_flex_table(TableRep1BT6) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)


```

# Product Report 2 - Healix Advance Knotless PEEK

## Sample Selection

The sample of patients with the relevant product group were identified and data were retrieved for analysis by matching registry records to the relevant stock keeping units (SKUs) for the product group of interest. Usage statistics for the product group were added, and adverse events data were attached. Patient-reported data were retrieved and the dataset was manipulated to include relevant details for procedures of interest.

```{r}
#| label: Reference-Code-Rep2

RefCode2 <- ProductTable |> filter(
  (Category == "Anchor"|Category == "Anchor + Suture") &
  stringr::str_detect(stringr::str_to_lower(Description),"advance") &
  stringr::str_detect(stringr::str_to_lower(Description),"peek") &
  stringr::str_detect(stringr::str_to_lower(Description),"knotless") &
  stringr::str_detect(stringr::str_to_lower(Description),"healix")  
)

```

```{r}
#| label: Slice-stack-Rep2

Pattern2 <- "healix advance knotless peek"

SelectRep2 <- SnapshotComb4 |> 
  filter(
    str_detect(ImplantCodes,paste(RefCode2$Reference,collapse = "|"))
  ) |> mutate(
    Product1Check = stringr::str_detect(stringr::str_to_lower(Product1),Pattern2),
    Product2Check = stringr::str_detect(stringr::str_to_lower(Product2),Pattern2),
    Product3Check = stringr::str_detect(stringr::str_to_lower(Product3),Pattern2),
    Product4Check = stringr::str_detect(stringr::str_to_lower(Product4),Pattern2)
  ) |> mutate(
    Product1Count = case_when(
      Product1Check == TRUE ~ stringr::str_extract(Product1,"\\d"),
      .default = NA
    ),
    Product2Count = case_when(
      Product2Check == TRUE ~ stringr::str_extract(Product2,"\\d"),
      .default = NA
    ),
    Product3Count = case_when(
      Product3Check == TRUE ~ stringr::str_extract(Product3,"\\d"),
      .default = NA
    ),
    Product4Count = case_when(
      Product4Check == TRUE ~ stringr::str_extract(Product4,"\\d"),
      .default = NA
      )
    ) |> mutate(
      across(Product1Count:Product4Count,~as.numeric(.))
    ) |> rowwise() |> mutate(
    ProductCount =  sum(across(Product1Count:Product4Count), na.rm = TRUE)
      ) |> mutate(
        ProductCountFct = forcats::fct(
            as.character(ProductCount),
            levels = c("1","2","3","4","5")
          )
        ) |> mutate(
  Infection = TreatmentID %in% ComplicInfection$TreatmentID,
  Ligament_Tendon = TreatmentID %in% ComplicLigament_Tendon$TreatmentID,
  Stiffness = TreatmentID %in% ComplicStiffness$TreatmentID,
  Loosening = TreatmentID %in% ComplicLoosening$TreatmentID,
  Hardware = TreatmentID %in% ComplicHardware$TreatmentID,
  Instability = TreatmentID %in% ComplicInstability$TreatmentID,
  Neurological = TreatmentID %in% ComplicNeurological$TreatmentID,
  Fracture = TreatmentID %in% ComplicFracture$TreatmentID,
  Thrombosis = TreatmentID %in% ComplicThrombosis$TreatmentID,
  Effusion = TreatmentID %in% ComplicEffusion$TreatmentID,
  Pain = TreatmentID %in% ComplicPain$TreatmentID,
  Other = TreatmentID %in% ComplicOther$TreatmentID,

  Reop = TreatmentID %in% ComplicReop$TreatmentID
) |> left_join(
  ComplicTable3 |> 
    group_by(TreatmentID) |>
    slice_max(ymd(`Reoperation Procedure Date`), n = 1) |> ungroup() |> dplyr::select(
    TreatmentID,
    ReopDelay_Occur,
    ReopDelay_Surgery,
    EventDelay
  ),
  by = "TreatmentID"
)
```

```{r}
#| label: PROMs-Rep2

SelectRep2PROM1 <- SnapshotPROM1 |>
  filter(
    str_detect(ImplantCodes,paste(RefCode2$Reference,collapse = "|"))
  )

SelectRep2PROM2 <- SnapshotPROM2 |>
  filter(
    str_detect(ImplantCodes,paste(RefCode2$Reference,collapse = "|"))
  )

```

```{r}
#| label:  Procedure-Rep2

SelectRep2RC <- SelectRep2 |> filter(str_detect(CuffRepair,"Repair"))

SelectRep2RCPROM1 <- SelectRep2PROM1 |> filter(str_detect(CuffRepair,"Repair"))
SelectRep2RCPROM2 <- SelectRep2PROM2 |> filter(str_detect(CuffRepair,"Repair"))

SelectRep2BT <- SelectRep2 |> filter(str_detect(LongHeadBiceps,"Tenodesis"))
SelectRep2BTPROM1<- SelectRep2PROM1 |> filter(str_detect(LongHeadBiceps,"Tenodesis"))
SelectRep2BTPROM2<- SelectRep2PROM2 |> filter(str_detect(LongHeadBiceps,"Tenodesis"))
```

## Overview

Usage of the Product within the patient group is summarised below.

```{epoxy}
#| label:  Overview-Rep2

{
  if(nrow(SelectRep2) == 1) {
    epoxy::epoxy("There is {nrow(SelectRep2)} case involving the anchor of interest.")
  } else {
    procedures <- unique(SelectRep2$ProcedureTotal)
    procedures <- procedures[procedures != "None" & procedures != "Unknown" & procedures != ""]
    procedures <- procedures[!grepl("^(Tenodesis|Tenotomy)$", procedures)]
    
    procedures_string <- if(length(procedures) > 1) {
  result2 <- paste(procedures[-length(procedures)], collapse = "] [")
  paste0(result2, "], and [", procedures[length(procedures)])
    } else {
      procedures
    }
    
    epoxy::epoxy("There are {nrow(SelectRep2)} cases involving the anchor of interest. Surgeries were performed between {format(min(SelectRep2$DateTreatment),'%Y-%b-%d')} and {format(max(SelectRep2$DateTreatment),'%Y-%b-%d')}. The procedures included [{procedures_string}].")
  }
} 
{ifelse(nrow(SelectRep2RC) == 1,
        epoxy::epoxy("There is {nrow(SelectRep2RC)} case involving the anchor of interest and a rotator cuff repair."),
        epoxy::epoxy("There are {nrow(SelectRep2RC)} cases involving the anchor of interest and a rotator cuff repair. Surgeries were performed between {format(min(SelectRep2RC$DateTreatment),'%Y-%b-%d')} to {format(max(SelectRep2RC$DateTreatment),'%Y-%b-%d')}.")
)} 
{ifelse(nrow(SelectRep2BT) == 1,
        epoxy::epoxy("There is {nrow(SelectRep2BT)} case involving the anchor of interest and a biceps tenodesis."),
        epoxy::epoxy("There are {nrow(SelectRep2BT)} cases involving the anchor of interest and a biceps tenodesis. Surgeries were performed between {format(min(SelectRep2BT$DateTreatment),'%Y-%b-%d')} to {format(max(SelectRep2BT$DateTreatment),'%Y-%b-%d')}.")
)}




```

## Procedure Report - Rotator Cuff Repair

### Patient Characteristics

Patient demographic, pathology, and treatment characteristics for this cohort receiving the Product are summarised below.

```{r}
#| label: tbl-Rep2RC1
#| tbl-cap: "Summary of PRULO Report 2 (Rotator Cuff) Case - Patient Characteristics"

TableRep2RC1 <-
  SelectRep2RC |> mutate(
    SurgeonA = case_when(
      Surgeon == "KE" ~ "A",
      Surgeon == "RP" ~ "B",
      Surgeon == "GB" ~ "C",
      .default = NA_character_
  )) |>
  dplyr::select(
    AgeAtInitialExam,
    Sex,
    Cohort,
    IndexSide,
    BilateralStatus,
    SymptomDuration,
    SymptomDurationCat,
    #SurgeonA,
    LongHeadBiceps,
    TreatmentStatus,
    RegistryStatus
    ) |>
    tbl_summary(
      by = LongHeadBiceps,
      label = list(
        #SurgeonA ~ "Surgeon",
        AgeAtInitialExam ~ "Age at Initial Consultation (Years)",
        Sex = "Male",
        BilateralStatus ~ "Bilateral Presentation",
        IndexSide ~ "Dominant Side",
        SymptomDuration ~ "Symptom Duration (Weeks)",
        SymptomDurationCat ~ "Symptom Duration Category",
        TreatmentStatus ~ "Treatment Record Active",
        RegistryStatus ~ "Patient Record Active"
      ),
      type = list(
        AgeAtInitialExam ~ "continuous",
        SymptomDuration ~ "continuous",
        Sex ~ "dichotomous",
        TreatmentStatus ~ "dichotomous",
        RegistryStatus ~ "dichotomous"
      ),
      value = list(
        Sex = "Male",
        IndexSide = "Dominant",
        TreatmentStatus = "Ongoing",
        RegistryStatus = "Open"
      ),
      statistic = list(
        all_categorical() ~ "{p} ({n})"
        ),
      missing = "no"
    ) |> add_stat_label(
    location = "column"
  ) |> add_overall() |> modify_table_styling(
      columns = label,
      rows = label == "Symptom Duration Category",
      footnote = "Dichotomised below or equal to 0.5 years or greater than 0.5 years"
  ) |> modify_table_styling(
      columns = label,
      rows = label == "Treatment Record Active",
      footnote = "Treatment record remains active - no change to follow up"
  ) |> modify_table_styling(
      columns = label,
      rows = label == "Patient Record Active",
      footnote = "Patient record remains open - no change to consent or mortality status"
  )

  gtsummary::as_flex_table(TableRep2RC1) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
  split = TRUE
  )
)

```

### Surgical Details

Surgical findings and management strategies are summarised below.

```{r}
#| eval: false


CuffStatus2 <- SelectRep2RC |> filter(is.na(CuffStatus))
```

<!--# There are a couple of cases that do not seem to fit the cuff status field properly. There is one GHI case that has the repair details (1399.1), but not cuff status inserted. The other is a general case that is a retorn RCR that probably needs to be moved across cohorts (193.2). -->

```{r}
#| label: tbl-Rep2RC2
#| tbl-cap: "Summary of PRULO Report 2 (Rotator Cuff) Cases Pathology and Surgical Details"


TableRep2RC2 <-
  SelectRep2RC |>
  dplyr::select(
    CuffStatus,
    TreatmentType,
    ProductCountFct, #This has a code block it depends on to derive this count within the dataframe - ensure its copied|amended into each report as required
    CuffRepair:AdjunctProcedure) |>
  tbl_summary(
      by = LongHeadBiceps,
      label = list(
        ProductCountFct ~ "Product Count",
        CuffStatus ~ "Cuff Status",
        TreatmentType ~ "Treatment Type",
        CuffRepair ~ "Cuff Repair",
        RepairAugmentation ~ "Repair Augmentation",
        LabrumRepair ~ "Labrum Repair",
        CapsuleLigament ~ "Capsule | Ligament",
        AdjunctProcedure ~ "Adjunct Procedure"
      ),
      statistic = list(
        all_categorical() ~ "{p} ({n})"
        ),
      missing = "no"
    ) |> add_overall() |> modify_table_styling(
      columns = label,
      rows = label == "Other",
      footnote = "Biceps tendon integration; Biceps tendon transfer; Tendon advancement"
    ) 

  gtsummary::as_flex_table(TableRep2RC2) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
  split = TRUE
  )
)

  
```

### Treatment Survival

```{epoxy}
#| label:  Duration-Rep2-Proc1

The mean follow up duration is {round(SelectRep2RC |> ungroup() |> summarise(mean = mean(Duration))/52,1)} years, with a standard deviation of {round(SelectRep2RC |> ungroup() |> summarise(sd = sd(Duration))/52,2)} years.

```

Failure or revision events as identified in the registry for this cohort are summarised below. Individual failure data can be accessed in [Attachment 1](https://docs.google.com/spreadsheets/d/1ESVvSKAv8ma11kri9pby6OEU9Gk5Z3UnF6XwjXBTcTg/edit#gid=0).

```{r}
#| label: tbl-Rep2RC3
#| tbl-cap: "Summary of PRULO Report 2 (Rotator Cuff) Procedure Survival"

TableRep2RC3 <- tbl_survfit(
  survfit2(Surv(Duration, Status) ~ 1, 
           data = SelectRep2RC),
  times = c(1,26,52,104),
  label_header = "**{time} Weeks**",
  label = "Procedure Survival",
  statistic = "{estimate} ({conf.low} - {conf.high})"
) |> gtsummary::modify_footnote_header(
    footnote = "% survival with 95% confidence intervals",
    columns = all_stat_cols(),
  )

  gtsummary::as_flex_table(TableRep2RC3) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
  split = TRUE
  )
)

```

```{r}
#| label:  Failure-Report-Rep2A-Proc1

#Previous surgery(ies) at the same site Anatomical Location 
#Anchor 1 Anchor 2 Anchor 3 Anchor 4

FailuresRep2RC <-
  SelectRep2RC |> mutate(
    TreatmentStatusDesc = stringr::str_to_sentence(TreatmentStatusNotes)
  ) |>
      filter(TreatmentStatus == "Failed") |> 
  dplyr::select(
    TreatmentID,
    AgeAtInitialExam, 
    Sex,
    TreatmentType,
    Duration,
    TreatmentStatusDesc,
    ReoperationProcedure2,
    SubsequentTx2,
    Product1,
    Product2,
    Product3,
    Product4,
    QDASH_TotalScore_Preop,
    QDASH_TotalScore_3months,
    QDASH_TotalScore_6months) |> mutate(
      Procedure = "Cuff Repair"
    ) |> arrange(
      TreatmentID
    )

```

```{r}
#| label:  Failure-Report-Rep2A-write
#| eval: false
#| include: false

# Authenticate for sheets using the same token
gs4_auth(token = drive_token())

# Do the write operation silently
if (nrow(FailuresRep1RC) > 0) {
  invisible(
    googlesheets4::range_write(
 ss = SheetIDs$AuditReport,
 data = FailuresRep2RC |> arrange(TreatmentID),
 sheet = "Failures2",
 range = "A1:P",
 col_names = TRUE
    )
  )
}


```


```{r}
#| label:  Failure-Report-Rep2A-display

if (nrow(FailuresRep2RC) == 0) {
  epoxy::epoxy_html("There are no failures to report.")
} else {
  epoxy::epoxy_html('Failures were written to <a href="{{SheetIDs$AuditReport}}"Attachment 1/a> for further review')
}


```

### Adverse Events

Complications and adverse events are summarised below.

```{r}
#| label:  Complication-Other-Rep2
SelectRep2Other <- SelectRep2 |> filter(
  Other == TRUE
) |> dplyr::select(
  TreatmentID,
  DateTreatment,
  Cohort
)
```


```{r}
#| label: tbl-intraop-complications-2A
#| tbl-cap: "Summary of PRULO Report 2 (Rotator Cuff) Cases - Intraoperative Events"

# Check if any complications exist in filtered data
has_complications <- SelectRep2RC |> 
  filter(TreatmentID %in% IntraopComp$TreatmentID) |> 
  nrow() > 0

# Conditionally generate content
if (!has_complications) {
  # If no complications, return the text message
  epoxy_html("No intraoperative complications were observed.")
} else {
  # Calculate incidence and confidence intervals
  total_cases <- nrow(SelectRep2RC)
  complication_cases <- SelectRep2RC |> 
    filter(TreatmentID %in% IntraopComp$TreatmentID) |> 
    nrow()
  
  # Calculate proportion and 95% CI using Wilson method
  prop_result <- binom::binom.confint(complication_cases, total_cases, 
                                      methods = "wilson")
  incidence_pct <- round(prop_result$mean * 100, 1)
  ci_lower <- round(prop_result$lower * 100, 1)
  ci_upper <- round(prop_result$upper * 100, 1)
  
  # Generate summary sentence
  summary_text <- glue::glue(
    "Intraoperative events occurred in {complication_cases} of {total_cases} cases ({incidence_pct}%, 95% CI: {ci_lower}%-{ci_upper}%)."
  )
  
  # Print summary sentence
  cat(summary_text, "\n\n")
  
  # Generate and return the table
  IntraopComp |> 
    filter(TreatmentID %in% SelectRep2RC$TreatmentID) |> 
    rename(
      Description = "ICNature2",
      Intervention = "ICIntervention",
      PostopManagement = "ICPostopManagement"
    ) |> 
    select(
      TreatmentID,
      Description,
      Intervention,
      PostopManagement
    ) |> 
    gt::gt()
}

```


```{r}
#| label: tbl-Rep2RC4
#| tbl-cap: "Summary of PRULO Report 2 (Rotator Cuff) Cases - Postoperative Events"

# Now create the summary table
TableRep2RC4 <- SelectRep2RC |>
  dplyr::select(
    Infection,
    Ligament_Tendon,
    Effusion,
    Pain,
    Hardware,
    Loosening,
    Instability,
    Stiffness,
    Neurological,
    Thrombosis,
    Other,
    Reop,
    SubsequentTx2, #Inserted to address C028
    ReopDelay_Surgery) |>
  tbl_summary(
    label = list(
      Ligament_Tendon ~ "Ligament|Tendon (Retear)",
      ReopDelay_Surgery ~ "Reoperation Delay (Weeks)",
      
      Reop ~ "Reoperation",
      SubsequentTx2 ~ "Subsequent Treatment"
      ),
    type = list(
      ReopDelay_Surgery ~ "continuous"
    ),
    statistic = list(
      all_categorical() ~ "{p} ({n})",
      all_continuous() ~ "{mean} ({sd})"
    ),
    missing = "no",) |> add_ci(
      statistic = list(
        all_categorical() ~ "{conf.low} - {conf.high}",
        all_continuous() ~ "{conf.low} - {conf.high}"
        
      )
    ) |> modify_table_styling(
      columns = label,
      rows = label == "Other",
      footnote = "Myocardial Infarction"
    ) |> modify_table_styling (
      columns = label,
      rows = label == "Subsequent Treatment",
      footnote = "Management undertaken for procedures that have suffered tissue failure or required hardware removal or replacement"
    ) |> modify_table_styling(
      columns = label,
      rows = label == "Reoperation",
      footnote = "A theatre procedure subsequent to the index surgery that does not involve removal, replacement or modification of the construct."
    ) |> modify_table_styling(
      columns = label,
      rows = label == "Reoperation Delay (Weeks)",
      footnote = "Time between index procedure and reoperation"
    )
  
  gtsummary::as_flex_table(TableRep2RC4) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
  split = TRUE
  )
)

```

```{r}
#| label:  Reoperations-Report-Rep2A-Proc1

#echo: false
#warning: false

#Previous surgery(ies) at the same site Anatomical Location 
#Anchor 1 Anchor 2 Anchor 3 Anchor 4

##Flip this around so that multiple reoperations are retained


SelectRep2RCReop <- ComplicTable3 |> filter(
  TreatmentID %in% SelectRep2RC$TreatmentID,
  `Reoperation Procedure` == "Yes"
  ) |> group_by(TreatmentID) |> slice_min(
    ReopDelay_Surgery,
    n = 1
    ) |> ungroup() |> left_join(
      SelectRep2 |> dplyr::select(
    TreatmentID,
    AgeAtInitialExam,
    Sex,
    TreatmentType,
    Product1,
    Product2,
    Product3,
    Product4,
    QDASH_TotalScore_Preop,
    QDASH_TotalScore_3months,
    QDASH_TotalScore_6months
      ),
    by = "TreatmentID",
    relationship = "one-to-one"
    ) |>
  mutate(
     QDASH_TotalScore_Preop = as.numeric(QDASH_TotalScore_Preop),
     QDASH_TotalScore_3months = as.numeric(QDASH_TotalScore_3months),
     QDASH_TotalScore_6months =as.numeric(QDASH_TotalScore_6months)
  ) |> dplyr::select(
    TreatmentID,
    AgeAtInitialExam,
    Sex,
    TreatmentType,
    `Complication Nature`,

    EventDelay,
    Product1,
    Product2,
    Product3,
    Product4,
    QDASH_TotalScore_Preop,
    QDASH_TotalScore_3months,
    QDASH_TotalScore_6months
  ) |> mutate(
    Procedure = "Cuff Repair"
    ) |> arrange(
    TreatmentID
    )

```

Write reoperations to external sheet

```{r}
#| label:  Reoperations-Report-Rep2A-write


{ifelse(nrow(SelectRep2RCReop) == 0,
        epoxy::epoxy("There are no reoperations to report."),
       with_gs4_quiet(googlesheets4::range_write(
         ss = SheetIDs$AuditReport,
         data = SelectRep2RCReop,
         sheet = "Reoperations2",
         range = "A1:P",
         col_names = TRUE
         )
      )
)
}


# Authenticate for sheets using the same token
gs4_auth(token = drive_token())

# Do the write operation silently
if (nrow(SelectRep1RCReop) > 0) {
  invisible(
    googlesheets4::range_write(
 ss = SheetIDs$AuditReport,
 data = SelectRep2RCReop,
 sheet = "Reoperations2",
 range = "A1:P",
 col_names = TRUE
    )
  )
}




```

```{r}
#| label:  Reoperations-Report-Rep2A-display

if (nrow(SelectRep2RCReop) == 0) {
  epoxy::epoxy_html("There are no reoperations to report.")
} else {
  epoxy::epoxy_html('Reoperations were written to <a href="{{SheetIDs$AuditReport}}"Attachment 1/a> for further review')
}
```



### Patient-Reported Outcomes

Complete case analysis of QDASH, WORC Index Normalised, and WORC Physical Question 3 (How much weakness do you experience in your shoulder?) is summarised below.

```{r}
#| label: fig-PROMs-Rep2-Proc1
#| fig-cap: "Complete case analysis of QDASH(Top), WORC Normalised (Middle) and WORC Physical Question 3 (Bottom)."
#| fig-cap-location: bottom



Rep2RCPROM1 <- ggplot(data = SelectRep2RCPROM1, mapping = aes(Timepoint,QDASH)) + 
geom_boxplot()

Rep2RCPROM2 <- ggplot(data = SelectRep2RCPROM2, mapping = aes(Timepoint,WORCNorm)) + 
geom_boxplot()

Rep2RCPROM3 <- ggplot(data = SelectRep2RCPROM2, mapping = aes(Timepoint,WORCPhysicalQ3)) + 
geom_boxplot()

Rep2RCPROM1 / Rep2RCPROM2 / Rep2RCPROM3

```

Figure 1: Complete case analysis of QDASH(Top), WORC Index Normalised (Middle), and WORC Physical Question 3 (Bottom).

Table 5:

```{r}
#| label: tbl-PROMsRep2RC1
#| tbl-cap-location: top
#| tbl-cap: "Summary of PRULO Report 2 (Rotator Cuff) Cases - QuickDASH"


TableRep2RC5 <- SelectRep2RCPROM1 |>
dplyr::select(
  QDASH,
  QDASHDelta,
  Timepoint) |>
tbl_summary(by = "Timepoint",
            missing = "no",
            type = list(
              QDASH ~ "continuous",
              QDASHDelta ~ "continuous"
            ),
            statistic = all_continuous() ~ "{median} ({p25} - {p75})"
            ) 

gtsummary::as_flex_table(TableRep2RC5) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
  split = TRUE
  )
)



```

```{r}
#| label: tbl-PROMsRep2RC2
#| tbl-cap: "Summary of PRULO Report 2 (Rotator Cuff) Cases - Western Ontario Rotator Cuff Index"

TableRep2RC6 <- SelectRep2RCPROM2 |>
dplyr::select(WORCNorm,
              WORCPhysicalQ3,
              WORCDelta,
              Timepoint) |>
tbl_summary(by = "Timepoint",
            missing = "no",
            type = list(
              WORCNorm ~ "continuous",
              WORCPhysicalQ3 ~ "continuous",
              WORCDelta ~ "continuous"
            ),
            statistic = all_continuous() ~ "{median} ({p25} - {p75})") 

gtsummary::as_flex_table(TableRep2RC6) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
  split = TRUE
  )
)

```

## Procedure Report - Biceps Tenodesis

### Patient Characteristics

Patient demographic, pathology, and treatment characteristics for this cohort receiving the Product are summarised below.

```{r}
#| label: tbl-Rep2BT1
#| tbl-cap: "Summary of PRULO Report 2 (Biceps Tenodesis) Cases - Patient Characteristics"

TableRep2BT1 <-
  SelectRep2BT |> mutate(
    SurgeonA = case_when(
      Surgeon == "KE" ~ "A",
      Surgeon == "RP" ~ "B",
      Surgeon == "GB" ~ "C",
      .default = NA_character_
  )) |>
  dplyr::select(
    AgeAtInitialExam,
    Sex,
    Cohort,
    IndexSide,
    BilateralStatus,
    #SymptomDuration,
    SymptomDurationCat,
    #SurgeonA,
    LongHeadBiceps,
    TreatmentStatus,
    RegistryStatus
    ) |>
    tbl_summary(
      by = LongHeadBiceps,
      label = list(
        #SurgeonA ~ "Surgeon",
        AgeAtInitialExam ~ "Age at Initial Consultation (Years)",
        Sex = "Male",
        BilateralStatus ~ "Bilateral Presentation",
        IndexSide ~ "Dominant Side",
        #SymptomDuration ~ "Symptom Duration (Weeks)",
        SymptomDurationCat ~ "Symptom Duration Category",
        TreatmentStatus ~ "Treatment Record Active",
        RegistryStatus ~ "Patient Record Active"
      ),
      type = list(
        AgeAtInitialExam ~ "continuous",
        #SymptomDuration ~ "continuous",
        Sex ~ "dichotomous",
        TreatmentStatus ~ "dichotomous",
        RegistryStatus ~ "dichotomous"
      ),
      value = list(
        Sex = "Male",
        IndexSide = "Dominant",
        TreatmentStatus = "Ongoing",
        RegistryStatus = "Open"
      ),
      statistic = list(
        all_categorical() ~ "{p} ({n})"
        ),
      missing = "no"
    )|> add_stat_label(
    location = "column"
  ) |> modify_table_styling(
      columns = label,
      rows = label == "Symptom Duration Category",
      footnote = "Dichotomised below or equal to 0.5 years or greater than 0.5 years"
  ) |> modify_table_styling(
      columns = label,
      rows = label == "Treatment Record Active",
      footnote = "Treatment record remains active - no change to follow up"
  ) |> modify_table_styling(
      columns = label,
      rows = label == "Patient Record Active",
      footnote = "Patient record remains open - no change to consent or mortality status"
  ) 

gtsummary::as_flex_table(TableRep2BT1) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
  split = TRUE
  )
)

```

### Surgical Details

Surgical findings and management strategies are summarised below.

```{r}
#| label: tbl-Rep2BT2
#| tbl-cap: "Summary of PRULO Report 2 (Biceps Tenodesis) Cases Pathology and Surgical Details"


TableRep2BT2 <-
  SelectRep2BT |>
  dplyr::select(
    CuffStatus,
    TreatmentType,
    ProductCountFct, #This has a code block it depends on to derive this count within the dataframe - ensure its copied|amended into each report as required
    CuffRepair:AdjunctProcedure,
    TreatmentType) |>
  tbl_summary(
    label = list(
        ProductCountFct ~ "Product Count",
        CuffStatus ~ "Cuff Status",
        TreatmentType ~ "Treatment Type",
        CuffRepair ~ "Cuff Repair",
        RepairAugmentation ~ "Repair Augmentation",
        LabrumRepair ~ "Labrum Repair",
        CapsuleLigament ~ "Capsule | Ligament",
        AdjunctProcedure ~ "Adjunct Procedure",
        LongHeadBiceps ~ "Long Head Biceps Procedures"
      ),
    #by = "LongHeadBiceps",
    missing = "no") |> modify_table_styling(
      columns = label,
      rows = label == "Other",
      footnote = "Biceps tendon integration; Biceps tendon transfer; Tendon advancement"
    ) 

gtsummary::as_flex_table(TableRep2BT2) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
  split = TRUE
  )
)

# |> add_overall() 
  
```

### Treatment Survival

```{epoxy}
#| label:  Duration-Rep2-Proc2

The mean follow up duration is {round(SelectRep2BT |> ungroup() |> summarise(mean = mean(Duration))/52,1)} years, with a standard deviation of {round(SelectRep2BT |> ungroup() |> summarise(sd = sd(Duration))/52,2)} years.
```

Failure or revision events as identified in the registry for this cohort are summarised below.

Individual failure data can be accessed in [Attachment 1](https://docs.google.com/spreadsheets/d/1ESVvSKAv8ma11kri9pby6OEU9Gk5Z3UnF6XwjXBTcTg/edit#gid=0)

<!--# Is the same link still relevant or does it need to be updated for cohorts/reports? -->

```{r}
#| label: tbl-Rep2BT3
#| tbl-cap: "Summary of PRULO Report 2 (Biceps Tenodesis) procedure survival"

TableRep2BT3 <- tbl_survfit(
  survfit2(Surv(Duration, Status) ~ 1, 
           data = SelectRep2BT),
  times = c(1,26,52,104),
  label_header = "**{time} Weeks**",
  label = "Procedure Survival",
  statistic = "{estimate} ({conf.low} - {conf.high})"
) |> gtsummary::modify_footnote_header(
    footnote = "% survival with 95% confidence intervals",
    columns = all_stat_cols(),
  )

gtsummary::as_flex_table(TableRep2BT3) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
  split = TRUE
  )
)
```

```{r}
#| label:  Failure-Report-Rep2A-Proc2

#Previous surgery(ies) at the same site Anatomical Location 
#Anchor 1 Anchor 2 Anchor 3 Anchor 4

FailuresRep2BT <-
  SelectRep2BT |> mutate(
    TreatmentStatusDesc = stringr::str_to_sentence(TreatmentStatusNotes)
  ) |>
      filter(TreatmentStatus == "Failed") |> 
  dplyr::select(
    TreatmentID,
    AgeAtInitialExam, 
    Sex,
    TreatmentType,
    Duration,
    TreatmentStatusDesc,
    ReoperationProcedure2,
    SubsequentTx2,
    Product1,
    Product2,
    Product3,
    Product4,
    QDASH_TotalScore_Preop,
    QDASH_TotalScore_3months,
    QDASH_TotalScore_6months) |> mutate(
      Procedure = "Biceps Tenodesis"
    )

```

```{r}
#| label:  Failure-Report-Rep2B-write
#| eval: false
#| include: false

# Authenticate for sheets using the same token
gs4_auth(token = drive_token())

# Do the write operation silently
if (nrow(FailuresRep2BT) > 0) {
  invisible(
    googlesheets4::sheet_append(
 ss = SheetIDs$AuditReport,
 data = FailuresRep2BT |> arrange(TreatmentID),
 sheet = "Failures2"
    )
  )
}


```


```{r}
#| label:  Failure-Report-Rep2B-display

if (nrow(FailuresRep2BT) == 0) {
  epoxy::epoxy_html("There are no failures to report.")
} else {
  epoxy::epoxy_html('Failures were written to <a href="{{SheetIDs$AuditReport}}"Attachment 1/a> for further review')
}


```

<!--# # This is fun, the range needs to be at the bottom of the RC failures and go to the end of the range of the new dataframe (BT failures). The +1 represents the conversion between R dataframe and the googlesheets table. -->

### Adverse Events

Complications and adverse events are summarised below. Individual reoperation data can be accessed in [Attachment 1](https://docs.google.com/spreadsheets/d/1ESVvSKAv8ma11kri9pby6OEU9Gk5Z3UnF6XwjXBTcTg/edit#gid=0).


```{r}
#| label: tbl-intraop-complications-2B
#| tbl-cap: "Summary of PRULO Report 2 (Biceps Tenodesis) Cases - Intraoperative Events"

# Check if any complications exist in filtered data
has_complications <- SelectRep2BT |> 
  filter(TreatmentID %in% IntraopComp$TreatmentID) |> 
  nrow() > 0

# Conditionally generate content
if (!has_complications) {
  # If no complications, return the text message
  epoxy("No intraoperative complications observed.")
} else {
  # Calculate incidence and confidence intervals
  total_cases <- nrow(SelectRep2BT)
  complication_cases <- SelectRep2BT |> 
    filter(TreatmentID %in% IntraopComp$TreatmentID) |> 
    nrow()
  
  # Calculate proportion and 95% CI using Wilson method
  prop_result <- binom::binom.confint(complication_cases, total_cases, 
                                      methods = "wilson")
  incidence_pct <- round(prop_result$mean * 100, 1)
  ci_lower <- round(prop_result$lower * 100, 1)
  ci_upper <- round(prop_result$upper * 100, 1)
  
  # Generate summary sentence
  summary_text <- glue::glue(
    "Intraoperative events occurred in {complication_cases} of {total_cases} cases ({incidence_pct}%, 95% CI: {ci_lower}%-{ci_upper}%)."
  )
  
  # Print summary sentence
  cat(summary_text, "\n\n")
  
  # Generate and return the table
  IntraopComp |> 
    filter(TreatmentID %in% SelectRep2BT$TreatmentID) |> 
    rename(
      Description = "ICNature2",
      Intervention = "ICIntervention",
      PostopManagement = "ICPostopManagement"
    ) |> 
    select(
      TreatmentID,
      Description,
      Intervention,
      PostopManagement
    ) |> 
    gt::gt()
}

```

```{r}
#| label: tbl-Rep2BT4
#| tbl-cap: "Summary of PRULO Report 2 (Biceps Tenodesis) Cases - Postoperative Events"

# Now create the summary table
TableRep2BT4 <- SelectRep2BT |>
  dplyr::select(
    Infection,
    Ligament_Tendon,
    Effusion,
    Pain,
    Hardware,
    Loosening,
    Instability,
    Stiffness,
    Neurological,
    Thrombosis,
    Other,
    Reop,
    SubsequentTx2 #Inserted to address C028
    #ReopDelay_Surgery
    ) |>
  tbl_summary(
    label = list(
      Ligament_Tendon ~ "Ligament|Tendon (Retear)",
      #ReopDelay_Surgery ~ "Reoperation Delay (Weeks)",
      
      Reop ~ "Reoperation",
      SubsequentTx2 ~ "Subsequent Treatment"
      ),
    # type = list(
    #   ReopDelay_Surgery ~ "continuous"
    # ),
    statistic = list(
      all_categorical() ~ "{p} ({n})"
      #all_continuous() ~ "{mean} ({sd})"
    ),
    missing = "no",) |> add_ci(
      statistic = list(
        all_categorical() ~ "{conf.low} - {conf.high}"
        #all_continuous() ~ "{conf.low} - {conf.high}"
        
      )
    ) |> modify_table_styling (
      columns = label,
      rows = label == "Subsequent Treatment",
      footnote = "Management undertaken for procedures that have suffered tissue failure or required hardware removal or replacement"
    ) |> modify_table_styling(
      columns = label,
      rows = label == "Reoperation",
      footnote = "A theatre procedure subsequent to the index surgery that does not involve removal, replacement or modification of the construct."
    ) 

gtsummary::as_flex_table(TableRep2BT4) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
  split = TRUE
  )
)

```

```{r}
#| label:  Reoperations-Report-Rep2A-Proc2

#echo: false
#warning: false

#Previous surgery(ies) at the same site Anatomical Location 
#Anchor 1 Anchor 2 Anchor 3 Anchor 4

##Flip this around so that multiple reoperations are retained


SelectRep2BTReop <- ComplicTable3 |> filter(
  TreatmentID %in% SelectRep2BT$TreatmentID,
  `Reoperation Procedure` == "Yes"
  ) |> group_by(TreatmentID) |> slice_min(
    ReopDelay_Surgery,
    n = 1
    ) |> ungroup() |> left_join(
      SelectRep2 |> dplyr::select(
    TreatmentID,
    AgeAtInitialExam,
    Sex,
    TreatmentType,
    Product1,
    Product2,
    Product3,
    Product4,
    QDASH_TotalScore_Preop,
    QDASH_TotalScore_3months,
    QDASH_TotalScore_6months
      ),
    by = "TreatmentID",
    relationship = "one-to-one"
    ) |>
  mutate(
     QDASH_TotalScore_Preop = as.numeric(QDASH_TotalScore_Preop),
     QDASH_TotalScore_3months = as.numeric(QDASH_TotalScore_3months),
     QDASH_TotalScore_6months =as.numeric(QDASH_TotalScore_6months)
  ) |> dplyr::select(
    TreatmentID,
    AgeAtInitialExam,
    Sex,
    TreatmentType,
    `Complication Nature`,

    EventDelay,
    Product1,
    Product2,
    Product3,
    Product4,
    QDASH_TotalScore_Preop,
    QDASH_TotalScore_3months,
    QDASH_TotalScore_6months
  ) |> mutate(
    Procedure = "Biceps Tenodesis"
  ) |> arrange(
    TreatmentID
    )

```

```{r}
#| label:  Reoperations-Report-Rep2B-write


# Authenticate for sheets using the same token
gs4_auth(token = drive_token())

# Do the write operation silently
if (nrow(SelectRep2BTReop) > 0) {
  invisible(
    googlesheets4::sheet_append(
 ss = SheetIDs$AuditReport,
 data = SelectRep2BTReop,
 sheet = "Reoperations2"
    )
  )
}


```


```{r}
#| label:  Reoperations-Report-Rep2B-display

if (nrow(SelectRep2BTReop) == 0) {
  epoxy::epoxy_html("There are no reoperations to report.")
} else {
  epoxy::epoxy_html('Reoperations were written to <a href="{{SheetIDs$AuditReport}}"Attachment 1/a> for further review')
}


```


### Patient-Reported Outcomes

Complete case analysis of QDASH, WORC Normalised, and WORC Physical Q3 is summarised below.

```{r}
#| label: fig-PROMRep2Proc2
#| fig-cap: "Complete case analysis of QDASH(Top), WORC Normalised (Middle) and WORC Physical Question 3 (Bottom)."

Rep2BTPROM1 <- ggplot(data = SelectRep2BTPROM1, mapping = aes(Timepoint,QDASH)) + 
geom_boxplot()

Rep2BTPROM2 <- ggplot(data = SelectRep2BTPROM2, mapping = aes(Timepoint,WORCNorm)) + 
geom_boxplot()

Rep2BTPROM3 <- ggplot(data = SelectRep2BTPROM2, mapping = aes(Timepoint,WORCPhysicalQ3)) + 
geom_boxplot()

Rep2BTPROM1 / Rep2BTPROM2 / Rep2BTPROM3

```

```{r}
#| label: tbl-PROMsrep2BT1
#| tbl-cap: "Summary of PRULO Report 2 (Biceps Tenodesis) Cases - QuickDASH"

TableRep2BT5 <- SelectRep2BTPROM1 |>
dplyr::select(
  QDASH,
  QDASHDelta,
  Timepoint) |>
tbl_summary(by = "Timepoint",
            missing = "no",
            type = list(
              QDASH ~ "continuous",
              QDASHDelta ~ "continuous"
            ),
            statistic = all_continuous() ~ "{median} ({p25} - {p75})"
            ) 

gtsummary::as_flex_table(TableRep2BT5) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.7,
  align = "center",
  opts_word = list(
  split = TRUE
  )
)

```

```{r}
#| label: tbl-PROMsrep2BT2
#| tbl-cap: "Summary of PRULO Report 2 (Biceps Tenodesis) Cases - Western Ontario Rotator Cuff Index"

TableRep2BT6 <- SelectRep2BTPROM2 |>
dplyr::select(
  WORCNorm,
  WORCPhysicalQ3,
  #WORCDelta, #Insufficient data points
  Timepoint) |>
tbl_summary(by = "Timepoint",
            missing = "no",
            type = list(
              WORCNorm ~ "continuous",
              WORCPhysicalQ3 ~ "continuous"
            ),
            statistic = all_continuous() ~ "{median} ({p25} - {p75})"
            )

gtsummary::as_flex_table(TableRep2BT6) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.7,
  align = "center",
  opts_word = list(
  split = TRUE
  )
)
```

# Product Report 3 - Healix Advance Knotless BR

## Sample Selection

The sample of patients with the relevant product group were identified and data were retrieved for analysis by matching registry records to the relevant stock keeping units (SKUs) for the product group of interest. Usage statistics for the product group were added, and adverse events data were attached. Patient-reported data were retrieved and the dataset was manipulated to include relevant details for procedures of interest.

```{r}
#| label:  Reference-Code-Rep3

RefCode3 <- ProductTable |> filter(
  (Category == "Anchor"|Category == "Anchor + Suture") &
  stringr::str_detect(stringr::str_to_lower(Description),"advance") &
  stringr::str_detect(stringr::str_to_lower(Description),"br") &
  stringr::str_detect(stringr::str_to_lower(Description),"knotless") &
  stringr::str_detect(stringr::str_to_lower(Description),"healix")  
)

```

```{r}
#| label:  Slice-stack-Rep3

Pattern3 <- "healix advance knotless br"

SelectRep3 <- SnapshotComb4 |> 
  filter(
    str_detect(ImplantCodes,paste(RefCode3$Reference,collapse = "|"))
  ) |> mutate(
    Product1Check = stringr::str_detect(stringr::str_to_lower(Product1),Pattern3),
    Product2Check = stringr::str_detect(stringr::str_to_lower(Product2),Pattern3),
    Product3Check = stringr::str_detect(stringr::str_to_lower(Product3),Pattern3),
    Product4Check = stringr::str_detect(stringr::str_to_lower(Product4),Pattern3)
  ) |> mutate(
    Product1Count = case_when(
      Product1Check == TRUE ~ stringr::str_extract(Product1,"\\d"),
      .default = NA
    ),
    Product2Count = case_when(
      Product2Check == TRUE ~ stringr::str_extract(Product2,"\\d"),
      .default = NA
    ),
    Product3Count = case_when(
      Product3Check == TRUE ~ stringr::str_extract(Product3,"\\d"),
      .default = NA
    ),
    Product4Count = case_when(
      Product4Check == TRUE ~ stringr::str_extract(Product4,"\\d"),
      .default = NA
      )
    ) |> mutate(
      across(Product1Count:Product4Count,~as.numeric(.))
    ) |> rowwise() |> mutate(
    ProductCount =  sum(across(Product1Count:Product4Count), na.rm = TRUE)
      ) |> mutate(
        ProductCountFct = forcats::fct(
            as.character(ProductCount),
            levels = c("1","2","3","4","5")
          )
        ) |> mutate(
  Infection = TreatmentID %in% ComplicInfection$TreatmentID,
  Ligament_Tendon = TreatmentID %in% ComplicLigament_Tendon$TreatmentID,
  Stiffness = TreatmentID %in% ComplicStiffness$TreatmentID,
  Loosening = TreatmentID %in% ComplicLoosening$TreatmentID,
  Hardware =  TreatmentID %in% ComplicHardware$TreatmentID,
  Instability =  TreatmentID %in% ComplicInstability$TreatmentID,
  Neurological = TreatmentID %in% ComplicNeurological$TreatmentID,
  Fracture = TreatmentID %in% ComplicFracture$TreatmentID,
  Thrombosis = TreatmentID %in% ComplicThrombosis$TreatmentID,
  Effusion = TreatmentID %in% ComplicEffusion$TreatmentID,
  Pain = TreatmentID %in% ComplicPain$TreatmentID,
  Other = TreatmentID %in% ComplicOther$TreatmentID,

  Reop = TreatmentID %in% ComplicReop$TreatmentID
) |> left_join(
  ComplicTable3 |> group_by(TreatmentID) |> slice_max(`Reoperation Procedure Date`, n = 1) |> ungroup() |> dplyr::select(
    TreatmentID,
    ReopDelay_Occur,
    ReopDelay_Surgery,
    EventDelay
  ),
  by = "TreatmentID"
)
```

```{r Select PROMs Rep3}

SelectRep3PROM1 <- SnapshotPROM1 |>
  filter(
    str_detect(ImplantCodes,paste(RefCode3$Reference,collapse = "|"))
  )

SelectRep3PROM2 <- SnapshotPROM2 |>
  filter(
    str_detect(ImplantCodes,paste(RefCode3$Reference,collapse = "|"))
  )

```

```{r Select by Procedure Rep3}

SelectRep3RC <- SelectRep3 |> filter(str_detect(CuffRepair,"Repair"))

SelectRep3RCPROM1 <- SelectRep3PROM1 |> filter(str_detect(CuffRepair,"Repair"))
SelectRep3RCPROM2 <- SelectRep3PROM2 |> filter(str_detect(CuffRepair,"Repair"))

SelectRep3BT <- SelectRep3 |> filter(str_detect(LongHeadBiceps,"Tenodesis"))
SelectRep3BTPROM1<- SelectRep3PROM1 |> filter(str_detect(LongHeadBiceps,"Tenodesis"))
SelectRep3BTPROM2<- SelectRep3PROM2 |> filter(str_detect(LongHeadBiceps,"Tenodesis"))
```

## Overview

Usage of the Product within the patient group is summarised below.

```{epoxy}
#| label:  Overview-Rep3

{
  if(nrow(SelectRep3) == 1) {
    epoxy::epoxy("There is {nrow(SelectRep3)} case involving the anchor of interest.")
  } else {
    procedures <- unique(SelectRep3$ProcedureTotal)
    procedures <- procedures[procedures != "None" & procedures != "Unknown" & procedures != ""]
    procedures <- procedures[!grepl("^(Tenodesis|Tenotomy)$", procedures)]
    
    procedures_string <- if(length(procedures) > 1) {
  result3 <- paste(procedures[-length(procedures)], collapse = "] [")
  paste0(result3, "], and [", procedures[length(procedures)])
    } else {
      procedures
    }
    
    epoxy::epoxy("There are {nrow(SelectRep3)} cases involving the anchor of interest. Surgeries were performed between {format(min(SelectRep3$DateTreatment),'%Y-%b-%d')} and {format(max(SelectRep3$DateTreatment),'%Y-%b-%d')}. The procedures included [{procedures_string}].")
  }
} 
{ifelse(nrow(SelectRep3RC) == 1,
        epoxy::epoxy("There is {nrow(SelectRep3RC)} case involving the anchor of interest and a rotator cuff repair."),
        epoxy::epoxy("There are {nrow(SelectRep3RC)} cases involving the anchor of interest and a rotator cuff repair. Surgeries were performed between {format(min(SelectRep3RC$DateTreatment),'%Y-%b-%d')} to {format(max(SelectRep3RC$DateTreatment),'%Y-%b-%d')}.")
)} 
{ifelse(nrow(SelectRep3BT) == 1,
        epoxy::epoxy("There is {nrow(SelectRep3BT)} case involving the anchor of interest and a biceps tenodesis."),
        epoxy::epoxy("There are {nrow(SelectRep3BT)} cases involving the anchor of interest and a biceps tenodesis. Surgeries were performed between {format(min(SelectRep3BT$DateTreatment),'%Y-%b-%d')} to {format(max(SelectRep3BT$DateTreatment),'%Y-%b-%d')}.")
)}




```

## Procedure Report - Rotator Cuff Repair

### Patient Characteristics

Patient demographic, pathology, and treatment characteristics for this cohort receiving the Product are summarised below.

```{r}
#| label: tbl-Rep3RC1
#| tbl-cap: "Summary of PRULO Report 3 (Rotator Cuff) Cases - Patient Characteristics"

TableRep3RC1 <-
  SelectRep3RC |> mutate(
    SurgeonA = case_when(
      Surgeon == "KE" ~ "A",
      Surgeon == "RP" ~ "B",
      Surgeon == "GB" ~ "C",
      .default = NA_character_
  )) |>
  dplyr::select(
    AgeAtInitialExam,
    Sex,
    Cohort,
    IndexSide,
    BilateralStatus,
    SymptomDuration,
    SymptomDurationCat,
    #SurgeonA,
    LongHeadBiceps,
    TreatmentStatus,
    RegistryStatus
    ) |>
    tbl_summary(
      by = LongHeadBiceps,
      label = list(
        #SurgeonA ~ "Surgeon",
        AgeAtInitialExam ~ "Age at Initial Consultation (Years)",
        Sex = "Male",
        BilateralStatus ~ "Bilateral Presentation",
        IndexSide ~ "Dominant Side",
        SymptomDuration ~ "Symptom Duration (Weeks)",
        SymptomDurationCat ~ "Symptom Duration Category",
        TreatmentStatus ~ "Treatment Record Active",
        RegistryStatus ~ "Patient Record Active"
      ),
      type = list(
        AgeAtInitialExam ~ "continuous",
        SymptomDuration ~ "continuous",
        Sex ~ "dichotomous",
        TreatmentStatus ~ "dichotomous",
        RegistryStatus ~ "dichotomous"
      ),
      value = list(
        Sex = "Male",
        IndexSide = "Dominant",
        TreatmentStatus = "Ongoing",
        RegistryStatus = "Open"
      ),
      statistic = list(
        all_categorical() ~ "{p} ({n})"
        ),
      missing = "no"
    ) |> add_stat_label(
    location = "column"
  ) |> add_overall() |> modify_table_styling(
      columns = label,
      rows = label == "Symptom Duration Category",
      footnote = "Dichotomised below or equal to 0.5 years or greater than 0.5 years"
  ) |> modify_table_styling(
      columns = label,
      rows = label == "Treatment Record Active",
      footnote = "Treatment record remains active - no change to follow up"
  ) |> modify_table_styling(
      columns = label,
      rows = label == "Patient Record Active",
      footnote = "Patient record remains open - no change to consent or mortality status"
  ) 

gtsummary::as_flex_table(TableRep3RC1) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)

```

### Surgical Details

Surgical findings and management strategies are summarised below.

```{r}
#| eval: false

CuffStatus2 <- SelectRep3RC |> filter(is.na(CuffStatus))
```

<!--# There are a couple of cases that do not seem to fit the cuff status field properly. There is one GHI case that has the repair details (1399.1), but not cuff status inserted. The other is a general case that is a retorn RCR that probably needs to be moved across cohorts (193.2). -->

```{r}
#| label: tbl-Rep3RC2
#| tbl-cap: "Summary of PRULO Report 3 (Rotator Cuff) Cases Pathology and Surgical Details"


TableRep3RC2 <-
  SelectRep3RC |>
  dplyr::select(
    CuffStatus,
    TreatmentType,
    ProductCountFct, #This has a code block it depends on to derive this count within the dataframe - ensure its copied|amended into each report as required
    CuffRepair:AdjunctProcedure) |>
  tbl_summary(
      by = LongHeadBiceps,
      label = list(
        ProductCountFct ~ "Product Count",
        CuffStatus ~ "Cuff Status",
        TreatmentType ~ "Treatment Type",
        CuffRepair ~ "Cuff Repair",
        RepairAugmentation ~ "Repair Augmentation",
        LabrumRepair ~ "Labrum Repair",
        CapsuleLigament ~ "Capsule | Ligament",
        AdjunctProcedure ~ "Adjunct Procedure"
      ),
      statistic = list(
        all_categorical() ~ "{p} ({n})"
        ),
      missing = "no"
    ) |> add_overall() |> modify_table_styling(
      columns = label,
      rows = label == "Other",
      footnote = "Biceps tendon integration; Biceps tendon transfer; Tendon advancement"
    ) 

gtsummary::as_flex_table(TableRep3RC2) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)

```

### Treatment Survival

```{epoxy}
#| label:  Duration-Rep3-Proc1

The mean follow up duration is {round(SelectRep3RC |> ungroup() |> summarise(mean = mean(Duration))/52,1)} years, with a standard deviation of {round(SelectRep3RC |> ungroup() |> summarise(sd = sd(Duration))/52,2)} years.

```

Failure or revision events as identified in the registry for this cohort are summarised below. Individual failure data can be accessed in [Attachment 1](https://docs.google.com/spreadsheets/d/1ESVvSKAv8ma11kri9pby6OEU9Gk5Z3UnF6XwjXBTcTg/edit#gid=0).

```{r}
#| label: tbl-Rep3RC34
#| tbl-cap: "Summary of PRULO Report 3 (Rotator Cuff) Procedure Survival"

TableRep3RC3 <- tbl_survfit(
  survfit2(Surv(Duration, Status) ~ 1, 
           data = SelectRep3RC),
  times = c(1,26,52,104),
  label_header = "**{time} Weeks**",
  label = "Procedure Survival",
  statistic = "{estimate} ({conf.low} - {conf.high})"
) |> gtsummary::modify_footnote_header(
    footnote = "% survival with 95% confidence intervals",
    columns = all_stat_cols(),
  )

gtsummary::as_flex_table(TableRep3RC3) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)
```

```{r}
#| label:  Failure-Report-Rep3A-Proc1

#Previous surgery(ies) at the same site Anatomical Location 
#Anchor 1 Anchor 2 Anchor 3 Anchor 4

FailuresRep3RC <-
  SelectRep3RC |> mutate(
    TreatmentStatusDesc = stringr::str_to_sentence(TreatmentStatusNotes)
  ) |>
      filter(TreatmentStatus == "Failed") |> 
  dplyr::select(
    TreatmentID,
    AgeAtInitialExam, 
    Sex,
    TreatmentType,
    Duration,
    TreatmentStatusDesc,
    ReoperationProcedure2,
    SubsequentTx2,
    Product1,
    Product2,
    Product3,
    Product4,
    QDASH_TotalScore_Preop,
    QDASH_TotalScore_3months,
    QDASH_TotalScore_6months) |> mutate(
      Procedure = "Cuff Repair"
    ) |> arrange(
      TreatmentID
    )

```

```{r}
#| label:  Failure-Report-Rep3A-write
#| eval: false
#| include: false

# Authenticate for sheets using the same token
gs4_auth(token = drive_token())

# Do the write operation silently
if (nrow(FailuresRep3RC) > 0) {
  invisible(
    googlesheets4::range_write(
 ss = SheetIDs$AuditReport,
 data = FailuresRep3RC |> arrange(TreatmentID),
 sheet = "Failures3",
 range = "A1:P",
 col_names = TRUE
    )
  )
}


```


```{r}
#| label:  Failure-Report-Rep3A-display

if (nrow(FailuresRep3RC) == 0) {
  epoxy::epoxy_html("There are no failures to report.")
} else {
  epoxy::epoxy_html('Failures were written to <a href="{{SheetIDs$AuditReport}}"Attachment 1/a> for further review')
}


```

### Adverse Events

Complications and adverse events are summarised below. Individual reoperation data can be accessed in [Attachment 1](https://docs.google.com/spreadsheets/d/1ESVvSKAv8ma11kri9pby6OEU9Gk5Z3UnF6XwjXBTcTg/edit#gid=0).


```{r}
#| label: tbl-intraop-complications-3A
#| tbl-cap: "Summary of PRULO Report 3 (Rotator Cuff) Cases - Intraoperative Events"

# Check if any complications exist in filtered data
has_complications <- SelectRep3RC |> 
  filter(TreatmentID %in% IntraopComp$TreatmentID) |> 
  nrow() > 0

# Conditionally generate content
if (!has_complications) {
  # If no complications, return the text message
  epoxy("No intraoperative complications observed.")
} else {
  # Calculate incidence and confidence intervals
  total_cases <- nrow(SelectRep3RC)
  complication_cases <- SelectRep3RC |> 
    filter(TreatmentID %in% IntraopComp$TreatmentID) |> 
    nrow()
  
  # Calculate proportion and 95% CI using Wilson method
  prop_result <- binom::binom.confint(complication_cases, total_cases, 
                                      methods = "wilson")
  incidence_pct <- round(prop_result$mean * 100, 1)
  ci_lower <- round(prop_result$lower * 100, 1)
  ci_upper <- round(prop_result$upper * 100, 1)
  
  # Generate summary sentence
  summary_text <- glue::glue(
    "Intraoperative events occurred in {complication_cases} of {total_cases} cases ({incidence_pct}%, 95% CI: {ci_lower}%-{ci_upper}%)."
  )
  
  # Print summary sentence
  cat(summary_text, "\n\n")
  
  # Generate and return the table
  IntraopComp |> 
    filter(TreatmentID %in% SelectRep3RC$TreatmentID) |> 
    rename(
      Description = "ICNature2",
      Intervention = "ICIntervention",
      PostopManagement = "ICPostopManagement"
    ) |> 
    select(
      TreatmentID,
      Description,
      Intervention,
      PostopManagement
    ) |> 
    gt::gt()
}

```


```{r}
#| label:  Complication-Other-Rep3


SelectRep3Other <- SelectRep3 |> filter(
  Other == TRUE
) |> dplyr::select(
  TreatmentID,
  DateTreatment,
  Cohort
)
```

```{r}
#| label: tbl-Rep3RC4
#| tbl-cap: "Summary of PRULO Report 3 (Rotator Cuff) Cases - Postoperative Events"

# Now create the summary table
TableRep3RC4 <- SelectRep3RC |>
  dplyr::select(
    Infection,
    Ligament_Tendon,
    Effusion,
    Pain,
    Hardware,
    Loosening,
    Instability,
    Stiffness,
    Neurological,
    Thrombosis,
    Other,
    Reop,
    SubsequentTx2, #Inserted to address C028
    #ReopDelay_Surgery
    ) |>
  tbl_summary(
    label = list(
      Ligament_Tendon ~ "Ligament|Tendon (Retear)",
      #ReopDelay_Surgery ~ "Reoperation Delay (Weeks)",
      
      Reop ~ "Reoperation",
      SubsequentTx2 ~ "Subsequent Treatment"
      ),
    # type = list(
    #   ReopDelay_Surgery ~ "continuous"
    # ),
    statistic = list(
      all_categorical() ~ "{p} ({n})",
      all_continuous() ~ "{mean} ({sd})"
    ),
    missing = "no"
    ) |> add_ci(
       statistic = list(
         all_categorical() ~ "{conf.low} - {conf.high}"
         #all_continuous() ~ "{conf.low} - {conf.high}"

       )
     ) |> modify_table_styling(
      columns = label,
      rows = label == "Other",
      footnote = "Myocardial Infarction"
    ) |> modify_table_styling (
      columns = label,
      rows = label == "Subsequent Treatment",
      footnote = "Management undertaken for procedures that have suffered tissue failure or required hardware removal or replacement"
    ) |> modify_table_styling(
      columns = label,
      rows = label == "Reoperation",
      footnote = "A theatre procedure subsequent to the index surgery that does not involve removal, replacement or modification of the construct."
    )  


gtsummary::as_flex_table(TableRep3RC4) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
  split = TRUE
  )
)


```

```{r}
#| label:  Reoperations-Report-Rep3A-Proc1

#echo: false
#warning: false

#Previous surgery(ies) at the same site Anatomical Location 
#Anchor 1 Anchor 2 Anchor 3 Anchor 4

##Flip this around so that multiple reoperations are retained


SelectRep3RCReop <- ComplicTable3 |> filter(
  TreatmentID %in% SelectRep3RC$TreatmentID,
  `Reoperation Procedure` == "Yes"
  ) |> group_by(TreatmentID) |> slice_min(
    ReopDelay_Surgery,
    n = 1
    ) |> ungroup() |> left_join(
      SelectRep3 |> dplyr::select(
    TreatmentID,
    AgeAtInitialExam,
    Sex,
    TreatmentType,
    Product1,
    Product2,
    Product3,
    Product4,
    QDASH_TotalScore_Preop,
    QDASH_TotalScore_3months,
    QDASH_TotalScore_6months
      ),
    by = "TreatmentID",
    relationship = "one-to-one"
    ) |>
  mutate(
     QDASH_TotalScore_Preop = as.numeric(QDASH_TotalScore_Preop),
     QDASH_TotalScore_3months = as.numeric(QDASH_TotalScore_3months),
     QDASH_TotalScore_6months =as.numeric(QDASH_TotalScore_6months)
  ) |> dplyr::select(
    TreatmentID,
    AgeAtInitialExam,
    Sex,
    TreatmentType,
    `Complication Nature`,

    EventDelay,
    Product1,
    Product2,
    Product3,
    Product4,
    QDASH_TotalScore_Preop,
    QDASH_TotalScore_3months,
    QDASH_TotalScore_6months
  ) |> mutate(
    Procedure = "Cuff Repair"
    ) |> arrange(
    TreatmentID
    )

```


```{r}
#| label:  Reoperations-Report-Rep3A-write

# Authenticate for sheets using the same token
gs4_auth(token = drive_token())

# Do the write operation silently
if (nrow(SelectRep3RCReop) > 0) {
  invisible(
    googlesheets4::range_write(
 ss = SheetIDs$AuditReport,
 data = SelectRep3RCReop,
 sheet = "Reoperations3",
 range = "A1:P",
 col_names = TRUE
    )
  )
}


```


```{r}
#| label:  Reoperations-Report-Rep3A-display

if (nrow(SelectRep3RCReop) == 0) {
  epoxy::epoxy_html("There are no reoperations to report.")
} else {
  epoxy::epoxy_html('Reoperations were written to <a href="{{SheetIDs$AuditReport}}"Attachment 1/a> for further review')
}


```

### Patient-Reported Outcomes

Complete case analysis of QDASH, WORC Index Normalised, and WORC Physical Question 3 (How much weakness do you experience in your shoulder?) is summarised below.

```{r}
#| label: fig-PROMsRep3RC
#| fig-cap: "Complete case analysis of QDASH(Top), WORC Normalised (Middle) and WORC Physical Question 3 (Bottom)"

Rep3RCPROM1 <- ggplot(data = SelectRep3RCPROM1, mapping = aes(Timepoint,QDASH)) + 
geom_boxplot()

Rep3RCPROM2 <- ggplot(data = SelectRep3RCPROM2, mapping = aes(Timepoint,WORCNorm)) + 
geom_boxplot()

Rep3RCPROM3 <- ggplot(data = SelectRep3RCPROM2, mapping = aes(Timepoint,WORCPhysicalQ3)) + 
geom_boxplot()

Rep3RCPROM1 / Rep3RCPROM2 / Rep3RCPROM3

```

```{r}
#| label: tbl-Rep3RC5
#| tbl-cap: "Summary of PRULO Report 3 (Rotator Cuff) Cases - QuickDASH"


TableRep3RC5 <- SelectRep3RCPROM1 |>
dplyr::select(
  QDASH,
  QDASHDelta,
  Timepoint) |>
tbl_summary(by = "Timepoint",
            missing = "no",
            type = list(
              QDASH ~ "continuous",
              QDASHDelta ~ "continuous"
            ),
            statistic = all_continuous() ~ "{median} ({p25} - {p75})"
            )


gtsummary::as_flex_table(TableRep3RC5) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
  split = TRUE
  )
)

```

```{r}
#| label: tbl-Rep3RC6
#| tbl-cap: "Summary of PRULO Report 3 (Rotator Cuff) Cases - Western Ontario Rotator Cuff Index"

TableRep3RC6 <- SelectRep3RCPROM2 |>
dplyr::select(WORCNorm,
              WORCPhysicalQ3,
              WORCDelta,
              Timepoint) |>
tbl_summary(by = "Timepoint",
            missing = "no",
            type = list(
              WORCNorm  ~ "continuous",
              WORCPhysicalQ3  ~ "continuous",
              WORCDelta  ~ "continuous"
            ),
            statistic = all_continuous() ~ "{median} ({p25} - {p75})")
  
gtsummary::as_flex_table(TableRep3RC6) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
  split = TRUE
  )
)
```

## Procedure Report - Biceps Tenodesis

### Patient Characteristics

Patient demographic, pathology, and treatment characteristics for this cohort receiving the Product are summarised below.

```{r}
#| label: tbl-Rep3BT1
#| tbl-cap: "Summary of PRULO Report 3 (Biceps Tenodesis) Case - Patient Characteristics"
#| 
TableRep3BT1 <-
  SelectRep3BT |> mutate(
    SurgeonA = case_when(
      Surgeon == "KE" ~ "A",
      Surgeon == "RP" ~ "B",
      Surgeon == "GB" ~ "C",
      .default = NA_character_
  )) |>
  dplyr::select(
    AgeAtInitialExam,
    Sex,
    Cohort,
    IndexSide,
    BilateralStatus,
    #SymptomDuration,
    SymptomDurationCat,
    #SurgeonA,
    LongHeadBiceps,
    TreatmentStatus,
    RegistryStatus
    ) |>
    tbl_summary(
      by = LongHeadBiceps,
      label = list(
        #SurgeonA ~ "Surgeon",
        AgeAtInitialExam ~ "Age at Initial Consultation (Years)",
        Sex = "Male",
        BilateralStatus ~ "Bilateral Presentation",
        IndexSide ~ "Dominant Side",
        #SymptomDuration ~ "Symptom Duration (Weeks)",
        SymptomDurationCat ~ "Symptom Duration Category",
        TreatmentStatus ~ "Treatment Record Active",
        RegistryStatus ~ "Patient Record Active"
      ),
      type = list(
        AgeAtInitialExam ~ "continuous",
        #SymptomDuration ~ "continuous",
        Sex ~ "dichotomous",
        TreatmentStatus ~ "dichotomous",
        RegistryStatus ~ "dichotomous"
      ),
      value = list(
        Sex = "Male",
        IndexSide = "Dominant",
        TreatmentStatus = "Ongoing",
        RegistryStatus = "Open"
      ),
      statistic = list(
        all_categorical() ~ "{p} ({n})"
        ),
      missing = "no"
    )|> add_stat_label(
    location = "column"
  ) |> modify_table_styling(
      columns = label,
      rows = label == "Symptom Duration Category",
      footnote = "Dichotomised below or equal to 0.5 years or greater than 0.5 years"
  ) |> modify_table_styling(
      columns = label,
      rows = label == "Treatment Record Active",
      footnote = "Treatment record remains active - no change to follow up"
  ) |> modify_table_styling(
      columns = label,
      rows = label == "Patient Record Active",
      footnote = "Patient record remains open - no change to consent or mortality status"
  )

gtsummary::as_flex_table(TableRep3BT1) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)

```

### Surgical Details

Surgical findings and management strategies are summarised below.

```{r}
#| label: tbl-Rep3BT2
#| tbl-cap: "Summary of PRULO Report 3 (Biceps Tenodesis) Cases Pathology and Surgical Details"

TableRep3BT2 <-
  SelectRep3BT |>
  dplyr::select(
    CuffStatus,
    TreatmentType,
    ProductCountFct, #This has a code block it depends on to derive this count within the dataframe - ensure its copied|amended into each report as required
    CuffRepair:AdjunctProcedure,
    TreatmentType) |>
  tbl_summary(
    label = list(
        ProductCountFct ~ "Product Count",
        CuffStatus ~ "Cuff Status",
        TreatmentType ~ "Treatment Type",
        CuffRepair ~ "Cuff Repair",
        RepairAugmentation ~ "Repair Augmentation",
        LabrumRepair ~ "Labrum Repair",
        CapsuleLigament ~ "Capsule | Ligament",
        AdjunctProcedure ~ "Adjunct Procedure",
        LongHeadBiceps ~ "Long Head Biceps Procedures"
      ),
    #by = "LongHeadBiceps",
    missing = "no") |> modify_table_styling(
      columns = label,
      rows = label == "Other",
      footnote = "Biceps tendon integration; Biceps tendon transfer; Tendon advancement"
    )
  
 gtsummary::as_flex_table(TableRep3BT2) |> flextable::set_table_properties(
   layout = "autofit",
   width = 0.15,
   align = "center",
   opts_word = list(
   split = TRUE
   )
   )

```

### Treatment Survival

```{epoxy}
#| label:  Duration-Rep3-Proc2

The mean follow up duration is {round(SelectRep3BT |> ungroup() |> summarise(mean = mean(Duration))/52,1)} years, with a standard deviation of {round(SelectRep3BT |> ungroup() |> summarise(sd = sd(Duration))/52,2)} years.
```

Failure or revision events as identified in the registry for this cohort are summarised below.

Individual failure data can be accessed in [Attachment 1](https://docs.google.com/spreadsheets/d/1ESVvSKAv8ma11kri9pby6OEU9Gk5Z3UnF6XwjXBTcTg/edit)

```{r}
#| label: tbl-Rep3BT3
#| tbl-cap: "Summary of PRULO Report 3 (Biceps Tenodesis) procedure survival"

TableRep3BT3 <- tbl_survfit(
  survfit2(Surv(Duration, Status) ~ 1, 
           data = SelectRep3BT),
  times = c(1,26,52,104),
  label_header = "**{time} Weeks**",
  label = "Procedure Survival",
  statistic = "{estimate} ({conf.low} - {conf.high})"
) |> gtsummary::modify_footnote_header(
    footnote = "% survival with 95% confidence intervals",
    columns = all_stat_cols(),
  )

 gtsummary::as_flex_table(TableRep3BT3) |> flextable::set_table_properties(
   layout = "autofit",
   width = 0.5,
   align = "center",
   opts_word = list(
     split = TRUE
   )
)
```

```{r}
#| label: Failure-Report-Rep3A-Proc2

#Previous surgery(ies) at the same site Anatomical Location 
#Anchor 1 Anchor 2 Anchor 3 Anchor 4

FailuresRep3BT <-
  SelectRep3BT |> mutate(
    TreatmentStatusDesc = stringr::str_to_sentence(TreatmentStatusNotes)
  ) |>
      filter(TreatmentStatus == "Failed") |> 
  dplyr::select(
    TreatmentID,
    AgeAtInitialExam, 
    Sex,
    TreatmentType,
    Duration,
    TreatmentStatusDesc,
    ReoperationProcedure2,
    SubsequentTx2,
    Product1,
    Product2,
    Product3,
    Product4,
    QDASH_TotalScore_Preop,
    QDASH_TotalScore_3months,
    QDASH_TotalScore_6months) |> mutate(
      Procedure = "Biceps Tenodesis"
    )

```

```{r}
#| label:  Failure-Report-Rep3B-write
#| eval: false
#| include: false

# Authenticate for sheets using the same token
gs4_auth(token = drive_token())

# Do the write operation silently
if (nrow(FailuresRep3BT) > 0) {
  invisible(
    googlesheets4::sheet_append(
 ss = SheetIDs$AuditReport,
 data = FailuresRep3BT |> arrange(TreatmentID),
 sheet = "Failures3"
    )
  )
}


```


```{r}
#| label:  Failure-Report-Rep3B-display

if (nrow(FailuresRep3BT) == 0) {
  epoxy::epoxy_html("There are no failures to report.")
} else {
  epoxy::epoxy_html('Failures were written to <a href="{{SheetIDs$AuditReport}}"Attachment 1/a> for further review')
}


```

### Adverse Events

Complications and adverse events are summarised below. Individual reoperation data can be accessed in [Attachment 1](https://docs.google.com/spreadsheets/d/1ESVvSKAv8ma11kri9pby6OEU9Gk5Z3UnF6XwjXBTcTg/edit#gid=0).


```{r}
#| label: tbl-intraop-complications-3B
#| tbl-cap: "Summary of PRULO Report 3 (Biceps Tenodesis) Cases - Intraoperative Events"

# Check if any complications exist in filtered data
has_complications <- SelectRep3BT |> 
  filter(TreatmentID %in% IntraopComp$TreatmentID) |> 
  nrow() > 0

# Conditionally generate content
if (!has_complications) {
  # If no complications, return the text message
  epoxy("No intraoperative complications observed.")
} else {
  # Calculate incidence and confidence intervals
  total_cases <- nrow(SelectRep3BT)
  complication_cases <- SelectRep3BT |> 
    filter(TreatmentID %in% IntraopComp$TreatmentID) |> 
    nrow()
  
  # Calculate proportion and 95% CI using Wilson method
  prop_result <- binom::binom.confint(complication_cases, total_cases, 
                                      methods = "wilson")
  incidence_pct <- round(prop_result$mean * 100, 1)
  ci_lower <- round(prop_result$lower * 100, 1)
  ci_upper <- round(prop_result$upper * 100, 1)
  
  # Generate summary sentence
  summary_text <- glue::glue(
    "Intraoperative events occurred in {complication_cases} of {total_cases} cases ({incidence_pct}%, 95% CI: {ci_lower}%-{ci_upper}%)."
  )
  
  # Print summary sentence
  cat(summary_text, "\n\n")
  
  # Generate and return the table
  IntraopComp |> 
    filter(TreatmentID %in% SelectRep3BT$TreatmentID) |> 
    rename(
      Description = "ICNature2",
      Intervention = "ICIntervention",
      PostopManagement = "ICPostopManagement"
    ) |> 
    select(
      TreatmentID,
      Description,
      Intervention,
      PostopManagement
    ) |> 
    gt::gt()
}

```

```{r}
#| label: tbl-Rep3BT4
#| tbl-cap: "Summary of PRULO Report 3 (Biceps Tenodesis) Cases - Postoperative Events"

# Now create the summary table
TableRep3BT4 <- SelectRep3BT |>
  dplyr::select(
    Infection,
    Ligament_Tendon,
    Effusion,
    Pain,
    Hardware,
    Loosening,
    Instability,
    Stiffness,
    Neurological,
    Thrombosis,
    Other,
    Reop,
    SubsequentTx2 #Inserted to address C028
    #ReopDelay_Surgery
    ) |>
  tbl_summary(
    label = list(
      Ligament_Tendon ~ "Ligament|Tendon (Retear)",
      #ReopDelay_Surgery ~ "Reoperation Delay (Weeks)",
      
      Reop ~ "Reoperation",
      SubsequentTx2 ~ "Subsequent Treatment"
      ),
    # type = list(
    #   ReopDelay_Surgery ~ "continuous"
    # ),
    statistic = list(
      all_categorical() ~ "{p} ({n})"
      #all_continuous() ~ "{mean} ({sd})"
    ),
    missing = "no",) |> add_ci(
      statistic = list(
        all_categorical() ~ "{conf.low} - {conf.high}"
        #all_continuous() ~ "{conf.low} - {conf.high}"
        
      )
    ) |> modify_table_styling (
      columns = label,
      rows = label == "Subsequent Treatment",
      footnote = "Management undertaken for procedures that have suffered tissue failure or required hardware removal or replacement"
    ) |> modify_table_styling(
      columns = label,
      rows = label == "Reoperation",
      footnote = "A theatre procedure subsequent to the index surgery that does not involve removal, replacement or modification of the construct."
    ) 

gtsummary::as_flex_table(TableRep3BT4) |> flextable::set_table_properties(
   layout = "autofit",
   width = 0.15,
   align = "center",
   opts_word = list(
     split = TRUE
   )
)
```

```{r}
#| label:  Reoperations-Report-Rep3A-Proc2

#echo: false
#warning: false

#Previous surgery(ies) at the same site Anatomical Location 
#Anchor 1 Anchor 2 Anchor 3 Anchor 4

##Flip this around so that multiple reoperations are retained


SelectRep3BTReop <- ComplicTable3 |> filter(
  TreatmentID %in% SelectRep3BT$TreatmentID,
  `Reoperation Procedure` == "Yes"
  ) |> group_by(TreatmentID) |> slice_min(
    ReopDelay_Surgery,
    n = 1
    ) |> ungroup() |> left_join(
      SelectRep3 |> dplyr::select(
    TreatmentID,
    AgeAtInitialExam,
    Sex,
    TreatmentType,
    Product1,
    Product2,
    Product3,
    Product4,
    QDASH_TotalScore_Preop,
    QDASH_TotalScore_3months,
    QDASH_TotalScore_6months
      ),
    by = "TreatmentID",
    relationship = "one-to-one"
    ) |>
  mutate(
     QDASH_TotalScore_Preop = as.numeric(QDASH_TotalScore_Preop),
     QDASH_TotalScore_3months = as.numeric(QDASH_TotalScore_3months),
     QDASH_TotalScore_6months =as.numeric(QDASH_TotalScore_6months)
  ) |> dplyr::select(
    TreatmentID,
    AgeAtInitialExam,
    Sex,
    TreatmentType,
    `Complication Nature`,

    EventDelay,
    Product1,
    Product2,
    Product3,
    Product4,
    QDASH_TotalScore_Preop,
    QDASH_TotalScore_3months,
    QDASH_TotalScore_6months
  ) |> mutate(
    Procedure = "Biceps Tenodesis"
  ) |> arrange(
    TreatmentID
    )

```

```{r}
#| label:  Reoperations-Report-Rep3B-write


# Authenticate for sheets using the same token
gs4_auth(token = drive_token())

# Do the write operation silently
if (nrow(SelectRep3BTReop) > 0) {
  invisible(
    googlesheets4::sheet_append(
 ss = SheetIDs$AuditReport,
 data = SelectRep3BTReop,
 sheet = "Reoperations3"
    )
  )
}


```


```{r}
#| label:  Reoperations-Report-Rep3B-display

if (nrow(SelectRep3BTReop) == 0) {
  epoxy::epoxy_html("There are no reoperations to report.")
} else {
  epoxy::epoxy_html('Reoperations were written to <a href="{{SheetIDs$AuditReport}}"Attachment 1/a> for further review')
}


```

### Patient-Reported Outcomes

Complete case analysis of QDASH, WORC Normalised, and WORC Physical Q3 is summarised below.

```{r}
#| label: fig-PROMsRep3BT
#| fig-cap: "Complete case analysis of QDASH(Top), WORC Normalised (Middle) and WORC Physical Question 3 (Bottom)"


Rep3BTPROM1 <- ggplot(data = SelectRep3BTPROM1, mapping = aes(Timepoint,QDASH)) + 
geom_boxplot()

Rep3BTPROM2 <- ggplot(data = SelectRep3BTPROM2, mapping = aes(Timepoint,WORCNorm)) + 
geom_boxplot()

Rep3BTPROM3 <- ggplot(data = SelectRep3BTPROM2, mapping = aes(Timepoint,WORCPhysicalQ3)) + 
geom_boxplot()

Rep3BTPROM1 / Rep3BTPROM2 / Rep3BTPROM3

```

```{r}
#| label: tbl-PROMsrep3BT1
#| tbl-cap: "Summary of PRULO Report 3 (Biceps Tenodesis) Cases - QuickDASH"


TableRep3BT5 <- SelectRep3BTPROM1 |>
dplyr::select(
  QDASH,
  QDASHDelta,
  Timepoint) |>
tbl_summary(by = "Timepoint",
            missing = "no",
            type = list(
              QDASH ~ "continuous",
              QDASHDelta ~ "continuous"
            ),
            statistic = all_continuous() ~ "{median} ({p25} - {p75})"
            )

gtsummary::as_flex_table(TableRep3BT5) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
  )
)

```

```{r}
#| label: tbl-PROMsrep3BT2
#| tbl-cap: "Summary of PRULO Report 3 (Biceps Tenodesis) Cases - Western Ontario Rotator Cuff Index"


TableRep3BT6 <- SelectRep3BTPROM2 |>
dplyr::select(
  WORCNorm,
  WORCPhysicalQ3,
  #WORCDelta, #Insufficient data points
  Timepoint) |>
tbl_summary(by = "Timepoint",
            missing = "no",
            type = list(
              WORCNorm ~ "continuous",
              WORCPhysicalQ3 ~ "continuous"
            ),
            statistic = all_continuous() ~ "{median} ({p25} - {p75})"
            )

gtsummary::as_flex_table(TableRep3BT6) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
  split = TRUE
  )
)
```

# Product Report 4 - Healix Advance BR with Dynacord

## Sample Selection

The sample of patients with the relevant product group were identified and data were retrieved for analysis by matching registry records to the relevant stock keeping units (SKUs) for the product group of interest. Usage statistics for the product group were added, and adverse events data were attached. Patient-reported data were retrieved and the dataset was manipulated to include relevant details for procedures of interest.

```{r}
#| label: Reference-Code-Rep4

RefCode4 <- ProductTable |> filter(
  (Category == "Anchor + Suture") &
  stringr::str_detect(stringr::str_to_lower(Description),"advance") &
  stringr::str_detect(stringr::str_to_lower(Description),"br") &
  stringr::str_detect(stringr::str_to_lower(Description),"healix") &
  stringr::str_detect(stringr::str_to_lower(Description),"dynacord")
)

```

```{r}
#| label: Slice-stack-Rep4

Pattern4 <- "healix advance br dynacord"

SelectRep4 <- SnapshotComb4 |> 
  filter(
    str_detect(ImplantCodes,paste(RefCode4$Reference,collapse = "|"))
  ) |> mutate(
    Product1Check = stringr::str_detect(stringr::str_to_lower(Product1),Pattern4),
    Product2Check = stringr::str_detect(stringr::str_to_lower(Product2),Pattern4),
    Product3Check = stringr::str_detect(stringr::str_to_lower(Product3),Pattern4),
    Product4Check = stringr::str_detect(stringr::str_to_lower(Product4),Pattern4)
  ) |> mutate(
    Product1Count = case_when(
      Product1Check == TRUE ~ stringr::str_extract(Product1,"\\d"),
      .default = NA
    ),
    Product2Count = case_when(
      Product2Check == TRUE ~ stringr::str_extract(Product2,"\\d"),
      .default = NA
    ),
    Product3Count = case_when(
      Product3Check == TRUE ~ stringr::str_extract(Product3,"\\d"),
      .default = NA
    ),
    Product4Count = case_when(
      Product4Check == TRUE ~ stringr::str_extract(Product4,"\\d"),
      .default = NA
      )
    ) |> mutate(
      across(Product1Count:Product4Count,~as.numeric(.))
    ) |> rowwise() |> mutate(
    ProductCount =  sum(across(Product1Count:Product4Count), na.rm = TRUE)
      ) |> mutate(
        ProductCountFct = forcats::fct(
            as.character(ProductCount),
            levels = c("1","2","3","4","5")
          )
        ) |> mutate(
  Infection = TreatmentID %in% ComplicInfection$TreatmentID,
  Ligament_Tendon = TreatmentID %in% ComplicLigament_Tendon$TreatmentID,
  Stiffness = TreatmentID %in% ComplicStiffness$TreatmentID,
  Loosening = TreatmentID %in% ComplicLoosening$TreatmentID,
  Hardware = TreatmentID %in% ComplicHardware$TreatmentID,
  Instability = TreatmentID %in% ComplicInstability$TreatmentID,
  Neurological = TreatmentID %in% ComplicNeurological$TreatmentID,
  Fracture = TreatmentID %in% ComplicFracture$TreatmentID,
  Thrombosis = TreatmentID %in% ComplicThrombosis$TreatmentID,
  Effusion = TreatmentID %in% ComplicEffusion$TreatmentID,
  Pain = TreatmentID %in% ComplicPain$TreatmentID,
  Other = TreatmentID %in% ComplicOther$TreatmentID,

  Reop = TreatmentID %in% ComplicReop$TreatmentID
) |> left_join(
  ComplicTable3 |> group_by(TreatmentID) |> slice_max(`Reoperation Procedure Date`, n = 1) |> ungroup() |> dplyr::select(
    TreatmentID,
    ReopDelay_Occur,
    ReopDelay_Surgery,
    EventDelay
  ),
  by = "TreatmentID"
)
```

```{r}
#| label: Select-PROMs-Rep4

SelectRep4PROM1 <- SnapshotPROM1 |>
  filter(
    str_detect(ImplantCodes,paste(RefCode4$Reference,collapse = "|"))
  )

SelectRep4PROM2 <- SnapshotPROM2 |>
  filter(
    str_detect(ImplantCodes,paste(RefCode4$Reference,collapse = "|"))
  )

```

```{r}
#| label:  Select-Procedure-Rep4

SelectRep4RC <- SelectRep4 |> filter(str_detect(CuffRepair,"Repair"))

SelectRep4RCPROM1 <- SelectRep4PROM1 |> filter(str_detect(CuffRepair,"Repair"))
SelectRep4RCPROM2 <- SelectRep4PROM2 |> filter(str_detect(CuffRepair,"Repair"))

SelectRep4BT <- SelectRep4 |> filter(str_detect(LongHeadBiceps,"Tenodesis"))
SelectRep4BTPROM1<- SelectRep4PROM1 |> filter(str_detect(LongHeadBiceps,"Tenodesis"))
SelectRep4BTPROM2<- SelectRep4PROM2 |> filter(str_detect(LongHeadBiceps,"Tenodesis"))
```

## Overview

Usage of the Product within the patient group is summarised below.

```{epoxy}
#| label:  Overview-Rep4

{
  if(nrow(SelectRep4) == 1) {
    epoxy::epoxy("There is {nrow(SelectRep4)} case involving the anchor of interest.")
  } else {
    procedures <- unique(SelectRep4$ProcedureTotal)
    procedures <- procedures[procedures != "None" & procedures != "Unknown" & procedures != ""]
    procedures <- procedures[!grepl("^(Tenodesis|Tenotomy)$", procedures)]
    
    procedures_string <- if(length(procedures) > 1) {
  result4 <- paste(procedures[-length(procedures)], collapse = "] [")
  paste0(result4, "], and [", procedures[length(procedures)])
    }  else {
      procedures
    }
    
    epoxy::epoxy("There are {nrow(SelectRep4)} cases involving the anchor of interest. Surgeries were performed between {format(min(SelectRep4$DateTreatment),'%Y-%b-%d')} and {format(max(SelectRep4$DateTreatment),'%Y-%b-%d')}. The procedures included [{procedures_string}].")
  }
} 
{ifelse(nrow(SelectRep4RC) == 1,
        epoxy::epoxy("There is {nrow(SelectRep4RC)} case involving the anchor of interest and a rotator cuff repair."),
        epoxy::epoxy("There are {nrow(SelectRep4RC)} cases involving the anchor of interest and a rotator cuff repair. Surgeries were performed between {format(min(SelectRep4RC$DateTreatment),'%Y-%b-%d')} to {format(max(SelectRep4RC$DateTreatment),'%Y-%b-%d')}.")
)} 
{ifelse(nrow(SelectRep4BT) == 1,
        epoxy::epoxy("There is {nrow(SelectRep4BT)} case involving the anchor of interest and a biceps tenodesis."),
        epoxy::epoxy("There are {nrow(SelectRep4BT)} cases involving the anchor of interest and a biceps tenodesis. Surgeries were performed between {format(min(SelectRep4BT$DateTreatment),'%Y-%b-%d')} to {format(max(SelectRep4BT$DateTreatment),'%Y-%b-%d')}.")
)}

```

## Procedure Report - Rotator Cuff Repair

### Patient Characteristics

Patient demographic, pathology, and treatment characteristics for this cohort receiving the Product are summarised below.

```{r}
#| label: tbl-TableRep4RC1
#| tbl-cap: "Summary of PRULO Report 4 (Rotator Cuff) Case - Patient Characteristics"

TableRep4RC1 <-
  SelectRep4RC |> mutate(
    SurgeonA = case_when(
      Surgeon == "KE" ~ "A",
      Surgeon == "RP" ~ "B",
      Surgeon == "GB" ~ "C",
      .default = NA_character_
  )) |>
  dplyr::select(
    AgeAtInitialExam,
    Sex,
    Cohort,
    IndexSide,
    BilateralStatus,
    SymptomDuration,
    SymptomDurationCat,
    #SurgeonA,
    LongHeadBiceps,
    TreatmentStatus,
    RegistryStatus
    ) |>
    tbl_summary(
      by = LongHeadBiceps,
      label = list(
        #SurgeonA ~ "Surgeon",
        AgeAtInitialExam ~ "Age at Initial Consultation (Years)",
        Sex = "Male",
        BilateralStatus ~ "Bilateral Presentation",
        IndexSide ~ "Dominant Side",
        SymptomDuration ~ "Symptom Duration (Weeks)",
        SymptomDurationCat ~ "Symptom Duration Category",
        TreatmentStatus ~ "Treatment Record Active",
        RegistryStatus ~ "Patient Record Active"
      ),
      type = list(
        AgeAtInitialExam ~ "continuous",
        SymptomDuration ~ "continuous",
        Sex ~ "dichotomous",
        TreatmentStatus ~ "dichotomous",
        RegistryStatus ~ "dichotomous"
      ),
      value = list(
        Sex = "Male",
        IndexSide = "Dominant",
        TreatmentStatus = "Ongoing",
        RegistryStatus = "Open"
      ),
      statistic = list(
        all_categorical() ~ "{p} ({n})"
        ),
      missing = "no"
    ) |> add_stat_label(
    location = "column"
  ) |> add_overall() |> modify_table_styling(
      columns = label,
      rows = label == "Symptom Duration Category",
      footnote = "Dichotomised below or equal to 0.5 years or greater than 0.5 years"
  ) |> modify_table_styling(
      columns = label,
      rows = label == "Treatment Record Active",
      footnote = "Treatment record remains active - no change to follow up"
  ) |> modify_table_styling(
      columns = label,
      rows = label == "Patient Record Active",
      footnote = "Patient record remains open - no change to consent or mortality status"
  ) 

gtsummary::as_flex_table(TableRep4RC1) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)

```

### Surgical Details

Surgical findings and management strategies are summarised below.

```{r}
#| eval: false

CuffStatus2 <- SelectRep4RC |> filter(is.na(CuffStatus))
```

<!--# There are a couple of cases that do not seem to fit the cuff status field properly. There is one GHI case that has the repair details (1399.1), but not cuff status inserted. The other is a general case that is a retorn RCR that probably needs to be moved across cohorts (193.2). -->

```{r}
#| label: tbl-TableRep4RC2
#| tbl-cap: "Summary of PRULO Report 4 (Rotator Cuff) Cases Pathology and Surgical Details"

TableRep4RC2 <-
  SelectRep4RC |>
  dplyr::select(
    CuffStatus,
    TreatmentType,
    ProductCountFct, #This has a code block it depends on to derive this count within the dataframe - ensure its copied|amended into each report as required
    CuffRepair:AdjunctProcedure) |>
  tbl_summary(
      by = LongHeadBiceps,
      label = list(
        ProductCountFct ~ "Product Count",
        CuffStatus ~ "Cuff Status",
        TreatmentType ~ "Treatment Type",
        CuffRepair ~ "Cuff Repair",
        RepairAugmentation ~ "Repair Augmentation",
        LabrumRepair ~ "Labrum Repair",
        CapsuleLigament ~ "Capsule | Ligament",
        AdjunctProcedure ~ "Adjunct Procedure"
      ),
      statistic = list(
        all_categorical() ~ "{p} ({n})"
        ),
      missing = "no"
    ) |> add_overall() |> modify_table_styling(
      columns = label,
      rows = label == "Other",
      footnote = "Biceps tendon integration; Biceps tendon transfer; Tendon advancement"
    ) 

gtsummary::as_flex_table(TableRep4RC2) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)

```

### Treatment Survival

```{epoxy}
#| label:  Duration-Rep4-Proc1

The mean follow up duration is {round(SelectRep4RC |> ungroup() |> summarise(mean = mean(Duration))/52,1)} years, with a standard deviation of {round(SelectRep4RC |> ungroup() |> summarise(sd = sd(Duration))/52,2)} years.

```

Failure or revision events as identified in the registry for this cohort are summarised below. Individual failure data can be accessed in [Attachment 1](https://docs.google.com/spreadsheets/d/https://docs.google.com/spreadsheets/d/1ESVvSKAv8ma11kri9pby6OEU9Gk5Z3UnF6XwjXBTcTg/edit#gid=0).

```{r}
#| label: tbl-TableRep4RC3
#| tbl-cap: "Summary of PRULO Report 4 (Rotator Cuff) Procedure Survival"

TableRep4RC3 <- tbl_survfit(
  survfit2(Surv(Duration, Status) ~ 1, 
           data = SelectRep4RC),
  times = c(1,26,52,104),
  label_header = "**{time} Weeks**",
  label = "Procedure Survival",
  statistic = "{estimate} ({conf.low} - {conf.high})"
) |> gtsummary::modify_footnote_header(
    footnote = "% survival with 95% confidence intervals",
    columns = all_stat_cols(),
  )

gtsummary::as_flex_table(TableRep4RC3) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)

```

```{r}
#| label:  Failure-Report-Rep4A-Proc1

#Previous surgery(ies) at the same site Anatomical Location 
#Anchor 1 Anchor 2 Anchor 3 Anchor 4

FailuresRep4RC <-
  SelectRep4RC |> mutate(
    TreatmentStatusDesc = stringr::str_to_sentence(TreatmentStatusNotes)
  ) |>
      filter(TreatmentStatus == "Failed") |> 
  dplyr::select(
    TreatmentID,
    AgeAtInitialExam, 
    Sex,
    TreatmentType,
    Duration,
    TreatmentStatusDesc,
    ReoperationProcedure2,
    SubsequentTx2,
    Product1,
    Product2,
    Product3,
    Product4,
    QDASH_TotalScore_Preop,
    QDASH_TotalScore_3months,
    QDASH_TotalScore_6months) |> mutate(
      Procedure = "Cuff Repair"
    ) |> arrange(
      TreatmentID
    )

```

```{r}
#| label:  Failure-Report-Rep4A-write
#| eval: false
#| include: false

# Authenticate for sheets using the same token
gs4_auth(token = drive_token())

# Do the write operation silently
if (nrow(FailuresRep4RC) > 0) {
  invisible(
    googlesheets4::range_write(
 ss = SheetIDs$AuditReport,
 data = FailuresRep4RC |> arrange(TreatmentID),
 sheet = "Failures4",
 range = "A1:P",
 col_names = TRUE
    )
  )
}


```


```{r}
#| label:  Failure-Report-Rep4A-display

if (nrow(FailuresRep4RC) == 0) {
  epoxy::epoxy_html("There are no failures to report.")
} else {
  epoxy::epoxy_html('Failures were written to <a href="{{SheetIDs$AuditReport}}"Attachment 1/a> for further review')
}


```

### Adverse Events

Complications and adverse events are summarised below. Individual reoperation data can be accessed in [Attachment 1](https://docs.google.com/spreadsheets/d/1ESVvSKAv8ma11kri9pby6OEU9Gk5Z3UnF6XwjXBTcTg/edit#gid=0).


```{r}
#| label: tbl-intraop-complications-4A
#| tbl-cap: "Summary of PRULO Report 4 (Rotator Cuff) Cases - Intraoperative Events"

# Check if any complications exist in filtered data
has_complications <- SelectRep4RC |> 
  filter(TreatmentID %in% IntraopComp$TreatmentID) |> 
  nrow() > 0

# Conditionally generate content
if (!has_complications) {
  # If no complications, return the text message
  epoxy("No intraoperative complications observed.")
} else {
  # Calculate incidence and confidence intervals
  total_cases <- nrow(SelectRep4RC)
  complication_cases <- SelectRep4RC |> 
    filter(TreatmentID %in% IntraopComp$TreatmentID) |> 
    nrow()
  
  # Calculate proportion and 95% CI using Wilson method
  prop_result <- binom::binom.confint(complication_cases, total_cases, 
                                      methods = "wilson")
  incidence_pct <- round(prop_result$mean * 100, 1)
  ci_lower <- round(prop_result$lower * 100, 1)
  ci_upper <- round(prop_result$upper * 100, 1)
  
  # Generate summary sentence
  summary_text <- glue::glue(
    "Intraoperative events occurred in {complication_cases} of {total_cases} cases ({incidence_pct}%, 95% CI: {ci_lower}%-{ci_upper}%)."
  )
  
  # Print summary sentence
  cat(summary_text, "\n\n")
  
  # Generate and return the table
  IntraopComp |> 
    filter(TreatmentID %in% SelectRep4RC$TreatmentID) |> 
    rename(
      Description = "ICNature2",
      Intervention = "ICIntervention",
      PostopManagement = "ICPostopManagement"
    ) |> 
    select(
      TreatmentID,
      Description,
      Intervention,
      PostopManagement
    ) |> 
    gt::gt()
}

```

```{r}
#| label:  Complication-Other-Rep4

SelectRep4Other <- SelectRep4 |> filter(
  Other == TRUE
) |> dplyr::select(
  TreatmentID,
  DateTreatment,
  Cohort
)
```

```{r}
#| label: tbl-TableRep4RC4
#| tbl-cap: "Summary of PRULO Report 4 (Rotator Cuff) Cases - Postoperative Events"

# Now create the summary table
TableRep4RC4 <- SelectRep4RC |>
  dplyr::select(
    Infection,
    Ligament_Tendon,
    Effusion,
    Pain,
    Hardware,
    Loosening,
    Instability,
    Stiffness,
    Neurological,
    Thrombosis,
    Other,
    Reop,
    SubsequentTx2, #Inserted to address C028 Feedback Round 1
    #ReopDelay_Surgery
    ) |>
  tbl_summary(
    label = list(
      Ligament_Tendon ~ "Ligament|Tendon (Retear)",
      #ReopDelay_Surgery ~ "Reoperation Delay (Weeks)",
      
      Reop ~ "Reoperation",
      SubsequentTx2 ~ "Subsequent Treatment"
      ),
    # type = list(
    #   ReopDelay_Surgery ~ "continuous"
    # ),
    statistic = list(
      all_categorical() ~ "{p} ({n})",
      all_continuous() ~ "{mean} ({sd})"
    ),
    missing = "no",) |> add_ci(
      statistic = list(
        all_categorical() ~ "{conf.low} - {conf.high}",
        all_continuous() ~ "{conf.low} - {conf.high}"
        
      )
    ) |> modify_table_styling(
      columns = label,
      rows = label == "Other",
      footnote = "Myocardial Infarction"
    ) |> modify_table_styling (
      columns = label,
      rows = label == "Subsequent Treatment",
      footnote = "Management undertaken for procedures that have suffered tissue failure or required hardware removal or replacement"
    ) |> modify_table_styling(
      columns = label,
      rows = label == "Reoperation",
      footnote = "A theatre procedure subsequent to the index surgery that does not involve removal, replacement or modification of the construct."
    ) 

gtsummary::as_flex_table(TableRep4RC4) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)
```

```{r}
#| label:  Reoperations-Report-Rep4A-Proc1

#echo: false
#warning: false

#Previous surgery(ies) at the same site Anatomical Location 
#Anchor 1 Anchor 2 Anchor 3 Anchor 4

##Flip this around so that multiple reoperations are retained


SelectRep4RCReop <- ComplicTable3 |> filter(
  TreatmentID %in% SelectRep4RC$TreatmentID,
  `Reoperation Procedure` == "Yes"
  ) |> group_by(TreatmentID) |> slice_min(
    ReopDelay_Surgery,
    n = 1
    ) |> ungroup() |> left_join(
      SelectRep4 |> dplyr::select(
    TreatmentID,
    AgeAtInitialExam,
    Sex,
    TreatmentType,
    Product1,
    Product2,
    Product3,
    Product4,
    QDASH_TotalScore_Preop,
    QDASH_TotalScore_3months,
    QDASH_TotalScore_6months
      ),
    by = "TreatmentID",
    relationship = "one-to-one"
    ) |>
  mutate(
     QDASH_TotalScore_Preop = as.numeric(QDASH_TotalScore_Preop),
     QDASH_TotalScore_3months = as.numeric(QDASH_TotalScore_3months),
     QDASH_TotalScore_6months =as.numeric(QDASH_TotalScore_6months)
  ) |> dplyr::select(
    TreatmentID,
    AgeAtInitialExam,
    Sex,
    TreatmentType,
    `Complication Nature`,

    EventDelay,
    Product1,
    Product2,
    Product3,
    Product4,
    QDASH_TotalScore_Preop,
    QDASH_TotalScore_3months,
    QDASH_TotalScore_6months
  ) |> mutate(
    Procedure = "Cuff Repair"
    ) |> arrange(
    TreatmentID
    )

```



```{r}
#| label:  Reoperations-Report-Rep4A-write

# Authenticate for sheets using the same token
gs4_auth(token = drive_token())

# Do the write operation silently
if (nrow(SelectRep4RCReop) > 0) {
  invisible(
    googlesheets4::range_write(
 ss = SheetIDs$AuditReport,
 data = SelectRep4RCReop,
 sheet = "Reoperations4",
 range = "A1:P",
 col_names = TRUE
    )
  )
}


```


```{r}
#| label:  Reoperations-Report-Rep4A-display

if (nrow(SelectRep4RCReop) == 0) {
  epoxy::epoxy_html("There are no reoperations to report.")
} else {
  epoxy::epoxy_html('Reoperations were written to <a href="{{SheetIDs$AuditReport}}"Attachment 1/a> for further review')
}


```

### Patient-Reported Outcomes

Complete case analysis of QDASH, WORC Index Normalised, and WORC Physical Question 3 (How much weakness do you experience in your shoulder?) is summarised below.

```{r}
#| label: fig-PROMsRep4
#| fig-cap: "Complete case analysis of QDASH(Top), WORC Normalised (Middle) and WORC Physical Question 3 (Bottom)."


Rep4RCPROM1 <- ggplot(data = SelectRep4RCPROM1, mapping = aes(Timepoint,QDASH)) + 
geom_boxplot()

Rep4RCPROM2 <- ggplot(data = SelectRep4RCPROM2, mapping = aes(Timepoint,WORCNorm)) + 
geom_boxplot()

Rep4RCPROM3 <- ggplot(data = SelectRep4RCPROM2, mapping = aes(Timepoint,WORCPhysicalQ3)) + 
geom_boxplot()

Rep4RCPROM1 / Rep4RCPROM2 / Rep4RCPROM3

```

```{r}
#| label: tbl-TableRep4RC5
#| tbl-cap: "Summary of PRULO Report 4 (Rotator Cuff) Cases - QuickDASH"


TableRep4RC5 <- SelectRep4RCPROM1 |>
dplyr::select(
  QDASH,
  QDASHDelta,
  Timepoint) |>
tbl_summary(by = "Timepoint",
            missing = "no",
            type = list(
              QDASH ~ "continuous",
              QDASHDelta ~ "continuous"
            ),
            statistic = all_continuous() ~ "{median} ({p25} - {p75})"
            ) 

gtsummary::as_flex_table(TableRep4RC5) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)
```

```{r}
#| label: tbl-TableRep4RC6
#| tbl-cap: "Summary of PRULO Report 4 (Rotator Cuff) Cases - Western Ontario Rotator Cuff Index"

TableRep4RC6 <- SelectRep4RCPROM2 |>
dplyr::select(WORCNorm,
              WORCPhysicalQ3,
              WORCDelta,
              Timepoint) |>
tbl_summary(by = "Timepoint",
            missing = "no",
            type = list(
              WORCNorm ~ "continuous",
              WORCPhysicalQ3 ~ "continuous",
              WORCDelta ~ "continuous"
            ),
            statistic = all_continuous() ~ "{median} ({p25} - {p75})") 

gtsummary::as_flex_table(TableRep4RC6) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)
```

## Procedure Report - Biceps Tenodesis

### Patient Characteristics

Patient demographic, pathology, and treatment characteristics for this cohort receiving the Product are summarised below.

```{r}
#| label: tbl-TableRep4BT1
#| tbl-cap: "Summary of PRULO Report 4 (Biceps Tenodesis) Case - Patient Characteristics"

TableRep4BT1 <-
  SelectRep4BT |> mutate(
    SurgeonA = case_when(
      Surgeon == "KE" ~ "A",
      Surgeon == "RP" ~ "B",
      Surgeon == "GB" ~ "C",
      .default = NA_character_
  )) |>
  dplyr::select(
    AgeAtInitialExam,
    Sex,
    Cohort,
    IndexSide,
    BilateralStatus,
    #SymptomDuration,
    SymptomDurationCat,
    #SurgeonA,
    LongHeadBiceps,
    TreatmentStatus,
    RegistryStatus
    ) |>
    tbl_summary(
      by = LongHeadBiceps,
      label = list(
        #SurgeonA ~ "Surgeon",
        AgeAtInitialExam ~ "Age at Initial Consultation (Years)",
        Sex = "Male",
        BilateralStatus ~ "Bilateral Presentation",
        IndexSide ~ "Dominant Side",
        #SymptomDuration ~ "Symptom Duration (Weeks)",
        SymptomDurationCat ~ "Symptom Duration Category",
        TreatmentStatus ~ "Treatment Record Active",
        RegistryStatus ~ "Patient Record Active"
      ),
      type = list(
        AgeAtInitialExam ~ "continuous",
        #SymptomDuration ~ "continuous",
        Sex ~ "dichotomous",
        TreatmentStatus ~ "dichotomous",
        RegistryStatus ~ "dichotomous"
      ),
      value = list(
        Sex = "Male",
        IndexSide = "Dominant",
        TreatmentStatus = "Ongoing",
        RegistryStatus = "Open"
      ),
      statistic = list(
        all_categorical() ~ "{p} ({n})"
        ),
      missing = "no"
    )|> add_stat_label(
    location = "column"
  ) |> modify_table_styling(
      columns = label,
      rows = label == "Symptom Duration Category",
      footnote = "Dichotomised below or equal to 0.5 years or greater than 0.5 years"
  ) |> modify_table_styling(
      columns = label,
      rows = label == "Treatment Record Active",
      footnote = "Treatment record remains active - no change to follow up"
  ) |> modify_table_styling(
      columns = label,
      rows = label == "Patient Record Active",
      footnote = "Patient record remains open - no change to consent or mortality status"
  ) 

gtsummary::as_flex_table(TableRep4BT1) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)

```

### Surgical Details

Surgical findings and management strategies are summarised below.

```{r}
#| label: tbl-TableRep4BT2
#| tbl-cap: "Summary of PRULO Report 1 (Biceps Tenodesis) Cases Pathology and Surgical Details"

TableRep4BT2 <-
  SelectRep4BT |>
  dplyr::select(
    CuffStatus,
    TreatmentType,
    ProductCountFct, #This has a code block it depends on to derive this count within the dataframe - ensure its copied|amended into each report as required
    CuffRepair:AdjunctProcedure,
    TreatmentType) |>
  tbl_summary(
    label = list(
        ProductCountFct ~ "Product Count",
        CuffStatus ~ "Cuff Status",
        TreatmentType ~ "Treatment Type",
        CuffRepair ~ "Cuff Repair",
        RepairAugmentation ~ "Repair Augmentation",
        LabrumRepair ~ "Labrum Repair",
        CapsuleLigament ~ "Capsule | Ligament",
        AdjunctProcedure ~ "Adjunct Procedure",
        LongHeadBiceps ~ "Long Head Biceps Procedures"
      ),
    #by = "LongHeadBiceps",
    missing = "no") |> modify_table_styling(
      columns = label,
      rows = label == "Other",
      footnote = "Biceps tendon integration; Biceps tendon transfer; Tendon advancement"
    ) 

gtsummary::as_flex_table(TableRep4BT2) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)

```

### Treatment Survival

```{epoxy}
#| label:  Duration-Rep4-Proc2

The mean follow up duration is {round(SelectRep4BT |> ungroup() |> summarise(mean = mean(Duration))/52,1)} years, with a standard deviation of {round(SelectRep4BT |> ungroup() |> summarise(sd = sd(Duration))/52,2)} years.
```

Failure or revision events as identified in the registry for this cohort are summarised below.

Individual failure data can be accessed in [Attachment 1](https://docs.google.com/spreadsheets/d/https://docs.google.com/spreadsheets/d/1ESVvSKAv8ma11kri9pby6OEU9Gk5Z3UnF6XwjXBTcTg/edit#gid=0)

<!--# Is the same link still relevant or does it need to be updated for cohorts/reports? -->

```{r}
#| label: tbl-TableRep4BT3
#| tbl-cap: "Summary of PRULO Report 4 (Biceps Tenodesis) procedure survival"

TableRep4BT3 <- tbl_survfit(
  survfit2(Surv(Duration, Status) ~ 1, 
           data = SelectRep4BT),
  times = c(1,26,52,104),
  label_header = "**{time} Weeks**",
  label = "Procedure Survival",
  statistic = "{estimate} ({conf.low} - {conf.high})"
) |> gtsummary::modify_footnote_header(
    footnote = "% survival with 95% confidence intervals",
    columns = all_stat_cols(),
  )

gtsummary::as_flex_table(TableRep4BT3) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)

```

```{r}
#| label:  Failure-Report-Rep4A-Proc2

#Previous surgery(ies) at the same site Anatomical Location 
#Anchor 1 Anchor 2 Anchor 3 Anchor 4

FailuresRep4BT <-
  SelectRep4BT |> mutate(
    TreatmentStatusDesc = stringr::str_to_sentence(TreatmentStatusNotes)
  ) |>
      filter(TreatmentStatus == "Failed") |> 
  dplyr::select(
    TreatmentID,
    AgeAtInitialExam, 
    Sex,
    TreatmentType,
    Duration,
    TreatmentStatusDesc,
    ReoperationProcedure2,
    SubsequentTx2,
    Product1,
    Product2,
    Product3,
    Product4,
    QDASH_TotalScore_Preop,
    QDASH_TotalScore_3months,
    QDASH_TotalScore_6months) |> mutate(
      Procedure = "Biceps Tenodesis"
    )

```

```{r}
#| label:  Failure-Report-Rep4B-write
#| eval: false
#| include: false

# Authenticate for sheets using the same token
gs4_auth(token = drive_token())

# Do the write operation silently
if (nrow(FailuresRep4BT) > 0) {
  invisible(
    googlesheets4::sheet_append(
 ss = SheetIDs$AuditReport,
 data = FailuresRep4BT |> arrange(TreatmentID),
 sheet = "Failures4"
    )
  )
}


```


```{r}
#| label:  Failure-Report-Rep1B-display

if (nrow(FailuresRep4BT) == 0) {
  epoxy::epoxy_html("There are no failures to report.")
} else {
  epoxy::epoxy_html('Failures were written to <a href="{{SheetIDs$AuditReport}}"Attachment 1/a> for further review')
}


```

### Adverse Events

Complications and adverse events are summarised below. Individual reoperation data can be accessed in [Attachment 1](https://docs.google.com/spreadsheets/d/1ESVvSKAv8ma11kri9pby6OEU9Gk5Z3UnF6XwjXBTcTg/edit#gid=0).


```{r}
#| label: tbl-intraop-complications-4B
#| tbl-cap: "Summary of PRULO Report 4 (Biceps Tenodesis) Cases - Intraoperative Events"

# Check if any complications exist in filtered data
has_complications <- SelectRep4BT |> 
  filter(TreatmentID %in% IntraopComp$TreatmentID) |> 
  nrow() > 0

# Conditionally generate content
if (!has_complications) {
  # If no complications, return the text message
  epoxy("No intraoperative complications observed.")
} else {
  # Calculate incidence and confidence intervals
  total_cases <- nrow(SelectRep4BT)
  complication_cases <- SelectRep4BT |> 
    filter(TreatmentID %in% IntraopComp$TreatmentID) |> 
    nrow()
  
  # Calculate proportion and 95% CI using Wilson method
  prop_result <- binom::binom.confint(complication_cases, total_cases, 
                                      methods = "wilson")
  incidence_pct <- round(prop_result$mean * 100, 1)
  ci_lower <- round(prop_result$lower * 100, 1)
  ci_upper <- round(prop_result$upper * 100, 1)
  
  # Generate summary sentence
  summary_text <- glue::glue(
    "Intraoperative events occurred in {complication_cases} of {total_cases} cases ({incidence_pct}%, 95% CI: {ci_lower}%-{ci_upper}%)."
  )
  
  # Print summary sentence
  cat(summary_text, "\n\n")
  
  # Generate and return the table
  IntraopComp |> 
    filter(TreatmentID %in% SelectRep4BT$TreatmentID) |> 
    rename(
      Description = "ICNature2",
      Intervention = "ICIntervention",
      PostopManagement = "ICPostopManagement"
    ) |> 
    select(
      TreatmentID,
      Description,
      Intervention,
      PostopManagement
    ) |> 
    gt::gt()
}

```

```{r}
#| label: tbl-TableRep4BT4
#| tbl-cap: "Summary of PRULO Report 4 (Biceps Tenodesis) Cases - Postoperative Events"

# Now create the summary table
TableRep4BT4 <- SelectRep4BT |>
  dplyr::select(
    Infection,
    Ligament_Tendon,
    Effusion,
    Pain,
    Hardware,
    Loosening,
    Instability,
    Stiffness,
    Neurological,
    Thrombosis,
    Other,
    Reop,
    SubsequentTx2 #Inserted to address C028
    #ReopDelay_Surgery
    ) |>
  tbl_summary(
    label = list(
      Ligament_Tendon ~ "Ligament|Tendon (Retear)",
      #ReopDelay_Surgery ~ "Reoperation Delay (Weeks)",
      
      Reop ~ "Reoperation",
      SubsequentTx2 ~ "Subsequent Treatment"
      ),
    # type = list(
    #   ReopDelay_Surgery ~ "continuous"
    # ),
    statistic = list(
      all_categorical() ~ "{p} ({n})"
      #all_continuous() ~ "{mean} ({sd})"
    ),
    missing = "no",) |> add_ci(
      statistic = list(
        all_categorical() ~ "{conf.low} - {conf.high}"
        #all_continuous() ~ "{conf.low} - {conf.high}"
        
      )
    ) |> modify_table_styling (
      columns = label,
      rows = label == "Subsequent Treatment",
      footnote = "Management undertaken for procedures that have suffered tissue failure or required hardware removal or replacement"
    ) |> modify_table_styling(
      columns = label,
      rows = label == "Reoperation",
      footnote = "A theatre procedure subsequent to the index surgery that does not involve removal, replacement or modification of the construct."
    ) 

gtsummary::as_flex_table(TableRep4BT4) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)
```

```{r}
#| label: Reoperations-Report-Rep4B

#echo: false
#warning: false

#Previous surgery(ies) at the same site Anatomical Location 
#Anchor 1 Anchor 2 Anchor 3 Anchor 4

##Flip this around so that multiple reoperations are retained


SelectRep4BTReop <- ComplicTable3 |> filter(
  TreatmentID %in% SelectRep4BT$TreatmentID,
  `Reoperation Procedure` == "Yes"
  ) |> group_by(TreatmentID) |> slice_min(
    ReopDelay_Surgery,
    n = 1
    ) |> ungroup() |> left_join(
      SelectRep4 |> dplyr::select(
    TreatmentID,
    AgeAtInitialExam,
    Sex,
    TreatmentType,
    Product1,
    Product2,
    Product3,
    Product4,
    QDASH_TotalScore_Preop,
    QDASH_TotalScore_3months,
    QDASH_TotalScore_6months
      ),
    by = "TreatmentID",
    relationship = "one-to-one"
    ) |>
  mutate(
     QDASH_TotalScore_Preop = as.numeric(QDASH_TotalScore_Preop),
     QDASH_TotalScore_3months = as.numeric(QDASH_TotalScore_3months),
     QDASH_TotalScore_6months =as.numeric(QDASH_TotalScore_6months)
  ) |> dplyr::select(
    TreatmentID,
    AgeAtInitialExam,
    Sex,
    TreatmentType,
    `Complication Nature`,

    EventDelay,
    Product1,
    Product2,
    Product3,
    Product4,
    QDASH_TotalScore_Preop,
    QDASH_TotalScore_3months,
    QDASH_TotalScore_6months
  ) |> mutate(
    Procedure = "Biceps Tenodesis"
  ) |> arrange(
    TreatmentID
    )

```

```{r}
#| label:  Reoperations-Report-Rep4B-write


# Authenticate for sheets using the same token
gs4_auth(token = drive_token())

# Do the write operation silently
if (nrow(SelectRep4BTReop) > 0) {
  invisible(
    googlesheets4::sheet_append(
 ss = SheetIDs$AuditReport,
 data = SelectRep4BTReop,
 sheet = "Reoperations4"
    )
  )
}


```


```{r}
#| label:  Reoperations-Report-Rep4B-display

if (nrow(SelectRep4BTReop) == 0) {
  epoxy::epoxy_html("There are no reoperations to report.")
} else {
  epoxy::epoxy_html('Reoperations were written to <a href="{{SheetIDs$AuditReport}}"Attachment 1/a> for further review')
}


```

### Patient-Reported Outcomes

Complete case analysis of QDASH, WORC Normalised, and WORC Physical Q3 is summarised below.

```{r}
#| label: fig-PROMsRep4BT
#| fig-cap: "Complete case analysis of QDASH(Top), WORC Normalised (Middle) and WORC Physical Question 3 (Bottom)."
#| fig-cap-location: bottom



Rep4BTPROM1 <- ggplot(data = SelectRep4BTPROM1, mapping = aes(Timepoint,QDASH)) + 
geom_boxplot()

Rep4BTPROM2 <- ggplot(data = SelectRep4BTPROM2, mapping = aes(Timepoint,WORCNorm)) + 
geom_boxplot()

Rep4BTPROM3 <- ggplot(data = SelectRep4BTPROM2, mapping = aes(Timepoint,WORCPhysicalQ3)) + 
geom_boxplot()

Rep4BTPROM1 / Rep4BTPROM2 / Rep4BTPROM3

```

```{r}
#| label: tbl-PROMsRep4BT1
#| tbl-cap: "Summary of PRULO Report 4 (Biceps Tenodesis) Cases - QuickDASH"


TableRep4BT5 <- SelectRep4BTPROM1 |>
dplyr::select(
  QDASH,
  QDASHDelta,
  Timepoint) |>
tbl_summary(by = "Timepoint",
            missing = "no",
            type = list(
              QDASH ~ "continuous",
              QDASHDelta ~ "continuous"
            ),
            statistic = all_continuous() ~ "{median} ({p25} - {p75})"
            ) 

gtsummary::as_flex_table(TableRep4BT5) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)
```

```{r}
#| label: tbl-PROMsRep4BT2
#| tbl-cap: "Summary of PRULO Report 4 (Biceps Tenodesis) Cases - Western Ontario Rotator Cuff Index"


TableRep4BT6 <- SelectRep4BTPROM2 |>
dplyr::select(
  WORCNorm,
  WORCPhysicalQ3,
  #WORCDelta, #Insufficient data points
  Timepoint) |>
tbl_summary(by = "Timepoint",
            missing = "no",
            type = list(
              WORCNorm ~ "continuous",
              WORCPhysicalQ3 ~ "continuous"
            ),
            statistic = all_continuous() ~ "{median} ({p25} - {p75})"
            )

gtsummary::as_flex_table(TableRep4BT6) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)
```

# Product Report 5 - Milagro Advance BR

## Sample Selection

The sample of patients with the relevant product group were identified and data were retrieved for analysis by matching registry records to the relevant stock keeping units (SKUs) for the product group of interest. Usage statistics for the product group were added, and adverse events data were attached. Patient-reported data were retrieved and the dataset was manipulated to include relevant details for procedures of interest.

```{r}
#| label:  Reference-Code-Rep5

RefCode5 <- ProductTable |> filter(
  (Category == "Anchor"|Category == "Anchor + Suture") &
  stringr::str_detect(stringr::str_to_lower(Description),"advance") &
  stringr::str_detect(stringr::str_to_lower(Description),"br") &
  stringr::str_detect(stringr::str_to_lower(Description),"milagro")  
)

```

```{r}
#| label:  Slice-stack-Rep5

Pattern5 <- "milagro advance br"

SelectRep5 <- SnapshotComb4 |> 
  filter(
    str_detect(ImplantCodes,paste(RefCode5$Reference,collapse = "|"))
  ) |> mutate(
    Product1Check = stringr::str_detect(stringr::str_to_lower(Product1),Pattern5),
    Product2Check = stringr::str_detect(stringr::str_to_lower(Product2),Pattern5),
    Product3Check = stringr::str_detect(stringr::str_to_lower(Product3),Pattern5),
    Product4Check = stringr::str_detect(stringr::str_to_lower(Product4),Pattern5)
  ) |> mutate(
    Product1Count = case_when(
      Product1Check == TRUE ~ stringr::str_extract(Product1,"\\d"),
      .default = NA
    ),
    Product2Count = case_when(
      Product2Check == TRUE ~ stringr::str_extract(Product2,"\\d"),
      .default = NA
    ),
    Product3Count = case_when(
      Product3Check == TRUE ~ stringr::str_extract(Product3,"\\d"),
      .default = NA
    ),
    Product4Count = case_when(
      Product4Check == TRUE ~ stringr::str_extract(Product4,"\\d"),
      .default = NA
      )
    ) |> mutate(
      across(Product1Count:Product4Count,~as.numeric(.))
    ) |> rowwise() |> mutate(
    ProductCount =  sum(across(Product1Count:Product4Count), na.rm = TRUE)
      ) |> mutate(
        ProductCountFct = forcats::fct(
            as.character(ProductCount),
            levels = c("1","2","3","4","5")
          )
        ) |> mutate(
  Infection = TreatmentID %in% ComplicInfection$TreatmentID,
  Ligament_Tendon = TreatmentID %in% ComplicLigament_Tendon$TreatmentID,
  Stiffness = TreatmentID %in% ComplicStiffness$TreatmentID,
  Loosening = TreatmentID %in% ComplicLoosening$TreatmentID,
  Hardware = TreatmentID %in% ComplicHardware$TreatmentID,
  Instability = TreatmentID %in% ComplicInstability$TreatmentID,
  Neurological = TreatmentID %in% ComplicNeurological$TreatmentID,
  Fracture = TreatmentID %in% ComplicFracture$TreatmentID,
  Thrombosis = TreatmentID %in% ComplicThrombosis$TreatmentID,
  Effusion = TreatmentID %in% ComplicEffusion$TreatmentID,
  Pain = TreatmentID %in% ComplicPain$TreatmentID,
  Other = TreatmentID %in% ComplicOther$TreatmentID,

  Reop = TreatmentID %in% ComplicReop$TreatmentID
) |> left_join(
  ComplicTable3 |> group_by(TreatmentID) |> slice_max(`Reoperation Procedure Date`, n = 1) |> ungroup() |> dplyr::select(
    TreatmentID,
    ReopDelay_Occur,
    ReopDelay_Surgery,
    EventDelay
  ),
  by = "TreatmentID"
)
```

```{r}
#| label: Select-PROMs-Rep5

SelectRep5PROM1 <- SnapshotPROM1 |>
  filter(
    str_detect(ImplantCodes,paste(RefCode5$Reference,collapse = "|"))
  )

SelectRep5PROM2 <- SnapshotPROM2 |>
  filter(
    str_detect(ImplantCodes,paste(RefCode5$Reference,collapse = "|"))
  )

```

```{r}
#| label:  Select-Procedure-Rep5

SelectRep5RC <- SelectRep5 |> filter(str_detect(CuffRepair,"Repair"))

SelectRep5RCPROM1 <- SelectRep5PROM1 |> filter(str_detect(CuffRepair,"Repair"))
SelectRep5RCPROM2 <- SelectRep5PROM2 |> filter(str_detect(CuffRepair,"Repair"))

SelectRep5BT <- SelectRep5 |> filter(str_detect(LongHeadBiceps,"Tenodesis"))
SelectRep5BTPROM1<- SelectRep5PROM1 |> filter(str_detect(LongHeadBiceps,"Tenodesis"))
SelectRep5BTPROM2<- SelectRep5PROM2 |> filter(str_detect(LongHeadBiceps,"Tenodesis"))
```

## Overview

Usage of the Product within the patient group is summarised below.

```{epoxy}
#| label:  Overview-Rep5

{
  if(nrow(SelectRep5) == 1) {
    epoxy::epoxy("There is {nrow(SelectRep5)} case involving the anchor of interest.")
  } else {
    procedures <- unique(SelectRep5$ProcedureTotal)
    procedures <- procedures[procedures != "None" & procedures != "Unknown" & procedures != ""]
    procedures <- procedures[!grepl("^(Tenodesis|Tenotomy)$", procedures)]
    
    procedures_string <- if(length(procedures) > 1) {
  result5 <- paste(procedures[-length(procedures)], collapse = "] [")
  paste0(result5, "], and [", procedures[length(procedures)])
    } else {
      procedures
    }
    
    epoxy::epoxy("There are {nrow(SelectRep5)} cases involving the anchor of interest. Surgeries were performed between {format(min(SelectRep5$DateTreatment),'%Y-%b-%d')} and {format(max(SelectRep5$DateTreatment),'%Y-%b-%d')}. The procedures included [{procedures_string}].")
  }
}
{ifelse(nrow(SelectRep5RC) == 1,
        epoxy::epoxy("There is {nrow(SelectRep5RC)} case involving the anchor of interest and a rotator cuff repair."),
        epoxy::epoxy("There are {nrow(SelectRep5RC)} cases involving the anchor of interest and a rotator cuff repair. Surgeries were performed between {format(min(SelectRep5RC$DateTreatment),'%Y-%b-%d')} to {format(max(SelectRep5RC$DateTreatment),'%Y-%b-%d')}.")
)} 
{ifelse(nrow(SelectRep5BT) == 1,
        epoxy::epoxy("There is {nrow(SelectRep5BT)} case involving the anchor of interest and a biceps tenodesis."),
        epoxy::epoxy("There are {nrow(SelectRep5BT)} cases involving the anchor of interest and a biceps tenodesis. Surgeries were performed between {format(min(SelectRep5BT$DateTreatment),'%Y-%b-%d')} to {format(max(SelectRep5BT$DateTreatment),'%Y-%b-%d')}.")
)}




```

## Procedure Report - Rotator Cuff Repair

### Patient Characteristics

Patient demographic, pathology, and treatment characteristics for this cohort receiving the Product are summarised below.

```{r}
#| label: tbl-TableRep5RC1
#| tbl-cap: "Summary of PRULO Report 5 (Rotator Cuff) Cases - Patient Characteristics"

TableRep5RC1 <-
  SelectRep5RC |> mutate(
    SurgeonA = case_when(
      Surgeon == "KE" ~ "A",
      Surgeon == "RP" ~ "B",
      Surgeon == "GB" ~ "C",
      .default = NA_character_
  )) |>
  dplyr::select(
    AgeAtInitialExam,
    Sex,
    Cohort,
    IndexSide,
    BilateralStatus,
    SymptomDuration,
    SymptomDurationCat,
    #SurgeonA,
    LongHeadBiceps,
    TreatmentStatus,
    RegistryStatus
    ) |>
    tbl_summary(
      by = LongHeadBiceps,
      label = list(
        #SurgeonA ~ "Surgeon",
        AgeAtInitialExam ~ "Age at Initial Consultation (Years)",
        Sex = "Male",
        BilateralStatus ~ "Bilateral Presentation",
        IndexSide ~ "Dominant Side",
        SymptomDuration ~ "Symptom Duration (Weeks)",
        SymptomDurationCat ~ "Symptom Duration Category",
        TreatmentStatus ~ "Treatment Record Active",
        RegistryStatus ~ "Patient Record Active"
      ),
      type = list(
        AgeAtInitialExam ~ "continuous",
        SymptomDuration ~ "continuous",
        Sex ~ "dichotomous",
        TreatmentStatus ~ "dichotomous",
        RegistryStatus ~ "dichotomous"
      ),
      value = list(
        Sex = "Male",
        IndexSide = "Dominant",
        TreatmentStatus = "Ongoing",
        RegistryStatus = "Open"
      ),
      statistic = list(
        all_categorical() ~ "{p} ({n})"
        ),
      missing = "no"
    ) |> add_stat_label(
    location = "column"
  ) |> add_overall() |> modify_table_styling(
      columns = label,
      rows = label == "Symptom Duration Category",
      footnote = "Dichotomised below or equal to 0.5 years or greater than 0.5 years"
  ) |> modify_table_styling(
      columns = label,
      rows = label == "Treatment Record Active",
      footnote = "Treatment record remains active - no change to follow up"
  ) |> modify_table_styling(
      columns = label,
      rows = label == "Patient Record Active",
      footnote = "Patient record remains open - no change to consent or mortality status"
  ) 

gtsummary::as_flex_table(TableRep5RC1) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)

```

### Surgical Details

Surgical findings and management strategies are summarised below.

```{r}
#| eval: false

CuffStatus2 <- SelectRep5RC |> filter(is.na(CuffStatus))
```

<!--# There are a couple of cases that do not seem to fit the cuff status field properly. There is one GHI case that has the repair details (1399.1), but not cuff status inserted. The other is a general case that is a retorn RCR that probably needs to be moved across cohorts (193.2). -->

```{r}
#| label: tbl-TableRep5RC2
#| tbl-cap: "Summary of PRULO Report 5 (Rotator Cuff) Cases - Pathology and Surgical Details"

TableRep5RC2 <-
  SelectRep5RC |>
  dplyr::select(
    CuffStatus,
    TreatmentType,
    ProductCountFct, #This has a code block it depends on to derive this count within the dataframe - ensure its copied|amended into each report as required
    CuffRepair:AdjunctProcedure) |>
  tbl_summary(
      by = LongHeadBiceps,
      label = list(
        ProductCountFct ~ "Product Count",
        CuffStatus ~ "Cuff Status",
        TreatmentType ~ "Treatment Type",
        CuffRepair ~ "Cuff Repair",
        RepairAugmentation ~ "Repair Augmentation",
        LabrumRepair ~ "Labrum Repair",
        CapsuleLigament ~ "Capsule | Ligament",
        AdjunctProcedure ~ "Adjunct Procedure"
      ),
      statistic = list(
        all_categorical() ~ "{p} ({n})"
        ),
      missing = "no"
    ) |> add_overall() |> modify_table_styling(
      columns = label,
      rows = label == "Other",
      footnote = "Biceps tendon integration; Biceps tendon transfer; Tendon advancement"
    ) 

gtsummary::as_flex_table(TableRep5RC2) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)

  
```

### Treatment Survival

```{epoxy}
#| label:  Duration-Rep5-Proc1

The mean follow up duration is {round(SelectRep5RC |> ungroup() |> summarise(mean = mean(Duration))/52,1)} years, with a standard deviation of {round(SelectRep5RC |> ungroup() |> summarise(sd = sd(Duration))/52,2)} years.

```

Failure or revision events as identified in the registry for this cohort are summarised below. Individual failure data can be accessed in [Attachment 1](https://docs.google.com/spreadsheets/d/https://docs.google.com/spreadsheets/d/1ESVvSKAv8ma11kri9pby6OEU9Gk5Z3UnF6XwjXBTcTg/edit#gid=0).

```{r}
#| label: tbl-TableRep5RC3
#| tbl-cap: "Summary of PRULO Report 5 (Rotator Cuff) Cases - Procedure Survival"

TableRep5RC3 <- tbl_survfit(
  survfit2(Surv(Duration, Status) ~ 1, 
           data = SelectRep5RC),
  times = c(1,26,52,104),
  label_header = "**{time} Weeks**",
  label = "Procedure Survival",
  statistic = "{estimate} ({conf.low} - {conf.high})"
) |> gtsummary::modify_footnote_header(
    footnote = "% survival with 95% confidence intervals",
    columns = all_stat_cols(),
  )

gtsummary::as_flex_table(TableRep5RC3) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)

```

```{r}
#| label:  Failure-Report-Rep5A-Proc1

#Previous surgery(ies) at the same site Anatomical Location 
#Anchor 1 Anchor 2 Anchor 3 Anchor 4

FailuresRep5RC <-
  SelectRep5RC |> mutate(
    TreatmentStatusDesc = stringr::str_to_sentence(TreatmentStatusNotes)
  ) |>
      filter(TreatmentStatus == "Failed") |> 
  dplyr::select(
    TreatmentID,
    AgeAtInitialExam, 
    Sex,
    TreatmentType,
    Duration,
    TreatmentStatusDesc,
    ReoperationProcedure2,
    SubsequentTx2,
    Product1,
    Product2,
    Product3,
    Product4,
    QDASH_TotalScore_Preop,
    QDASH_TotalScore_3months,
    QDASH_TotalScore_6months) |> mutate(
      Procedure = "Cuff Repair"
    ) |> arrange(
      TreatmentID
    )

```

```{r}
#| label:  Failure-Report-Rep5A-write
#| eval: false
#| include: false

# Authenticate for sheets using the same token
gs4_auth(token = drive_token())

# Do the write operation silently
if (nrow(FailuresRep5RC) > 0) {
  invisible(
    googlesheets4::range_write(
 ss = SheetIDs$AuditReport,
 data = FailuresRep5RC |> arrange(TreatmentID),
 sheet = "Failures5",
 range = "A1:P",
 col_names = TRUE
    )
  )
}


```


```{r}
#| label:  Failure-Report-Rep5A-display

if (nrow(FailuresRep5RC) == 0) {
  epoxy::epoxy_html("There are no failures to report.")
} else {
  epoxy::epoxy_html('Failures were written to <a href="{{SheetIDs$AuditReport}}"Attachment 1/a> for further review')
}


```

### Adverse Events

Complications and adverse events are summarised below. Individual reoperation data can be accessed in [Attachment 1](https://docs.google.com/spreadsheets/d/1ESVvSKAv8ma11kri9pby6OEU9Gk5Z3UnF6XwjXBTcTg/edit#gid=0).


```{r}
#| label: tbl-intraop-complications-5A
#| tbl-cap: "Summary of PRULO Report 5 (Rotator Cuff) Cases - Intraoperative Events"

# Check if any complications exist in filtered data
has_complications <- SelectRep5RC |> 
  filter(TreatmentID %in% IntraopComp$TreatmentID) |> 
  nrow() > 0

# Conditionally generate content
if (!has_complications) {
  # If no complications, return the text message
  epoxy("No intraoperative complications observed.")
} else {
  # Calculate incidence and confidence intervals
  total_cases <- nrow(SelectRep5RC)
  complication_cases <- SelectRep5RC |> 
    filter(TreatmentID %in% IntraopComp$TreatmentID) |> 
    nrow()
  
  # Calculate proportion and 95% CI using Wilson method
  prop_result <- binom::binom.confint(complication_cases, total_cases, 
                                      methods = "wilson")
  incidence_pct <- round(prop_result$mean * 100, 1)
  ci_lower <- round(prop_result$lower * 100, 1)
  ci_upper <- round(prop_result$upper * 100, 1)
  
  # Generate summary sentence
  summary_text <- glue::glue(
    "Intraoperative events occurred in {complication_cases} of {total_cases} cases ({incidence_pct}%, 95% CI: {ci_lower}%-{ci_upper}%)."
  )
  
  # Print summary sentence
  cat(summary_text, "\n\n")
  
  # Generate and return the table
  IntraopComp |> 
    filter(TreatmentID %in% SelectRep5RC$TreatmentID) |> 
    rename(
      Description = "ICNature2",
      Intervention = "ICIntervention",
      PostopManagement = "ICPostopManagement"
    ) |> 
    select(
      TreatmentID,
      Description,
      Intervention,
      PostopManagement
    ) |> 
    gt::gt()
}

```

```{r}
#| label:  Complication-Other-Rep5

SelectRep5Other <- SelectRep5 |> filter(
  Other == TRUE
) |> dplyr::select(
  TreatmentID,
  DateTreatment,
  Cohort
)
```

```{r}
#| label: tbl-TableRep5RC4
#| tbl-cap: "Summary of PRULO Report 5 (Rotator Cuff) Cases - Postoperative Events"

# Now create the summary table
TableRep5RC4 <- SelectRep5RC |>
  dplyr::select(
    Infection,
    Ligament_Tendon,
    Effusion,
    Pain,
    Hardware,
    Loosening,
    Instability,
    Stiffness,
    Neurological,
    Thrombosis,
    Other,
    Reop,
    SubsequentTx2, #Inserted to address C028
    #ReopDelay_Surgery
    ) |>
  tbl_summary(
    label = list(
      Ligament_Tendon ~ "Ligament|Tendon (Retear)",
      #ReopDelay_Surgery ~ "Reoperation Delay (Weeks)",
      
      Reop ~ "Reoperation",
      SubsequentTx2 ~ "Subsequent Treatment"
      ),
    # type = list(
    #   ReopDelay_Surgery ~ "continuous"
    # ),
    statistic = list(
      all_categorical() ~ "{p} ({n})",
      all_continuous() ~ "{mean} ({sd})"
    ),
    missing = "no",) |> add_ci(
      statistic = list(
        all_categorical() ~ "{conf.low} - {conf.high}",
        all_continuous() ~ "{conf.low} - {conf.high}"
        
      )
    ) |> modify_table_styling(
      columns = label,
      rows = label == "Other",
      footnote = "Myocardial Infarction"
    ) |> modify_table_styling (
      columns = label,
      rows = label == "Subsequent Treatment",
      footnote = "Management undertaken for procedures that have suffered tissue failure or required hardware removal or replacement"
    ) |> modify_table_styling(
      columns = label,
      rows = label == "Reoperation",
      footnote = "A theatre procedure subsequent to the index surgery that does not involve removal, replacement or modification of the construct."
    ) 

gtsummary::as_flex_table(TableRep5RC4) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)
```

```{r}
#| label:  Reoperations-Report-Rep5A-Proc1

#echo: false
#warning: false

#Previous surgery(ies) at the same site Anatomical Location 
#Anchor 1 Anchor 2 Anchor 3 Anchor 4

##Flip this around so that multiple reoperations are retained


SelectRep5RCReop <- ComplicTable3 |> filter(
  TreatmentID %in% SelectRep5RC$TreatmentID,
  `Reoperation Procedure` == "Yes"
  ) |> group_by(TreatmentID) |> slice_min(
    ReopDelay_Surgery,
    n = 1
    ) |> ungroup() |> left_join(
      SelectRep5 |> dplyr::select(
    TreatmentID,
    AgeAtInitialExam,
    Sex,
    TreatmentType,
    Product1,
    Product2,
    Product3,
    Product4,
    QDASH_TotalScore_Preop,
    QDASH_TotalScore_3months,
    QDASH_TotalScore_6months
      ),
    by = "TreatmentID",
    relationship = "one-to-one"
    ) |>
  mutate(
     QDASH_TotalScore_Preop = as.numeric(QDASH_TotalScore_Preop),
     QDASH_TotalScore_3months = as.numeric(QDASH_TotalScore_3months),
     QDASH_TotalScore_6months =as.numeric(QDASH_TotalScore_6months)
  ) |> dplyr::select(
    TreatmentID,
    AgeAtInitialExam,
    Sex,
    TreatmentType,
    `Complication Nature`,

    EventDelay,
    Product1,
    Product2,
    Product3,
    Product4,
    QDASH_TotalScore_Preop,
    QDASH_TotalScore_3months,
    QDASH_TotalScore_6months
  ) |> mutate(
    Procedure = "Cuff Repair"
    ) |> arrange(
    TreatmentID
    )

```

<!--# Write reoperations to external sheet -->


```{r}
#| label:  Reoperations-Report-Rep5A-write

# Authenticate for sheets using the same token
gs4_auth(token = drive_token())

# Do the write operation silently
if (nrow(SelectRep5RCReop) > 0) {
  invisible(
    googlesheets4::range_write(
 ss = SheetIDs$AuditReport,
 data = SelectRep5RCReop,
 sheet = "Reoperations5",
 range = "A1:P",
 col_names = TRUE
    )
  )
}


```


```{r}
#| label:  Reoperations-Report-Rep5A-display

if (nrow(SelectRep5RCReop) == 0) {
  epoxy::epoxy_html("There are no reoperations to report.")
} else {
  epoxy::epoxy_html('Reoperations were written to <a href="{{SheetIDs$AuditReport}}"Attachment 1/a> for further review')
}


```

### Patient-Reported Outcomes

Complete case analysis of QDASH, WORC Index Normalised, and WORC Physical Question 3 (How much weakness do you experience in your shoulder?) is summarised below.

```{r}
#| label: fig-PROMsRep5RC
#| fig-cap: "Complete case analysis of QuickDASH(Top), WORC Normalised (Middle) and WORC Physical Question 3 (Bottom)."
#| fig-cap-location: bottom


Rep5RCPROM1 <- ggplot(data = SelectRep5RCPROM1, mapping = aes(Timepoint,QDASH)) + 
geom_boxplot()

Rep5RCPROM2 <- ggplot(data = SelectRep5RCPROM2, mapping = aes(Timepoint,WORCNorm)) + 
geom_boxplot()

Rep5RCPROM3 <- ggplot(data = SelectRep5RCPROM2, mapping = aes(Timepoint,WORCPhysicalQ3)) + 
geom_boxplot()

Rep5RCPROM1 / Rep5RCPROM2 / Rep5RCPROM3

```

```{r}
#| label: tbl-TableRep5RC5
#| tbl-cap: "Summary of PRULO Report 5 (Rotator Cuff) Cases - QuickDASH"


TableRep5RC5 <- SelectRep5RCPROM1 |>
dplyr::select(
  QDASH,
  QDASHDelta,
  Timepoint) |>
tbl_summary(by = "Timepoint",
            missing = "no",
            type = list(
              QDASH ~ "continuous",
              QDASHDelta ~ "continuous"
            ),
            statistic = all_continuous() ~ "{median} ({p25} - {p75})"
            ) 

gtsummary::as_flex_table(TableRep5RC5) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)

```

```{r}
#| label: tbl-TableRep5RC6
#| tbl-cap: "Summary of PRULO Report 5 (Rotator Cuff) Cases - WORC Normalised and WORC (Physical) Q3"


TableRep5RC6 <- SelectRep5RCPROM2 |>
dplyr::select(
  WORCNorm,
  WORCPhysicalQ3,
  WORCDelta,
  Timepoint
  ) |> tbl_summary(
    by = "Timepoint",
    missing = "no",
    type = list(
      WORCNorm ~ "continuous",
      WORCPhysicalQ3 ~ "continuous",
      WORCDelta ~ "continuous"
            ),
    statistic = all_continuous() ~ "{median} ({p25} - {p75})") 

gtsummary::as_flex_table(TableRep5RC6) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)
```

## Procedure Report - Biceps Tenodesis

### Patient Characteristics

Patient demographic, pathology, and treatment characteristics for this cohort receiving the Product are summarised below.

```{r}
#| label: tbl-TableRep5BT1
#| tbl-cap: "Summary of PRULO Report 5 (Biceps Tenodesis) Cases - Patient Characteristics"

TableRep5BT1 <-
  SelectRep5BT |> mutate(
    SurgeonA = case_when(
      Surgeon == "KE" ~ "A",
      Surgeon == "RP" ~ "B",
      Surgeon == "GB" ~ "C",
      .default = NA_character_
  )) |>
  dplyr::select(
    AgeAtInitialExam,
    Sex,
    Cohort,
    IndexSide,
    BilateralStatus,
    #SymptomDuration,
    SymptomDurationCat,
    #SurgeonA,
    LongHeadBiceps,
    TreatmentStatus,
    RegistryStatus
    ) |>
    tbl_summary(
      by = LongHeadBiceps,
      label = list(
        #SurgeonA ~ "Surgeon",
        AgeAtInitialExam ~ "Age at Initial Consultation (Years)",
        Sex = "Male",
        BilateralStatus ~ "Bilateral Presentation",
        IndexSide ~ "Dominant Side",
        #SymptomDuration ~ "Symptom Duration (Weeks)",
        SymptomDurationCat ~ "Symptom Duration Category",
        TreatmentStatus ~ "Treatment Record Active",
        RegistryStatus ~ "Patient Record Active"
      ),
      type = list(
        AgeAtInitialExam ~ "continuous",
        #SymptomDuration ~ "continuous",
        Sex ~ "dichotomous",
        TreatmentStatus ~ "dichotomous",
        RegistryStatus ~ "dichotomous"
      ),
      value = list(
        Sex = "Male",
        IndexSide = "Dominant",
        TreatmentStatus = "Ongoing",
        RegistryStatus = "Open"
      ),
      statistic = list(
        all_categorical() ~ "{p} ({n})"
        ),
      missing = "no"
    ) |> add_stat_label(
    location = "column"
  ) |> modify_table_styling(
      columns = label,
      rows = label == "Symptom Duration Category",
      footnote = "Dichotomised below or equal to 0.5 years or greater than 0.5 years"
  ) |> modify_table_styling(
      columns = label,
      rows = label == "Treatment Record Active",
      footnote = "Treatment record remains active - no change to follow up"
  ) |> modify_table_styling(
      columns = label,
      rows = label == "Patient Record Active",
      footnote = "Patient record remains open - no change to consent or mortality status"
  ) 

gtsummary::as_flex_table(TableRep5BT1) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)
```

### Surgical Details

Surgical findings and management strategies are summarised below.

```{r}
#| label: tbl-TableRep5BT2
#| tbl-cap: "Summary of PRULO Report 5 (Biceps Tenodesis) Cases - Pathology and Surgical Details"


TableRep5BT2 <-
  SelectRep5BT |>
  dplyr::select(
    CuffStatus,
    TreatmentType,
    ProductCountFct, #This has a code block it depends on to derive this count within the dataframe - ensure its copied|amended into each report as required
    CuffRepair:AdjunctProcedure,
    TreatmentType) |>
  tbl_summary(
    label = list(
        ProductCountFct ~ "Product Count",
        CuffStatus ~ "Cuff Status",
        TreatmentType ~ "Treatment Type",
        CuffRepair ~ "Cuff Repair",
        RepairAugmentation ~ "Repair Augmentation",
        LabrumRepair ~ "Labrum Repair",
        CapsuleLigament ~ "Capsule | Ligament",
        AdjunctProcedure ~ "Adjunct Procedure",
        LongHeadBiceps ~ "Long Head Biceps Procedures"
      ),
    #by = "LongHeadBiceps",
    missing = "no") |> modify_table_styling(
      columns = label,
      rows = label == "Other",
      footnote = "Biceps tendon integration; Biceps tendon transfer; Tendon advancement"
    ) 

gtsummary::as_flex_table(TableRep5BT2) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)
  
```

### Treatment Survival

```{epoxy}
#| label:  Duration-Rep5-Proc2

The mean follow up duration is {round(SelectRep5BT |> ungroup() |> summarise(mean = mean(Duration))/52,1)} years, with a standard deviation of {round(SelectRep5BT |> ungroup() |> summarise(sd = sd(Duration))/52,2)} years.
```

Failure or revision events as identified in the registry for this cohort are summarised below.

Individual failure data can be accessed in [Attachment 1](https://docs.google.com/spreadsheets/d/https://docs.google.com/spreadsheets/d/1ESVvSKAv8ma11kri9pby6OEU9Gk5Z3UnF6XwjXBTcTg/edit#gid=0)

<!--# Is the same link still relevant or does it need to be updated for cohorts/reports? -->

```{r}
#| label: tbl-TableRep5BT3
#| tbl-cap: "Summary of PRULO Report 5 (Biceps Tenodesis) Cases - Procedure Survival"

TableRep5BT3 <- tbl_survfit(
  survfit2(Surv(Duration, Status) ~ 1, 
           data = SelectRep5BT),
  times = c(1,26,52,104),
  label_header = "**{time} Weeks**",
  label = "Procedure Survival",
  statistic = "{estimate} ({conf.low} - {conf.high})"
) |> gtsummary::modify_footnote_header(
    footnote = "% survival with 95% confidence intervals",
    columns = all_stat_cols(),
  )


gtsummary::as_flex_table(TableRep5BT3) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)

```

```{r}
#| label:  Failure-Report-Rep5A-Proc2

#Previous surgery(ies) at the same site Anatomical Location 
#Anchor 1 Anchor 2 Anchor 3 Anchor 4

FailuresRep5BT <-
  SelectRep5BT |> mutate(
    TreatmentStatusDesc = stringr::str_to_sentence(TreatmentStatusNotes)
  ) |>
      filter(TreatmentStatus == "Failed") |> 
  dplyr::select(
    TreatmentID,
    AgeAtInitialExam, 
    Sex,
    TreatmentType,
    Duration,
    TreatmentStatusDesc,
    ReoperationProcedure2,
    SubsequentTx2,
    Product1,
    Product2,
    Product3,
    Product4,
    QDASH_TotalScore_Preop,
    QDASH_TotalScore_3months,
    QDASH_TotalScore_6months) |> mutate(
      Procedure = "Biceps Tenodesis"
    )

```

```{r}
#| label:  Failure-Report-Rep5B-write
#| eval: false
#| include: false

# Authenticate for sheets using the same token
gs4_auth(token = drive_token())

# Do the write operation silently
if (nrow(FailuresRep5BT) > 0) {
  invisible(
    googlesheets4::sheet_append(
 ss = SheetIDs$AuditReport,
 data = FailuresRep5BT |> arrange(TreatmentID),
 sheet = "Failures5"
    )
  )
}


```


```{r}
#| label:  Failure-Report-Rep5B-display

if (nrow(FailuresRep5BT) == 0) {
  epoxy::epoxy_html("There are no failures to report.")
} else {
  epoxy::epoxy_html('Failures were written to an <a href="{{SheetIDs$AuditReport}}"Attachment 1/a> for further review')
}


```

### Adverse Events

Complications and adverse events are summarised below. Individual reoperation data can be accessed in [Attachment 1](https://docs.google.com/spreadsheets/d/1ESVvSKAv8ma11kri9pby6OEU9Gk5Z3UnF6XwjXBTcTg/edit#gid=0).


```{r}
#| label: tbl-intraop-complications-5B
#| tbl-cap: "Summary of PRULO Report 5 (Biceps Tenodesis) Cases - Intraoperative Events"

# Check if any complications exist in filtered data
has_complications <- SelectRep5BT |> 
  filter(TreatmentID %in% IntraopComp$TreatmentID) |> 
  nrow() > 0

# Conditionally generate content
if (!has_complications) {
  # If no complications, return the text message
  epoxy("No intraoperative complications observed.")
} else {
  # Calculate incidence and confidence intervals
  total_cases <- nrow(SelectRep5BT)
  complication_cases <- SelectRep5BT |> 
    filter(TreatmentID %in% IntraopComp$TreatmentID) |> 
    nrow()
  
  # Calculate proportion and 95% CI using Wilson method
  prop_result <- binom::binom.confint(complication_cases, total_cases, 
                                      methods = "wilson")
  incidence_pct <- round(prop_result$mean * 100, 1)
  ci_lower <- round(prop_result$lower * 100, 1)
  ci_upper <- round(prop_result$upper * 100, 1)
  
  # Generate summary sentence
  summary_text <- glue::glue(
    "Intraoperative events occurred in {complication_cases} of {total_cases} cases ({incidence_pct}%, 95% CI: {ci_lower}%-{ci_upper}%)."
  )
  
  # Print summary sentence
  cat(summary_text, "\n\n")
  
  # Generate and return the table
  IntraopComp |> 
    filter(TreatmentID %in% SelectRep5BT$TreatmentID) |> 
    rename(
      Description = "ICNature2",
      Intervention = "ICIntervention",
      PostopManagement = "ICPostopManagement"
    ) |> 
    select(
      TreatmentID,
      Description,
      Intervention,
      PostopManagement
    ) |> 
    gt::gt()
}

```

```{r}
#| label: tbl-TableRep5BT4
#| tbl-cap: "Summary of PRULO Report 5 (Biceps Tenodesis) Cases - Postoperative Events"

# Now create the summary table
TableRep5BT4 <- SelectRep5BT |>
  dplyr::select(
    Infection,
    Ligament_Tendon,
    Effusion,
    Pain,
    Hardware,
    Loosening,
    Instability,
    Stiffness,
    Neurological,
    Thrombosis,
    Other,
    Reop,
    SubsequentTx2 #Inserted to address C028
    #ReopDelay_Surgery
    ) |>
  tbl_summary(
    label = list(
      Ligament_Tendon ~ "Ligament|Tendon (Retear)",
      #ReopDelay_Surgery ~ "Reoperation Delay (Weeks)",
      
      Reop ~ "Reoperation",
      SubsequentTx2 ~ "Subsequent Treatment"
      ),
    # type = list(
    #   ReopDelay_Surgery ~ "continuous"
    # ),
    statistic = list(
      all_categorical() ~ "{p} ({n})"
      #all_continuous() ~ "{mean} ({sd})"
    ),
    missing = "no",) |> add_ci(
      statistic = list(
        all_categorical() ~ "{conf.low} - {conf.high}"
        #all_continuous() ~ "{conf.low} - {conf.high}"
        
      )
    ) |> modify_table_styling (
      columns = label,
      rows = label == "Subsequent Treatment",
      footnote = "Management undertaken for procedures that have suffered tissue failure or required hardware removal or replacement"
    ) |> modify_table_styling(
      columns = label,
      rows = label == "Reoperation",
      footnote = "A theatre procedure subsequent to the index surgery that does not involve removal, replacement or modification of the construct."
    ) 

gtsummary::as_flex_table(TableRep5BT4) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)

```

```{r}
#| label:  Reoperations-Report-Rep5A-Proc2

#echo: false
#warning: false

#Previous surgery(ies) at the same site Anatomical Location 
#Anchor 1 Anchor 2 Anchor 3 Anchor 4

##Flip this around so that multiple reoperations are retained


SelectRep5BTReop <- ComplicTable3 |> filter(
  TreatmentID %in% SelectRep5BT$TreatmentID,
  `Reoperation Procedure` == "Yes"
  ) |> group_by(TreatmentID) |> slice_min(
    ReopDelay_Surgery,
    n = 1
    ) |> ungroup() |> left_join(
      SelectRep5 |> dplyr::select(
    TreatmentID,
    AgeAtInitialExam,
    Sex,
    TreatmentType,
    Product1,
    Product2,
    Product3,
    Product4,
    QDASH_TotalScore_Preop,
    QDASH_TotalScore_3months,
    QDASH_TotalScore_6months
      ),
    by = "TreatmentID",
    relationship = "one-to-one"
    ) |>
  mutate(
     QDASH_TotalScore_Preop = as.numeric(QDASH_TotalScore_Preop),
     QDASH_TotalScore_3months = as.numeric(QDASH_TotalScore_3months),
     QDASH_TotalScore_6months =as.numeric(QDASH_TotalScore_6months)
  ) |> dplyr::select(
    TreatmentID,
    AgeAtInitialExam,
    Sex,
    TreatmentType,
    `Complication Nature`,

    EventDelay,
    Product1,
    Product2,
    Product3,
    Product4,
    QDASH_TotalScore_Preop,
    QDASH_TotalScore_3months,
    QDASH_TotalScore_6months
  ) |> mutate(
    Procedure = "Biceps Tenodesis"
  ) |> arrange(
    TreatmentID
    )

```

```{r}
#| label:  Reoperations-Report-Rep5B-write


# Authenticate for sheets using the same token
gs4_auth(token = drive_token())

# Do the write operation silently
if (nrow(SelectRep5BTReop) > 0) {
  invisible(
    googlesheets4::sheet_append(
 ss = SheetIDs$AuditReport,
 data = SelectRep5BTReop,
 sheet = "Reoperations5"
    )
  )
}


```


```{r}
#| label:  Reoperations-Report-Rep5B-display

if (nrow(SelectRep5BTReop) == 0) {
  epoxy::epoxy_html("There are no reoperations to report.")
} else {
  epoxy::epoxy_html('Reoperations were written to <a href="{{SheetIDs$AuditReport}}"Attachment 1/a> for further review')
}


```

### Patient-Reported Outcomes

Complete case analysis of QDASH, WORC Normalised, and WORC Physical Q3 is summarised below.

```{r}
#| label: fig-PROMRep5BT
#| fig-cap: "Complete case analysis of QDASH(Top), WORC Normalised (Middle), and WORC Physical Question 3 (Bottom)"


Rep5BTPROM1 <- ggplot(data = SelectRep5BTPROM1, mapping = aes(Timepoint,QDASH)) + 
geom_boxplot()

Rep5BTPROM2 <- ggplot(data = SelectRep5BTPROM2, mapping = aes(Timepoint,WORCNorm)) + 
geom_boxplot()

Rep5BTPROM3 <- ggplot(data = SelectRep5BTPROM2, mapping = aes(Timepoint,WORCPhysicalQ3)) + 
geom_boxplot()

Rep5BTPROM1 / Rep5BTPROM2 / Rep5BTPROM3

```

```{r}
#| label: tbl-TableRep5BT5
#| tbl-cap-location: top
#| tbl-cap: "Summary of PRULO Report 5 (Biceps Tenodesis) Cases - QuickDASH"


TableRep5BT5 <- SelectRep5BTPROM1 |>
dplyr::select(
  QDASH,
  QDASHDelta,
  Timepoint) |>
tbl_summary(by = "Timepoint",
            missing = "no",
            type = list(
              QDASH ~ "continuous",
              QDASHDelta ~ "continuous"
            ),
            statistic = all_continuous() ~ "{median} ({p25} - {p75})"
            ) 

gtsummary::as_flex_table(TableRep5BT5) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)
```

```{r}
#| label: tbl-TableRep5BT6
#| tbl-cap: "Summary of PRULO Report 5 (Biceps Tenodesis) Cases - WORC Normalised"

TableRep5BT6 <- SelectRep5BTPROM2 |>
dplyr::select(
  WORCNorm,
  WORCPhysicalQ3,
  #WORCDelta, #Insufficient data points
  Timepoint) |>
tbl_summary(by = "Timepoint",
            missing = "no",
            type = list(
              WORCNorm ~ "continuous",
              WORCPhysicalQ3 ~ "continuous"
              #WORCDelta ~ "continuous"
            ),
            statistic = all_continuous() ~ "{median} ({p25} - {p75})"
            )

gtsummary::as_flex_table(TableRep5BT6) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)
```

# Product Report 6 - Gryphon ProKnot BR

## Sample Selection

The sample of patients with the relevant product group were identified and data were retrieved for analysis by matching registry records to the relevant stock keeping units (SKUs) for the product group of interest. Usage statistics for the product group were added, and adverse events data were attached. Patient-reported data were retrieved and the dataset was manipulated to include relevant details for procedures of interest.

```{r}
#| label:  Reference-Code-Rep6

RefCode6 <- ProductTable |> filter(
  (Category == "Anchor"|Category == "Anchor + Suture") &
  stringr::str_detect(stringr::str_to_lower(Description),"proknot") &
  stringr::str_detect(stringr::str_to_lower(Description),"br") &
  stringr::str_detect(stringr::str_to_lower(Description),"gryphon")  
)

```

```{r}
#| label: Slice-stack-Rep6

Pattern6 <- "gryphon proknot br"

SelectRep6 <- SnapshotComb4 |> 
  filter(
    str_detect(ImplantCodes,paste(RefCode6$Reference,collapse = "|"))
  ) |> mutate(
    CuffStatus2 = case_when(
      is.na(CuffStatus) & !is.na(PatientPosition) ~ "Intact",
      !is.na(CuffStatus) ~ CuffStatus,
      .default = NA_character_
    ),
    Product1Check = stringr::str_detect(stringr::str_to_lower(Product1),Pattern6),
    Product2Check = stringr::str_detect(stringr::str_to_lower(Product2),Pattern6),
    Product3Check = stringr::str_detect(stringr::str_to_lower(Product3),Pattern6),
    Product4Check = stringr::str_detect(stringr::str_to_lower(Product4),Pattern6)
  ) |> mutate(
    Product1Count = case_when(
      Product1Check == TRUE ~ stringr::str_extract(Product1,"\\d"),
      .default = NA
    ),
    Product2Count = case_when(
      Product2Check == TRUE ~ stringr::str_extract(Product2,"\\d"),
      .default = NA
    ),
    Product3Count = case_when(
      Product3Check == TRUE ~ stringr::str_extract(Product3,"\\d"),
      .default = NA
    ),
    Product4Count = case_when(
      Product4Check == TRUE ~ stringr::str_extract(Product4,"\\d"),
      .default = NA
      )
    ) |> mutate(
      across(Product1Count:Product4Count,~as.numeric(.))
    ) |> rowwise() |> mutate(
    ProductCount =  sum(across(Product1Count:Product4Count), na.rm = TRUE)
      ) |> mutate(
        ProductCountFct = forcats::fct(
            as.character(ProductCount),
            levels = c("1","2","3","4","5")
          )
        ) |> mutate(
  Infection = TreatmentID %in% ComplicInfection$TreatmentID,
  Ligament_Tendon = TreatmentID %in% ComplicLigament_Tendon$TreatmentID,
  Stiffness = TreatmentID %in% ComplicStiffness$TreatmentID,
  Loosening = TreatmentID %in% ComplicLoosening$TreatmentID,
  Hardware = TreatmentID %in% ComplicHardware$TreatmentID,
  Instability = TreatmentID %in% ComplicInstability$TreatmentID,
  Neurological = TreatmentID %in% ComplicNeurological$TreatmentID,
  Fracture = TreatmentID %in% ComplicFracture$TreatmentID,
  Thrombosis = TreatmentID %in% ComplicThrombosis$TreatmentID,
  Effusion = TreatmentID %in% ComplicEffusion$TreatmentID,
  Pain = TreatmentID %in% ComplicPain$TreatmentID,
  Other = TreatmentID %in% ComplicOther$TreatmentID,

  Reop = TreatmentID %in% ComplicReop$TreatmentID
) |> left_join(
  ComplicTable3 |> group_by(TreatmentID) |> slice_max(`Reoperation Procedure Date`, n = 1) |> ungroup() |> dplyr::select(
    TreatmentID,
    ReopDelay_Occur,
    ReopDelay_Surgery,
    EventDelay
  ),
  by = "TreatmentID"
)
```

```{r}
#| label: Select-PROMs-Rep6

SelectRep6PROM1 <- SnapshotPROM1 |>
  filter(
    str_detect(ImplantCodes,paste(RefCode6$Reference,collapse = "|"))
  )

```

```{r}
#| label:  Select-Procedure-Rep6

SelectRep6BR <- SelectRep6 |> filter(LabrumRepair == "Bankart")
SelectRep6BRPROM1 <- SelectRep6PROM1 |> filter(LabrumRepair == "Bankart")

SelectRep6SLAP <- SelectRep6 |> filter(LabrumRepair == "SLAP")
SelectRep6SLAPPROM1<- SelectRep6PROM1 |> filter(LabrumRepair == "SLAP")

```

## Overview

Usage of the Product within the patient group is summarised below.

```{epoxy}
#| label:  Overview-Rep6

{
  if(nrow(SelectRep6) == 1) {
    epoxy::epoxy("There is {nrow(SelectRep6)} case involving the anchor of interest.")
  } else {
    procedures <- unique(SelectRep6$ProcedureTotal)
    procedures <- procedures[procedures != "None" & procedures != "Unknown" & procedures != ""]
    procedures <- procedures[!grepl("^(Tenodesis|Tenotomy)$", procedures)]
    
    procedures_string <- if(length(procedures) > 1) {
  result6 <- paste(procedures[-length(procedures)], collapse = "] [")
  paste0(result6, "], and [", procedures[length(procedures)])
    } else {
      procedures
    }
    
    epoxy::epoxy("There are {nrow(SelectRep6)} cases involving the anchor of interest. Surgeries were performed between {format(min(SelectRep6$DateTreatment),'%Y-%b-%d')} and {format(max(SelectRep6$DateTreatment),'%Y-%b-%d')}. The procedures included [{procedures_string}].")
  }
}

{ifelse(nrow(SelectRep6BR) <= 1,
        epoxy::epoxy("There is {nrow(SelectRep6BR)} case(s) involving the anchor of interest and a Bankart repair. There is insufficient sample size to provide a report."),
        ifelse(dplyr::between(nrow(SelectRep6BR),2,5),
        epoxy::epoxy("There are {nrow(SelectRep6BR)} cases involving the anchor of interest and a Bankart repair. Surgeries were performed between {format(min(SelectRep6BR$DateTreatment),'%Y-%b-%d')} to {format(max(SelectRep6BR$DateTreatment),'%Y-%b-%d')}. There is insufficient sample size to provide a report."),
        epoxy::epoxy("There are {nrow(SelectRep6BR)} cases involving the anchor of interest and a Bankart repair. Surgeries were performed between {format(min(SelectRep6BR$DateTreatment),'%Y-%b-%d')} to {format(max(SelectRep6BR$DateTreatment),'%Y-%b-%d')}."
        )))} 

{ifelse(nrow(SelectRep6SLAP) == 1,
        epoxy::epoxy("There is {nrow(SelectRep6SLAP)} case(s) involving the anchor of interest and a SLAP repair. There is insufficient sample size to provide a report."),
        ifelse(dplyr::between(nrow(SelectRep6SLAP),2,5),
        epoxy::epoxy("There are {nrow(SelectRep6SLAP)} cases involving the anchor of interest and a SLAP repair. Surgeries were performed between {format(min(SelectRep6SLAP$DateTreatment),'%Y-%b-%d')} to {format(max(SelectRep6SLAP$DateTreatment),'%Y-%b-%d')}. There is insufficient sample size to provide a report."),
        epoxy::epoxy("There are {nrow(SelectRep6SLAP)} cases involving the anchor of interest and a SLAP repair. Surgeries were performed between {format(min(SelectRep6SLAP$DateTreatment),'%Y-%b-%d')} to {format(max(SelectRep6SLAP$DateTreatment),'%Y-%b-%d')}."
)))} 


```

## Procedure Report - All

### Patient Characteristics

Patient demographic, pathology, and treatment characteristics for this cohort receiving the Product are summarised below.

```{r}
#| label: tbl-TableRep61
#| tbl-cap: "Summary of PRULO Report 6 (All) - Patient Characteristics"

TableRep61 <-
  SelectRep6 |> mutate(
    SurgeonA = case_when(
      Surgeon == "KE" ~ "A",
      Surgeon == "RP" ~ "B",
      Surgeon == "GB" ~ "C",
      .default = NA_character_
  )) |>
  dplyr::select(
    AgeAtInitialExam,
    Sex,
    Cohort,
    IndexSide,
    BilateralStatus,
    SymptomDuration,
    SymptomDurationCat,
    #SurgeonA,
    #LongHeadBiceps,
    TreatmentStatus,
    RegistryStatus
    ) |>
    tbl_summary(
      #by = LongHeadBiceps,
      label = list(
        #SurgeonA ~ "Surgeon",
        AgeAtInitialExam ~ "Age at Initial Consultation (Years)",
        Sex = "Male",
        BilateralStatus ~ "Bilateral Presentation",
        IndexSide ~ "Dominant Side",
        SymptomDuration ~ "Symptom Duration (Weeks)",
        SymptomDurationCat ~ "Symptom Duration Category",
        TreatmentStatus ~ "Treatment Record Active",
        RegistryStatus ~ "Patient Record Active"
      ),
      type = list(
        AgeAtInitialExam ~ "continuous",
        SymptomDuration ~ "continuous",
        Sex ~ "dichotomous",
        TreatmentStatus ~ "dichotomous",
        RegistryStatus ~ "dichotomous"
      ),
      value = list(
        Sex = "Male",
        IndexSide = "Dominant",
        TreatmentStatus = "Ongoing",
        RegistryStatus = "Open"
      ),
      statistic = list(
        all_categorical() ~ "{p} ({n})"
        ),
      missing = "no"
    ) |> add_stat_label(
    location = "column"
  ) |> modify_table_styling(
      columns = label,
      rows = label == "Symptom Duration Category",
      footnote = "Dichotomised below or equal to 0.5 years or greater than 0.5 years"
  ) |> modify_table_styling(
      columns = label,
      rows = label == "Treatment Record Active",
      footnote = "Treatment record remains active - no change to follow up"
  ) |> modify_table_styling(
      columns = label,
      rows = label == "Patient Record Active",
      footnote = "Patient record remains open - no change to consent or mortality status"
  ) 

gtsummary::as_flex_table(TableRep61) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)

```

### Surgical Details

Surgical findings and management strategies are summarised below.

```{r}
#| label: tbl-TableRep62
#| tbl-cap: "Summary of PRULO Report 6 (All) Cases Pathology and Surgical Details"


TableRep62 <-
  SelectRep6 |>
  dplyr::select(
    CuffStatus2,
    TreatmentType,
    ProductCountFct, #This has a code block it depends on to derive this count within the dataframe - ensure its copied|amended into each report as required
    CuffRepair:AdjunctProcedure) |>
  tbl_summary(
      #by = LongHeadBiceps,
      label = list(
        CuffStatus2 ~ "Cuff Status",
        TreatmentType ~ "Treatment Type",
        ProductCountFct ~ "Product Count"
      ),
      statistic = list(
        all_categorical() ~ "{p} ({n})"
        ),
      missing = "no"
    ) |> modify_table_styling(
      columns = label,
      rows = label == "Other",
      footnote = "Labral tear uncategorised"
    ) 

gtsummary::as_flex_table(TableRep62) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)
```

### Treatment Survival

```{epoxy}
#| label:  Duration-Rep6-Proc1


The mean follow up duration is {round(SelectRep6 |> ungroup() |> summarise(mean = mean(Duration))/52,1)} years, with a standard deviation of {round(SelectRep6 |> ungroup() |> summarise(sd = sd(Duration))/52,2)} years.

```

Failure or revision events as identified in the registry for this cohort are summarised below. Individual failure data can be accessed in [Attachment 1](https://docs.google.com/spreadsheets/d/https://docs.google.com/spreadsheets/d/1ESVvSKAv8ma11kri9pby6OEU9Gk5Z3UnF6XwjXBTcTg/edit).

```{r}
#| label: tbl-TableRep63
#| tbl-cap: "Summary of PRULO Report 6 (All) Cases - Procedure Survival"

TableRep63 <- tbl_survfit(
  survfit2(Surv(Duration, Status) ~ 1, 
           data = SelectRep6),
  times = c(1,26,52,104),
  label_header = "**{time} Weeks**",
  label = "Procedure Survival",
  statistic = "{estimate} ({conf.low} - {conf.high})"
) |> gtsummary::modify_footnote_header(
    footnote = "% survival with 95% confidence intervals",
    columns = all_stat_cols(),
  )

gtsummary::as_flex_table(TableRep63) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)

```

```{r}
#| label:  Failure-Report-Rep6A-Proc1

#Previous surgery(ies) at the same site Anatomical Location 
#Anchor 1 Anchor 2 Anchor 3 Anchor 4

FailuresRep6 <-
  SelectRep6 |> mutate(
    TreatmentStatusDesc = stringr::str_to_sentence(TreatmentStatusNotes)
  ) |>
      filter(TreatmentStatus == "Failed") |> 
  dplyr::select(
    TreatmentID,
    AgeAtInitialExam, 
    Sex,
    TreatmentType,
    Duration,
    TreatmentStatusDesc,
    ReoperationProcedure2,
    SubsequentTx2,
    Product1,
    Product2,
    Product3,
    Product4,
    QDASH_TotalScore_Preop,
    QDASH_TotalScore_3months,
    QDASH_TotalScore_6months) |> mutate(
      Procedure = "All"
    ) |> arrange(
      TreatmentID
    )

```

```{r}
#| label:  Failure-Report-Rep6A-write
#| eval: false
#| include: false

# Authenticate for sheets using the same token
gs4_auth(token = drive_token())

# Do the write operation silently
if (nrow(FailuresRep6) > 0) {
  invisible(
    googlesheets4::range_write(
 ss = SheetIDs$AuditReport,
 data = FailuresRep6 |> arrange(TreatmentID),
 sheet = "Failures6",
 range = "A1:P",
 col_names = TRUE
    )
  )
}


```


```{r}
#| label:  Failure-Report-Rep6A-display

if (nrow(FailuresRep6) == 0) {
  epoxy::epoxy_html("There are no failures to report.")
} else {
  epoxy::epoxy_html('Failures were written to <a href="{{SheetIDs$AuditReport}}"Attachment 1/a> for further review')
}


```

### Adverse Events

Complications and adverse events are summarised below. 


```{r}
#| label: IntraopComp - Rep6A


# Check if any Count value is greater than zero in filtered data
has_complications <- SelectRep6 |> 
  filter(TreatmentID %in% IntraopComp$TreatmentID) |> 
  nrow() > 0

# Conditionally set chunk options and generate table
if (has_complications == 0) {
  # If no rows, return the text message
  epoxy("No intraoperative complications observed.")
} else {
  knitr::opts_current$set(
    label = "tbl-intraop-complications-6",
    tbl.cap = "Summary of PRULO Report 6 (All) Cases - Intraoperative Events"
  )
  
  IntraopComp |> filter(
    TreatmentID %in% SelectRep6$TreatmentID
  ) |> rename(
    Description = "ICNature2",
    Intervention = "ICIntervention",
    PostopManagement = "ICPostopManagement"
  ) |> select(
    TreatmentID,
    Description,
    Intervention,
    PostopManagement
    ) |> gt::gt()
}
```

```{r}
#| label:  Complication-Other-Rep6


SelectRep6Other <- SelectRep6 |> filter(
  Other == TRUE
) |> dplyr::select(
  TreatmentID,
  DateTreatment,
  Cohort
)
```

```{r}
#| label: tbl-TableRep64
#| tbl-cap: "Summary of PRULO Report 6 (All) Cases - Postoperative Events"

# Now create the summary table
TableRep64 <- SelectRep6 |>
  dplyr::select(
    Infection,
    Ligament_Tendon,
    Effusion,
    Pain,
    Hardware,
    Loosening,
    Instability,
    Stiffness,
    Neurological,
    Thrombosis,
    Other,
    Reop,
    SubsequentTx2, #Inserted to address C028
    ReopDelay_Surgery) |>
  tbl_summary(
    label = list(
      Ligament_Tendon ~ "Ligament|Tendon (Retear)",
      ReopDelay_Surgery ~ "Reoperation Delay (Weeks)",
      Reop ~ "Reoperation",
      SubsequentTx2 ~ "Subsequent Treatment"
      ),
    type = list(
      ReopDelay_Surgery ~ "continuous"
    ),
    statistic = list(
      all_categorical() ~ "{p} ({n})",
      all_continuous() ~ "{mean} ({sd})"
    ),
    missing = "no",
    digits = list(
      all_continuous() ~ 1,
      all_categorical() ~ 0)
    ) |> modify_table_styling (
      columns = label,
      rows = label == "Subsequent Treatment",
      footnote = "Management undertaken for procedures that have suffered tissue failure or required hardware removal or replacement"
    ) |> modify_table_styling(
      columns = label,
      rows = label == "Reoperation",
      footnote = "A theatre procedure subsequent to the index surgery that does not involve removal, replacement or modification of the construct."
    ) |> modify_table_styling(
      columns = label,
      rows = label == "Reoperation Delay (Weeks)",
      footnote = "Time between index procedure and reoperation"
    ) 

gtsummary::as_flex_table(TableRep64) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)
```

```{r}
#| label: Reoperations-Report-Rep6A-Proc1

#echo: false
#warning: false

#Previous surgery(ies) at the same site Anatomical Location 
#Anchor 1 Anchor 2 Anchor 3 Anchor 4

##Flip this around so that multiple reoperations are retained


SelectRep6Reop <- ComplicTable3 |> filter(
  TreatmentID %in% SelectRep6$TreatmentID,
  `Reoperation Procedure` == "Yes"
  ) |> group_by(TreatmentID) |> slice_min(
    ReopDelay_Surgery,
    n = 1
    ) |> ungroup() |> left_join(
      SelectRep6 |> dplyr::select(
    TreatmentID,
    AgeAtInitialExam,
    Sex,
    TreatmentType,
    Product1,
    Product2,
    Product3,
    Product4,
    QDASH_TotalScore_Preop,
    QDASH_TotalScore_3months,
    QDASH_TotalScore_6months
      ),
    by = "TreatmentID",
    relationship = "one-to-one"
    ) |>
  mutate(
     QDASH_TotalScore_Preop = as.numeric(QDASH_TotalScore_Preop),
     QDASH_TotalScore_3months = as.numeric(QDASH_TotalScore_3months),
     QDASH_TotalScore_6months =as.numeric(QDASH_TotalScore_6months)
  ) |> dplyr::select(
    TreatmentID,
    AgeAtInitialExam,
    Sex,
    TreatmentType,
    `Complication Nature`,

    EventDelay,
    Product1,
    Product2,
    Product3,
    Product4,
    QDASH_TotalScore_Preop,
    QDASH_TotalScore_3months,
    QDASH_TotalScore_6months
  ) |> mutate(
    Procedure = "All"
    ) |> arrange(
    TreatmentID
    )

```

```{r}
#| label:  Reoperations-Report-Rep6-write

# Authenticate for sheets using the same token
gs4_auth(token = drive_token())

# Do the write operation silently
if (nrow(SelectRep6Reop) > 0) {
  invisible(
    googlesheets4::range_write(
 ss = SheetIDs$AuditReport,
 data = SelectRep6Reop,
 sheet = "Reoperations6",
 range = "A1:P",
 col_names = TRUE
    )
  )
}


```


```{r}
#| label:  Reoperations-Report-Rep6-display

if (nrow(SelectRep6Reop) == 0) {
  epoxy::epoxy_html("There are no reoperations to report.")
} else {
  epoxy::epoxy_html('Reoperations were written to <a href="{{SheetIDs$AuditReport}}"Attachment 1/a> for further review')
}


```

### Patient-Reported Outcomes

Complete case analysis of QDASH and WOSI Index Normalised is summarised below.

```{r}
#| label: fig-PROMRep6
#| fig-cap: "Complete case analysis of QDASH(Top), WOSI Index (Bottom)"


Rep6PROM1 <- ggplot(data = SelectRep6PROM1, mapping = aes(Timepoint,QDASH)) + 
geom_boxplot()

Rep6PROM2 <- ggplot(data = SelectRep6PROM1, mapping = aes(Timepoint,WOSINorm)) + 
geom_boxplot()

Rep6PROM1 / Rep6PROM2

```

```{r}
#| label: tbl-TableRep65
#| tbl-cap: "Summary of PRULO Report 6 (All) Cases - QuickDASH"


TableRep65 <- SelectRep6PROM1 |>
dplyr::select(
  QDASH,
  QDASHDelta,
  WOSINorm,
  WOSIDelta,
  Timepoint) |>
tbl_summary(by = "Timepoint",
            missing = "no",
            type = list(
              QDASH ~ "continuous",
              QDASHDelta ~ "continuous",
              WOSINorm ~ "continuous",
              WOSIDelta ~ "continuous"
            ),
            statistic = all_continuous() ~ "{median} ({p25} - {p75})"
            )

gtsummary::as_flex_table(TableRep65) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)


```

## Procedure Report - Bankart Repair

### Patient Characteristics

Patient demographic, pathology, and treatment characteristics for this cohort receiving the Product are summarised below.

```{r}
#| label: tbl-TableRep6BR1
#| tbl-cap: "Summary of PRULO Report 6 (Bankart Repair) - Patient Characteristics"

TableRep6BR1 <-
  SelectRep6BR |> mutate(
    SurgeonA = case_when(
      Surgeon == "KE" ~ "A",
      Surgeon == "RP" ~ "B",
      Surgeon == "GB" ~ "C",
      .default = NA_character_
  )) |>
  dplyr::select(
    AgeAtInitialExam,
    Sex,
    Cohort,
    IndexSide,
    BilateralStatus,
    SymptomDuration,
    SymptomDurationCat,
    #SurgeonA,
    #LongHeadBiceps,
    TreatmentStatus,
    RegistryStatus
    ) |>
    tbl_summary(
      #by = LongHeadBiceps,
      label = list(
        #SurgeonA ~ "Surgeon",
        AgeAtInitialExam ~ "Age at Initial Consultation (Years)",
        Sex = "Male",
        BilateralStatus ~ "Bilateral Presentation",
        IndexSide ~ "Dominant Side",
        SymptomDuration ~ "Symptom Duration (Weeks)",
        SymptomDurationCat ~ "Symptom Duration Category",
        TreatmentStatus ~ "Treatment Record Active",
        RegistryStatus ~ "Patient Record Active"
      ),
      type = list(
        AgeAtInitialExam ~ "continuous",
        SymptomDuration ~ "continuous",
        Sex ~ "dichotomous",
        TreatmentStatus ~ "dichotomous",
        RegistryStatus ~ "dichotomous"
      ),
      value = list(
        Sex = "Male",
        IndexSide = "Dominant",
        TreatmentStatus = "Ongoing",
        RegistryStatus = "Open"
      ),
      statistic = list(
        all_categorical() ~ "{p} ({n})"
        ),
      missing = "no"
    ) |> add_stat_label(
    location = "column"
  ) |> modify_table_styling(
      columns = label,
      rows = label == "Symptom Duration Category",
      footnote = "Dichotomised below or equal to 0.5 years or greater than 0.5 years"
  ) |> modify_table_styling(
      columns = label,
      rows = label == "Treatment Record Active",
      footnote = "Treatment record remains active - no change to follow up"
  ) |> modify_table_styling(
      columns = label,
      rows = label == "Patient Record Active",
      footnote = "Patient record remains open - no change to consent or mortality status"
  ) 

gtsummary::as_flex_table(TableRep6BR1) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)

```

### Surgical Details

Surgical findings and management strategies are summarised below.

```{r}
#| label: tbl-TableRep6BR2
#| tbl-cap: "Summary of PRULO Report 6 (Bankart Repair) Cases Pathology and Surgical Details"

TableRep6BR2 <-
  SelectRep6BR |>
  dplyr::select(
    CuffStatus2,
    TreatmentType,
    ProductCountFct, #This has a code block it depends on to derive this count within the dataframe - ensure its copied|amended into each report as required
    CuffRepair:AdjunctProcedure) |>
  tbl_summary(
      #by = LongHeadBiceps,
      label = list(
        ProductCountFct ~ "Product Count",
        CuffStatus2 ~ "Cuff Status",
        TreatmentType ~ "Treatment Type",
        CuffRepair ~ "Cuff Repair",
        RepairAugmentation ~ "Repair Augmentation",
        LabrumRepair ~ "Labrum Repair",
        CapsuleLigament ~ "Capsule | Ligament",
        AdjunctProcedure ~ "Adjunct Procedure"
      ),
      statistic = list(
        all_categorical() ~ "{p} ({n})"
        ),
      missing = "no"
    ) |> modify_table_styling(
      columns = label,
      rows = label == "Other",
      footnote = "Labral tear uncategorised"
    ) 

gtsummary::as_flex_table(TableRep6BR2) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)

```

### Treatment Survival

```{epoxy}
#| label:  Duration-Rep6BR-Proc2

The mean follow up duration is {round(SelectRep6BR |> ungroup() |> summarise(mean = mean(Duration))/52,1)} years, with a standard deviation of {round(SelectRep6BR |> ungroup() |> summarise(sd = sd(Duration))/52,2)} years.

```

Failure or revision events as identified in the registry for this cohort are summarised below. Individual failure data can be accessed in [Attachment 1](https://docs.google.com/spreadsheets/d/https://docs.google.com/spreadsheets/d/1ESVvSKAv8ma11kri9pby6OEU9Gk5Z3UnF6XwjXBTcTg/edit).

```{r}
#| label: tbl-TableRep6BR3
#| tbl-cap: "Summary of PRULO Report 6 (Bankart Repair) Procedure Survival"

TableRep6BR3 <- tbl_survfit(
  survfit2(Surv(Duration, Status) ~ 1, 
           data = SelectRep6BR),
  times = c(1,26,52,104),
  label_header = "**{time} Weeks**",
  label = "Procedure Survival",
  statistic = "{estimate} ({conf.low} - {conf.high})"
) |> gtsummary::modify_footnote_header(
    footnote = "% survival with 95% confidence intervals",
    columns = all_stat_cols(),
  )

gtsummary::as_flex_table(TableRep6BR3) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)

```

```{r}
#| label:  Failure-Report-Rep6BRA-Proc2

#Previous surgery(ies) at the same site Anatomical Location 
#Anchor 1 Anchor 2 Anchor 3 Anchor 4

FailuresRep6BR <-
  SelectRep6BR |> mutate(
    TreatmentStatusDesc = stringr::str_to_sentence(TreatmentStatusNotes)
  ) |>
      filter(TreatmentStatus == "Failed") |> 
  dplyr::select(
    TreatmentID,
    AgeAtInitialExam, 
    Sex,
    TreatmentType,
    Duration,
    TreatmentStatusDesc,
    ReoperationProcedure2,
    SubsequentTx2,
    Product1,
    Product2,
    Product3,
    Product4,
    QDASH_TotalScore_Preop,
    QDASH_TotalScore_3months,
    QDASH_TotalScore_6months) |> mutate(
      Procedure = "Cuff Repair"
    ) |> arrange(
      TreatmentID
    )

```

```{r}
#| label:  Failure-Report-Rep6B-write
#| eval: false
#| include: false

# Authenticate for sheets using the same token
gs4_auth(token = drive_token())

# Do the write operation silently
if (nrow(FailuresRep6BR) > 0) {
  invisible(
    googlesheets4::sheet_append(
 ss = SheetIDs$AuditReport,
 data = FailuresRep6BR |> arrange(TreatmentID),
 sheet = "Failures6"
    )
  )
}


```


```{r}
#| label:  Failure-Report-Rep6B-display

if (nrow(FailuresRep6BR) == 0) {
  epoxy::epoxy_html("There are no failures to report.")
} else {
  epoxy::epoxy_html('Failures were written to <a href="{{SheetIDs$AuditReport}}"Attachment 1/a> for further review')
}


```

### Adverse Events

Complications and adverse events are summarised below. Individual reoperation data can be accessed in [Attachment 1](https://docs.google.com/spreadsheets/d/1ESVvSKAv8ma11kri9pby6OEU9Gk5Z3UnF6XwjXBTcTg/edit#gid=0).

```{r}
#| label: tbl-intraop-complications-6B
#| tbl-cap: "Summary of PRULO Report 6 (Bankart Repair) Cases - Intraoperative Events"

# Check if any complications exist in filtered data
has_complications <- SelectRep6BR |> 
  filter(TreatmentID %in% IntraopComp$TreatmentID) |> 
  nrow() > 0

# Conditionally generate content
if (!has_complications) {
  # If no complications, return the text message
  epoxy("No intraoperative complications observed.")
} else {
  # Calculate incidence and confidence intervals
  total_cases <- nrow(SelectRep6BR)
  complication_cases <- SelectRep6BR |> 
    filter(TreatmentID %in% IntraopComp$TreatmentID) |> 
    nrow()
  
  # Calculate proportion and 95% CI using Wilson method
  prop_result <- binom::binom.confint(complication_cases, total_cases, 
                                      methods = "wilson")
  incidence_pct <- round(prop_result$mean * 100, 1)
  ci_lower <- round(prop_result$lower * 100, 1)
  ci_upper <- round(prop_result$upper * 100, 1)
  
  # Generate summary sentence
  summary_text <- glue::glue(
    "Intraoperative events occurred in {complication_cases} of {total_cases} cases ({incidence_pct}%, 95% CI: {ci_lower}%-{ci_upper}%)."
  )
  
  # Print summary sentence
  cat(summary_text, "\n\n")
  
  # Generate and return the table
  IntraopComp |> 
    filter(TreatmentID %in% SelectRep6BR$TreatmentID) |> 
    rename(
      Description = "ICNature2",
      Intervention = "ICIntervention",
      PostopManagement = "ICPostopManagement"
    ) |> 
    select(
      TreatmentID,
      Description,
      Intervention,
      PostopManagement
    ) |> 
    gt::gt()
}

```

```{r}
#| label:  Complication-Other-Rep6BR


SelectRep6BROther <- SelectRep6BR |> filter(
  Other == TRUE
) |> dplyr::select(
  TreatmentID,
  DateTreatment,
  Cohort
)
```

```{r}
#| label: tbl-TableRep6BR4
#| tbl-cap: "Summary of PRULO Report 6 (Bankart Repair) Cases - Postoperative Events"

# Now create the summary table
TableRep6BR4 <- SelectRep6BR |>
  dplyr::select(
    Infection,
    Ligament_Tendon,
    Effusion,
    Pain,
    Hardware,
    Loosening,
    Instability,
    Stiffness,
    Neurological,
    Thrombosis,
    Other,
    Reop,
    SubsequentTx2, #Inserted to address C028
    ReopDelay_Surgery) |>
  tbl_summary(
    label = list(
      Ligament_Tendon ~ "Ligament|Tendon (Retear)",
      ReopDelay_Surgery ~ "Reoperation Delay (Weeks)",
      Reop ~ "Reoperation",
      SubsequentTx2 ~ "Subsequent Treatment"
      ),
    type = list(
      ReopDelay_Surgery ~ "continuous"
    ),
    statistic = list(
      all_categorical() ~ "{p} ({n})",
      all_continuous() ~ "{mean} ({sd})"
    ),
    missing = "no",
    digits = list(
      all_continuous() ~ 1,
      all_categorical() ~ 0)
    )  |> modify_table_styling (
      columns = label,
      rows = label == "Subsequent Treatment",
      footnote = "Management undertaken for procedures that have suffered tissue failure or required hardware removal or replacement"
    ) |> modify_table_styling(
      columns = label,
      rows = label == "Reoperation",
      footnote = "A theatre procedure subsequent to the index surgery that does not involve removal, replacement or modification of the construct."
    ) |> modify_table_styling(
      columns = label,
      rows = label == "Reoperation Delay (Weeks)",
      footnote = "Time between index procedure and reoperation"
    ) 

gtsummary::as_flex_table(TableRep6BR4) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)

```

```{r}
#| label:  Reoperations-Report-Rep6BRA-Proc2

#echo: false
#warning: false

#Previous surgery(ies) at the same site Anatomical Location 
#Anchor 1 Anchor 2 Anchor 3 Anchor 4

##Flip this around so that multiple reoperations are retained


SelectRep6BRReop <- ComplicTable3 |> filter(
  TreatmentID %in% SelectRep6BR$TreatmentID,
  `Reoperation Procedure` == "Yes"
  ) |> group_by(TreatmentID) |> slice_min(
    ReopDelay_Surgery,
    n = 1
    ) |> ungroup() |> left_join(
      SelectRep6BR |> dplyr::select(
    TreatmentID,
    AgeAtInitialExam,
    Sex,
    TreatmentType,
    Product1,
    Product2,
    Product3,
    Product4,
    QDASH_TotalScore_Preop,
    QDASH_TotalScore_3months,
    QDASH_TotalScore_6months
      ),
    by = "TreatmentID",
    relationship = "one-to-one"
    ) |>
  mutate(
     QDASH_TotalScore_Preop = as.numeric(QDASH_TotalScore_Preop),
     QDASH_TotalScore_3months = as.numeric(QDASH_TotalScore_3months),
     QDASH_TotalScore_6months =as.numeric(QDASH_TotalScore_6months)
  ) |> dplyr::select(
    TreatmentID,
    AgeAtInitialExam,
    Sex,
    TreatmentType,
    `Complication Nature`,

    EventDelay,
    Product1,
    Product2,
    Product3,
    Product4,
    QDASH_TotalScore_Preop,
    QDASH_TotalScore_3months,
    QDASH_TotalScore_6months
  ) |> mutate(
    Procedure = "Bankart Repair"
    ) |> arrange(
    TreatmentID
    )

```

```{r}
#| label:  Reoperations-Report-Rep6B-display

if (nrow(SelectRep6BRReop) == 0) {
  epoxy::epoxy_html("There are no reoperations to report.")
} else {
  epoxy::epoxy_html('Reoperations were written to <a href="{{SheetIDs$AuditReport}}"Attachment 1/a> for further review')
}


```

### Patient-Reported Outcomes

Complete case analysis of QuickDASH and WOSI Index Normalised are summarised below.

```{r}
#| label: fig-PROMRep6BR
#| fig-cap: "Complete case analysis of QDASH(Top), WOSI Index (Bottom)"


Rep6PROM1 <- ggplot(data = SelectRep6PROM1, mapping = aes(Timepoint,QDASH)) + 
geom_boxplot()

Rep6PROM2 <- ggplot(data = SelectRep6PROM1, mapping = aes(Timepoint,WOSINorm)) + 
geom_boxplot()

Rep6PROM1 / Rep6PROM2

```

```{r}
#| label: tbl-TableRep6BR5
#| tbl-cap: "Summary of PRULO Report 6 (Bankart Repair) Cases - QuickDASH and WOSI Normalised"


TableRep6BR5 <- SelectRep6BRPROM1 |>
dplyr::select(
  QDASH,
  #QDASHDelta,
  WOSINorm,
  #WOSIDelta,
  Timepoint) |>
tbl_summary(by = "Timepoint",
            missing = "no",
            type = list(
              QDASH ~ "continuous",
              #QDASHDelta ~ "continuous",
              WOSINorm ~ "continuous"
              #WOSIDelta ~ "continuous"
            ),
            statistic = all_continuous() ~ "{median} ({p25} - {p75})"
            ) 

gtsummary::as_flex_table(TableRep6BR5) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)

```

# Product Report 7 - Gryphon BR with Orthocord

## Sample Selection

The sample of patients with the relevant product group were identified and data were retrieved for analysis by matching registry records to the relevant stock keeping units (SKUs) for the product group of interest. Usage statistics for the product group were added, and adverse events data were attached. Patient-reported data were retrieved and the dataset was manipulated to include relevant details for procedures of interest.

```{r}
#| label: Reference-Code-Rep7

RefCode7 <- ProductTable |> filter(
  (Category == "Anchor + Suture") &
  stringr::str_detect(stringr::str_to_lower(Description),"orthocord") &
  stringr::str_detect(stringr::str_to_lower(Description),"br") &
  stringr::str_detect(stringr::str_to_lower(Description),"gryphon")  
)

```

```{r}
#| label: Slice-stack-Rep7

Pattern7 <- "gryphon.*br.*orthocord"

SelectRep7 <- SnapshotComb4 |> 
  filter(
    str_detect(ImplantCodes, paste(RefCode7$Reference, collapse = "|"))
  ) |> mutate(
    CuffStatus2 = case_when(
      is.na(CuffStatus) & !is.na(PatientPosition) ~ "Intact",
      !is.na(CuffStatus) ~ CuffStatus,
      .default = NA_character_
    ),
    across(
      starts_with("Product"),
      ~str_detect(str_to_lower(.), Pattern7),
      .names = "{.col}Check"
    )
  ) |> mutate(
    Product1Count = case_when(
      Product1Check == TRUE ~ stringr::str_extract(Product1,"\\d"),
      .default = NA
    ),
    Product2Count = case_when(
      Product2Check == TRUE ~ stringr::str_extract(Product2,"\\d"),
      .default = NA
    ),
    Product3Count = case_when(
      Product3Check == TRUE ~ stringr::str_extract(Product3,"\\d"),
      .default = NA
    ),
    Product4Count = case_when(
      Product4Check == TRUE ~ stringr::str_extract(Product4,"\\d"),
      .default = NA
      )
    ) |> mutate(
      across(Product1Count:Product4Count,~as.numeric(.))
    ) |> rowwise() |> mutate(
    ProductCount =  sum(across(Product1Count:Product4Count), na.rm = TRUE)
      ) |> mutate(
        ProductCountFct = forcats::fct(
            as.character(ProductCount),
            levels = c("1","2","3","4","5")
          )
        ) |> mutate(
  Infection = TreatmentID %in% ComplicInfection$TreatmentID,
  Ligament_Tendon = TreatmentID %in% ComplicLigament_Tendon$TreatmentID,
  Stiffness = TreatmentID %in% ComplicStiffness$TreatmentID,
  Loosening = TreatmentID %in% ComplicLoosening$TreatmentID,
  Hardware = TreatmentID %in% ComplicHardware$TreatmentID,
  Instability = TreatmentID %in% ComplicInstability$TreatmentID,
  Neurological = TreatmentID %in% ComplicNeurological$TreatmentID,
  Fracture = TreatmentID %in% ComplicFracture$TreatmentID,
  Thrombosis = TreatmentID %in% ComplicThrombosis$TreatmentID,
  Effusion = TreatmentID %in% ComplicEffusion$TreatmentID,
  Pain = TreatmentID %in% ComplicPain$TreatmentID,
  Other = TreatmentID %in% ComplicOther$TreatmentID,

  Reop = TreatmentID %in% ComplicReop$TreatmentID
) |> left_join(
  ComplicTable3 |> group_by(TreatmentID) |> slice_max(`Reoperation Procedure Date`, n = 1) |> ungroup() |> dplyr::select(
    TreatmentID,
    ReopDelay_Occur,
    ReopDelay_Surgery,
    EventDelay
  ),
  by = "TreatmentID"
)
```

```{r}
#| label:  Select-PROMs-Rep7

SelectRep7PROM1 <- SnapshotPROM1 |>
  filter(
    str_detect(ImplantCodes,paste(RefCode7$Reference,collapse = "|"))
  )

```

```{r}
#| label:  Select-Procedure-Rep7

SelectRep7BR <- SelectRep7 |> filter(LabrumRepair == "Bankart")
SelectRep7BRPROM1 <- SelectRep7PROM1 |> filter(LabrumRepair == "Bankart")

SelectRep7SLAP <- SelectRep7 |> filter(LabrumRepair == "SLAP")
SelectRep7SLAPPROM1<- SelectRep7PROM1 |> filter(LabrumRepair == "SLAP")

```

## Overview

Usage of the Product within the patient group is summarised below.

```{epoxy}
#| label:  Overview-Rep7

{
  if(nrow(SelectRep7) == 1) {
    epoxy::epoxy("There is {nrow(SelectRep7)} case involving the anchor of interest.")
  } else {
    procedures <- unique(SelectRep7$ProcedureTotal)
    procedures <- procedures[procedures != "None" & procedures != "Unknown" & procedures != ""]
    procedures <- procedures[!grepl("^(Tenodesis|Tenotomy)$", procedures)]
    
   procedures_string <- if(length(procedures) > 1) {
  result7 <- paste(procedures[-length(procedures)], collapse = "] [")
  paste0(result7, "], and [", procedures[length(procedures)])
    } else {
      procedures
    }
    
    epoxy::epoxy("There are {nrow(SelectRep7)} cases involving the anchor of interest. Surgeries were performed between {format(min(SelectRep7$DateTreatment),'%Y-%b-%d')} and {format(max(SelectRep7$DateTreatment),'%Y-%b-%d')}. The procedures included [{procedures_string}].")
  }
}

{ifelse(nrow(SelectRep7BR) <= 1,
        epoxy::epoxy("There is {nrow(SelectRep7BR)} case involving the anchor of interest and a Bankart repair. There is insufficient sample size to provide a report."),
        ifelse(dplyr::between(nrow(SelectRep7BR),2,5),
        epoxy::epoxy("There are {nrow(SelectRep7BR)} cases involving the anchor of interest and a Bankart repair. Surgeries were performed between {format(min(SelectRep7BR$DateTreatment),'%Y-%b-%d')} to {format(max(SelectRep7BR$DateTreatment),'%Y-%b-%d')}. There is insufficient sample size to provide a report."),
        epoxy::epoxy("There are {nrow(SelectRep7BR)} cases involving the anchor of interest and a Bankart repair. Surgeries were performed between {format(min(SelectRep7BR$DateTreatment),'%Y-%b-%d')} to {format(max(SelectRep7BR$DateTreatment),'%Y-%b-%d')}."
        )))} 

{ifelse(nrow(SelectRep7SLAP) <= 1,
        epoxy::epoxy("There is {nrow(SelectRep7SLAP)} case(s) involving the anchor of interest and a SLAP repair. There is insufficient sample size to provide a report."),
        ifelse(dplyr::between(nrow(SelectRep7SLAP),2,5),
        epoxy::epoxy("There are {nrow(SelectRep7SLAP)} cases involving the anchor of interest and a SLAP repair. Surgeries were performed between {format(min(SelectRep7SLAP$DateTreatment),'%Y-%b-%d')} to {format(max(SelectRep7SLAP$DateTreatment),'%Y-%b-%d')}. There is insufficient sample size to provide a report."),
        epoxy::epoxy("There are {nrow(SelectRep7SLAP)} cases involving the anchor of interest and a SLAP repair. Surgeries were performed between {format(min(SelectRep7SLAP$DateTreatment),'%Y-%b-%d')} to {format(max(SelectRep7SLAP$DateTreatment),'%Y-%b-%d')}."
)))} 


```

## Procedure Report - All

### Patient Characteristics

Patient demographic, pathology, and treatment characteristics for this cohort receiving the Product are summarised below.

```{r}
#| label: tbl-TableRep71
#| tbl-cap: "Summary of PRULO Report 7 (All) - Patient Characteristics"

TableRep71 <-
  SelectRep7 |> mutate(
    SurgeonA = case_when(
      Surgeon == "KE" ~ "A",
      Surgeon == "RP" ~ "B",
      Surgeon == "GB" ~ "C",
      .default = NA_character_
  )) |>
  dplyr::select(
    AgeAtInitialExam,
    Sex,
    Cohort,
    IndexSide,
    BilateralStatus,
    SymptomDuration,
    SymptomDurationCat,
    #SurgeonA,
    #LongHeadBiceps,
    TreatmentStatus,
    RegistryStatus
    ) |>
    tbl_summary(
      #by = LongHeadBiceps,
      label = list(
        #SurgeonA ~ "Surgeon",
        AgeAtInitialExam ~ "Age at Initial Consultation (Years)",
        Sex = "Male",
        BilateralStatus ~ "Bilateral Presentation",
        IndexSide ~ "Dominant Side",
        SymptomDuration ~ "Symptom Duration (Weeks)",
        SymptomDurationCat ~ "Symptom Duration Category",
        TreatmentStatus ~ "Treatment Record Active",
        RegistryStatus ~ "Patient Record Active"
      ),
      type = list(
        AgeAtInitialExam ~ "continuous",
        SymptomDuration ~ "continuous",
        Sex ~ "dichotomous",
        TreatmentStatus ~ "dichotomous",
        RegistryStatus ~ "dichotomous"
      ),
      value = list(
        Sex = "Male",
        IndexSide = "Dominant",
        TreatmentStatus = "Ongoing",
        RegistryStatus = "Open"
      ),
      statistic = list(
        all_categorical() ~ "{p} ({n})"
        ),
      missing = "no"
    ) |> add_stat_label(
    location = "column"
  ) |> modify_table_styling(
      columns = label,
      rows = label == "Symptom Duration Category",
      footnote = "Dichotomised below or equal to 0.5 years or greater than 0.5 years"
  ) |> modify_table_styling(
      columns = label,
      rows = label == "Treatment Record Active",
      footnote = "Treatment record remains active - no change to follow up"
  ) |> modify_table_styling(
      columns = label,
      rows = label == "Patient Record Active",
      footnote = "Patient record remains open - no change to consent or mortality status"
  ) 

gtsummary::as_flex_table(TableRep71) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)

```

### Surgical Details

Surgical findings and management strategies are summarised below.

```{r}
#| label: tbl-TableRep72
#| tbl-cap: "Summary of PRULO Report 7 (All) Cases Pathology and Surgical Details"


TableRep72 <-
  SelectRep7 |>
  dplyr::select(
    CuffStatus2,
    TreatmentType,
    ProductCountFct, #This has a code block it depends on to derive this count within the dataframe - ensure its copied|amended into each report as required
    CuffRepair:AdjunctProcedure) |>
  tbl_summary(
      #by = LongHeadBiceps,
      label = list(
        ProductCountFct ~ "Product Count",
        CuffStatus2 ~ "Cuff Status",
        TreatmentType ~ "Treatment Type",
        CuffRepair ~ "Cuff Repair",
        RepairAugmentation ~ "Repair Augmentation",
        LabrumRepair ~ "Labrum Repair",
        CapsuleLigament ~ "Capsule | Ligament",
        AdjunctProcedure ~ "Adjunct Procedure"
      ),
      statistic = list(
        all_categorical() ~ "{p} ({n})"
        ),
      missing = "no"
    ) |> modify_table_styling(
      columns = label,
      rows = label == "Other",
      footnote = "Labral tear uncategorised"
    ) 

gtsummary::as_flex_table(TableRep72) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)


```

### Treatment Survival

```{epoxy}
#| label:  Duration-Rep7-Proc1

The mean follow up duration is {round(SelectRep7 |> ungroup() |> summarise(mean = mean(Duration))/52,1)} years, with a standard deviation of {round(SelectRep7 |> ungroup() |> summarise(sd = sd(Duration))/52,2)} years.

```

Failure or revision events as identified in the registry for this cohort are summarised below. Individual failure data can be accessed in [Attachment 1](https://docs.google.com/spreadsheets/d/1ESVvSKAv8ma11kri9pby6OEU9Gk5Z3UnF6XwjXBTcTg/edit#gid=0).

```{r}
#| label: tbl-TableRep73
#| tbl-cap: "Summary of PRULO Report 7 (Rotator Cuff) - Procedure Survival"

TableRep73 <- tbl_survfit(
  survfit2(Surv(Duration, Status) ~ 1, 
           data = SelectRep7),
  times = c(1,26,52,104),
  label_header = "**{time} Weeks**",
  label = "Procedure Survival",
  statistic = "{estimate} ({conf.low} - {conf.high})"
) |> gtsummary::modify_footnote_header(
    footnote = "% survival with 95% confidence intervals",
    columns = all_stat_cols(),
  )

gtsummary::as_flex_table(TableRep73) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)

```

```{r}
#| label:  Failure-Report-Rep7A-Proc1

#Previous surgery(ies) at the same site Anatomical Location 
#Anchor 1 Anchor 2 Anchor 3 Anchor 4

FailuresRep7 <-
  SelectRep7 |> mutate(
    TreatmentStatusDesc = stringr::str_to_sentence(TreatmentStatusNotes)
  ) |>
      filter(TreatmentStatus == "Failed") |> 
  dplyr::select(
    TreatmentID,
    AgeAtInitialExam, 
    Sex,
    TreatmentType,
    Duration,
    TreatmentStatusDesc,
    ReoperationProcedure2,
    SubsequentTx2,
    Product1,
    Product2,
    Product3,
    Product4,
    QDASH_TotalScore_Preop,
    QDASH_TotalScore_3months,
    QDASH_TotalScore_6months) |> mutate(
      Procedure = "All"
    ) |> arrange(
      TreatmentID
    )

```

```{r}
#| label:  Failure-Report-Rep7A-write
#| eval: false
#| include: false

# Authenticate for sheets using the same token
gs4_auth(token = drive_token())

# Do the write operation silently
if (nrow(FailuresRep7) > 0) {
  invisible(
    googlesheets4::range_write(
 ss = SheetIDs$AuditReport,
 data = FailuresRep7 |> arrange(TreatmentID),
 sheet = "Failures7",
 range = "A1:P",
 col_names = TRUE
    )
  )
}


```


```{r}
#| label:  Failure-Report-Rep7-display

if (nrow(FailuresRep7) == 0) {
  epoxy::epoxy_html("There are no failures to report.")
} else {
  epoxy::epoxy_html('Failures were written to <a href="{{SheetIDs$AuditReport}}"Attachment 1/a> for further review')
}


```

### Adverse Events

Complications and adverse events are summarised below. Individual reoperation data can be accessed in [Attachment 1](https://docs.google.com/spreadsheets/d/1ESVvSKAv8ma11kri9pby6OEU9Gk5Z3UnF6XwjXBTcTg/edit#gid=0).


```{r}
#| label: IntraopComp - Rep7A


# Check if any Count value is greater than zero in filtered data
has_complications <- SelectRep7 |> 
  filter(TreatmentID %in% IntraopComp$TreatmentID) |> 
  nrow() > 0

# Conditionally set chunk options and generate table
if (has_complications == 0) {
  # If no rows, return the text message
  epoxy("No intraoperative complications observed.")
} else {
  knitr::opts_current$set(
    label = "tbl-intraop-complications-7A",
    tbl.cap = "Summary of PRULO Report 7 (All) Cases - Intraoperative Events"
  )
  
  IntraopComp |> filter(
    TreatmentID %in% SelectRep7$TreatmentID
  ) |> rename(
    Description = "ICNature2",
    Intervention = "ICIntervention",
    PostopManagement = "ICPostopManagement"
  ) |> select(
    TreatmentID,
    Description,
    Intervention,
    PostopManagement
    ) |> gt::gt()
}
```

```{r}
#| label:  Complication-Other-Rep7

SelectRep7Other <- SelectRep7 |> filter(
  Other == TRUE
) |> dplyr::select(
  TreatmentID,
  DateTreatment,
  Cohort
)
```

```{r}
#| label: tbl-TableRep74
#| tbl-cap: "Summary of PRULO Report 7 (All) Cases - Postoperative Events"

# Now create the summary table
TableRep74 <- SelectRep7 |>
  dplyr::select(
    Infection,
    Ligament_Tendon,
    Effusion,
    Pain,
    Hardware,
    Loosening,
    Instability,
    Stiffness,
    Neurological,
    Thrombosis,
    Other,
    Reop,
    SubsequentTx2, #Inserted to address C028
    ReopDelay_Surgery) |>
  tbl_summary(
    label = list(
      Ligament_Tendon ~ "Ligament|Tendon (Retear)",
      ReopDelay_Surgery ~ "Reoperation Delay (Weeks)",
      
      Reop ~ "Reoperation",
      SubsequentTx2 ~ "Subsequent Treatment"
      ),
    type = list(
      ReopDelay_Surgery ~ "continuous"
    ),
    statistic = list(
      all_categorical() ~ "{p} ({n})",
      all_continuous() ~ "{mean} ({sd})"
    ),
    missing = "no",
    digits = list(
      all_continuous() ~ 1,
      all_categorical() ~ 0)
    )  |> modify_table_styling (
      columns = label,
      rows = label == "Subsequent Treatment",
      footnote = "Management undertaken for procedures that have suffered tissue failure or required hardware removal or replacement"
    ) |> modify_table_styling(
      columns = label,
      rows = label == "Reoperation",
      footnote = "A theatre procedure subsequent to the index surgery that does not involve removal, replacement or modification of the construct."
    ) |> modify_table_styling(
      columns = label,
      rows = label == "Reoperation Delay (Weeks)",
      footnote = "Time between index procedure and reoperation"
    ) 

gtsummary::as_flex_table(TableRep74) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)


```

```{r}
#| label:  Reoperations-Report-Rep7A-Proc1

#echo: false
#warning: false

#Previous surgery(ies) at the same site Anatomical Location 
#Anchor 1 Anchor 2 Anchor 3 Anchor 4

##Flip this around so that multiple reoperations are retained


SelectRep7Reop <- ComplicTable3 |> filter(
  TreatmentID %in% SelectRep7$TreatmentID,
  `Reoperation Procedure` == "Yes"
  ) |> group_by(TreatmentID) |> slice_min(
    ReopDelay_Surgery,
    n = 1
    ) |> ungroup() |> left_join(
      SelectRep7 |> dplyr::select(
    TreatmentID,
    AgeAtInitialExam,
    Sex,
    TreatmentType,
    Product1,
    Product2,
    Product3,
    Product4,
    QDASH_TotalScore_Preop,
    QDASH_TotalScore_3months,
    QDASH_TotalScore_6months
      ),
    by = "TreatmentID",
    relationship = "one-to-one"
    ) |>
  mutate(
     QDASH_TotalScore_Preop = as.numeric(QDASH_TotalScore_Preop),
     QDASH_TotalScore_3months = as.numeric(QDASH_TotalScore_3months),
     QDASH_TotalScore_6months =as.numeric(QDASH_TotalScore_6months)
  ) |> dplyr::select(
    TreatmentID,
    AgeAtInitialExam,
    Sex,
    TreatmentType,
    `Complication Nature`,

    EventDelay,
    Product1,
    Product2,
    Product3,
    Product4,
    QDASH_TotalScore_Preop,
    QDASH_TotalScore_3months,
    QDASH_TotalScore_6months
  ) |> mutate(
    Procedure = "All"
    ) |> arrange(
    TreatmentID
    )

```

<!--# Write reoperations to external sheet -->


```{r}
#| label:  Reoperations-Report-Rep7-write

# Authenticate for sheets using the same token
gs4_auth(token = drive_token())

# Do the write operation silently
if (nrow(SelectRep7Reop) > 0) {
  invisible(
    googlesheets4::range_write(
 ss = SheetIDs$AuditReport,
 data = SelectRep7Reop,
 sheet = "Reoperations7",
 range = "A1:P",
 col_names = TRUE
    )
  )
}


```


```{r}
#| label:  Reoperations-Report-Rep7-display

if (nrow(SelectRep7Reop) == 0) {
  epoxy::epoxy_html("There are no reoperations to report.")
} else {
  epoxy::epoxy_html('Reoperations were written to <a href="{{SheetIDs$AuditReport}}"Attachment 1/a> for further review')
}


```

### Patient-Reported Outcomes

Complete case analysis of QDASH and WOSI Index Normalised is summarised below.

```{r}
#| label: fig-PROMsRep7
#| fig-cap: "Complete case analysis of QuickDASH and WOSI Normalised"



Rep7PROM1 <- ggplot(data = SelectRep7PROM1, mapping = aes(Timepoint,QDASH)) + 
geom_boxplot()

Rep7PROM2 <- ggplot(data = SelectRep7PROM1, mapping = aes(Timepoint,WOSINorm)) + 
geom_boxplot()

Rep7PROM1 / Rep7PROM2

```

```{r}
#| label: tbl-TableRep75
#| tbl-cap: " Summary of PRULO Report 7 (All) Cases - QuickDASH"


TableRep75 <- SelectRep7PROM1 |>
dplyr::select(
  QDASH,
  QDASHDelta,
  WOSINorm,
  WOSIDelta,
  Timepoint) |>
tbl_summary(by = "Timepoint",
            missing = "no",
            type = list(
              QDASH ~ "continuous",
              QDASHDelta ~ "continuous",
              WOSINorm ~ "continuous",
              WOSIDelta ~ "continuous"
            ),
            statistic = all_continuous() ~ "{median} ({p25} - {p75})"
            ) 

gtsummary::as_flex_table(TableRep75) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)


```

## Procedure Report - Bankart Repair

### Patient Characteristics

Patient demographic, pathology, and treatment characteristics for this cohort receiving the Product are summarised below.

```{r}
#| label: tbl-TableRep7BR1
#| tbl-cap: "Summary of PRULO Report 7 (Bankart Repair) - Patient Characteristics"

TableRep7BR1 <-
  SelectRep7BR |> mutate(
    SurgeonA = case_when(
      Surgeon == "KE" ~ "A",
      Surgeon == "RP" ~ "B",
      Surgeon == "GB" ~ "C",
      .default = NA_character_
  )) |>
  dplyr::select(
    AgeAtInitialExam,
    Sex,
    Cohort,
    IndexSide,
    BilateralStatus,
    SymptomDuration,
    SymptomDurationCat,
    #SurgeonA,
    #LongHeadBiceps,
    TreatmentStatus,
    RegistryStatus
    ) |>
    tbl_summary(
      #by = LongHeadBiceps,
      label = list(
        #SurgeonA ~ "Surgeon",
        AgeAtInitialExam ~ "Age at Initial Consultation (Years)",
        Sex = "Male",
        BilateralStatus ~ "Bilateral Presentation",
        IndexSide ~ "Dominant Side",
        SymptomDuration ~ "Symptom Duration (Weeks)",
        SymptomDurationCat ~ "Symptom Duration Category",
        TreatmentStatus ~ "Treatment Record Active",
        RegistryStatus ~ "Patient Record Active"
      ),
      type = list(
        Sex ~ "dichotomous",
        TreatmentStatus ~ "dichotomous",
        RegistryStatus ~ "dichotomous"
      ),
      value = list(
        Sex = "Male",
        IndexSide = "Dominant",
        TreatmentStatus = "Ongoing",
        RegistryStatus = "Open"
      ),
      statistic = list(
        all_categorical() ~ "{p} ({n})"
        ),
      missing = "no"
    ) |> add_stat_label(
    location = "column"
  ) |> modify_table_styling(
      columns = label,
      rows = label == "Symptom Duration Category",
      footnote = "Dichotomised below or equal to 0.5 years or greater than 0.5 years"
  ) |> modify_table_styling(
      columns = label,
      rows = label == "Treatment Record Active",
      footnote = "Treatment record remains active - no change to follow up"
  ) |> modify_table_styling(
      columns = label,
      rows = label == "Patient Record Active",
      footnote = "Patient record remains open - no change to consent or mortality status"
  ) 

gtsummary::as_flex_table(TableRep7BR1) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)

```

### Surgical Details

Surgical findings and management strategies are summarised below.

```{r}
#| label: tbl-TableRep7BR2
#| tbl-cap: "Summary of PRULO Report 7 (Bankart Repair) Cases - Pathology and Surgical Details"


TableRep7BR2 <-
  SelectRep7BR |>
  dplyr::select(
    CuffStatus2,
    TreatmentType,
    ProductCountFct, #This has a code block it depends on to derive this count within the dataframe - ensure its copied|amended into each report as required
    CuffRepair:AdjunctProcedure) |>
  tbl_summary(
      #by = LongHeadBiceps,
      label = list(
        ProductCountFct ~ "Product Count",
        CuffStatus2 ~ "Cuff Status",
        TreatmentType ~ "Treatment Type",
        CuffRepair ~ "Cuff Repair",
        RepairAugmentation ~ "Repair Augmentation",
        LabrumRepair ~ "Labrum Repair",
        CapsuleLigament ~ "Capsule | Ligament",
        AdjunctProcedure ~ "Adjunct Procedure"
      ),
      statistic = list(
        all_categorical() ~ "{p} ({n})"
        ),
      missing = "no"
    ) |> modify_table_styling(
      columns = label,
      rows = label == "Other",
      footnote = "Labral tear uncategorised"
    ) 

gtsummary::as_flex_table(TableRep7BR2) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)

```

### Treatment Survival

```{epoxy}
#| label:  Duration-Rep7BR-Proc2

The mean follow up duration is {round(SelectRep7BR |> ungroup() |> summarise(mean = mean(Duration))/52,1)} years, with a standard deviation of {round(SelectRep7BR |> ungroup() |> summarise(sd = sd(Duration))/52,2)} years.

```

Failure or revision events as identified in the registry for this cohort are summarised below. Individual failure data can be accessed in [Attachment 1](https://docs.google.com/spreadsheets/d/1ESVvSKAv8ma11kri9pby6OEU9Gk5Z3UnF6XwjXBTcTg/edit#gid=0).

```{r}
#| label: tbl-TableRep7BR3
#| tbl-cap: "Summary of PRULO Report 7 (Bankart Repair) Cases - Procedure Survival"

TableRep7BR3 <- tbl_survfit(
  survfit2(Surv(Duration, Status) ~ 1, 
           data = SelectRep7BR),
  times = c(1,26,52,104),
  label_header = "**{time} Weeks**",
  label = "Procedure Survival",
  statistic = "{estimate} ({conf.low} - {conf.high})"
) |> gtsummary::modify_footnote_header(
    footnote = "% survival with 95% confidence intervals",
    columns = all_stat_cols(),
  )

gtsummary::as_flex_table(TableRep7BR3) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)
```

```{r}
#| label:  Failure-Report-Rep7BRA-Proc2

#Previous surgery(ies) at the same site Anatomical Location 
#Anchor 1 Anchor 2 Anchor 3 Anchor 4

FailuresRep7BR <-
  SelectRep7BR |> mutate(
    TreatmentStatusDesc = stringr::str_to_sentence(TreatmentStatusNotes)
  ) |>
      filter(TreatmentStatus == "Failed") |> 
  dplyr::select(
    TreatmentID,
    AgeAtInitialExam, 
    Sex,
    TreatmentType,
    Duration,
    TreatmentStatusDesc,
    ReoperationProcedure2,
    SubsequentTx2,
    Product1,
    Product2,
    Product3,
    Product4,
    QDASH_TotalScore_Preop,
    QDASH_TotalScore_3months,
    QDASH_TotalScore_6months) |> mutate(
      Procedure = "Cuff Repair"
    ) |> arrange(
      TreatmentID
    )

```

```{r}
#| label:  Failure-Report-Rep7B-write
#| eval: false
#| include: false

# Authenticate for sheets using the same token
gs4_auth(token = drive_token())

# Do the write operation silently
if (nrow(FailuresRep7BR) > 0) {
  invisible(
    googlesheets4::sheet_append(
 ss = SheetIDs$AuditReport,
 data = FailuresRep7BR |> arrange(TreatmentID),
 sheet = "Failures7"
    )
  )
}


```


```{r}
#| label:  Failure-Report-Rep7B-display

if (nrow(FailuresRep7BR) == 0) {
  epoxy::epoxy_html("There are no failures to report.")
} else {
  epoxy::epoxy_html('Failures were written to an <a href="{{SheetIDs$AuditReport}}"Attachment 1/a> for further review')
}


```

### Adverse Events

Complications and adverse events are summarised below. Individual reoperation data can be accessed in [Attachment 1](https://docs.google.com/spreadsheets/d/1ESVvSKAv8ma11kri9pby6OEU9Gk5Z3UnF6XwjXBTcTg/edit#gid=0).


```{r}
#| label: tbl-intraop-complications-7B
#| tbl-cap: "Summary of PRULO Report 7 (Bankart Repair) Cases - Intraoperative Events"

# Check if any complications exist in filtered data
has_complications <- SelectRep7BR |> 
  filter(TreatmentID %in% IntraopComp$TreatmentID) |> 
  nrow() > 0

# Conditionally generate content
if (!has_complications) {
  # If no complications, return the text message
  epoxy("No intraoperative complications observed.")
} else {
  # Calculate incidence and confidence intervals
  total_cases <- nrow(SelectRep7BR)
  complication_cases <- SelectRep7BR |> 
    filter(TreatmentID %in% IntraopComp$TreatmentID) |> 
    nrow()
  
  # Calculate proportion and 95% CI using Wilson method
  prop_result <- binom::binom.confint(complication_cases, total_cases, 
                                      methods = "wilson")
  incidence_pct <- round(prop_result$mean * 100, 1)
  ci_lower <- round(prop_result$lower * 100, 1)
  ci_upper <- round(prop_result$upper * 100, 1)
  
  # Generate summary sentence
  summary_text <- glue::glue(
    "Intraoperative events occurred in {complication_cases} of {total_cases} cases ({incidence_pct}%, 95% CI: {ci_lower}%-{ci_upper}%)."
  )
  
  # Print summary sentence
  cat(summary_text, "\n\n")
  
  # Generate and return the table
  IntraopComp |> 
    filter(TreatmentID %in% SelectRep7BR$TreatmentID) |> 
    rename(
      Description = "ICNature2",
      Intervention = "ICIntervention",
      PostopManagement = "ICPostopManagement"
    ) |> 
    select(
      TreatmentID,
      Description,
      Intervention,
      PostopManagement
    ) |> 
    gt::gt()
}

```

```{r}
#| label: Complication-Other-Rep7BR


SelectRep7BROther <- SelectRep7BR |> filter(
  Other == TRUE
) |> dplyr::select(
  TreatmentID,
  DateTreatment,
  Cohort
)
```

```{r}
#| label: tbl-TableRep7BR4
#| tbl-cap: "Summary of PRULO Report 7 (Bankart Repair) Cases - Postoperative Events"

# Now create the summary table
TableRep7BR4 <- SelectRep7BR |>
  dplyr::select(
    Infection,
    Ligament_Tendon,
    Effusion,
    Pain,
    Hardware,
    Loosening,
    Instability,
    Stiffness,
    Neurological,
    Thrombosis,
    Other,
    Reop,
    SubsequentTx2, #Inserted to address C028
    ReopDelay_Surgery) |>
  tbl_summary(
    label = list(
      Ligament_Tendon ~ "Ligament|Tendon (Retear)",
      ReopDelay_Surgery ~ "Reoperation Delay (Weeks)",
      
      Reop ~ "Reoperation",
      SubsequentTx2 ~ "Subsequent Treatment"
      ),
    type = list(
      ReopDelay_Surgery ~ "continuous"
    ),
    statistic = list(
      all_categorical() ~ "{p} ({n})",
      all_continuous() ~ "{mean} ({sd})"
    ),
    missing = "no",
    digits = list(
      all_continuous() ~ 1,
      all_categorical() ~ 0)
    ) |> modify_table_styling (
      columns = label,
      rows = label == "Subsequent Treatment",
      footnote = "Management undertaken for procedures that have suffered tissue failure or required hardware removal or replacement"
    ) |> modify_table_styling(
      columns = label,
      rows = label == "Reoperation",
      footnote = "A theatre procedure subsequent to the index surgery that does not involve removal, replacement or modification of the construct."
    ) |> modify_table_styling(
      columns = label,
      rows = label == "Reoperation Delay (Weeks)",
      footnote = "Time between index procedure and reoperation"
    ) 

gtsummary::as_flex_table(TableRep7BR4) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)
```

```{r}
#| label: Reoperations-Report-Rep7BRA-Proc2

#echo: false
#warning: false

#Previous surgery(ies) at the same site Anatomical Location 
#Anchor 1 Anchor 2 Anchor 3 Anchor 4

##Flip this around so that multiple reoperations are retained


SelectRep7BRReop <- ComplicTable3 |> filter(
  TreatmentID %in% SelectRep7BR$TreatmentID,
  `Reoperation Procedure` == "Yes"
  ) |> group_by(TreatmentID) |> slice_min(
    ReopDelay_Surgery,
    n = 1
    ) |> ungroup() |> left_join(
      SelectRep7BR |> dplyr::select(
    TreatmentID,
    AgeAtInitialExam,
    Sex,
    TreatmentType,
    Product1,
    Product2,
    Product3,
    Product4,
    QDASH_TotalScore_Preop,
    QDASH_TotalScore_3months,
    QDASH_TotalScore_6months
      ),
    by = "TreatmentID",
    relationship = "one-to-one"
    ) |>
  mutate(
     QDASH_TotalScore_Preop = as.numeric(QDASH_TotalScore_Preop),
     QDASH_TotalScore_3months = as.numeric(QDASH_TotalScore_3months),
     QDASH_TotalScore_6months =as.numeric(QDASH_TotalScore_6months)
  ) |> dplyr::select(
    TreatmentID,
    AgeAtInitialExam,
    Sex,
    TreatmentType,
    `Complication Nature`,

    EventDelay,
    Product1,
    Product2,
    Product3,
    Product4,
    QDASH_TotalScore_Preop,
    QDASH_TotalScore_3months,
    QDASH_TotalScore_6months
  ) |> mutate(
    Procedure = "Bankart Repair"
    ) |> arrange(
    TreatmentID
    )

```


```{r}
#| label:  Reoperations-Report-Rep7B-display

if (nrow(SelectRep7BRReop) == 0) {
  epoxy::epoxy_html("There are no reoperations to report.")
} else {
  epoxy::epoxy_html('Reoperations were written to <a href="{{SheetIDs$AuditReport}}"Attachment 1/a> for further review')
}


```

### Patient-Reported Outcomes

Complete case analysis of QuickDASH and WOSI Index Normalised is summarised below.

```{r}
#| label: fig-PROMsRep7BR
#| fig-cap: "Complete case analysis of QuickDASH and WOSI Normalised"


Rep7PROM1 <- ggplot(data = SelectRep7PROM1, mapping = aes(Timepoint,QDASH)) + 
geom_boxplot()

Rep7PROM2 <- ggplot(data = SelectRep7PROM1, mapping = aes(Timepoint,WOSINorm)) + 
geom_boxplot()

Rep7PROM1 / Rep7PROM2

```

```{r}
#| label: tbl-TableRep7BR5
#| tbl-cap: "Summary of PRULO Report 7 (Bankart Repair) Cases - QuickDASH and WOSI Normalised"


TableRep7BR5 <- SelectRep7BRPROM1 |>
dplyr::select(
  QDASH,
  #QDASHDelta,
  WOSINorm,
  #WOSIDelta,
  Timepoint) |>
tbl_summary(by = "Timepoint",
            missing = "no",
            type = list(
              QDASH ~ "continuous",
              #QDASHDelta ~ "continuous",
              WOSINorm ~ "continuous"
              #WOSIDelta ~ "continuous"
            ),
            statistic = all_continuous() ~ "{median} ({p25} - {p75})"
            ) 

gtsummary::as_flex_table(TableRep7BR5) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)



```

# Product Report 8 - Gryphon BR with Dynacord

## Sample Selection

The sample of patients with the relevant product group were identified and data were retrieved for analysis by matching registry records to the relevant stock keeping units (SKUs) for the product group of interest. Usage statistics for the product group were added, and adverse events data were attached. Patient-reported data were retrieved and the dataset was manipulated to include relevant details for procedures of interest.

```{r}
#| label:  Reference-Code-Rep8

RefCode8 <- ProductTable |> filter(
  (Category == "Anchor + Suture") &
  stringr::str_detect(stringr::str_to_lower(Description),"dynacord") &
  stringr::str_detect(stringr::str_to_lower(Description),"br") &
  stringr::str_detect(stringr::str_to_lower(Description),"gryphon")  
)

```

```{r}
#| label:  Slice-stack-Rep8

Pattern8 <- "gryphon.*br.*dynacord"

SelectRep8 <- SnapshotComb4 |> 
  filter(
    str_detect(ImplantCodes, paste(RefCode8$Reference, collapse = "|"))
  ) |> mutate(
    CuffStatus2 = case_when(
      is.na(CuffStatus) & !is.na(PatientPosition) ~ "Intact",
      !is.na(CuffStatus) ~ CuffStatus,
      .default = NA_character_
    ),
    across(
      starts_with("Product"),
      ~str_detect(str_to_lower(.), Pattern8),
      .names = "{.col}Check"
    )
  ) |> mutate(
    Product1Count = case_when(
      Product1Check == TRUE ~ stringr::str_extract(Product1,"\\d"),
      .default = NA
    ),
    Product2Count = case_when(
      Product2Check == TRUE ~ stringr::str_extract(Product2,"\\d"),
      .default = NA
    ),
    Product3Count = case_when(
      Product3Check == TRUE ~ stringr::str_extract(Product3,"\\d"),
      .default = NA
    ),
    Product4Count = case_when(
      Product4Check == TRUE ~ stringr::str_extract(Product4,"\\d"),
      .default = NA
      )
    ) |> mutate(
      across(Product1Count:Product4Count,~as.numeric(.))
    ) |> rowwise() |> mutate(
    ProductCount =  sum(across(Product1Count:Product4Count), na.rm = TRUE)
      ) |> mutate(
        ProductCountFct = forcats::fct(
            as.character(ProductCount),
            levels = c("1","2","3","4","5")
          )
        ) |> mutate(
  Infection = TreatmentID %in% ComplicInfection$TreatmentID,
  Ligament_Tendon = TreatmentID %in% ComplicLigament_Tendon$TreatmentID,
  Stiffness = TreatmentID %in% ComplicStiffness$TreatmentID,
  Loosening = TreatmentID %in% ComplicLoosening$TreatmentID,
  Hardware = TreatmentID %in% ComplicHardware$TreatmentID,
  Instability = TreatmentID %in% ComplicInstability$TreatmentID,
  Neurological = TreatmentID %in% ComplicNeurological$TreatmentID,
  Fracture = TreatmentID %in% ComplicFracture$TreatmentID,
  Thrombosis = TreatmentID %in% ComplicThrombosis$TreatmentID,
  Effusion = TreatmentID %in% ComplicEffusion$TreatmentID,
  Pain = TreatmentID %in% ComplicPain$TreatmentID,
  Other = TreatmentID %in% ComplicOther$TreatmentID,

  Reop = TreatmentID %in% ComplicReop$TreatmentID
) |> left_join(
  ComplicTable3 |> group_by(TreatmentID) |> slice_max(`Reoperation Procedure Date`, n = 1) |> ungroup() |> dplyr::select(
    TreatmentID,
    ReopDelay_Occur,
    ReopDelay_Surgery,
    EventDelay
  ),
  by = "TreatmentID"
)
```

```{r}
#| label:  Select-PROMs-Rep8

SelectRep8PROM1 <- SnapshotPROM1 |>
  filter(
    str_detect(ImplantCodes,paste(RefCode8$Reference,collapse = "|"))
  )

```

```{r}
#| label:  Select-Procedure-Rep8

SelectRep8BR <- SelectRep8 |> filter(LabrumRepair == "Bankart")
SelectRep8BRPROM1 <- SelectRep8PROM1 |> filter(LabrumRepair == "Bankart")

SelectRep8SLAP <- SelectRep8 |> filter(LabrumRepair == "SLAP")
SelectRep8SLAPPROM1<- SelectRep8PROM1 |> filter(LabrumRepair == "SLAP")

```

## Overview

Usage of the Product within the patient group is summarised below.

```{epoxy}
#| label: Overview-Rep8

{
  if(nrow(SelectRep8) == 1) {
    epoxy::epoxy("There is {nrow(SelectRep8)} case involving the anchor of interest.")
  } else {
    procedures <- unique(SelectRep8$ProcedureTotal)
    procedures <- procedures[procedures != "None" & procedures != "Unknown" & procedures != ""]
    procedures <- procedures[!grepl("^(Tenodesis|Tenotomy)$", procedures)]
    
    procedures_string <- if(length(procedures) > 1) {
  result8 <- paste(procedures[-length(procedures)], collapse = "] [")
  paste0(result8, "], and [", procedures[length(procedures)])
    } else {
      procedures
    }
    
    epoxy::epoxy("There are {nrow(SelectRep8)} cases involving the anchor of interest. Surgeries were performed between {format(min(SelectRep8$DateTreatment),'%Y-%b-%d')} and {format(max(SelectRep8$DateTreatment),'%Y-%b-%d')}. The procedures included [{procedures_string}].")
  }
}

{ifelse(nrow(SelectRep8BR) <= 1,
        epoxy::epoxy("There is {nrow(SelectRep8BR)} case involving the anchor of interest. There is insufficient sample size to provide a report."),
        ifelse(dplyr::between(nrow(SelectRep8BR),2,5),
        epoxy::epoxy("There are {nrow(SelectRep8BR)} cases involving the anchor of interest and a Bankart repair. Surgeries were performed between {format(min(SelectRep8BR$DateTreatment),'%Y-%b-%d')} to {format(max(SelectRep8BR$DateTreatment),'%Y-%b-%d')}. There is insufficient sample size to provide a report."),
        epoxy::epoxy("There are {nrow(SelectRep8BR)} cases involving the anchor of interest and a Bankart repair. Surgeries were performed between {format(min(SelectRep8BR$DateTreatment),'%Y-%b-%d')} to {format(max(SelectRep8BR$DateTreatment),'%Y-%b-%d')}."
        )))} 


```


# Product Report 9 - Gryphon PEEK with Dynacord

## Sample Selection

The sample of patients with the relevant product group were identified and data were retrieved for analysis by matching registry records to the relevant stock keeping units (SKUs) for the product group of interest. Usage statistics for the product group were added, and adverse events data were attached. Patient-reported data were retrieved and the dataset was manipulated to include relevant details for procedures of interest.

```{r}
#| label: Reference-Code-Rep9 

RefCode9 <- ProductTable |> filter(
  (Category == "Anchor + Suture") &
  stringr::str_detect(stringr::str_to_lower(Description),"dynacord") &
  stringr::str_detect(stringr::str_to_lower(Description),"peek") &
  stringr::str_detect(stringr::str_to_lower(Description),"gryphon")  
)

```

```{r}
#| label: Slice-stack-Rep9

Pattern9 <- "gryphon.*peek.*dynacord"

SelectRep9 <- SnapshotComb4 |> 
  filter(
    str_detect(ImplantCodes, paste(RefCode9$Reference, collapse = "|"))
  ) |> mutate(
    CuffStatus2 = case_when(
      is.na(CuffStatus) & !is.na(PatientPosition) ~ "Intact",
      !is.na(CuffStatus) ~ CuffStatus,
      .default = NA_character_
    ),
    across(
      starts_with("Product"),
      ~str_detect(str_to_lower(.), Pattern9),
      .names = "{.col}Check"
    )
  ) |> mutate(
    Product1Count = case_when(
      Product1Check == TRUE ~ stringr::str_extract(Product1,"\\d"),
      .default = NA
    ),
    Product2Count = case_when(
      Product2Check == TRUE ~ stringr::str_extract(Product2,"\\d"),
      .default = NA
    ),
    Product3Count = case_when(
      Product3Check == TRUE ~ stringr::str_extract(Product3,"\\d"),
      .default = NA
    ),
    Product4Count = case_when(
      Product4Check == TRUE ~ stringr::str_extract(Product4,"\\d"),
      .default = NA
      )
    ) |> mutate(
      across(Product1Count:Product4Count,~as.numeric(.))
    ) |> rowwise() |> mutate(
    ProductCount =  sum(across(Product1Count:Product4Count), na.rm = TRUE)
      ) |> mutate(
        ProductCountFct = forcats::fct(
            as.character(ProductCount),
            levels = c("1","2","3","4","5")
          )
        ) |> mutate(
  Infection = TreatmentID %in% ComplicInfection$TreatmentID,
  Ligament_Tendon = TreatmentID %in% ComplicLigament_Tendon$TreatmentID,
  Stiffness = TreatmentID %in% ComplicStiffness$TreatmentID,
  Loosening = TreatmentID %in% ComplicLoosening$TreatmentID,
  Hardware = TreatmentID %in% ComplicHardware$TreatmentID,
  Instability = TreatmentID %in% ComplicInstability$TreatmentID,
  Neurological = TreatmentID %in% ComplicNeurological$TreatmentID,
  Fracture = TreatmentID %in% ComplicFracture$TreatmentID,
  Thrombosis = TreatmentID %in% ComplicThrombosis$TreatmentID,
  Effusion = TreatmentID %in% ComplicEffusion$TreatmentID,
  Pain = TreatmentID %in% ComplicPain$TreatmentID,
  Other = TreatmentID %in% ComplicOther$TreatmentID,

  Reop = TreatmentID %in% ComplicReop$TreatmentID
) |> left_join(
  ComplicTable3 |> group_by(TreatmentID) |> slice_min(DateOccurFix, n = 1) |> ungroup() |> dplyr::select(
    TreatmentID,
    ReopDelay_Occur,
    ReopDelay_Surgery,
    EventDelay
  ),
  by = "TreatmentID"
)
```

```{r}
#| label: Select-PROMs-Rep9 

SelectRep9PROM1 <- SnapshotPROM1 |>
  filter(
    str_detect(ImplantCodes,paste(RefCode9$Reference,collapse = "|"))
  )

```

```{r}
#| label: Select-Procedure-Rep9 

SelectRep9BR <- SelectRep9 |> filter(LabrumRepair == "Bankart")
SelectRep9BRPROM1 <- SelectRep9PROM1 |> filter(LabrumRepair == "Bankart")

```

## Overview

Usage of the Product within the patient group is summarised below.

```{epoxy}
#| label: Overview-Rep9

{
  if(nrow(SelectRep9) == 1) {
    epoxy::epoxy("There is {nrow(SelectRep9)} case involving the anchor of interest.")
  } else {
    procedures <- unique(SelectRep9$ProcedureTotal)
    procedures <- procedures[procedures != "None" & procedures != "Unknown" & procedures != ""]
    procedures <- procedures[!grepl("^(Tenodesis|Tenotomy)$", procedures)]
    
    procedures_string <- if(length(procedures) > 1) {
  result9 <- paste(procedures[-length(procedures)], collapse = "] [")
  paste0(result9, "], and [", procedures[length(procedures)])
    } else {
      procedures
    }
    
    epoxy::epoxy("There are {nrow(SelectRep9)} cases involving the anchor of interest. Surgeries were performed between {format(min(SelectRep9$DateTreatment),'%Y-%b-%d')} and {format(max(SelectRep9$DateTreatment),'%Y-%b-%d')}. The procedures included [{procedures_string}].")
  }
} 

{ifelse(nrow(SelectRep9BR) <= 1,
        epoxy::epoxy("There is {nrow(SelectRep9BR)} case involving the anchor of interest and a Bankart Repair. There is insufficient sample size to provide a report."),
        ifelse(dplyr::between(nrow(SelectRep9BR),2,5),
        epoxy::epoxy("There are {nrow(SelectRep9BR)} cases involving the anchor of interest and a Bankart repair. Surgeries were performed between {format(min(SelectRep9BR$DateTreatment),'%Y-%b-%d')} to {format(max(SelectRep9BR$DateTreatment),'%Y-%b-%d')}. There is insufficient sample size to provide a report."),
        epoxy::epoxy("There are {nrow(SelectRep9BR)} cases involving the anchor of interest and a Bankart repair. Surgeries were performed between {format(min(SelectRep9BR$DateTreatment),'%Y-%b-%d')} to {format(max(SelectRep9BR$DateTreatment),'%Y-%b-%d')}."
        )))} 


```

## Adverse Events

Complications and adverse events are summarised below. 

```{r}
#| label: tbl-intraop-complications-9
#| tbl-cap: "Summary of PRULO Report 9 (All) Cases - Intraoperative Events"

# Check if any complications exist in filtered data
has_complications <- SelectRep9 |> 
  filter(TreatmentID %in% IntraopComp$TreatmentID) |> 
  nrow() > 0

# Conditionally generate content
if (!has_complications) {
  # If no complications, return the text message
  epoxy("No intraoperative complications observed.")
} else {
  # Calculate incidence and confidence intervals
  total_cases <- nrow(SelectRep9)
  complication_cases <- SelectRep9 |> 
    filter(TreatmentID %in% IntraopComp$TreatmentID) |> 
    nrow()
  
  # Calculate proportion and 95% CI using Wilson method
  prop_result <- binom::binom.confint(complication_cases, total_cases, 
                                      methods = "wilson")
  incidence_pct <- round(prop_result$mean * 100, 1)
  ci_lower <- round(prop_result$lower * 100, 1)
  ci_upper <- round(prop_result$upper * 100, 1)
  
  # Generate summary sentence
  summary_text <- glue::glue(
    "Intraoperative events occurred in {complication_cases} of {total_cases} cases ({incidence_pct}%, 95% CI: {ci_lower}%-{ci_upper}%)."
  )
  
  # Print summary sentence
  cat(summary_text, "\n\n")
  
  # Generate and return the table
  IntraopComp |> 
    filter(TreatmentID %in% SelectRep9$TreatmentID) |> 
    rename(
      Description = "ICNature2",
      Intervention = "ICIntervention",
      PostopManagement = "ICPostopManagement"
    ) |> 
    select(
      TreatmentID,
      Description,
      Intervention,
      PostopManagement
    ) |> 
    gt::gt()
}

```

```{r}
#| label: tbl-TableRep-PC-9
#| tbl-cap: "Summary of PRULO Report 4 (Rotator Cuff) Cases - Postoperative Events"

# Now create the summary table
TableRep_PC9 <- SelectRep9 |>
  dplyr::select(
    Infection,
    Ligament_Tendon,
    Effusion,
    Pain,
    Hardware,
    Loosening,
    Instability,
    Stiffness,
    Neurological,
    Thrombosis,
    Other,
    Reop,
    SubsequentTx2, #Inserted to address C028 Feedback Round 1
    #ReopDelay_Surgery
    ) |>
  tbl_summary(
    label = list(
      Ligament_Tendon ~ "Ligament|Tendon (Retear)",
      #ReopDelay_Surgery ~ "Reoperation Delay (Weeks)",
      
      Reop ~ "Reoperation",
      SubsequentTx2 ~ "Subsequent Treatment"
      ),
    # type = list(
    #   ReopDelay_Surgery ~ "continuous"
    # ),
    statistic = list(
      all_categorical() ~ "{p} ({n})",
      all_continuous() ~ "{mean} ({sd})"
    ),
    missing = "no",) |> add_ci(
      statistic = list(
        all_categorical() ~ "{conf.low} - {conf.high}",
        all_continuous() ~ "{conf.low} - {conf.high}"
        
      )
    ) |> modify_table_styling(
      columns = label,
      rows = label == "Other",
      footnote = "Myocardial Infarction"
    ) |> modify_table_styling (
      columns = label,
      rows = label == "Subsequent Treatment",
      footnote = "Management undertaken for procedures that have suffered tissue failure or required hardware removal or replacement"
    ) |> modify_table_styling(
      columns = label,
      rows = label == "Reoperation",
      footnote = "A theatre procedure subsequent to the index surgery that does not involve removal, replacement or modification of the construct."
    ) 

gtsummary::as_flex_table(TableRep_PC9) |> flextable::set_table_properties(
  layout = "autofit",
  width = 0.5,
  align = "center",
  opts_word = list(
    split = TRUE
    )
)
```

```{r}
#| label:  Reoperations-Report-Rep9

#echo: false
#warning: false

#Previous surgery(ies) at the same site Anatomical Location 
#Anchor 1 Anchor 2 Anchor 3 Anchor 4

##Flip this around so that multiple reoperations are retained


SelectRep9Reop <- ComplicTable3 |> filter(
  TreatmentID %in% SelectRep9$TreatmentID,
  `Reoperation Procedure` == "Yes"
  ) |> group_by(TreatmentID) |> slice_min(
    ReopDelay_Surgery,
    n = 1
    ) |> ungroup() |> left_join(
      SelectRep9 |> dplyr::select(
    TreatmentID,
    AgeAtInitialExam,
    Sex,
    TreatmentType,
    Product1,
    Product2,
    Product3,
    Product4,
    QDASH_TotalScore_Preop,
    QDASH_TotalScore_3months,
    QDASH_TotalScore_6months
      ),
    by = "TreatmentID",
    relationship = "one-to-one"
    ) |>
  mutate(
     QDASH_TotalScore_Preop = as.numeric(QDASH_TotalScore_Preop),
     QDASH_TotalScore_3months = as.numeric(QDASH_TotalScore_3months),
     QDASH_TotalScore_6months =as.numeric(QDASH_TotalScore_6months)
  ) |> dplyr::select(
    TreatmentID,
    AgeAtInitialExam,
    Sex,
    TreatmentType,
    `Complication Nature`,

    EventDelay,
    Product1,
    Product2,
    Product3,
    Product4,
    QDASH_TotalScore_Preop,
    QDASH_TotalScore_3months,
    QDASH_TotalScore_6months
  ) |> mutate(
    Procedure = "Cuff Repair"
    ) |> arrange(
    TreatmentID
    )

```

```{r}
#| label:  Reoperations-Report-Rep9-write

# Authenticate for sheets using the same token
gs4_auth(token = drive_token())

# Do the write operation silently
if (nrow(SelectRep9Reop) > 0) {
  invisible(
    googlesheets4::range_write(
 ss = SheetIDs$AuditReport,
 data = SelectRep9Reop,
 sheet = "Reoperations9",
 range = "A1:P",
 col_names = TRUE
    )
  )
}


```

```{r}
#| label:  Reoperations-Report-Rep9-display

if (nrow(SelectRep9Reop) == 0) {
  epoxy::epoxy_html("There are no reoperations to report.")
} else {
  epoxy::epoxy_html('Reoperations were written to <a href="{{SheetIDs$AuditReport}}"Attachment 1/a> for further review')
}


```


# Product Report 10 - Latarjet Screw

## Sample Selection

The sample of patients with the relevant product group were identified and data were retrieved for analysis by matching registry records to the relevant stock keeping units (SKUs) for the product group of interest. Usage statistics for the product group were added, and adverse events data were attached. Patient-reported data were retrieved and the dataset was manipulated to include relevant details for procedures of interest.

```{r}
#| label: Reference-Code-Rep10 

RefCode10 <- ProductTable |> filter(
  (Category == "Screw" | Category == "Interference Screw") &
  stringr::str_detect(stringr::str_to_lower(Description),"latarjet")
)

```

```{r}
#| label: Slice-stack-Rep10 

Pattern10 <- "latarjet"

SelectRep10 <- SnapshotComb4 |> 
  filter(
    str_detect(ImplantCodes, paste(RefCode10$Reference, collapse = "|"))
  ) |> mutate(
    CuffStatus2 = case_when(
      is.na(CuffStatus) & !is.na(PatientPosition) ~ "Intact",
      !is.na(CuffStatus) ~ CuffStatus,
      .default = NA_character_
    ),
    across(
      starts_with("Product"),
      ~str_detect(str_to_lower(.), Pattern10),
      .names = "{.col}Check"
    )
  ) |> mutate(
    Product1Count = case_when(
      Product1Check == TRUE ~ stringr::str_extract(Product1,"\\d"),
      .default = NA
    ),
    Product2Count = case_when(
      Product2Check == TRUE ~ stringr::str_extract(Product2,"\\d"),
      .default = NA
    ),
    Product3Count = case_when(
      Product3Check == TRUE ~ stringr::str_extract(Product3,"\\d"),
      .default = NA
    ),
    Product4Count = case_when(
      Product4Check == TRUE ~ stringr::str_extract(Product4,"\\d"),
      .default = NA
      )
    ) |> mutate(
      across(Product1Count:Product4Count,~as.numeric(.))
    ) |> rowwise() |> mutate(
    ProductCount =  sum(across(Product1Count:Product4Count), na.rm = TRUE)
      ) |> mutate(
        ProductCountFct = forcats::fct(
            as.character(ProductCount),
            levels = c("1","2","3","4","5")
          )
        ) |> mutate(
  Infection = TreatmentID %in% ComplicInfection$TreatmentID,
  Ligament_Tendon = TreatmentID %in% ComplicLigament_Tendon$TreatmentID,
  Stiffness = TreatmentID %in% ComplicStiffness$TreatmentID,
  Loosening = TreatmentID %in% ComplicLoosening$TreatmentID,
  Hardware = TreatmentID %in% ComplicHardware$TreatmentID,
  Instability = TreatmentID %in% ComplicInstability$TreatmentID,
  Neurological = TreatmentID %in% ComplicNeurological$TreatmentID,
  Fracture = TreatmentID %in% ComplicFracture$TreatmentID,
  Thrombosis = TreatmentID %in% ComplicThrombosis$TreatmentID,
  Effusion = TreatmentID %in% ComplicEffusion$TreatmentID,
  Pain = TreatmentID %in% ComplicPain$TreatmentID,
  Other = TreatmentID %in% ComplicOther$TreatmentID,

  Reop = TreatmentID %in% ComplicReop$TreatmentID
) |> left_join(
  ComplicTable3 |> group_by(TreatmentID) |> slice_max(`Reoperation Procedure Date`, n = 1) |> ungroup() |> dplyr::select(
    TreatmentID,
    ReopDelay_Occur,
    ReopDelay_Surgery,
    EventDelay
  ),
  by = "TreatmentID"
)
```

```{r}
#| label: Select-PROMs-Rep10 

SelectRep10PROM1 <- SnapshotPROM1 |>
  filter(
    str_detect(ImplantCodes,paste(RefCode10$Reference,collapse = "|"))
  )

```

## Overview

Usage of the Product within the patient group is summarised below.

```{epoxy}
#| label: Overview-Rep10 

{
  if(nrow(SelectRep10) == 1) {
    epoxy::epoxy("There is {nrow(SelectRep10)} case involving the anchor of interest.")
  } else {
    procedures <- unique(SelectRep10$ProcedureTotal)
    procedures <- procedures[procedures != "None" & procedures != "Unknown" & procedures != ""]
    procedures <- procedures[!grepl("^(Tenodesis|Tenotomy)$", procedures)]
    
    procedures_string <- if(length(procedures) > 1) {
  result10 <- paste(procedures[-length(procedures)], collapse = "] [")
  paste0(result10, "], and [", procedures[length(procedures)])
    } else {
      procedures
    }
    
    epoxy::epoxy("There are {nrow(SelectRep10)} cases involving the anchor of interest. Surgeries were performed between {format(min(SelectRep10$DateTreatment),'%Y-%b-%d')} and {format(max(SelectRep10$DateTreatment),'%Y-%b-%d')}. The procedures included [{procedures_string}].")
  }
} 


```

## Procedure Report - All

### Patient Characteristics

Patient demographic, pathology, and treatment characteristics for this cohort receiving the Product are summarised below.

```{r}
#| label: tbl-TableRep101
#| tbl-cap: "Summary of PRULO Report 10 (All) - Patient Characteristics"

TableRep101 <-
  SelectRep10 |> mutate(
    SurgeonA = case_when(
      Surgeon == "KE" ~ "A",
      Surgeon == "RP" ~ "B",
      Surgeon == "GB" ~ "C",
      .default = NA_character_
  )) |>
  dplyr::select(
    AgeAtInitialExam,
    Sex,
    Cohort,
    IndexSide,
    BilateralStatus,
    # SymptomDuration,
    SymptomDurationCat,
    #SurgeonA,
    #LongHeadBiceps,
    TreatmentStatus,
    RegistryStatus
    ) |>
    tbl_summary(
      #by = LongHeadBiceps,
      label = list(
        #SurgeonA ~ "Surgeon",
        AgeAtInitialExam ~ "Age at Initial Consultation (Years)",
        Sex = "Male",
        BilateralStatus ~ "Bilateral Presentation",
        IndexSide ~ "Dominant Side",
        # SymptomDuration ~ "Symptom Duration (Weeks)",
        SymptomDurationCat ~ "Symptom Duration Category",
        TreatmentStatus ~ "Treatment Record Active",
        RegistryStatus ~ "Patient Record Active"
      ),
      type = list(
        AgeAtInitialExam ~ "continuous",
        #SymptomDuration ~ "continuous",
        Sex ~ "dichotomous",
        TreatmentStatus ~ "dichotomous",
        RegistryStatus ~ "dichotomous"
      ),
      value = list(
        Sex = "Male",
        IndexSide = "Dominant",
        TreatmentStatus = "Ongoing",
        RegistryStatus = "Open"
      ),
      statistic = list(
        all_categorical() ~ "{p} ({n})"
        ),
      missing = "no",
      digits = all_continuous() ~ 1
    ) |> add_stat_label(
    location = "column"
  ) |> modify_table_styling(
      columns = label,
      rows = label == "Symptom Duration Category",
      footnote = "Dichotomised below or equal to 0.5 years or greater than 0.5 years"
  ) |> modify_table_styling(
      columns = label,
      rows = label == "Treatment Record Active",
      footnote = "Treatment record remains active - no change to follow up"
  ) |> modify_table_styling(
      columns = label,
      rows = label == "Patient Record Active",
      footnote = "Patient record remains open - no change to consent or mortality status"
  ) 

gtsummary::as_flex_table(TableRep101) |> flextable::set_table_properties(
    layout = "autofit",
    width = 0.5,
    align = "center",
    opts_word = list(
      split = TRUE)
    )

```

### Surgical Details

Surgical findings and management strategies are summarised below.

```{r}
#| label: tbl-TableRep102
#| tbl-cap: "Summary of PRULO Report 10 (All) Cases - Pathology and Surgical Details"


TableRep102 <-
  SelectRep10 |>
  dplyr::select(
    CuffStatus2,
    TreatmentType,
    ProductCountFct, #This has a code block it depends on to derive this count within the dataframe - ensure its copied|amended into each report as required
    CuffRepair:AdjunctProcedure) |> mutate(
      ProductCountFct = fct_infreq(ProductCountFct),
      RepairAugmentation = case_when(
        is.na(RepairAugmentation) ~ "None",
        .default = RepairAugmentation
      )
    ) |>
  tbl_summary(
      #by = LongHeadBiceps,
      label = list(
        ProductCountFct ~ "Product Count",
        CuffStatus2 ~ "Cuff Status",
        TreatmentType ~ "Treatment Type",
        CuffRepair ~ "Cuff Repair",
        RepairAugmentation ~ "Repair Augmentation",
        LabrumRepair ~ "Labrum Repair",
        CapsuleLigament ~ "Capsule | Ligament",
        AdjunctProcedure ~ "Adjunct Procedure"
      ),
      statistic = list(
        all_categorical() ~ "{p} ({n})"
        ),
      missing = "no"
    ) |> modify_table_styling(
      columns = label,
      rows = label == "Other",
      footnote = "Labral tear uncategorised"
    ) 

gtsummary::as_flex_table(TableRep102) |> flextable::set_table_properties(
    layout = "autofit",
    width = 0.5,
    align = "center",
    opts_word = list(
      split = TRUE)
    )
  


```

### Treatment Survival

```{epoxy}
#| label: Duration-Rep10-Proc1

The mean follow up duration is {round(SelectRep10 |> ungroup() |> summarise(mean = mean(Duration))/52,1)} years, with a standard deviation of {round(SelectRep10 |> ungroup() |> summarise(sd = sd(Duration))/52,2)} years.

```

Failure or revision events as identified in the registry for this cohort are summarised below. Individual data can be accessed in [Attachment 1](https://docs.google.com/spreadsheets/d/1ESVvSKAv8ma11kri9pby6OEU9Gk5Z3UnF6XwjXBTcTg/edit#gid=0).

```{r}
#| label: tbl-TableRep103
#| tbl-cap: "Summary of PRULO Report 10 (Rotator Cuff) - Procedure Survival"

TableRep103 <- tbl_survfit(
  survfit2(Surv(Duration, Status) ~ 1, 
           data = SelectRep10),
  times = c(1,26,52,104),
  label_header = "**{time} Weeks**",
  label = "Procedure Survival",
  statistic = "{estimate} ({conf.low} - {conf.high})"
) |> gtsummary::modify_footnote_header(
    footnote = "% survival with 95% confidence intervals",
    columns = all_stat_cols(),
  )


gtsummary::as_flex_table(TableRep103) |> flextable::set_table_properties(
    layout = "autofit",
    width = 0.5,
    align = "center",
    opts_word = list(
      split = TRUE)
    )

```

```{r}
#| label: Failure-Report-Rep10A-Proc1

#Previous surgery(ies) at the same site Anatomical Location 
#Anchor 1 Anchor 2 Anchor 3 Anchor 4

FailuresRep10 <-
  SelectRep10 |> mutate(
    TreatmentStatusDesc = stringr::str_to_sentence(TreatmentStatusNotes)
  ) |>
      filter(TreatmentStatus == "Failed") |> 
  dplyr::select(
    TreatmentID,
    AgeAtInitialExam, 
    Sex,
    TreatmentType,
    Duration,
    TreatmentStatusDesc,
    ReoperationProcedure2,
    SubsequentTx2,
    Product1,
    Product2,
    Product3,
    Product4,
    QDASH_TotalScore_Preop,
    QDASH_TotalScore_3months,
    QDASH_TotalScore_6months) |> mutate(
      Procedure = "All"
    ) |> arrange(
      TreatmentID
    )

```

```{r}
#| label:  Failure-Report-Rep10-write
#| eval: false
#| include: false

# Authenticate for sheets using the same token
gs4_auth(token = drive_token())

# Do the write operation silently
if (nrow(FailuresRep10) > 0) {
  invisible(
    googlesheets4::range_write(
 ss = SheetIDs$AuditReport,
 data = FailuresRep10 |> arrange(TreatmentID),
 sheet = "Failures10",
 range = "A1:P",
 col_names = TRUE
    )
  )
}


```


```{r}
#| label:  Failure-Report-Rep10-display

if (nrow(FailuresRep10) == 0) {
  epoxy::epoxy_html("There are no failures to report.")
} else {
  epoxy::epoxy_html('Failures were written to <a href="{{SheetIDs$AuditReport}}"Attachment 1/a> for further review')
}


```

### Adverse Events

Complications and adverse events are summarised below. Individual reoperation data can be accessed in [Attachment 1](https://docs.google.com/spreadsheets/d/1ESVvSKAv8ma11kri9pby6OEU9Gk5Z3UnF6XwjXBTcTg/edit#gid=0).


```{r}
#| label: tbl-intraop-complications-10
#| tbl-cap: "Summary of PRULO Report 10 (All) Cases - Intraoperative Events"

# Check if any complications exist in filtered data
has_complications <- SelectRep10 |> 
  filter(TreatmentID %in% IntraopComp$TreatmentID) |> 
  nrow() > 0

# Conditionally generate content
if (!has_complications) {
  # If no complications, return the text message
  epoxy("No intraoperative complications observed.")
} else {
  # Calculate incidence and confidence intervals
  total_cases <- nrow(SelectRep10)
  complication_cases <- SelectRep10 |> 
    filter(TreatmentID %in% IntraopComp$TreatmentID) |> 
    nrow()
  
  # Calculate proportion and 95% CI using Wilson method
  prop_result <- binom::binom.confint(complication_cases, total_cases, 
                                      methods = "wilson")
  incidence_pct <- round(prop_result$mean * 100, 1)
  ci_lower <- round(prop_result$lower * 100, 1)
  ci_upper <- round(prop_result$upper * 100, 1)
  
  # Generate summary sentence
  summary_text <- glue::glue(
    "Intraoperative events occurred in {complication_cases} of {total_cases} cases ({incidence_pct}%, 95% CI: {ci_lower}%-{ci_upper}%)."
  )
  
  # Print summary sentence
  cat(summary_text, "\n\n")
  
  # Generate and return the table
  IntraopComp |> 
    filter(TreatmentID %in% SelectRep10$TreatmentID) |> 
    rename(
      Description = "ICNature2",
      Intervention = "ICIntervention",
      PostopManagement = "ICPostopManagement"
    ) |> 
    select(
      TreatmentID,
      Description,
      Intervention,
      PostopManagement
    ) |> 
    gt::gt()
}

```

```{r}
#| label: Complication-Other-Rep10 
SelectRep10Other <- SelectRep10 |> filter(
  Other == TRUE
) |> dplyr::select(
  TreatmentID,
  DateTreatment,
  Cohort
)
```

```{r}
#| label: tbl-TableRep104
#| tbl-cap: "Summary of PRULO Report 10 (All) Cases - Postoperative Events"

# Now create the summary table
TableRep104 <- SelectRep10 |>
  dplyr::select(
    Infection,
    Ligament_Tendon,
    Effusion,
    Pain,
    Hardware,
    Loosening,
    Instability,
    Stiffness,
    Neurological,
    Thrombosis,
    Other,
    Reop,
    SubsequentTx2, #Inserted to address C028
    ReopDelay_Surgery
    ) |>
  tbl_summary(
    label = list(
      Ligament_Tendon ~ "Ligament|Tendon (Retear)",
      ReopDelay_Surgery ~ "Reoperation Delay (Weeks)",
      
      Reop ~ "Reoperation",
      SubsequentTx2 ~ "Subsequent Treatment"
      ),
    type = list(
      ReopDelay_Surgery ~ "continuous"
    ),
    statistic = list(
      all_categorical() ~ "{p} ({n})",
      all_continuous() ~ "{mean} ({sd})"
    ),
    missing = "no",
    digits = list(
      all_continuous() ~ 1,
      all_categorical() ~ 0)
    ) |> modify_table_styling (
      columns = label,
      rows = label == "Subsequent Treatment",
      footnote = "Management undertaken for procedures that have suffered tissue failure or required hardware removal or replacement"
    ) |> modify_table_styling(
      columns = label,
      rows = label == "Reoperation",
      footnote = "A theatre procedure subsequent to the index surgery that does not involve removal, replacement or modification of the construct."
    ) |> modify_table_styling(
      columns = label,
      rows = label == "Reoperation Delay (Weeks)",
      footnote = "Time between index procedure and reoperation"
    ) |> add_ci(
      statistic = list(
        all_categorical() ~ "{conf.low} - {conf.high}",
        all_continuous() ~ "{conf.low} - {conf.high}"
        )
) 

gtsummary::as_flex_table(TableRep104) |> flextable::set_table_properties(
    layout = "autofit",
    width = 0.5,
    align = "center",
    opts_word = list(
      split = TRUE)
    )
```

```{r}
#| label: Reoperations-Report-Rep10A

#echo: false
#warning: false

#Previous surgery(ies) at the same site Anatomical Location 
#Anchor 1 Anchor 2 Anchor 3 Anchor 4

##Flip this around so that multiple reoperations are retained


SelectRep10Reop <- ComplicTable3 |> filter(
  TreatmentID %in% SelectRep10$TreatmentID,
  `Reoperation Procedure` == "Yes"
  ) |> group_by(TreatmentID) |> slice_min(
    ReopDelay_Surgery,
    n = 1
    ) |> ungroup() |> left_join(
      SelectRep10 |> dplyr::select(
    TreatmentID,
    AgeAtInitialExam,
    Sex,
    TreatmentType,
    Product1,
    Product2,
    Product3,
    Product4,
    QDASH_TotalScore_Preop,
    QDASH_TotalScore_3months,
    QDASH_TotalScore_6months
      ),
    by = "TreatmentID",
    relationship = "one-to-one"
    ) |>
  mutate(
     QDASH_TotalScore_Preop = as.numeric(QDASH_TotalScore_Preop),
     QDASH_TotalScore_3months = as.numeric(QDASH_TotalScore_3months),
     QDASH_TotalScore_6months =as.numeric(QDASH_TotalScore_6months)
  ) |> dplyr::select(
    TreatmentID,
    AgeAtInitialExam,
    Sex,
    TreatmentType,
    `Complication Nature`,

    EventDelay,
    Product1,
    Product2,
    Product3,
    Product4,
    QDASH_TotalScore_Preop,
    QDASH_TotalScore_3months,
    QDASH_TotalScore_6months
  ) |> mutate(
    Procedure = "All"
    ) |> arrange(
    TreatmentID
    )

```

<!--# Write reoperations to external sheet -->


```{r}
#| label:  Reoperations-Report-Rep10-write

# Authenticate for sheets using the same token
gs4_auth(token = drive_token())

# Do the write operation silently
if (nrow(SelectRep10Reop) > 0) {
  invisible(
    googlesheets4::range_write(
 ss = SheetIDs$AuditReport,
 data = SelectRep10Reop,
 sheet = "Reoperations10",
 range = "A1:P",
 col_names = TRUE
    )
  )
}


```


```{r}
#| label:  Reoperations-Report-Rep10-display

if (nrow(SelectRep10Reop) == 0) {
  epoxy::epoxy_html("There are no reoperations to report.")
} else {
  epoxy::epoxy_html('Reoperations were written to <a href="{{SheetIDs$AuditReport}}"Attachment 1/a> for further review')
}


```


### Patient-Reported Outcomes

Complete case analysis of QuickDASH and WOSI Index Normalised is summarised below.

```{r}
#| label: fig-PROMsRep10
#| fig-cap: "Complete case analysis of QuickDASH(Top) and WOSI Index Normalised (Bottom)."


Rep10PROM1 <- ggplot(data = SelectRep10PROM1, mapping = aes(Timepoint,QDASH)) + 
geom_boxplot()

Rep10PROM2 <- ggplot(data = SelectRep10PROM1, mapping = aes(Timepoint,WOSINorm)) + 
geom_boxplot()

Rep10PROM1 / Rep10PROM2

```

```{r}
#| label: tbl-TableRep105
#| tbl-cap: " Summary of PRULO Report 10 (All) Cases - QuickDASH and WOSI"


TableRep105 <- SelectRep10PROM1 |>
dplyr::select(
  QDASH,
  #QDASHDelta,
  WOSINorm,
  WOSIDelta,
  Timepoint) |>
tbl_summary(by = "Timepoint",
            missing = "no",
            type = list(
              QDASH ~ "continuous",
              #QDASHDelta ~ "continuous",
              WOSINorm ~ "continuous",
              WOSIDelta ~ "continuous"
            ),
            statistic = all_continuous() ~ "{median} ({p25} - {p75})"
            ) 

gtsummary::as_flex_table(TableRep105) |> flextable::set_table_properties(
    layout = "autofit",
    width = 0.5,
    align = "center",
    opts_word = list(
      split = TRUE)
    )


```

# Product Report 11 - Dynacord Freestrand Suture

## Sample Selection

The sample of patients with the relevant product group were identified and data were retrieved for analysis by matching registry records to the relevant stock keeping units (SKUs) for the product group of interest. Usage statistics for the product group were added, and adverse events data were attached. Patient-reported data were retrieved and the dataset was manipulated to include relevant details for procedures of interest.

```{r}
#| label: Reference-Code-Rep11 

RefCode11 <- ProductTable |> filter(
  (Category == "Suture") &
 stringr::str_detect(stringr::str_to_lower(Description),"dynacord") 
)

```

```{r}
#| label: Slice-stack-Rep11 

Pattern11 <- "dynacord.*pack"

SelectRep11 <- SnapshotComb4 |> 
  filter(
    str_detect(ImplantCodes,paste(RefCode11$Reference,collapse = "|"))
  ) |> mutate(
    CuffStatus2 = case_when(
      is.na(CuffStatus) & !is.na(PatientPosition) ~ "Intact",
      !is.na(CuffStatus) ~ CuffStatus,
      .default = NA_character_
    ),
    Product1Check = stringr::str_detect(stringr::str_to_lower(Product1),Pattern11),
    Product2Check = stringr::str_detect(stringr::str_to_lower(Product2),Pattern11),
    Product3Check = stringr::str_detect(stringr::str_to_lower(Product3),Pattern11),
    Product4Check = stringr::str_detect(stringr::str_to_lower(Product4),Pattern11)
  ) |> mutate(
    Product1Count = case_when(
      Product1Check == TRUE ~ stringr::str_extract(Product1,"\\d"),
      .default = NA
    ),
    Product2Count = case_when(
      Product2Check == TRUE ~ stringr::str_extract(Product2,"\\d"),
      .default = NA
    ),
    Product3Count = case_when(
      Product3Check == TRUE ~ stringr::str_extract(Product3,"\\d"),
      .default = NA
    ),
    Product4Count = case_when(
      Product4Check == TRUE ~ stringr::str_extract(Product4,"\\d"),
      .default = NA
      )
    ) |> mutate(
      across(Product1Count:Product4Count,~as.numeric(.))
    ) |> rowwise() |> mutate(
    ProductCount =  sum(across(Product1Count:Product4Count), na.rm = TRUE)
      ) |> mutate(
        ProductCountFct = forcats::fct(
            as.character(ProductCount),
            levels = c("1","2","3","4","5")
          )
        ) |> mutate(
  Infection = TreatmentID %in% ComplicInfection$TreatmentID,
  Ligament_Tendon = TreatmentID %in% ComplicLigament_Tendon$TreatmentID,
  Stiffness = TreatmentID %in% ComplicStiffness$TreatmentID,
  Loosening = TreatmentID %in% ComplicLoosening$TreatmentID,
  Hardware = TreatmentID %in% ComplicHardware$TreatmentID,
  Instability = TreatmentID %in% ComplicInstability$TreatmentID,
  Neurological = TreatmentID %in% ComplicNeurological$TreatmentID,
  Fracture = TreatmentID %in% ComplicFracture$TreatmentID,
  Thrombosis = TreatmentID %in% ComplicThrombosis$TreatmentID,
  Effusion = TreatmentID %in% ComplicEffusion$TreatmentID,
  Pain = TreatmentID %in% ComplicPain$TreatmentID,
  Other = TreatmentID %in% ComplicOther$TreatmentID,

  Reop = TreatmentID %in% ComplicReop$TreatmentID
) |> left_join(
  ComplicTable3 |> group_by(TreatmentID) |> slice_max(`Reoperation Procedure Date`, n = 1) |> ungroup() |> dplyr::select(
    TreatmentID,
    ReopDelay_Occur,
    ReopDelay_Surgery,
    EventDelay
  ),
  by = "TreatmentID"
)
```

```{r}
#| label: Select-PROMs-Rep11

SelectRep11PROM1 <- SnapshotPROM1 |>
  filter(
    str_detect(ImplantCodes,paste(RefCode11$Reference,collapse = "|"))
  )

SelectRep11PROM2 <- SnapshotPROM2 |>
  filter(
    str_detect(ImplantCodes,paste(RefCode11$Reference,collapse = "|"))
  )

```

```{r}
#| label: Select-Procedure-Rep11

SelectRep11RC <- SelectRep11 |> filter(str_detect(CuffRepair,"Repair"))

SelectRep11RCPROM1 <- SelectRep11PROM1 |> filter(str_detect(CuffRepair,"Repair"))
SelectRep11RCPROM2 <- SelectRep11PROM2 |> filter(str_detect(CuffRepair,"Repair"))

SelectRep11BT <- SelectRep11 |> filter(str_detect(LongHeadBiceps,"Tenodesis"))
SelectRep11BTPROM1<- SelectRep11PROM1 |> filter(str_detect(LongHeadBiceps,"Tenodesis"))
SelectRep11BTPROM2<- SelectRep11PROM2 |> filter(str_detect(LongHeadBiceps,"Tenodesis"))
```

## Overview

Usage of the Product within the patient group is summarised below.

```{epoxy}
#| label: Overview-Rep11

{
  if(nrow(SelectRep11) == 1) {
    epoxy::epoxy("There is {nrow(SelectRep11)} case involving the anchor of interest.")
  } else {
    procedures <- unique(SelectRep11$ProcedureTotal)
    procedures <- procedures[procedures != "None" & procedures != "Unknown" & procedures != ""]
    procedures <- procedures[!grepl("^(Tenodesis|Tenotomy)$", procedures)]
    
    procedures_string <- if(length(procedures) > 1) {
  result11 <- paste(procedures[-length(procedures)], collapse = "] [")
  paste0(result11, "], and [", procedures[length(procedures)])
    } else {
      procedures
    }
    
    epoxy::epoxy("There are {nrow(SelectRep11)} cases involving the anchor of interest. Surgeries were performed between {format(min(SelectRep11$DateTreatment),'%Y-%b-%d')} and {format(max(SelectRep11$DateTreatment),'%Y-%b-%d')}. The procedures included [{procedures_string}].")
  }
} 

{ifelse(nrow(SelectRep11RC) <= 1,
        epoxy::epoxy("There is {nrow(SelectRep11RC)} case involving the suture of interest and a Cuff Repair. There is insufficient sample size to provide a report."),
        ifelse(dplyr::between(nrow(SelectRep11RC),2,5),
        epoxy::epoxy("There are {nrow(SelectRep11RC)} cases involving the suture of interest and a Cuff repair. Surgeries were performed between {format(min(SelectRep11RC$DateTreatment),'%Y-%b-%d')} to {format(max(SelectRep11RC$DateTreatment),'%Y-%b-%d')}. There is insufficient sample size to provide a report."),
        epoxy::epoxy("There are {nrow(SelectRep11RC)} cases involving the suture of interest and a Cuff repair. Surgeries were performed between {format(min(SelectRep11RC$DateTreatment),'%Y-%b-%d')} to {format(max(SelectRep11RC$DateTreatment),'%Y-%b-%d')}. The procedures included {paste(unique(SelectRep11RC$Procedures2), collapse = ', ')}."
        )))} 

{ifelse(nrow(SelectRep11BT) <= 1,
        epoxy::epoxy("There is {nrow(SelectRep11BT)} case involving the suture of interest and a Biceps Tenodesis. There is insufficient sample size to provide a report."),
        ifelse(dplyr::between(nrow(SelectRep11BT),2,5),
        epoxy::epoxy("There are {nrow(SelectRep11BT)} cases involving the suture of interest and a Biceps Tenodesis. Surgeries were performed between {format(min(SelectRep11BT$DateTreatment),'%Y-%b-%d')} to {format(max(SelectRep11BT$DateTreatment),'%Y-%b-%d')}. There is insufficient sample size to provide a report."),
        epoxy::epoxy("There are {nrow(SelectRep11BT)} cases involving the suture of interest and a Biceps Tenodesis. Surgeries were performed between {format(min(SelectRep11BT$DateTreatment),'%Y-%b-%d')} to {format(max(SelectRep11BT$DateTreatment),'%Y-%b-%d')}. The procedures included {paste(unique(SelectRep11BT$Procedures2), collapse = ', ')}."
        )))} 


```

## Procedure Report - Rotator Cuff Repair

### Patient Characteristics

Patient demographic, pathology, and treatment characteristics for this cohort receiving the Product are summarised below.

```{r}
#| label: tbl-TableRep11RC1
#| tbl-cap: "Summary of PRULO Report 11 (Rotator Cuff) Case - Patient Characteristics"

TableRep11RC1 <-
  SelectRep11RC |> mutate(
    SurgeonA = case_when(
      Surgeon == "KE" ~ "A",
      Surgeon == "RP" ~ "B",
      Surgeon == "GB" ~ "C",
      .default = NA_character_
  )) |>
  dplyr::select(
    AgeAtInitialExam,
    Sex,
    Cohort,
    IndexSide,
    BilateralStatus,
    SymptomDuration,
    SymptomDurationCat,
    #SurgeonA,
    LongHeadBiceps,
    TreatmentStatus,
    RegistryStatus
    ) |>
    tbl_summary(
      by = LongHeadBiceps,
      label = list(
        #SurgeonA ~ "Surgeon",
        AgeAtInitialExam ~ "Age at Initial Consultation (Years)",
        Sex = "Male",
        BilateralStatus ~ "Bilateral Presentation",
        IndexSide ~ "Dominant Side",
        SymptomDuration ~ "Symptom Duration (Weeks)",
        SymptomDurationCat ~ "Symptom Duration Category",
        TreatmentStatus ~ "Treatment Record Active",
        RegistryStatus ~ "Patient Record Active"
      ),
      type = list(
        AgeAtInitialExam ~ "continuous",
        SymptomDuration ~ "continuous",
        Sex ~ "dichotomous",
        TreatmentStatus ~ "dichotomous",
        RegistryStatus ~ "dichotomous",
        AgeAtInitialExam ~ "continuous"
      ),
      value = list(
        Sex = "Male",
        IndexSide = "Dominant",
        TreatmentStatus = "Ongoing",
        RegistryStatus = "Open"
      ),
      statistic = list(
        all_categorical() ~ "{p} ({n})"
        ),
      missing = "no"
    ) |> add_stat_label(
    location = "column"
  ) |> add_overall() |> modify_table_styling(
      columns = label,
      rows = label == "Symptom Duration Category",
      footnote = "Dichotomised below or equal to 0.5 years or greater than 0.5 years"
  ) |> modify_table_styling(
      columns = label,
      rows = label == "Treatment Record Active",
      footnote = "Treatment record remains active - no change to follow up"
  ) |> modify_table_styling(
      columns = label,
      rows = label == "Patient Record Active",
      footnote = "Patient record remains open - no change to consent or mortality status"
  ) 

gtsummary::as_flex_table(TableRep11RC1) |> flextable::set_table_properties(
    layout = "autofit",
    width = 0.5,
    align = "center",
    opts_word = list(
      split = TRUE)
    )

```

### Surgical Details

Surgical findings and management strategies are summarised below.

```{r}
#| eval: false

CuffStatus2 <- SelectRep11RC |> filter(is.na(CuffStatus))
```

<!--# There are a couple of cases that do not seem to fit the cuff status field properly. There is one GHI case that has the repair details (1399.1), but not cuff status inserted. The other is a general case that is a retorn RCR that probably needs to be moved across cohorts (193.2). -->

```{r}
#| label: tbl-TableRep11RC2
#| tbl-cap: "Summary of PRULO Report 11 (Rotator Cuff) Cases - Pathology and Surgical Details"

TableRep11RC2 <-
  SelectRep11RC |>
  dplyr::select(
    CuffStatus2,
    TreatmentType,
    ProductCountFct, #This has a code block it depends on to derive this count within the dataframe - ensure its copied|amended into each report as required
    CuffRepair:AdjunctProcedure) |>
  tbl_summary(
      by = LongHeadBiceps,
      label = list(
        ProductCountFct ~ "Product Count",
        CuffStatus2 ~ "Cuff Status",
        TreatmentType ~ "Treatment Type",
        CuffRepair ~ "Cuff Repair",
        RepairAugmentation ~ "Repair Augmentation",
        LabrumRepair ~ "Labrum Repair",
        CapsuleLigament ~ "Capsule | Ligament",
        AdjunctProcedure ~ "Adjunct Procedure"
      ),
      statistic = list(
        all_categorical() ~ "{p} ({n})"
        ),
      missing = "no"
    ) |> add_overall() |> modify_table_styling(
      columns = label,
      rows = label == "Other",
      footnote = "Biceps tendon integration; Biceps tendon transfer; Tendon advancement"
    ) 

gtsummary::as_flex_table(TableRep11RC2) |> flextable::set_table_properties(
    layout = "autofit",
    width = 0.5,
    align = "center",
    opts_word = list(
      split = TRUE)
    )

```

### Treatment Survival

```{epoxy}
#| label: Duration-Rep11-Proc1

The mean follow up duration is {round(SelectRep11RC |> ungroup() |> summarise(mean = mean(Duration))/52,1)} years, with a standard deviation of {round(SelectRep11RC |> ungroup() |> summarise(sd = sd(Duration))/52,2)} years.

```

Failure or revision events as identified in the registry for this cohort are summarised below. Individual failure data can be accessed in [Attachment 1](https://docs.google.com/spreadsheets/d/1ESVvSKAv8ma11kri9pby6OEU9Gk5Z3UnF6XwjXBTcTg/edit#gid=0).

```{r}
#| label: tbl-TableRep11RC3
#| tbl-cap: "Summary of PRULO Report 11 (Rotator Cuff) Cases - Procedure Survival"

TableRep11RC3 <- tbl_survfit(
  survfit2(Surv(Duration, Status) ~ 1, 
           data = SelectRep11RC),
  times = c(1,26,52,104),
  label_header = "**{time} Weeks**",
  label = "Procedure Survival",
  statistic = "{estimate} ({conf.low} - {conf.high})"
) |> gtsummary::modify_footnote_header(
    footnote = "% survival with 95% confidence intervals",
    columns = all_stat_cols(),
  )

gtsummary::as_flex_table(TableRep11RC3) |> flextable::set_table_properties(
    layout = "autofit",
    width = 0.5,
    align = "center",
    opts_word = list(
      split = TRUE)
    )

```

```{r}
#| label: Failure-Report-Rep11A-Proc1

#Previous surgery(ies) at the same site Anatomical Location 
#Anchor 1 Anchor 2 Anchor 3 Anchor 4

FailuresRep11RC <-
  SelectRep11RC |> mutate(
    TreatmentStatusDesc = stringr::str_to_sentence(TreatmentStatusNotes)
  ) |>
      filter(TreatmentStatus == "Failed") |> 
  dplyr::select(
    TreatmentID,
    AgeAtInitialExam, 
    Sex,
    TreatmentType,
    Duration,
    TreatmentStatusDesc,
    ReoperationProcedure2,
    SubsequentTx2,
    Product1,
    Product2,
    Product3,
    Product4,
    QDASH_TotalScore_Preop,
    QDASH_TotalScore_3months,
    QDASH_TotalScore_6months) |> mutate(
      Procedure = "Cuff Repair"
    ) |> arrange(
      TreatmentID
    )

```

```{r}
#| label:  Failure-Report-Rep11-write
#| eval: false
#| include: false

# Authenticate for sheets using the same token
gs4_auth(token = drive_token())

# Do the write operation silently
if (nrow(FailuresRep11) > 0) {
  invisible(
    googlesheets4::range_write(
 ss = SheetIDs$AuditReport,
 data = FailuresRep11 |> arrange(TreatmentID),
 sheet = "Failures11",
 range = "A1:P",
 col_names = TRUE
    )
  )
}


```


```{r}
#| label:  Failure-Report-Rep11-display

if (nrow(FailuresRep11) == 0) {
  epoxy::epoxy_html("There are no failures to report.")
} else {
  epoxy::epoxy_html('Failures were written to <a href="{{SheetIDs$AuditReport}}"Attachment 1/a> for further review')
}


```

### Adverse Events

Complications and adverse events are summarised below. Individual reoperation data can be accessed in [Attachment 1](https://docs.google.com/spreadsheets/d/1ESVvSKAv8ma11kri9pby6OEU9Gk5Z3UnF6XwjXBTcTg/edit#gid=0).


```{r}
#| label: tbl-intraop-complications-11A
#| tbl-cap: "Summary of PRULO Report 11 (Rotator Cuff) Cases - Intraoperative Events"

# Check if any complications exist in filtered data
has_complications <- SelectRep11RC |> 
  filter(TreatmentID %in% IntraopComp$TreatmentID) |> 
  nrow() > 0

# Conditionally generate content
if (!has_complications) {
  # If no complications, return the text message
  epoxy("No intraoperative complications observed.")
} else {
  # Calculate incidence and confidence intervals
  total_cases <- nrow(SelectRep11RC)
  complication_cases <- SelectRep11RC |> 
    filter(TreatmentID %in% IntraopComp$TreatmentID) |> 
    nrow()
  
  # Calculate proportion and 95% CI using Wilson method
  prop_result <- binom::binom.confint(complication_cases, total_cases, 
                                      methods = "wilson")
  incidence_pct <- round(prop_result$mean * 100, 1)
  ci_lower <- round(prop_result$lower * 100, 1)
  ci_upper <- round(prop_result$upper * 100, 1)
  
  # Generate summary sentence
  summary_text <- glue::glue(
    "Intraoperative events occurred in {complication_cases} of {total_cases} cases ({incidence_pct}%, 95% CI: {ci_lower}%-{ci_upper}%)."
  )
  
  # Print summary sentence
  cat(summary_text, "\n\n")
  
  # Generate and return the table
  IntraopComp |> 
    filter(TreatmentID %in% SelectRep11RC$TreatmentID) |> 
    rename(
      Description = "ICNature2",
      Intervention = "ICIntervention",
      PostopManagement = "ICPostopManagement"
    ) |> 
    select(
      TreatmentID,
      Description,
      Intervention,
      PostopManagement
    ) |> 
    gt::gt()
}

```

```{r}
#| label: Complication-Other-Rep11

SelectRep11Other <- SelectRep11 |> filter(
  Other == TRUE
) |> dplyr::select(
  TreatmentID,
  DateTreatment,
  Cohort
)
```

```{r}
#| label: tbl-TableRep11RC4
#| tbl-cap: "Summary of PRULO Report 11 (Rotator Cuff) Cases - Postoperative Events"

# Now create the summary table
TableRep11RC4 <- SelectRep11RC |>
  dplyr::select(
    Infection,
    Ligament_Tendon,
    Effusion,
    Pain,
    Hardware,
    Loosening,
    Instability,
    Stiffness,
    Neurological,
    Thrombosis,
    Other,
    Reop,
    SubsequentTx2 #Inserted to address C028
    #ReopDelay_Surgery
    ) |>
  tbl_summary(
    label = list(
      Ligament_Tendon ~ "Ligament|Tendon (Retear)",
      #ReopDelay_Surgery ~ "Reoperation Delay (Weeks)",
      
      Reop ~ "Reoperation",
      SubsequentTx2 ~ "Subsequent Treatment"
      ),
    # type = list(
    #   ReopDelay_Surgery ~ "continuous"
    # ),
    statistic = list(
      all_categorical() ~ "{p} ({n})",
      all_continuous() ~ "{mean} ({sd})"
    ),
    missing = "no",) |> add_ci(
      statistic = list(
        all_categorical() ~ "{conf.low} - {conf.high}",
        all_continuous() ~ "{conf.low} - {conf.high}"
        
      )
    ) |> modify_table_styling(
      columns = label,
      rows = label == "Other",
      footnote = "Myocardial Infarction"
    ) |> modify_table_styling (
      columns = label,
      rows = label == "Subsequent Treatment",
      footnote = "Management undertaken for procedures that have suffered tissue failure or required hardware removal or replacement"
    ) |> modify_table_styling(
      columns = label,
      rows = label == "Reoperation",
      footnote = "A theatre procedure subsequent to the index surgery that does not involve removal, replacement or modification of the construct."
    ) 

 gtsummary::as_flex_table(TableRep11RC4) |> flextable::set_table_properties(
    layout = "autofit",
    width = 0.5,
    align = "center",
    opts_word = list(
      split = TRUE)
    )
 
 
```

```{r}
#| label: Reoperations-Report-Rep11A-Proc1
#echo: false
#warning: false

#Previous surgery(ies) at the same site Anatomical Location 
#Anchor 1 Anchor 2 Anchor 3 Anchor 4

##Flip this around so that multiple reoperations are retained


SelectRep11RCReop <- ComplicTable3 |> filter(
  TreatmentID %in% SelectRep11RC$TreatmentID,
  `Reoperation Procedure` == "Yes"
  ) |> group_by(TreatmentID) |> slice_min(
    ReopDelay_Surgery,
    n = 1
    ) |> ungroup() |> left_join(
      SelectRep11 |> dplyr::select(
    TreatmentID,
    AgeAtInitialExam,
    Sex,
    TreatmentType,
    Product1,
    Product2,
    Product3,
    Product4,
    QDASH_TotalScore_Preop,
    QDASH_TotalScore_3months,
    QDASH_TotalScore_6months
      ),
    by = "TreatmentID",
    relationship = "one-to-one"
    ) |>
  mutate(
     QDASH_TotalScore_Preop = as.numeric(QDASH_TotalScore_Preop),
     QDASH_TotalScore_3months = as.numeric(QDASH_TotalScore_3months),
     QDASH_TotalScore_6months =as.numeric(QDASH_TotalScore_6months)
  ) |> dplyr::select(
    TreatmentID,
    AgeAtInitialExam,
    Sex,
    TreatmentType,
    `Complication Nature`,

    EventDelay,
    Product1,
    Product2,
    Product3,
    Product4,
    QDASH_TotalScore_Preop,
    QDASH_TotalScore_3months,
    QDASH_TotalScore_6months
  ) |> mutate(
    Procedure = "Cuff Repair"
    ) |> arrange(
    TreatmentID
    )

```

<!--# Write reoperations to external sheet -->


```{r}
#| label:  Reoperations-Report-Rep11-write

# Authenticate for sheets using the same token
gs4_auth(token = drive_token())

# Do the write operation silently
if (nrow(SelectRep11RCReop) > 0) {
  invisible(
    googlesheets4::range_write(
 ss = SheetIDs$AuditReport,
 data = SelectRep11RCReop,
 sheet = "Reoperations11",
 range = "A1:P",
 col_names = TRUE
    )
  )
}


```


```{r}
#| label:  Reoperations-Report-Rep11-display

if (nrow(SelectRep11RCReop) == 0) {
  epoxy::epoxy_html("There are no reoperations to report.")
} else {
  epoxy::epoxy_html('Reoperations were written to <a href="{{SheetIDs$AuditReport}}"Attachment 1/a> for further review')
}


```

### Patient-Reported Outcomes

Complete case analysis of QDASH, WORC Index Normalised, and WORC Physical Question 3 (How much weakness do you experience in your shoulder?) is summarised below.

```{r}
#| label: fig-PROMsRep11
#| fig-cap: "Complete case analysis of QDASH(Top), WORC Index Normalised (Middle), and WORC Physical Question 3 (Bottom)"


Rep11RCPROM1 <- ggplot(data = SelectRep11RCPROM1, mapping = aes(Timepoint,QDASH)) + 
geom_boxplot()

Rep11RCPROM2 <- ggplot(data = SelectRep11RCPROM2, mapping = aes(Timepoint,WORCNorm)) + 
geom_boxplot()

Rep11RCPROM3 <- ggplot(data = SelectRep11RCPROM2, mapping = aes(Timepoint,WORCPhysicalQ3)) + 
geom_boxplot()

Rep11RCPROM1 / Rep11RCPROM2 / Rep11RCPROM3

```

```{r}
#| label: tbl-TableRep11RC5
#| tbl-cap: "Summary of PRULO Report 11 (Rotator Cuff) Cases - QuickDASH"



TableRep11RC5 <- SelectRep11RCPROM1 |>
dplyr::select(
  QDASH,
  #QDASHDelta,
  Timepoint) |>
tbl_summary(by = "Timepoint",
            missing = "no",
            type = list(
              QDASH ~ "continuous"
              #QDASHDelta ~ "continuous"
            ),
            statistic = all_continuous() ~ "{median} ({p25} - {p75})"
            )
  
  
  gtsummary::as_flex_table(TableRep11RC5) |> flextable::set_table_properties(
    layout = "autofit",
    width = 0.5,
    align = "center",
    opts_word = list(
      split = TRUE)
    )
```

```{r}
#| label: tbl-TableRep11RC6
#| tbl-cap: "Summary of PRULO Report 11 (Rotator Cuff) Cases - WORC Normalised and WORC Physical Question 3."

TableRep11RC6 <- SelectRep11RCPROM2 |>
dplyr::select(WORCNorm,
              WORCPhysicalQ3,
              WORCDelta,
              Timepoint) |>
tbl_summary(by = "Timepoint",
            missing = "no",
            type = list(
              WORCNorm ~ "continuous",
              WORCPhysicalQ3 ~ "continuous",
              WORCDelta ~ "continuous"
            ),
            statistic = all_continuous() ~ "{median} ({p25} - {p75})") 


 gtsummary::as_flex_table(TableRep11RC6) |> flextable::set_table_properties(
    layout = "autofit",
    width = 0.5,
    align = "center",
    opts_word = list(
      split = TRUE)
    )

```

# Product Report 12 - Dynatape Freestrand Suture

## Sample Selection

The sample of patients with the relevant product group were identified and data were retrieved for analysis by matching registry records to the relevant stock keeping units (SKUs) for the product group of interest. Usage statistics for the product group were added, and adverse events data were attached. Patient-reported data were retrieved and the dataset was manipulated to include relevant details for procedures of interest.

```{r}
#| label: Reference-Code-Rep12

RefCode12 <- ProductTable |> filter(
  (Category == "Suture") &
 stringr::str_detect(stringr::str_to_lower(Description),"dynatape") 
)

```

```{r}
#| label: Slice-stack-Rep12

Pattern12 <- "dynatape"

SelectRep12 <- SnapshotComb4 |> 
  filter(
    str_detect(ImplantCodes,paste(RefCode12$Reference,collapse = "|"))
  ) |> mutate(
    CuffStatus2 = case_when(
      is.na(CuffStatus) & !is.na(PatientPosition) ~ "Intact",
      !is.na(CuffStatus) ~ CuffStatus,
      .default = NA_character_
    ),
    Product1Check = stringr::str_detect(stringr::str_to_lower(Product1),Pattern12),
    Product2Check = stringr::str_detect(stringr::str_to_lower(Product2),Pattern12),
    Product3Check = stringr::str_detect(stringr::str_to_lower(Product3),Pattern12),
    Product4Check = stringr::str_detect(stringr::str_to_lower(Product4),Pattern12)
  ) |> mutate(
    Product1Count = case_when(
      Product1Check == TRUE ~ stringr::str_extract(Product1,"\\d"),
      .default = NA
    ),
    Product2Count = case_when(
      Product2Check == TRUE ~ stringr::str_extract(Product2,"\\d"),
      .default = NA
    ),
    Product3Count = case_when(
      Product3Check == TRUE ~ stringr::str_extract(Product3,"\\d"),
      .default = NA
    ),
    Product4Count = case_when(
      Product4Check == TRUE ~ stringr::str_extract(Product4,"\\d"),
      .default = NA
      )
    ) |> mutate(
      across(Product1Count:Product4Count,~as.numeric(.))
    ) |> rowwise() |> mutate(
    ProductCount =  sum(across(Product1Count:Product4Count), na.rm = TRUE)
      ) |> mutate(
        ProductCountFct = forcats::fct(
            as.character(ProductCount),
            levels = c("1","2","3","4","5")
          )
        ) |> mutate(
  Infection = TreatmentID %in% ComplicInfection$TreatmentID,
  Ligament_Tendon = TreatmentID %in% ComplicLigament_Tendon$TreatmentID,
  Stiffness = TreatmentID %in% ComplicStiffness$TreatmentID,
  Loosening = TreatmentID %in% ComplicLoosening$TreatmentID,
  Hardware = TreatmentID %in% ComplicHardware$TreatmentID,
  Instability = TreatmentID %in% ComplicInstability$TreatmentID,
  Neurological = TreatmentID %in% ComplicNeurological$TreatmentID,
  Fracture = TreatmentID %in% ComplicFracture$TreatmentID,
  Thrombosis = TreatmentID %in% ComplicThrombosis$TreatmentID,
  Effusion = TreatmentID %in% ComplicEffusion$TreatmentID,
  Pain = TreatmentID %in% ComplicPain$TreatmentID,
  Other = TreatmentID %in% ComplicOther$TreatmentID,

  Reop = TreatmentID %in% ComplicReop$TreatmentID
) |> left_join(
  ComplicTable3 |> group_by(TreatmentID) |> slice_max(`Reoperation Procedure Date`, n = 1) |> ungroup() |> dplyr::select(
    TreatmentID,
    ReopDelay_Occur,
    ReopDelay_Surgery,
    EventDelay
  ),
  by = "TreatmentID"
)
```

```{r}
#| label: Select-PROMs-Rep12

SelectRep12PROM1 <- SnapshotPROM1 |>
  filter(
    str_detect(ImplantCodes,paste(RefCode12$Reference,collapse = "|"))
  )

SelectRep12PROM2 <- SnapshotPROM2 |>
  filter(
    str_detect(ImplantCodes,paste(RefCode12$Reference,collapse = "|"))
  )

```

```{r}
#| label: Select-Procedure-Rep12

SelectRep12RC <- SelectRep12 |> filter(str_detect(CuffRepair,"Repair"))

SelectRep12RCPROM1 <- SelectRep12PROM1 |> filter(str_detect(CuffRepair,"Repair"))
SelectRep12RCPROM2 <- SelectRep12PROM2 |> filter(str_detect(CuffRepair,"Repair"))
```

## Overview

Usage of the Product within the patient group is summarised below.

```{epoxy}
#| label: Overview-Rep12

{
  if(nrow(SelectRep12) <= 1) {
    epoxy::epoxy("There is {nrow(SelectRep12)} case involving the product of interest. There is insufficient sample size to provide a report.")
  } else {
    procedures <- unique(SelectRep12$ProcedureTotal)
    procedures <- procedures[procedures != "None" & procedures != "Unknown" & procedures != ""]
    procedures <- procedures[!grepl("^(Tenodesis|Tenotomy)$", procedures)]
    
   procedures_string <- if(length(procedures) > 1) {
  result12 <- paste(procedures[-length(procedures)], collapse = "] [")
  paste0(result12, "], and [", procedures[length(procedures)])
    } else {
      procedures
    }
    
    epoxy::epoxy("There are {nrow(SelectRep12)} cases involving the anchor of interest. Surgeries were performed between {format(min(SelectRep12$DateTreatment),'%Y-%b-%d')} and {format(max(SelectRep12$DateTreatment),'%Y-%b-%d')}. The procedures included [{procedures_string}].")
  }
} 

{ifelse(nrow(SelectRep12RC) <= 1,
        epoxy::epoxy("There are {nrow(SelectRep12RC)} cases involving the suture of interest and a Cuff Repair. There is insufficient sample size to provide a report."),
        ifelse(dplyr::between(nrow(SelectRep12RC),2,5),
        epoxy::epoxy("There are {nrow(SelectRep12RC)} cases involving the suture of interest and a Cuff repair. Surgeries were performed between {format(min(SelectRep12RC$DateTreatment),'%Y-%b-%d')} to {format(max(SelectRep12RC$DateTreatment),'%Y-%b-%d')}. There is insufficient sample size to provide a report."),
        epoxy::epoxy("There are {nrow(SelectRep12RC)} cases involving the suture of interest and a Cuff repair. Surgeries were performed between {format(min(SelectRep12RC$DateTreatment),'%Y-%b-%d')} to {format(max(SelectRep12RC$DateTreatment),'%Y-%b-%d')}. The procedures included {paste(unique(SelectRep12RC$Procedures2), collapse = ', ')}."
        )))} 




```

# Product Report 13 - Orthocord Freestrand Suture

## Sample Selection

The sample of patients with the relevant product group were identified and data were retrieved for analysis by matching registry records to the relevant stock keeping units (SKUs) for the product group of interest. Usage statistics for the product group were added, and adverse events data were attached. Patient-reported data were retrieved and the dataset was manipulated to include relevant details for procedures of interest.

```{r}
#| label: Reference-Code-Rep13

RefCode13 <- ProductTable |> filter(
  (Category == "Suture") &
 stringr::str_detect(stringr::str_to_lower(Description),"orthocord") 
)

```

```{r}
#| label: Slice-stack-Rep13

Pattern13 <- "orthocord"

SelectRep13 <- SnapshotComb4 |> 
  filter(
    str_detect(ImplantCodes,paste(RefCode13$Reference,collapse = "|"))
  ) |> mutate(
    case_when(
      is.na(CuffStatus) & !is.na(PatientPosition) ~ "Intact",
      !is.na(CuffStatus) ~ CuffStatus,
      .default = NA_character_
    ),
    Product1Check = stringr::str_detect(stringr::str_to_lower(Product1),Pattern13),
    Product2Check = stringr::str_detect(stringr::str_to_lower(Product2),Pattern13),
    Product3Check = stringr::str_detect(stringr::str_to_lower(Product3),Pattern13),
    Product4Check = stringr::str_detect(stringr::str_to_lower(Product4),Pattern13)
  ) |> mutate(
    Product1Count = case_when(
      Product1Check == TRUE ~ stringr::str_extract(Product1,"\\d"),
      .default = NA
    ),
    Product2Count = case_when(
      Product2Check == TRUE ~ stringr::str_extract(Product2,"\\d"),
      .default = NA
    ),
    Product3Count = case_when(
      Product3Check == TRUE ~ stringr::str_extract(Product3,"\\d"),
      .default = NA
    ),
    Product4Count = case_when(
      Product4Check == TRUE ~ stringr::str_extract(Product4,"\\d"),
      .default = NA
      )
    ) |> mutate(
      across(Product1Count:Product4Count,~as.numeric(.))
    ) |> rowwise() |> mutate(
    ProductCount =  sum(across(Product1Count:Product4Count), na.rm = TRUE)
      ) |> mutate(
        ProductCountFct = forcats::fct(
            as.character(ProductCount),
            levels = c("1","2","3","4","5")
          )
        ) |> mutate(
  Infection = TreatmentID %in% ComplicInfection$TreatmentID,
  Ligament_Tendon = TreatmentID %in% ComplicLigament_Tendon$TreatmentID,
  Stiffness = TreatmentID %in% ComplicStiffness$TreatmentID,
  Loosening = TreatmentID %in% ComplicLoosening$TreatmentID,
  Hardware = TreatmentID %in% ComplicHardware$TreatmentID,
  Instability = TreatmentID %in% ComplicInstability$TreatmentID,
  Neurological = TreatmentID %in% ComplicNeurological$TreatmentID,
  Fracture = TreatmentID %in% ComplicFracture$TreatmentID,
  Thrombosis = TreatmentID %in% ComplicThrombosis$TreatmentID,
  Effusion = TreatmentID %in% ComplicEffusion$TreatmentID,
  Pain = TreatmentID %in% ComplicPain$TreatmentID,
  Other = TreatmentID %in% ComplicOther$TreatmentID,
  Reop = TreatmentID %in% ComplicReop$TreatmentID
) |> left_join(
  ComplicTable3 |> group_by(TreatmentID) |> slice_max(`Reoperation Procedure Date`, n = 1) |> ungroup() |> dplyr::select(
    TreatmentID,
    ReopDelay_Occur,
    ReopDelay_Surgery,
    EventDelay
  ),
  by = "TreatmentID"
)
```

```{r}
#| label: Select-PROMs-Rep13

SelectRep13PROM1 <- SnapshotPROM1 |>
  filter(
    str_detect(ImplantCodes,paste(RefCode13$Reference,collapse = "|"))
  )

SelectRep13PROM2 <- SnapshotPROM2 |>
  filter(
    str_detect(ImplantCodes,paste(RefCode13$Reference,collapse = "|"))
  )

```

## Overview

Usage of the Product within the patient group is summarised below.

```{epoxy}
#| label: Overview-Rep13

{ifelse(nrow(SelectRep13) <= 1,
        epoxy::epoxy("There is {nrow(SelectRep13)} case involving the suture of interest. There is insufficient sample size to provide a report."),
        ifelse(dplyr::between(nrow(SelectRep13),2,5),
        epoxy::epoxy("There are {nrow(SelectRep13)} cases involving the suture of interest. Surgeries were performed between {format(min(SelectRep13$DateTreatment),'%Y-%b-%d')} to {format(max(SelectRep13$DateTreatment),'%Y-%b-%d')}. There is insufficient sample size to provide a report."),
        epoxy::epoxy("There are {nrow(SelectRep13)} cases involving the suture of interest. Surgeries were performed between {format(min(SelectRep13$DateTreatment),'%Y-%b-%d')} to {format(max(SelectRep13$DateTreatment),'%Y-%b-%d')}."
        )))} 

 


```

# Product usage patterns

Product usage patterns were determined by merging multiple product datasets into a single table. This combined data was then modified to include additional information and restructured to have separate columns for different product groups. Following this, a list of product category names was established and proportions for various combinations were calculated. The results were reformatted for presentation, with count data incorporated and proportions displayed as percentages.

```{r}
#| label: Product-usage-summary



# Second approach: Use values_fn to handle duplicates
SelectRepAll <- bind_rows(
  SelectRep1,
  SelectRep2,
  SelectRep3,
  SelectRep4,
  SelectRep5,
  SelectRep6,
  SelectRep7,
  SelectRep8,
  SelectRep9,
  SelectRep10,
  SelectRep11,
  SelectRep12,
  SelectRep13,
  .id = "Report"
) |>
  mutate(
    ReportInclus = 1,
    Report = paste0("Report", Report)
  ) |>
  select(
    TreatmentID,
    Report,
    ReportInclus
  ) |>
  pivot_wider(
    names_from = Report,
    values_from = ReportInclus,
    values_fill = 0,
    values_fn = max
  )

# Add any missing Report columns with 0s
for (i in 1:13) {
  col_name <- paste0("Report", i)
  if (!col_name %in% colnames(SelectRepAll)) {
    SelectRepAll[[col_name]] <- 0
  }
}

# Reorder columns to ensure consistent order
SelectRepAll <- SelectRepAll |>
  select(TreatmentID, paste0("Report", 1:13))



```

```{r}
#| label: tbl-productusage
#| tbl-cap: "Summary of product overlap for each report sample (row), the proportion of cases within that sample that also include products included in the remaining reports (columns)"

ReportNames <- c(
  "Healix Advance Peek with Dynacord",
  "Healix Advance Knotless Peek",
  "Healix Advance Knotless BR",
  "Healix Advance BR with Dynacord",
  "Milagro Advance BR",
  "Gryphon ProKnot BR",
  "Gryphon BR with Orthocord",
  "Gryphon BR with Dynacord",
  "Gryphon PEEK with Dynacord",
  "Latarjet Experience",
  "Dynacord Freestrand Suture",
  "Dynatape Freestrand Suture",
  "Orthocord Freestrand Suture"
)

SelectRepAll1 <- SelectRepAll |> dplyr::select(-TreatmentID)

# Empty matrix to store results
prop_table <- matrix(nrow = ncol(SelectRepAll1), ncol = ncol(SelectRepAll1), 0)
dimnames(prop_table) <- list(colnames(SelectRepAll1), colnames(SelectRepAll1))

# Loop through each column and calculate proportions
for (i in 1:ncol(SelectRepAll1)) {
  # Filter data based on 1s in the current column using [[i]] to extract vector
  filtered_data <- SelectRepAll1 |> 
    filter(SelectRepAll1[[i]] == 1)
  
  # Check if there are any 1s in the current column
  if (nrow(filtered_data) > 0) {
    # Calculate proportions for remaining columns
    props <- colMeans(filtered_data[, -i])
    
    # Create a vector with 1 at the ith position and proportions elsewhere
    prop_vec <- rep(0, ncol(SelectRepAll1))
    prop_vec[i] <- 1
    prop_vec[-i] <- props
  } else {
    # Fill with NA if no 1s in the current column
    prop_vec <- rep(NA, ncol(SelectRepAll1))
  }
  
  # Assign calculated proportions to the corresponding row in prop_table
  prop_table[i, ] <- prop_vec
}

colnames(prop_table) <- ReportNames
rownames(prop_table) <- ReportNames

# Convert matrix to data frame
prop_table <- as.data.frame(prop_table) |> 
  mutate(CaseCount = colSums(SelectRepAll1)) |> 
  relocate(CaseCount, .before = everything()) |> 
  gt::gt(rownames_to_stub = TRUE) |> 
  gt::fmt_number(
    columns = 3:15,
    scale_by = 100,
    decimals = 1
  )

```



## Proportion with multiple products

The proportion of cases that contained hardware from different product codes was summarised. 

```{r}
#| label: product-usage2

SelectRepSum <- SelectRepAll1 |> 
  rowwise() |> 
  mutate(Sum = sum(c_across(Report1:Report13), na.rm = TRUE)) |>
  ungroup()





```

A cross-tabulation of usage for all products was generated and written to an external file for further review.

```{r}
#| label: cross-tabulation
#| message: false
#| warning: false
#| include: false

# Authenticate for sheets using the same token
gs4_auth(token = drive_token())

# Create co-occurrence matrix
report_cols <- paste0("Report", 1:13)

# Extract report columns and convert to matrix
report_matrix <- SelectRepSum |>
  select(all_of(report_cols)) |>
  as.matrix()

# Calculate co-occurrence: t(matrix) %*% matrix gives counts
cooccurrence <- t(report_matrix) %*% report_matrix

# Convert to tibble with row names
cooccurrence_table <- cooccurrence |>
  as_tibble() |>
  mutate(Report = report_cols, .before = 1)


with_gs4_quiet(googlesheets4::range_write(
         ss = SheetIDs$AuditReport,
         data = cooccurrence_table,
         sheet = "ProductUsage",
         range = "A1:N",
         col_names = TRUE
         )
       )


```

A summary table was generated to illustrate the proportion of cases where multiple product codes were utilised.

```{r}
#| label: tbl-productusage3
#| tbl-cap: "Summary of cross-product usage in the PRULO dataset"

# Corrected approach using summarise
summary_table <- SelectRepSum |>
  summarise(across(Report1:Report13, list(
    Total = ~sum(.x == 1, na.rm = TRUE),
    Multiple = ~sum(.x == 1 & Sum > 1, na.rm = TRUE)
  ))) |>
  pivot_longer(everything(), 
               names_to = c("Report", "metric"), 
               names_pattern = "(.*)_(Total|Multiple)$",
               values_to = "value") |>
  pivot_wider(names_from = metric, values_from = value) |>
  mutate(Proportion = Multiple / Total) |>
  gt::gt(rownames_to_stub = TRUE) |>
  gt::fmt_number(
    columns = 5,
    scale = 100,
    decimals = 1
  ) |>
  tab_footnote(
    footnote = "Proportion as a % of the Total",
    locations = cells_column_labels(columns = Proportion)
  )

knitr::knit_print(summary_table)


```

